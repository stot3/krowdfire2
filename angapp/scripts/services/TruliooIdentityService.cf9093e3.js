app.service("TruliooIdentityService",["$q","Restangular","IDENTITY_PROXY_SERVER",function($q,Restangular,IDENTITY_PROXY_SERVER){var TruliooIdentityService={fields:{}};function getPhoneNumber(paramID){return Restangular.one("account/").customGET("phone-number",{person_id:paramID}).then((function(success){return{pphonenumber:success.personal,bphonenumber:success.business}}))}return TruliooIdentityService.generateTruliooNeededFields=function(user){return $q.all([(paramID=user.person_id,Restangular.one("account/").customGET("address",{person_id:paramID}).then((function(success){if(success)return{paddress:success.personal,baddress:success.business}}))),getPhoneNumber(user.person_id)]).then((function(result){for(var address,phoneNumber,country_code,xhr,i=0;i<result.length;i++){if(result[i]&&result[i].hasOwnProperty("paddress")&&result[i].paddress[0].hasOwnProperty("address_type"))for(var j=0;j<result[i].paddress.length;j++)if(result[i].paddress[j].primary_address){address=result[i].paddress[j];break}result[i]&&result[i].hasOwnProperty("pphonenumber")&&result[i].pphonenumber[0].hasOwnProperty("phone_number_type")&&(phoneNumber=result[i].pphonenumber[0])}return address?(country_code=address.code_iso3166_1,xhr=new XMLHttpRequest,xhr.open("GET",IDENTITY_PROXY_SERVER.APP_URL+"/fields/"+country_code,!0),xhr.setRequestHeader("Content-Type","application/json"),xhr.send(),new Promise((function(resolve,reject){xhr.onload=function(){if(200===xhr.status){var response=JSON.parse(xhr.response);resolve(response)}else reject({error:"Unable to communicate with server."})}}))).then((function(success){if("object"==typeof success){var personInfoReq=success.properties.PersonInfo.properties,locationReq=success.properties.Location.properties,communicationReq=success.properties.Communication.properties;if(personInfoReq)for(var property in personInfoReq)"FirstGivenName"===property&&(TruliooIdentityService.fields[property]={value:user.first_name,required:-1!=success.properties.PersonInfo.required.indexOf(property)}),"FirstSurName"===property&&(TruliooIdentityService.fields[property]={value:user.last_name,required:-1!=success.properties.PersonInfo.required.indexOf(property)});if(locationReq)for(var property in locationReq)"City"===property&&(TruliooIdentityService.fields[property]={value:address.city,required:-1!=success.properties.Location.required.indexOf(property)}),"PostalCode"===property&&(TruliooIdentityService.fields[property]={value:address.mail_code,required:-1!=success.properties.Location.required.indexOf(property)}),"StreetName"===property&&(TruliooIdentityService.fields[property]={value:address.street2,required:-1!=success.properties.Location.required.indexOf(property)}),"BuildingNumber"===property&&(TruliooIdentityService.fields[property]={value:address.street1,required:-1!=success.properties.Location.required.indexOf(property)}),"StateProvinceCode"===property&&(TruliooIdentityService.fields[property]={value:address.subcountry,required:-1!=success.properties.Location.required.indexOf(property)});if(communicationReq)for(var property in communicationReq)"EmailAddress"===property&&(TruliooIdentityService.fields[property]={value:user.email,required:-1!=success.properties.Communication.required.indexOf(property)}),phoneNumber.hasOwnProperty("phone_number_type")&&"Mobile Phone Number"===phoneNumber.phone_number_type&&"MobileNumber"===property&&(TruliooIdentityService.fields[property]={value:phoneNumber.number,required:-1!=success.properties.Communication.required.indexOf(property)}),phoneNumber.hasOwnProperty("phone_number_type")&&"Landline Phone Number"===phoneNumber.phone_number_type&&"Telephone"===property&&(TruliooIdentityService.fields[property]={value:phoneNumber.number,required:-1!=success.properties.Communication.required.indexOf(property)}),TruliooIdentityService.fields.TelephoneType||(TruliooIdentityService.fields.TelephoneType={value:phoneNumber.phone_number_type,required:-1!=success.properties.Communication.required.indexOf(property)});return TruliooIdentityService.fields}})):{error:"No primary address set"}}));var paramID},TruliooIdentityService.confirmTransaction=function(transId){var xhr=new XMLHttpRequest;return xhr.open("GET",IDENTITY_PROXY_SERVER.APP_URL+"/confirm/"+transId,!0),xhr.setRequestHeader("Content-Type","application/json"),xhr.send(),new Promise((function(resolve,reject){xhr.onload=function(){if(200===xhr.status){var response=JSON.parse(xhr.response);resolve(response)}else reject({error:"Unable to communicate with server."})}}))},TruliooIdentityService.verifyTransaction=function(fields){var payload=fields;if(payload){payload={AcceptTruliooTermsAndConditions:!0,CleansedAddress:!1,FirstGivenName:payload.FirstGivenName.value,FirstSurName:payload.FirstSurName.value,BuildingNumber:payload.BuildingNumber.value,StreetName:payload.StreetName.value,City:payload.City.value,StreetName:payload.StreetName.value,PostalCode:payload.PostalCode.value};var xhr=new XMLHttpRequest;return xhr.open("POST",IDENTITY_PROXY_SERVER.APP_URL+"/verify",!0),xhr.setRequestHeader("Content-Type","application/json"),xhr.send(JSON.stringify(payload)),new Promise((function(resolve,reject){xhr.onload=function(){var trulioo_verified={country:"",product_name:"",verified:!1,response:!1};if(200===xhr.status){var response=JSON.parse(xhr.response);"match"===response.Record.RecordStatus?(trulioo_verified={TransactionRecordID:response.Record.TransactionRecordID},resolve(trulioo_verified)):reject(response)}}}))}},TruliooIdentityService}]);