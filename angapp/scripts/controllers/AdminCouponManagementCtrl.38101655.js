app.controller("AdminCouponsCtrl",["$scope","PortalSettingsService","$rootScope","$timeout","$q","$translatePartialLoader","Restangular","RestFullResponse","FileUploadService","$translate","UserService",function($scope,PortalSettingsService,$rootScope,$timeout,$q,$translatePartialLoader,Restangular,RestFullResponse,FileUploadService,$translate,UserService){$scope.clearMessage=function(){$rootScope.floatingMessage=[]};var msg={};function updateUserListing(sortOrFilters){RestFullResponse.one("portal").all("coupon").getList(sortOrFilters).then((function(success){$("#myloader").hide("fast",(function(){$("body").removeClass("loading")})),$scope.coupons=success.data,$scope.data=[];var headers=success.headers();$scope.sortOrFiltersPerson.pagination.currentpage=headers["x-pager-current-page"],$scope.sortOrFiltersPerson.pagination.numpages=headers["x-pager-last-page"],$scope.sortOrFiltersPerson.pagination.nextpage=headers["x-pager-next-page"],$scope.sortOrFiltersPerson.pagination.pagesinset=headers["x-pager-pages-in-set"],$scope.sortOrFiltersPerson.pagination.totalentries=headers["x-pager-total-entries"],$scope.sortOrFiltersPerson.pagination.entriesperpage=headers["x-pager-entries-per-page"],createCouponCSV($scope.persons,$scope.data)}))}function createCouponCSV(couponData,couponDataCSV){var translations=$translate.instant(["tab_coupon_name","tab_coupon_code","tab_coupon_desc","tab_coupon_amount","tab_coupon_id","tab_coupon_type","tab_coupon_dollar","tab_coupon_percent"]);$scope.csvheader={id:translations.tab_coupon_id,name:translations.tab_coupon_name,code:translations.tab_coupon_code,desc:translations.tab_coupon_desc,amount:translations.tab_coupon_amount,type:translations.tab_coupon_type},couponDataCSV.push($scope.csvheader),angular.forEach(couponData,(function(coupon){var data1;data1={id:coupon.id,name:coupon.name,code:coupon.code,desc:coupon.description,amount:coupon.discount_amount>0?coupon.discount_amount:coupon.discount_percentage,type:coupon.discount_amount>0?translations.tab_coupon_dollar:translations.tab_coupon_percent},couponDataCSV.push(data1)}))}function confirmMultiUserDelete(){msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg;var requestQueue=[];angular.forEach($scope.couponsToDelete,(function(value){var id;requestQueue.push((id=value.id,Restangular.one("portal/coupon",id).customDELETE()))})),$q.all(requestQueue).then((function(success){angular.forEach(success,(function(value){console.log(value);var deleted_coupon_id=value[0].id;angular.forEach($scope.coupons,(function(value,key){console.log("dcid "+deleted_coupon_id+", "+value.id+", "+key),value.id==deleted_coupon_id&&$scope.coupons.splice(key,1)}))})),msg={header:"tab_coupon_coupon_deleted"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),$scope.testval=msg.header,$translate($scope.testval).then((function(value){value&&($scope.Message1=value)}))}),(function(failed){msg={header:failed.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}))}function checkNative(addressData){return angular.forEach(addressData,(function(value,key){if($scope.native_lookup){var name="";null!=value.country_native_name?name+=value.country_native_name:name+=value.country,null!=value.subcountry_native_name?name+=" "+value.subcountry_native_name:name+=" "+value.subcountry,null!=value.city_native_name&&"Other"!=value.city?name+=", "+value.city_native_name:"Other"!=value.city?name+=", "+value.city:value.city="",value.city_full=name}})),addressData}$scope.organization_name={},$scope.sortOrFiltersPerson={sort:"-created",filters:{},page_entries:25,page_limit:100,pagination:{},page:1},$scope.createdtype="-created",$scope.createdbtn=!0,$scope.showcreated=!0,$scope.nametype="-first_name",$scope.namebtn=!0,$scope.showname=!1,$scope.persontype="-person_id",$scope.personbtn=!0,$scope.showperson=!1,Restangular.one("portal/setting").customGET().then((function(success){angular.forEach(success,(function(value){"site_payment_gateway"==value.name?$scope.payment_gateway=value.value:"site_theme_campaign_display_iso_date"==value.name&&($scope.isISODate=value.value)}))})),PortalSettingsService.getSettingsObj().then((function(success){$scope.public_settings=success.public_setting,$scope.isRemoveUserProfileBio=success.public_setting.site_remove_user_profile_bio})),$scope.getCustomFields=function(person_id){$scope.custom_field=[],Restangular.one('portal/person/attribute?filters={"person_id":"'+person_id+'"}').customGET().then((function(success){$scope.$emit("loading_finished"),success&&($scope.custom_field=success),$scope.public_settings.site_campaign_enable_organization_name&&$scope.custom_field[0].attributes&&($scope.organization_name.value=$scope.custom_field[0].attributes.organization_name,$scope.organization_name.ein=$scope.custom_field[0].attributes.ein),$scope.public_settings.site_campaign_business_section_custom&&$scope.public_settings.site_campaign_business_section_custom.length>0&&($scope.bcustom=[],angular.forEach($scope.public_settings.site_campaign_business_section_custom,(function(value){var fieldRequire=!1,fieldPlaceholder="";value.placeholder&&(fieldPlaceholder=value.placeholder),value.profile_setting_required&&(fieldRequire=value.profile_setting_required);var field={name:value.name,identifier:"customFieldBusiness"+key,value:"",placeholder:fieldPlaceholder,required:fieldRequire};angular.forEach($scope.custom_field[0].attributes,(function(val,key,obj){key&&key==value.name&&(field.value=val)})),$scope.bcustom.push(field)})),$scope.bcustom_copy=angular.copy($scope.bcustom)),$scope.public_settings.site_campaign_personal_section_custom&&$scope.public_settings.site_campaign_personal_section_custom.length>0&&($scope.pcustom=[],angular.forEach($scope.public_settings.site_campaign_personal_section_custom,(function(value,key){var fieldRequire=!1,fieldPlaceholder="";if(value.placeholder&&(fieldPlaceholder=value.placeholder),value.profile_setting_required&&(fieldRequire=value.profile_setting_required),$scope.public_settings.site_campaign_personal_section_enhanced)var field={name:value.name,identifier:"customField"+key,value:"",option:value.option,dropdown_array:value.dropdown_array,profile_step_show:value.profile_step_show,profile_setting_register_show:value.profile_setting_register_show,profile_setting_show:value.profile_setting_show,register_show:value.register_show,validate:value.validate,placeholder:fieldPlaceholder,required:fieldRequire};else field={name:value.name,identifier:"customField"+key,value:"",option:"Text",dropdown_array:null,profile_step_show:!0,placeholder:fieldPlaceholder,required:fieldRequire};angular.forEach($scope.custom_field[0].attributes,(function(val,key,obj){key&&key==value.name&&(field.value=val)})),$scope.pcustom.push(field)})),$scope.pcustom_copy=angular.copy($scope.pcustom))}),(function(error){$scope.custom_field=[],$scope.pcustom=[],$scope.pcustom_copy=angular.copy($scope.pcustom),$scope.$emit("loading_finished")}))},$scope.customFieldDropdown=function(option,field){field.value=option},$scope.savePersonAttributes=function(person_id,$data){Restangular.one("portal/person/attribute",person_id).customPUT($data)},$scope.checkentry=function(){$scope.entries=$("#searchbtn").dropdown("get value"),$scope.sortOrFiltersPerson.page_entries=$scope.entries,updateUserListing($scope.sortOrFiltersPerson)},$scope.sortUserCreated=function(){$scope.showcreated=!0,$scope.showname=!1,$scope.showperson=!1,"-created"==$scope.createdtype?($scope.createdtype="created",$scope.createdbtn=!1,$scope.sortOrFiltersPerson.sort="created"):($scope.createdbtn=!0,$scope.createdtype="-created",$scope.sortOrFiltersPerson.sort="-created"),$scope.sortOrFiltersPerson.page_entries=$("#resultValue").text(),updateUserListing($scope.sortOrFiltersPerson)},$scope.sortUserName=function(){$scope.showcreated=!1,$scope.showname=!0,$scope.showperson=!1,"-first_name"==$scope.persontype?($scope.persontype="first_name",$scope.namebtn=!1,$scope.sortOrFiltersPerson.sort="first_name"):($scope.namebtn=!0,$scope.persontype="-first_name",$scope.sortOrFiltersPerson.sort="-first_name"),$scope.sortOrFiltersPerson.page_entries=$("#resultValue").text(),updateUserListing($scope.sortOrFiltersPerson)},$scope.applyToggle=function(){$scope.public_settings.site_campaign_coupon_management||($scope.public_settings.site_campaign_coupon_management={toggle:!1}),$scope.public_settings.site_campaign_coupon_management.toggle=!$scope.public_settings.site_campaign_coupon_management.toggle,Restangular.one("portal/setting/public").customPUT($scope.public_settings).then((function(success){$rootScope.floatingMessage={header:$translate.instant("tab_coupon_coupon_management_"+($scope.public_settings.site_campaign_coupon_management.toggle?"enabled":"disabled"))}}),(function(failed){$rootScope.floatingMessage={header:$translate.instant("tab_coupon_coupon_management_toggle_error")}}))},$scope.totalentry=[25,50,100],$scope.userShown=!1,$scope.person={},$scope.coupons=[],$scope.couponsToDelete=[],$scope.userSearch={},$scope.goBackUser=function(){$scope.userShown=!1},$scope.updateUserListing=function(){updateUserListing($scope.sortOrFiltersPerson)},$scope.getAllCouponsCSV=function(){var userRequestArray=[],totalNumUsers=$scope.sortOrFiltersPerson.pagination.totalentries,requiredNumCalls=0;$scope.allCouponsArray=[];var reqArg={page:1};requiredNumCalls=parseInt(parseInt(totalNumUsers)/100),totalNumUsers%100!=0&&(requiredNumCalls+=1);for(var curNumCall=0;curNumCall<requiredNumCalls;curNumCall++){var request=RestFullResponse.one("portal").all("coupon").getList(reqArg);userRequestArray.push(request),reqArg.page+=1}return $q.all(userRequestArray).then((function(success){return $scope.allCouponsCSV=[],success.forEach((function(resArr){$scope.allCouponsArray=$scope.allCouponsArray.concat(resArr.data)})),createCouponCSV($scope.allCouponsArray,$scope.allCouponsCSV),$scope.allCouponsCSV}))},updateUserListing($scope.sortOrFiltersPerson),$scope.getTotalItemsPerson=function(){var desiredtotal=$scope.sortOrFiltersPerson.pagination.entriesperpage*$scope.sortOrFiltersPerson.page_limit;return desiredtotal>$scope.sortOrFiltersPerson.pagination.totalentries?$scope.sortOrFiltersPerson.pagination.totalentries:desiredtotal},$scope.updatePagingPerson=function(){updateUserListing($scope.sortOrFiltersPerson)},$scope.deleteOneUser=function($event,user){$scope.user=user,$(".delete-one-user-modal").modal("show")},$scope.addCouponValidation=function(){var translation=$translate.instant(["tab_coupon_name_message","tab_coupon_code_message","tab_coupon_amount_message","tab_coupon_amount_min_message","tab_coupon_choose_discount"]);$scope.form_validation={coupon_name:{identifier:"coupon_name",rules:[{type:"empty",prompt:translation.tab_coupon_name_message}]},coupon_code:{identifier:"coupon_code",rules:[{type:"empty",prompt:translation.tab_coupon_code_message}]},coupon_amount:{identifier:"coupon_amount",rules:[{type:"empty",prompt:translation.tab_coupon_amount_message},{type:"integer[1..100000000]",prompt:translation.tab_coupon_amount_min_message}]},coupon_discount_type:{identifier:"coupon_discount_type",rules:[{type:"empty",prompt:translation.tab_coupon_choose_discount}]}},$("#add-user-form.ui.form").form($scope.form_validation,{inline:!0,keyboardShortcuts:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1,$("html, body").animate({scrollTop:$(".field.error").offset().top},1e3)}}).form("validate form")},$scope.editUserValidation=function(){var translation=$translate.instant(["tab_coupon_name_message","tab_coupon_code_message","tab_coupon_amount_message","tab_coupon_amount_min_message","tab_coupon_choose_discount"]);$scope.form_validation={coupon_name:{identifier:"coupon_name",rules:[{type:"empty",prompt:translation.tab_coupon_name_message}]},coupon_code:{identifier:"coupon_code",rules:[{type:"empty",prompt:translation.tab_coupon_code_message}]},coupon_amount:{identifier:"coupon_amount",rules:[{type:"empty",prompt:translation.tab_coupon_amount_message},{type:"integer[1..100000000]",prompt:translation.tab_coupon_amount_min_message}]},coupon_discount_type:{identifier:"coupon_discount_type",rules:[{type:"empty",prompt:translation.tab_coupon_choose_discount}]}},$("#edit-user-form.ui.form").form($scope.form_validation,{inline:!0,keyboardShortcuts:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1,$("html, body").animate({scrollTop:$(".field.error").offset().top},1e3)}}).form("validate form")},$scope.openModal=function(modalId,callback){$(".modal#"+modalId).modal({closable:!1,onApprove:function(){return"function"==typeof callback&&callback(),!1}}).modal("show")},$scope.closeModal=function(){$(".ui.modal").modal("hide")},$scope.getCompany=function(){var data={person_id:$scope.formData.person_id};$scope.formData.person_id&&Restangular.one("account").customGET("business",data).then((function(success){$scope.businesses=success,$scope.companies=success}))},$scope.editCoupon=function(coupon){$scope.formData=coupon,$scope.formData.amount=coupon.discount_amount>0?coupon.discount_amount:coupon.discount_percentage,$scope.formData.id=coupon.id,$scope.userShown=!0,$(".user-edit").find("[data-tab]").removeClass("active"),$(".user-edit").find("[data-tab='profile-details']").addClass("active"),$scope.clickHash=function(tabName){$(".user-edit").find("[data-tab]").removeClass("active"),$(".user-edit").find("[data-tab="+tabName+"]").addClass("active")},$(".coupon-discount-type").dropdown("set selected",coupon.discount_amount>0?1:2)},$scope.confirmUserEdit=function(){if($scope.valcheck=!0,$scope.editUserValidation(),$scope.valcheck){msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg;var couponType=$(".user-edit-body").find('input[name="coupon_discount_type"]').val(),data={name:$scope.formData.name,code:$scope.formData.code,description:$scope.formData.description,discount_amount:1==couponType?$scope.formData.amount:0,discount_percentage:2==couponType?Math.min(100,$scope.formData.amount):0,expiry_date_time:(new Date).toISOString(),expiry_quantity:0};console.log(couponType),console.log(data),Restangular.one("portal/coupon/"+$scope.formData.id).customPUT(data).then((function(success){console.log(success),$translate(["tab_coupon_coupon_edited","tab_coupon_coupon_not_edited"]).then((function(translations){$rootScope.floatingMessage={header:translations.tab_coupon_coupon_edited},$scope.userShown=!1}));var index=$scope.coupons.findIndex((function(c){return c.id==success[0].id}));$scope.coupons.splice(index,1,success[0])}),(function(failure){console.log(failure),$translate(["tab_coupon_coupon_not_edited"]).then((function(success){$rootScope.floatingMessage={header:success.tab_coupon_coupon_not_edited}}))}))}},$scope.addCoupon=function($event){$(".add-coupon-modal").modal({closable:!1,onApprove:function(){return!1}}).modal("show"),$scope.formData={}},$scope.confirmUserAdd=function(){if($scope.valcheck=!0,$scope.addCouponValidation(),$scope.valcheck){msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg;var couponType=$(".add-coupon-modal").find('input[name="coupon_discount_type"]').val();console.log("Coupon type = "+couponType);var data={name:$scope.formData.name,code:$scope.formData.code,description:$scope.formData.description,discount_amount:1==couponType?$scope.formData.amount:0,discount_percentage:2==couponType?Math.min(100,$scope.formData.amount):0,expiry_date_time:(new Date).toISOString(),expiry_quantity:0};Restangular.one("portal/coupon").customPOST(data).then((function(success){$(".add-coupon-modal").modal("hide"),$translate(["tab_coupon_coupon_added","tab_coupon_coupon_not_added"]).then((function(success){$rootScope.floatingMessage={header:success.tab_coupon_coupon_added},$scope.hideFloatingMessage()})),updateUserListing($scope.sortOrFiltersPerson)}),(function(failure){console.log(failure),$translate(["tab_coupon_coupon_not_added"]).then((function(success){$rootScope.floatingMessage={header:success.tab_coupon_coupon_not_added},$scope.hideFloatingMessage()}))}))}},$scope.deleteMultiUser=function($event){$(".user-table");$scope.couponsToDelete=[],$(".coupon-row").each((function(){$(this).find(".t-check-box input").prop("checked")&&$scope.couponsToDelete.push($(this).scope().coupon)})),$scope.couponsToDelete.length?$(".delete-multi-user-modal").modal({onApprove:confirmMultiUserDelete}).modal("show"):(msg={header:"tab_users_select_error"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage())},$scope.disableMultiUser=function(){msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg;var selectError=!1;$(".coupon-row").each((function(){if($(this).find(".t-check-box input").prop("checked")){var ps=$(this).scope().person,form={person_id:ps.id,person_status_id:3};selectError=!0,Restangular.one("portal/person",form.person_id).customPUT(form).then((function(success){ps.person_status_id=3,msg={header:"users_disabled_successfully"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}),(function(failure){0==$rootScope.floatingMessage.length&&(msg={header:failure.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage())}))}})),selectError||(msg={header:"tab_users_select_error"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage())},$scope.searchUserBy=function(word){1!=$scope.searchMode&&$scope.searchMode?2==$scope.searchMode&&($scope.sortOrFiltersPerson.filters.name="",$scope.sortOrFiltersPerson.filters.code=word):($scope.sortOrFiltersPerson.filters.name=word,$scope.sortOrFiltersPerson.filters.code=""),updateUserListing($scope.sortOrFiltersPerson)},$scope.searchType=function(type){$scope.searchMode=type,$scope.searchUserBy($scope.userSearch.searchInput)},$scope.userStatusFilter=function(status){$scope.sortOrFiltersPerson.filters.person_status=status,updateUserListing($scope.sortOrFiltersPerson)},$scope.userTypeFilter=function(type){$scope.sortOrFiltersPerson.filters.person_type=type,updateUserListing($scope.sortOrFiltersPerson)},$scope.uploadUserImage=function(files){if(files&&files.length){var $picNode=$(".userProfileImage"),params={person_id:$scope.formData.id,resource_content_type:"image"};$scope.formData.files=[],FileUploadService.upload("account/resource/file",files,params,$picNode).then((function(success){$scope.formData.files[0]=success[0].data}))}},$scope.deleteUserImage=function(files){if(files&&files.length){var file=files.shift(),param={person_id:$scope.formData.id};Restangular.one("account/resource/file").customDELETE(file.id,param),$(".imagePlace .dimmer").dimmer("hide"),$(".ui.progress.upload-bar").show(),$(".ui.loader.download-loader").hide()}},$scope.showPersonal=function(id){"p"==id&&(setTimeout((function(){$("#personalbtn").addClass("positive"),$("#Npersonalbtn").addClass("positive"),$("#Nbusinessbtn").removeClass("positive"),$("#businessbtn").removeClass("positive")}),50),$scope.showpersonal=!0,$scope.showbusiness=!1),"b"==id&&(setTimeout((function(){$("#Nbusinessbtn").addClass("positive"),$("#businessbtn").addClass("positive"),$("#personalbtn").removeClass("positive"),$("#Npersonalbtn").removeClass("positive")}),50),$scope.showpersonal=!1,$scope.showbusiness=!0)},$scope.getAddressInfo=function(){var data={person_id:$scope.formData.person_id};$scope.formData.person_id&&Restangular.one("account").customGET("address",data).then((function(success){$scope.personal_addresses=checkNative(success.personal),$scope.business_addresses=checkNative(success.business),success.personal?($scope.showadd=!0,$scope.showbadd=!0,$scope.showPersonal("p")):success.business&&($scope.showadd=!1,$scope.showbadd=!0,$scope.showPersonal("b"))}))},$scope.getPhoneInfo=function(){var data={person_id:$scope.formData.person_id};$scope.formData.person_id&&Restangular.one("account").customGET("phone-number",data).then((function(success){$scope.personal_number=success.personal,$scope.business_number=success.business,success.personal?($scope.showadd=!0,$scope.showPersonal("p")):success.business&&($scope.showadd=!0,$scope.showPersonal("b"))}))},$scope.multiDelete=function(tableClass,modalID,callback){$scope.deleteQueue=function(tableClass){var queue=[];return $("table."+tableClass).find("tbody td.t-check-box input").each((function(){if($(this).prop("checked")){var item=$(this).scope();queue.push(item)}})),queue}(tableClass),$scope.itemDeleteCount=$scope.deleteQueue.length,$scope.deleteQueue.length?$scope.openModal(modalID,callback):(msg={header:"profile_setting_select_error"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage())}}]),app.controller("TabUserCompanyCtrl",["$translate","$scope","$timeout","$q","Restangular","UserService","FileUploadService","$rootScope",function($translate,$scope,$timeout,$q,Restangular,UserService,FileUploadService,$rootScope){function saveBusinessLinks(){var selectedProtocols=$(".dropdown.business-link-setup").dropdown("get text");angular.forEach($scope.businessLinks,(function(link,key){var new_link={};for(var prop in link)new_link[prop]=link[prop];Array.isArray(selectedProtocols)?"Relative Path"==selectedProtocols[key]?new_link.uri=link.uri:(link.uri=link.uri.replace(/^https?\:\/\//i,""),new_link.uri=selectedProtocols[key]+link.uri):"Relative Path"==selectedProtocols?new_link.uri=link.uri:(link.uri=link.uri.replace(/^https?\:\/\//i,""),new_link.uri=selectedProtocols+link.uri),new_link.person_id=$scope.formData.person_id,new_link.uri_text&&new_link.uri&&(new_link.uri_id?Restangular.one("account/website",new_link.uri_id).customPUT(new_link):(new_link.business_organization_id=$scope.businessSelected.business_organization_id,Restangular.one("account/website").customPOST(new_link)))}))}function getBusinessInfo(){var data={person_id:$scope.formData.person_id};Restangular.one("account").customGET("business",data).then((function(success){$scope.businesses=success,$scope.businesses[0]?$scope.showcompany=!0:$scope.showcompany=!1}))}$scope.deleteProfileImage=function(files){Restangular.one("account/resource/file").customDELETE(files[0].id).then((function(){files.splice(0,1)})),$(".imagePlace .dimmer").dimmer("hide"),$(".ui.loader.download-loader").fadeOut(),$(".ui.progress.upload-bar").fadeOut()},$scope.profile_protocols=[{value:"http://"},{value:"https://"},{value:"Relative Path"}],$scope.profile_link_default_protocol=$scope.profile_protocols[0],getBusinessInfo(),$scope.getBusinessImage=function(businessID){Restangular.one("account/resource/file?person_id="+$scope.formData.person_id+"&business_organization_id="+businessID).customGET().then((function(success){$scope.businessImage=success}))},$scope.uploadBusinessImage=function(files){if(files.length){var $picNode=$(".profileCompany"),params={resource_content_type:"image",business_organization_id:$scope.businessSelected.id};params.person_id=$scope.formData.person_id,$scope.businessSelected.id?FileUploadService.upload("account/resource/file/",files,params,$picNode).then((function(success){$scope.businessImage=[],$scope.businessImage.push(success[0].data)})):($scope.businessSelected.name="Placeholder",$scope.businessSelected.person_id=$scope.formData.person_id,Restangular.one("account/business").customPOST($scope.businessSelected).then((function(success){$scope.businessSelected=success,getBusinessInfo(),$scope.getCompany(),params.business_organization_id=$scope.businessSelected.id,FileUploadService.upload("account/resource/file/",files,params,$picNode).then((function(success){$scope.businessImage=[],$scope.businessImage.push(success[0].data)}))})))}},$scope.deleteBusinessImage=function(files){if(files&&files.length){var file=files.pop(),param={business_organization_id:$scope.businessSelected.id};params.person_id=$scope.formData.person_id,Restangular.one("account/resource/file").customDELETE(file.id,param),$(".imagePlace .dimmer").dimmer("hide"),$(".ui.loader.download-loader").fadeOut(),$(".ui.progress.upload-bar").fadeOut()}},$scope.selectBusiness=function(business){var businessId;$scope.openModal("setting-add-company"),$scope.businessLinks=[],$scope.businessImage=null,$scope.getBusinessImage(business.business_organization_id),$scope.businessSelected=business,businessId=business.business_organization_id,Restangular.all("account/website?person_id="+$scope.formData.person_id+"&business_organization_id="+businessId).customGET().then((function(success){for(var n in $scope.businessLinks=success.business,$scope.businessLinks){var current_business_link=$scope.businessLinks[n].uri;for(var i in $scope.profile_protocols){if(current_business_link.indexOf($scope.profile_protocols[i].value)>-1){$scope.businessLinks[n].uri=current_business_link.replace($scope.profile_protocols[i].value,""),$scope.businessLinks[n].profile_link_default_protocol=$scope.profile_protocols[i].value;break}$scope.businessLinks[n].profile_link_default_protocol=$scope.profile_protocols[2].value}}}))},$scope.newBusiness=function(){$(".ui.form.company-form").form("clear"),$scope.businessSelected={business_organization_id:"",description:"",name:""},$scope.businessLinks=[],$scope.businessImage=[]},$scope.addBusinessLink=function(arr){var link={uri:"",uri_text:"",business_organization_id:$scope.businessSelected.business_organization_id};angular.isUndefined(arr)?angular.copy(link):arr.push(angular.copy(link))},$scope.removeBusinessLink=function(link){link.uri_id?Restangular.one("account/website").customDELETE(link.uri_id,{business_organization_id:link.business_organization_id}).then((function(success){$scope.businessLinks.splice($scope.businessLinks.indexOf(link),1)})):$scope.businessLinks.splice($scope.businessLinks.indexOf(link),1)},$scope.companyValidation=function(){var translation=$translate.instant(["tab_company_setting_company_name_error"]);$(".company-form.ui.form").form({company_name:{identifier:"company_name",rules:[{type:"empty",prompt:translation.tab_company_setting_company_name_error}]}},{inline:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form")},$scope.saveBusinessInfoEnter=function(event){13==event.keyCode&&(event.target.blur(),$scope.saveBusinessInfo(event))},$scope.saveBusinessInfo=function(){if($scope.valcheck=!0,$scope.companyValidation(),$scope.businessSelected.person_id=$scope.formData.person_id,$scope.valcheck){var request;msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg;var custom_fields={};angular.forEach($scope.bcustom,(function(v){custom_fields[v.name]=v.value})),custom_fields&&(custom_fields=JSON.stringify(custom_fields));var customFieldData={attributes:custom_fields};$scope.businessSelected.business_organization_id?($scope.savePersonAttributes($scope.selectedPersonId,customFieldData),request=Restangular.one("account/business",$scope.businessSelected.business_organization_id).customPUT($scope.businessSelected).then((function(success){saveBusinessLinks(),msg={header:"success_message_save_changes_button"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),$scope.getCompany()}))):(Restangular.one("portal/person").customPOST(customFieldData).then((function(success){})),request=Restangular.one("account/business").customPOST($scope.businessSelected).then((function(success){$scope.businessSelected=success,saveBusinessLinks(),msg={header:"success_message_save_changes_button"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),$scope.getCompany()}))),request?request.then((function(){$("#setting-add-company").modal("hide"),msg={header:"tab_company_setting_company_info_save_success"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),getBusinessInfo(),$scope.getCompany()})):(msg={header:"tab_company_setting_company_info_save_error"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage())}},$scope.removeBusiness=function(business){return data={},data.person_id=$scope.formData.person_id,Restangular.one("account/business",business.business_organization_id).customDELETE(data)},$scope.confirmDeleteBusiness=function(){var requestQueue=[];angular.forEach($scope.deleteQueue,(function(value){requestQueue.push($scope.removeBusiness(value.business))})),msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg,$q.all(requestQueue).then((function(success){angular.forEach(success,(function(value){angular.forEach($scope.businesses,(function(business,index){value.id==business.id&&$scope.businesses.splice(index,1)}))})),msg={header:"tab_company_setting_company_info_delete_success"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),$scope.getCompany()}),(function(failed){msg={header:failed.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}))},$scope.checkAll=function(tableClass){0==$("."+tableClass+" thead tr .check-all input").prop("checked")?$("."+tableClass+" tbody tr .t-check-box input").prop("checked",!0):$("."+tableClass+" tbody tr .t-check-box input").prop("checked",!1)}}]),app.controller("TabUserAddressCtrl",["$translate","$scope","$timeout","$q","Restangular","UserService","Geolocator","PortalSettingsService","$rootScope",function($translate,$scope,$timeout,$q,Restangular,UserService,Geolocator,PortalSettingsService,$rootScope){$scope.addressSubcountrySelected={},$scope.addressCountrySelected={},$scope.addressSelected={},PortalSettingsService.getSettingsObj().then((function(success){$scope.alt_shipping=success.public_setting.site_theme_alt_shipping_layout,$scope.native_lookup=success.public_setting.site_theme_shipping_native_lookup,$scope.native_lookup&&(success.public_setting.site_theme_default_shipping_country.name=success.public_setting.site_theme_default_shipping_country.native_name),$scope.alt_shipping&&Geolocator.getCountries().then((function(countries){if($scope.native_lookup)for(var i in countries)null!=countries[i].native_name&&(countries[i].name=countries[i].native_name);if($scope.countries=countries,$scope.default_country){for(var index in $scope.countries){var value=$scope.countries[index];if(value.id==$scope.default_country.id){$scope.default_country=value,$scope.countries.splice(index,1);break}}$scope.countries.splice(0,0,$scope.default_country)}})),$scope.default_country=success.public_setting.site_theme_default_shipping_country,$scope.addressCountrySelected.selected=$scope.default_country,$scope.setCountry($scope.addressCountrySelected.selected),null!=$scope.addressCountrySelected.selected&&Object.getOwnPropertyNames($scope.addressCountrySelected.selected).length&&$scope.addressCountrySelected.selected.name&&getSubcountries($scope.addressCountrySelected.selected.id)}));var address_table="";function getSubcountries(countryID){Geolocator.getSubcountriesByCountry(countryID).then((function(subcountries){if($scope.native_lookup)for(var i in subcountries)null!=subcountries[i].native_name&&(subcountries[i].name=subcountries[i].native_name);$scope.subcountries=subcountries}))}$scope.getCompany(),$scope.selectAddress=function(address){$scope.addressSelected=address,$scope.alt_shipping?($scope.addressCountrySelected.selected={name:"",id:0},$scope.addressSubcountrySelected.selected={name:"",id:0},$scope.addressSelected.selected={name:"",id:0},$scope.addressCountrySelected.selected.name=$scope.native_lookup&&address.country_native_name?address.country_native_name:address.country,$scope.addressCountrySelected.selected.id=address.country_id,$scope.addressSubcountrySelected.selected.name=$scope.native_lookup&&address.subcountry_native_name?address.subcountry_native_name:address.subcountry,$scope.addressSubcountrySelected.selected.id=address.subcountry_id,$scope.addressSelected.selected.name=$scope.native_lookup&&address.city_native_name?address.city_native_name:address.city):$scope.addressSelected.selected={name:address.city_full},address.business_organization?$scope.showBusName=!0:$scope.showbusName=!1,angular.forEach($scope.companies,(function(value){value.business_organization_id==$scope.addressSelected.business_organization_id&&($scope.companyName=value.name,$("#defaulttext").text($scope.companyName),$("#defaulttext").removeClass("default"))}))},$scope.showpersonal=!0,$scope.showbusiness=!1,$scope.newAddress=function(){$(".ui.form").form("clear"),$scope.showBusName=!1,addressCountrySelected="",$scope.addressSelected={business_organization_id:"",city_id:"",mail_code:"",street1:"",street2:"",description:""}},$scope.removeAddress=function(address){if($scope.showbusiness){var par={business_organization_id:address.business_organization_id};return Restangular.one("account/address",address.address_id).remove(par)}if($scope.showpersonal)return Restangular.one("account/address",address.address_id).customDELETE()},$scope.confirmDeleteAddress=function(){$scope.deleteQueue.length;var requestQueue=[];angular.forEach($scope.deleteQueue,(function(value,key){requestQueue.push($scope.removeAddress(value.address))})),msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg,$q.all(requestQueue).then((function(success){angular.forEach(success,(function(value){angular.forEach($scope.addresses,(function(address,index){address.id==value.id&&$scope.addresses.splice(index,1)}))})),msg={header:"tab_address_delete_success"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),$scope.getAddressInfo()}),(function(failed){msg={header:failed.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}))},$scope.searchCities=function(term){var native_lookup=1==$scope.native_lookup?1:0;term&&($scope.alt_shipping?Geolocator.searchCitiesBySubcountry(term,$scope.addressSubcountrySelected.selected.id,native_lookup).then((function(cities){if(native_lookup)for(var i in cities)null!=cities[i].city_native_name&&(cities[i].name=cities[i].city_native_name),null!=cities[i].country_native_name&&(cities[i].country=cities[i].country_native_name),null!=cities[i].subcountry_native_name&&(cities[i].subcountry=cities[i].subcountry_native_name);$scope.cities=cities})):Geolocator.searchCities(term,native_lookup).then((function(cities){$scope.cities=cities})))},$scope.$watch("addressCountrySelected.selected",(function(value,oldValue){value!=oldValue&&value&&getSubcountries(value.id)})),$scope.$watch("addressSelected.selected",(function(value){if(value){var cityID=Geolocator.lookupCityID(value.name);cityID&&($scope.addressSelected.city_id=cityID),$("#select-city .select-error").remove(),$("#select-city").removeClass("error")}})),$scope.setCountry=function(country){$scope.addressCountrySelected.selected=country},$scope.addressValidation=function(){var translation=$translate.instant(["tab_address_select_company_error","tab_address_address1_error","tab_address_mailcode_error"]);$(".address-form.ui.form").form({company_select:{identifier:"company_select",rules:[{type:"empty",prompt:translation.tab_address_select_company_error}]},address1:{identifier:"address1",rules:[{type:"empty",prompt:translation.tab_address_address1_error}]},mail_code:{identifier:"mail_code",rules:[{type:"empty",prompt:translation.tab_address_mailcode_error}]}},{inline:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form")},$scope.saveAddressInfoEnter=function(event){13==event.keyCode&&(event.target.blur(),$scope.saveAddressInfo(event))},$scope.saveAddressInfo=function(event){var translation=$translate.instant(["tab_address_select_city_error"]);($scope.valcheck=!0,$("#select-city .select2-container").hasClass("select2-container-disabled")||$scope.addressSelected.selected||($(".select-error").remove(),$("#select-city").append('<div class="select-error ui red pointing prompt label transition visible">'+translation.tab_address_select_city_error+"</div>"),$("#select-city").addClass("error")),$scope.addressValidation(),$scope.valcheck)&&(angular.element(event.target).addClass("disabled"),msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg,$scope.addressSelected.person_id=$scope.formData.person_id,($scope.addressSelected.address_id?Restangular.one("account/address",$scope.addressSelected.address_id).customPUT($scope.addressSelected):Restangular.one("account/address").customPOST($scope.addressSelected)).then((function(success){$("#setting-add-address").modal("hide"),msg={header:"tab_address_save_success"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),angular.element(event.target).removeClass("disabled"),$scope.getAddressInfo()}),(function(failed){msg={header:failed.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),angular.element(event.target).removeClass("disabled")})))},$scope.setPrimary=function(){msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg;var queue=function(tableClass){var queue=[];return $("table."+tableClass).find("tbody td.t-check-box input").each((function(){if($(this).prop("checked")){var item=$(this).scope();queue.push(item)}})),queue}(address_table);if(1!=queue.length)msg={header:"tab_address_set_primary"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage();else{var unsetPrimary;angular.forEach($scope.addresses,(function(value){if(1==value.primary_address){var update={primary_address:0};update.person_id=$scope.formData.person_id,unsetPrimary=Restangular.one("account/address",value.address_id).customPUT(update)}}));var update={primary_address:1};update.person_id=$scope.formData.person_id,unsetPrimary?unsetPrimary.then((function(success){Restangular.one("account/address",queue[0].address.address_id).customPUT(update)})).then((function(){msg={header:"tab_address_reset_primary"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),$scope.getAddressInfo()}),(function(failed){msg={header:failed.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()})):Restangular.one("account/address",queue[0].address.address_id).customPUT(update).then((function(){msg={header:"tab_address_set_primary_success"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),$scope.getAddressInfo()}),(function(failed){msg={header:failed.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}))}},$scope.selectCompany=function(id){$scope.addressSelected.business_organization_id=id},$scope.showPersonal=function(id){"p"==id&&(setTimeout((function(){$("#personalbtn").addClass("positive"),$("#businessbtn").removeClass("positive")}),50),$scope.showpersonal=!0,$scope.showbusiness=!1,address_table="address-table-personal"),"b"==id&&(setTimeout((function(){$("#businessbtn").addClass("positive"),$("#personalbtn").removeClass("positive")}),50),$scope.showpersonal=!1,$scope.showbusiness=!0,address_table="address-table-business")}}]),app.controller("TabUserPhoneCtrl",["$translate","$scope","$timeout","$q","Restangular","UserService","PHONE_TYPE","$rootScope",function($translate,$scope,$timeout,$q,Restangular,UserService,PHONE_TYPE,$rootScope){$scope.getCompany(),$scope.formPreventDefault=function(event){if(13==event.keyCode)return event.preventDefault(),!1},$scope.savePhoneInfoEnter=function(event){13==event.keyCode&&(event.target.blur(),$scope.savePhoneInfo(event))},$scope.selectPhone=function(phone){$scope.phoneSelected=phone,phone.business_organization?$scope.showBusName=!0:$scope.showBusName=!1,angular.forEach($scope.phonetype,(function(value){value.id==$scope.phoneSelected.phone_number_type_id&&($scope.phoneName=value.name)}))},$scope.showpersonal=!0,$scope.showbusiness=!1,$scope.phonetype=PHONE_TYPE,$scope.newPhone=function(){$(".ui.form").form("clear"),$scope.showBusName=!1,$scope.phoneSelected={business_organization_id:"",number:"",phone_number_type_id:"",id:""}},$scope.removePhone=function(phone){if((par={}).person_id=$scope.formData.person_id,$scope.showbusiness){var par={business_organization_id:phone.business_organization_id};return Restangular.one("account/phone-number",phone.id).remove(par)}if($scope.showpersonal)return Restangular.one("account/phone-number",phone.id).customDELETE(par)},$scope.confirmDeletePhone=function(){$scope.deleteQueue.length;var requestQueue=[];angular.forEach($scope.deleteQueue,(function(value,key){requestQueue.push($scope.removePhone(value.phone))})),$q.all(requestQueue).then((function(success){msg={header:"tab_phone_deleted_success"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),$scope.getPhoneInfo()}),(function(failed){msg={header:failed.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}))},$scope.phoneValidation=function(){var translation=$translate.instant(["tab_phone_setting_company_error","tab_phone_setting_number_error","tab_phone_setting_notvalidnumber_error"]);$(".phone-number-form.ui.form").form({company_select:{identifier:"company_select",rules:[{type:"empty",prompt:translation.tab_phone_setting_company_error}]},number:{identifier:"number",rules:[{type:"empty",prompt:translation.tab_phone_setting_number_error},{type:"integer",prompt:translation.tab_phone_setting_notvalidnumber_error}]}},{inline:!0,keyboardShortcuts:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form")},$scope.savePhoneInfo=function(event){($scope.valcheck=!0,$scope.phoneValidation(),$scope.valcheck)&&(angular.element(event.target).addClass("disabled"),msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg,$scope.phoneSelected.person_id=$scope.formData.person_id,($scope.phoneSelected.id?Restangular.one("account/phone-number",$scope.phoneSelected.id).customPUT($scope.phoneSelected):Restangular.one("account/phone-number").customPOST($scope.phoneSelected)).then((function(success){$("#setting-add-phone").modal("hide"),msg={header:"tab_phone_saved_success"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),angular.element(event.target).removeClass("disabled"),$scope.getPhoneInfo()}),(function(failed){$("#setting-add-phone").modal("hide"),msg={header:failed.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),angular.element(event.target).removeClass("disabled")})))},$scope.phoneTypeSelected=function(id){$scope.phoneSelected.phone_number_type_id=id},$scope.selectCompany=function(id){$scope.phoneSelected.business_organization_id=id},$scope.showPersonal=function(id){"p"==id&&(setTimeout((function(){$("#Npersonalbtn").addClass("positive"),$("#Nbusinessbtn").removeClass("positive")}),50),$scope.showpersonal=!0,$scope.showbusiness=!1),"b"==id&&(setTimeout((function(){$("#Nbusinessbtn").addClass("positive"),$("#Npersonalbtn").removeClass("positive")}),50),$scope.showpersonal=!1,$scope.showbusiness=!0)}}]),app.controller("UserAccountCtrl",["$translate","$scope","UserService","Restangular","$location","$timeout","$rootScope",function($translate,$scope,UserService,Restangular,$location,$timeout,$rootScope){UserService.isLoggedIn()||$location.path("/"),$scope.formData={},$scope.formData.email=UserService.email,window.a=$scope,$scope.showPassword=!1,$scope.toggleContent=function(){$scope.showPassword^=!0},$scope.accountValidation=function(){var translation=$translate.instant(["tab_account_setting_old_pw_error","tab_account_setting_pw_error","tab_account_setting_pw_match_error"]);$(".account-form.ui.form").form({current_password:{identifier:"current_password",rules:[{type:"empty",prompt:translation.tab_account_setting_old_pw_error}]},new_password:{identifier:"new_password",rules:[{type:"empty",prompt:translation.tab_account_setting_pw_error}]},confirm_password:{identifier:"confirm_password",rules:[{type:"empty",prompt:translation.tab_account_setting_pw_error},{type:"match[new_password]",prompt:translation.tab_account_setting_pw_match_error}]}},{inline:!0,keyboardShortcuts:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form")},$scope.changePassword=function(){if($scope.valcheck=!0,$scope.accountValidation(),$rootScope.scrollToError(),$scope.valcheck){var data={password_old:$scope.formData.old_password,password:$scope.formData.new_password,password_confirm:$scope.formData.confirm_password};Restangular.one("account").customPUT(data).then((function(success){$rootScope.floatingMessage={header:"tab_account_setting_pw_reset_success"},$scope.hideFloatingMessage()}),(function(failed){!function(failed){var msg={header:""};if(failed.data){if(failed.data.errors)for(var prop in failed.data.errors){msg.header=failed.data.errors[prop][0].code;break}else failed.data.type?msg.header="invalid_request_error":msg.header=failed.data.code;$rootScope.floatingMessage=msg}}(failed)}))}},$scope.sentChangeEmail=function(){msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg,Restangular.one("account").one("email").customPOST().then((function(success){msg={header:"tab_profile_setting_email_change_instructions"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}))}}]);