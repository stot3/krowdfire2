app.controller("PortalSettingCtrl",["$location","$browser","$compile","$rootScope","$scope","$translate","RESOURCE_REGIONS","$translatePartialLoader","Restangular","CreateCampaignService","FONT_FAMILY","PortalSettingsService","RequestCacheService",function($location,$browser,$compile,$rootScope,$scope,$translate,RESOURCE_REGIONS,$translatePartialLoader,Restangular,CreateCampaignService,FONT_FAMILY,PortalSettingsService,RequestCacheService){$scope.formData={},$scope.font_list=FONT_FAMILY,$scope.clearMessage=function(){$rootScope.floatingMessage=[]},$scope.$emit("loading_finished"),$scope.RESOURCE_REGIONS=RESOURCE_REGIONS,$scope.stripe_fee={},$scope.page={showHtml:!1},$scope.home_url=$location.protocol()+"://"+$location.host()+$browser.baseHref(),$scope.successShown=!1,$scope.errorShown=!1,$scope.error=!1,$scope.showportals=!1,$scope.pageShown=!1,$scope.froalaOptionsContributionInfo={},function(foption){for(var prop in $rootScope.froalaOptions)$rootScope.froalaOptions.hasOwnProperty(prop)&&(foption[prop]=$rootScope.froalaOptions[prop])}($scope.froalaOptionsContributionInfo),$scope.home_page_text={main_banner:{header_one:"Acme Helps!",header_two:"Crowdfund, anywhere and anytime!",paragraph:"We are here to help you fundraise your own creative campaign!",display:"text",html:"",display_button:!0},middle_header:"Be passionate, explore and share your ideas!",bottom_banner:{header_top:"Why choose us?",paragraph:"We're helping out many unique campaigns around the world in order for them to accomplish their fundraising goals. Whether it's a small amount or huge amount of money, We are here to help you and don't worry about owing us right away! Take your time until your funding is done!",header_bottom:"Each and every project is unique with your own creations. Still eager to know more?",left_column:{icon_class:"circular thumbs up icon",display:1,header:"Easy to use",paragraph:"We have the easiest steps for you to start your campaign. You will be creating one in no time!"},middle_column:{icon_class:"circular certificate icon",display:1,header:"Trusted",paragraph:"We are a fully licensed company, with professionals helping us fund you what you need!"},right_column:{icon_class:"circular globe icon",display:1,header:"Global",paragraph:"You will gain so much exposure you won't even realize it! We also offer our services to almost all the countries in the world."},display:"text",html:""},titles:{top_title:"Featured Projects",bottom_title:"Recent Projects"}},$scope.footer_text={media_header:"Follow our Social Media to keep yourself updated!"},$scope.explore_page_text={banner_header:"Start exploring different possibilities and passion!",display:"text",html:""},$scope.home_page_html_content={main_banner:"",bottom_banner:""},$scope.explore_page_html_content={top_banner:""};var hashVal=$location.hash(),includeLoaded=!1;$scope.showDimmer=!1;var tabStatus={reports:!0,users:!1,categories:!1,campaigns:!1,"portal-settings":!1,pages:!1,"api-settings":!1};hashVal&&($(".portal-setting-tabs").find("[data-tab]").removeClass("active"),$(".portal-setting-tabs").find("[data-tab="+hashVal+"]").addClass("active")),"reports"==$location.hash()||""==$location.hash()?$scope.showreports=!0:"portal-settings"==$location.hash()?$scope.showportals=!0:"pages"==$location.hash()?$scope.showpages=!0:"campaigns"==$location.hash()?$scope.showcampaigns=!0:"categories"==$location.hash()?$scope.showcategories=!0:"site-menus"==$location.hash()?$scope.showSiteMenus=!0:"coupons"==$location.hash()?$scope.showcoupons=!0:"users"==$location.hash()?$scope.showusers=!0:"web-settings"==$location.hash()?$scope.showapi=!0:"subscription-settings"==$location.hash()&&($scope.showSubscriptionSettings=!0),""==$location.hash()?tabStatus.reports=!0:tabStatus[$location.hash()]=!0,RequestCacheService.getCategory().then((function(success){$scope.categories=success}));var lastTab="";$scope.clickHash=function(tabName){$scope.showDimmer=!1,$(".partialLoading .dimmer").dimmer("hide"),includeLoaded=!1,""!=lastTab&&(tabStatus[lastTab]=!0,$scope["show"+lastTab]=!0),"reports"==tabName?$scope.showreports=!0:"users"==tabName?$scope.showusers=!0:"categories"==tabName?$scope.showcategories=!0:"site-menus"==tabName?$scope.showSiteMenus=!0:"campaigns"==tabName?$scope.showcampaigns=!0:"coupons"==tabName?$scope.showcoupons=!0:"portal-settings"==tabName?$scope.showportals=!0:"pages"==tabName?$scope.showpages=!0:"web-settings"==tabName?$scope.showapi=!0:"subscription-settings"==tabName&&($scope.showSubscriptionSettings=!0),tabStatus[tabName]||($scope.showDimmer=!0,$(".partialLoading .dimmer").dimmer({closable:!1}).dimmer("show")),tabStatus[tabName]=!0,lastTab=tabName,$location.hash(tabName).replace()},$("#admin-setting-tabs .menu-tabs .item").tab({context:$("#admin-setting-tabs")}),$scope.showGoBack=!0,window.a=$scope,$scope.checkall=function($evt,wrapper_class){var $elem=$evt.currentTarget;angular.element($elem).children("input:checkbox").prop("checked")?$(wrapper_class).find(".ui.checkbox").checkbox("uncheck"):$(wrapper_class).find(".ui.checkbox").checkbox("check")},$scope.clearMessage=function(){$scope.selectErrorShown=[]},$scope.replaceStyleTag=function(content){return content},$scope.replaceInsideStyleTag=function(content){return content},RequestCacheService.getPage().then((function(success){for(var i=0;i<success.length;i++){var page=success[i];page.content&&(page.content=$scope.replaceStyleTag(page.content)),page.meta||(page.meta=[])}$scope.pages=success})),Restangular.one("account/stripe/currency").customGET().then((function(success){$scope.stripeSupportedCurrencies=success,$scope.defaultCurrency=$scope.stripeSupportedCurrencies[0],PortalSettingsService.getSettingsObj().then((function(success){var tmp=success.public_setting.site_campaign_fee_currency;tmp&&($scope.stripeSupportedCurrencies=tmp,$scope.defaultCurrency=tmp[0])}))})),$scope.$on("$includeContentLoaded",(function(){includeLoaded||(includeLoaded=!0)&&($(".partialLoading .dimmer").dimmer("hide"),$scope.showDimmer=!1)}))}]),app.controller("AdminReportsCtrl",["$scope","$timeout","$translatePartialLoader","$translate","Restangular",function($scope,$timeout,$translatePartialLoader,$translate,Restangular){$scope.report={},$scope.strToDate=function(str){return new Date(str).toString().substring(4,21)},$scope.formatMoney=function(num){var ret=0;num&&(ret=parseInt(num));return ret.toFixed(2).toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},$scope.calTotalEarn=function(){return $scope.formatMoney($scope.stripe_fee.campaign_fee*$scope.report.total_campaign_funding_raised_capture_complete/100)},$scope.refreshReport=function(){Restangular.one("portal/stats").customGET().then((function(success){$scope.report=success,$("#myloader").fadeOut(4e3,(function(){$("body").removeClass("loading")})),$scope.chart1=[{value:parseInt($scope.report.total_campaigns_sent_for_review),color:"#F7464A",highlight:"#FF5A5E",label:"Sent for Review"},{value:parseInt($scope.report.total_campaigns_being_reviewed),color:"#46BFBD",highlight:"#5AD3D1",label:"Being Reviewed"},{value:parseInt($scope.report.total_campaigns_cancelled),color:"#FDB45C",highlight:"#FFC870",label:"Cancelled"},{value:parseInt($scope.report.total_campaigns_being_edited),color:"#FFB6EC",highlight:"#FFCEF3",label:"Being Edited"},{value:parseInt($scope.report.total_campaigns_not_funded),color:"#F7464A",highlight:"#FF5A5E",label:"Not Funded"},{value:parseInt($scope.report.total_campaigns_processing_processing_capture),color:"#9FFFFF",highlight:"#D9FFFF",label:"Processing Capture"},{value:parseInt($scope.report.total_campaigns_processing_accepted_capture),color:"#3399FF",highlight:"#99CCFF",label:"Capture Accepted"},{value:parseInt($scope.report.total_campaigns_processing_pre_auth),color:"#CCFF66",highlight:"#E0FFA3",label:"Pre Authorizing"},{label:"Paused",color:"#FF5050",highlight:"#FFA8A8",value:parseInt($scope.report.total_campaigns_paused)},{label:"Capture Declined",color:"#6666FF",highlight:"#B2B2FF",value:parseInt($scope.report.total_campaigns_processing_declined_capture)},{label:"Running",color:"#00CC66",highlight:"#80E6B2",value:parseInt($scope.report.total_campaigns_running)},{label:"Capture Completed",color:"#3333CC",highlight:"#8585E0",value:parseInt($scope.report.total_campaigns_processing_capture_complete)},{label:"Not Approved",color:"#FF3399",highlight:"#FF99CC",value:parseInt($scope.report.total_campaigns_not_approved)}];var ctx=$("#chart1").get(0).getContext("2d");$scope.myDoughnutChart=new Chart(ctx),$scope.myDoughnutChart.Doughnut($scope.chart1,{}).update(),$scope.chart2={labels:["Funding Sought Total","Funding Sought Running","Funding Sought Captured","Funding Raised Running","Sought Capture Completed","Raised Capture Completed"],datasets:[{label:"My First dataset",fillColor:"rgba(151,187,205,0.5)",strokeColor:"rgba(151,187,205,0.8)",highlightFill:"rgba(151,187,205,0.75)",highlightStroke:"rgba(151,187,205,1)",data:[$scope.report.total_campaign_funding_sought,$scope.report.total_campaign_funding_sought_running,$scope.report.total_campaign_funding_sought_capture_complete,$scope.report.total_campaign_funding_raised_running,$scope.report.total_campaign_funding_sought_capture_complete,$scope.report.total_campaign_funding_raised_capture_complete]}]};var ctx2=$("#chart2").get(0).getContext("2d");$scope.barChart=new Chart(ctx2),$scope.barChart.Bar($scope.chart2,{})}))},function init(){if($("#chart1").get(0))return $scope.refreshReport(),void $("#myloader").fadeOut(1e3,(function(){$("body").removeClass("loading")}));$timeout((function(){init()}),100)}()}]),app.controller("AdminEmailNotificationsCtrl",["$scope","$timeout","$translatePartialLoader","$translate","Restangular","$rootScope","PortalSettingsService",function($scope,$timeout,$translatePartialLoader,$translate,Restangular,$rootScope,PortalSettingsService){var fEditor,publicSettings={},privateSettings={};$scope.settingLoaded=!1,Restangular.one("portal").one("setting").one("site_email_notification").customGET().then((function(success){$scope.emails=success,$timeout((function(){$("#emailaccord").accordion({selector:{trigger:".title .notification-title-left"}})}));for(var i=0;i<$scope.emails.length;i++)if("site_email_notification_enable"==$scope.emails[i].name){$scope.emails.splice(i,1);break}for(var k=0;k<$scope.emails.length;k++)$scope.emails[k].value.html=$scope.replaceStyleTag($scope.emails[k].value.html),$scope.emails[k].showHtml=!1;for($scope.emails.sort((function(a,b){return a.name.localeCompare(b.name)})),$scope.email_copy=angular.copy($scope.emails),i=0;i<$scope.emails.length;i++)if($scope.emails[i].value.available_tokens)for(var j=0;j<$scope.emails[i].value.available_tokens.length;j++)$scope.emails[i].value.available_tokens[j].token="<tmplvar>"+$scope.emails[i].value.available_tokens[j].name+"</tmplvar>"}),(function(failure){msg={header:failure.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()})),$scope.email_preview=!1,$scope.toggle_email=function(){$scope.email_preview=!$scope.email_preview},Restangular.one("portal/setting").getList().then((function(success){angular.forEach(success,(function(value){3==value.setting_type_id?publicSettings[value.name]=value.value:1==value.setting_type_id&&(privateSettings[value.name]=value.value)})),$scope.settingLoaded=!0})),$scope.checkAccordion=function(accordionIndex,$event){$scope.accordionNum=accordionIndex;var currentAccordion=$event.currentTarget;$timeout((function(){$(currentAccordion).next().find(".fr-view").focus()}),500)},$rootScope.froalaOptions.events["froalaEditor.focus"]=function(e,editor){(fEditor=editor).events.bindClick($("body"),"div.button.tokens",(function(event){var element=fEditor.selection.element();"TMPLVAR"==$(element).prop("tagName")&&($(element).after($.FroalafEditor.MARKERS),fEditor.selection.restore());var frBox=$(event.currentTarget).parent().prev().find(".fr-box");if($(frBox).hasClass("fr-code-view")){var $codemirror=$(frBox).find(".CodeMirror")[0];!function(text,$codemirror){$codemirror.CodeMirror.replaceSelection(text)}($scope.select_token,$codemirror)}else fEditor.undo.saveStep(),fEditor.html.insert($scope.select_token),fEditor.undo.saveStep()}))},$timeout((function(){$('button[name="html"]').click((function(event){var email_target=$(event.target).closest(".email-accordion"),email=email_target.scope().email;email.showHtml=!email.showHtml,$scope.toggle_email(),email_target.find(".token-dropdown .token-selected").removeClass("default"),$scope.selectToken(email.value.available_tokens[0],event)}))}),6e3),$scope.confirmUpdateEmail=function(email){msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg,$rootScope.froalaOptions.froalaEditor("events.trigger","form.submit",[],!0);var htmlBlock,$form={};email.value.html=email.value.html.replace(/&lt;/g,"<"),email.value.html=email.value.html.replace(/&gt;/g,">"),email.value.html=email.value.html.replace(/&#10;/g,""),email.value.html=email.value.html.replace(/&#9;/g," "),email.value.html=email.value.html.replace(/&#8;/g," "),email.value.html=$scope.replaceInsideStyleTag(email.value.html),$form[email.name]={subject:email.value.subject,available_tokens:email.value.available_tokens,html:email.value.html},$scope.isCodeValid=!((htmlBlock=$form[email.name].html)&&htmlBlock.match(/document.write/g)&&(msg={header:"document_write_prompt_msg"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),1)),$scope.isCodeValid&&Restangular.one("portal","setting").customPUT($form).then((function(success){msg={header:"site_email_notification_saved_successfully"},email.value.html=$scope.replaceStyleTag(email.value.html),$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}),(function(failure){msg={header:"site_email_notification_error"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),email.value.html=$scope.replaceStyleTag(email.value.html)}))},$scope.resetEmailContent=function(email){for(var i=0;i<$scope.email_copy.length;i++)$scope.email_copy[i].id==email.id&&(email.value.html=$scope.email_copy[i].value.html)},$scope.selectToken=function(token,$event){var email_target=$($event.target).closest(".email-accordion");$scope.select_token=token.token;var description=token.description,ret=description;description.length>28&&(ret=ret.slice(0,25)+"..."),email_target.find(".token-selected").html(ret);var $insertBtn=$($event.currentTarget).parent().parent().next();$($insertBtn).removeClass("disabled")},$scope.getNotificationEnabledString=function(email){return privateSettings.site_email_notification_enable&&privateSettings.site_email_notification_enable.hasOwnProperty(email.name)?1==privateSettings.site_email_notification_enable[email.name]?"site_email_notification_disable":"site_email_notification_enable":"site_email_notification_disable"},$scope.checkNotificationEnabled=function(email,index){privateSettings.site_email_notification_enable&&privateSettings.site_email_notification_enable.hasOwnProperty(email.name)?1==privateSettings.site_email_notification_enable[email.name]?$timeout((function(){$($(".enable-notification").get(index)).checkbox("check")})):$timeout((function(){$($(".enable-notification").get(index)).checkbox("uncheck")})):$($(".enable-notification").get(index)).checkbox("check")},$scope.setNotificationEnabled=function(event,email){var $elem=$(event.currentTarget),emailName=email.name,emailEnabled=!$elem.hasClass("checked"),param={site_email_notification_enable:privateSettings.site_email_notification_enable};param.site_email_notification_enable[emailName]=emailEnabled,Restangular.one("portal","setting").customPUT(param)}}]);