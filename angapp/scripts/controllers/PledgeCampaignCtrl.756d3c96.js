app.controller("PledgeCampaignCtrl",["$q","$location","$rootScope","$scope","$filter","UserService","StripeService","PaypalService","PledgeService","$translate","$routeParams","Restangular","Geolocator","RESOURCE_REGIONS","PortalSettingsService","$sce","$timeout","PHONE_TYPE","SOCIAL_SHARING_OPTIONS",function($q,$location,$rootScope,$scope,$filter,UserService,StripeService,PaypalService,PledgeService,$translate,$routeParams,Restangular,Geolocator,RESOURCE_REGIONS,PortalSettingsService,$sce,$timeout,PHONE_TYPE,SOCIAL_SHARING_OPTIONS){var msg;!function(paramID){Restangular.one("account/").customGET("phone-number",paramID).then((function(success){success.personal?($scope.hasNumber=!0,$scope.toggle.newNumber=!0,$scope.personalNumbers=success.personal,$scope.businessNumbers=success.business):($scope.hasNumber=!1,$scope.toggle.newNumber=!1)}))}(paramID),$scope.pledgeReplace=!1,$scope.rewardsQueue=[];var businessData={business_id:null,phone_id:null,address_id:null};$scope.organization_name={},$scope.selectedContributionAnon={},$scope.totalAmountPlusTip=0,$scope.user=UserService,$scope.RESOURCE_REGIONS=RESOURCE_REGIONS,$scope.campaign_loc=$rootScope.currentLoc,$scope.pledgeLevel=$routeParams.plid,$scope.allow_max=!1,$scope.pledgeAmount=parseInt($routeParams.m),$scope.directContribution=!!$scope.pledgeAmount,$scope.campaign_id=$routeParams.eid,$routeParams.attr&&($scope.selectedRewardAttrs=$routeParams.attr),$scope.selectedCity={},$scope.selectedSubcountry={},$scope.selectedCountry={},$scope.charity={},$rootScope.charity&&($scope.charity=$rootScope.charity,$rootScope.charity={}),console.log($scope.user),$scope.chosenPhoneNumberId="",$scope.failed_submit=!1,$scope.phoneInfo={number:"",phone_number_type_id:"",business_organization_id:"",person_id:""},$scope.newNumberCreated={number:"",phonetype:""},$scope.selectedReward=null,$scope.contributionMessage="",$rootScope.contributionMessage&&($scope.contributionMessage=$rootScope.contributionMessage,$rootScope.contributionMessage={}),$scope.stripeExtraDetails={address_city:"",address_country:"",address_line1:"",name:""},$scope.toggle={newCard:!1,newAddress:!1,newNumber:!1,selectedCard:!1,selectedAddress:!1,selectedNumber:!1,newCompany:!1},$scope.contribution=[{name:"contribution_type_regular",type:1},{name:"contribution_type_partiallyanon",type:3},{name:"contribution_type_fullyanon",type:2}],$scope.cardselected="Visa",$scope.cardtype=[{name:"Visa",id:1},{name:"American Express",id:2},{name:"Master Card",id:3},{name:"Discover",id:4}],$scope.selectedAccountType="Individual",$scope.businessSelected={name:"",email:""};var portal_settings,phonetype=PHONE_TYPE,trans_array=[];function getSettings(){$("i").popup(),Restangular.one("portal/setting").getList().then((function(success){$scope.public_settings={},$scope.private_settings={},angular.forEach(success,(function(value){if(3==value.setting_type_id)switch($scope.public_settings[value.name]=value.value,$scope.payment_gateway=$scope.public_settings.site_payment_gateway,$scope.public_settings.site_theme_campaign_min_contribute_amount&&($scope.public_settings.site_theme_campaign_min_contribute_amount=parseInt($scope.public_settings.site_theme_campaign_min_contribute_amount),$scope.pledgeAmount=parseInt($scope.pledgeAmount)),$scope.public_settings.site_campaign_sharing_options){case SOCIAL_SHARING_OPTIONS.sharing_users:$scope.is_sharing_available=!0;break;case SOCIAL_SHARING_OPTIONS.sharing_backers:$scope.is_sharing_available=!1,$scope.campaign.managers[0].id!=$scope.user.id&&1!=$scope.user.person_type_id||($scope.is_sharing_available=!0);break;case SOCIAL_SHARING_OPTIONS.sharing_disabled:$scope.is_sharing_available=!1;break;default:$scope.is_sharing_available=!0}})),void 0===$scope.site_stripe_tokenization_settings||null==$scope.site_stripe_tokenization_settings?$scope.site_stripe_tokenization_settings={public_stripe_key:"",toggle:!1}:Restangular.one("account").one("address").get().then((function(address){var city,country,street;angular.forEach(address.personal,(function(value,key,obj){if(value.primary_address)return city=value.city,country=value.country,void(street=value.street1);city=value.city,country=value.country,street=value.street1})),$scope.stripeExtraDetails.address_city=city,$scope.stripeExtraDetails.address_country=country,$scope.stripeExtraDetails.address_line1=street,$scope.stripeExtraDetails.name=$scope.user.first_name+" "+$scope.user.last_name})),$scope.max_amoumt=parseInt($scope.public_settings.site_theme_campaign_max_contribute_amount),$scope.public_settings.site_theme_campaign_max_pledge_enabled&&void 0===$scope.pledgeLevel&&($scope.allow_max=!0),void 0!==$scope.public_settings.site_theme_campaign_per_min&&$scope.public_settings.site_theme_campaign_per_min&&void 0!==$scope.campaign.min_contribution&&($scope.public_settings.site_theme_campaign_min_contribute_amount=parseFloat($scope.campaign.min_contribution),$scope.pledgeAmount=parseFloat($scope.pledgeAmount),$scope.pledgeAmount<$scope.public_settings.site_theme_campaign_min_contribute_amount&&($scope.pledgeAmount=$scope.public_settings.site_theme_campaign_min_contribute_amount,$scope.campaignFundingGoal={value:$scope.pledgeAmount})),void 0!==$scope.public_settings.site_theme_campaign_per_max&&$scope.public_settings.site_theme_campaign_per_max&&void 0!==$scope.campaign.max_contribution&&($scope.max_amoumt=parseFloat($scope.campaign.max_contribution),$scope.allow_max=!0),void 0===$scope.public_settings.site_tos_contribution_ui?$scope.contrib=!0:$scope.contrib=$scope.public_settings.site_tos_contribution_ui,$scope.public_settings.site_campaign_charity_helper_alternate_form&&getCountries(),$scope.$emit("settings_loaded")}),(function(failure){msg={header:failure.data.message},$rootScope.floatingMessage=msg}))}angular.forEach(PHONE_TYPE,(function(value){trans_array.push(value.name)})),$translate(trans_array).then((function(translation){angular.forEach(translation,(function(value,key){for(var i=0;i<phonetype.length;i++)phonetype[i].name==key&&(phonetype[i].name=value)})),$scope.phonetype=phonetype})),$scope.campaignFundingGoal={value:$scope.pledgeAmount},$scope.lowestAmount,$scope.tipInfo,$scope.requiresShipping=!1,$scope.pledgeReplaceShippingFound=!1,$scope.pledgeReplacement=function(){var reward_id;null!=$routeParams.r&&($scope.campaign_id=$routeParams.eid,$scope.rewards=[],$scope.pledgeReplace=!0,$scope.replaceId=$routeParams.r,$scope.pledgeAmount=parseInt($routeParams.m),$scope.totalReplacedCost=0,$scope.totalReplacedCost=$scope.pledgeAmount?$scope.pledgeAmount:0,angular.forEach($routeParams,(function(value,key,obj){-1!=key.indexOf("plid")&&(reward_id=value,$scope.rewards.push({plid:reward_id}));if($scope.rewards.length&&-1!=key.indexOf(reward_id+"_quantity"))for(var i=0;i<$scope.rewards.length;i++)$scope.rewards[i].plid==reward_id&&($scope.rewards[i].quantity=value);if($scope.rewards.length&&-1!=key.indexOf(reward_id+"_amount"))for(i=0;i<$scope.rewards.length;i++)$scope.rewards[i].plid==reward_id&&($scope.rewards[i].amount=value);if($scope.rewards.length&&-1!=key.indexOf(reward_id+"_attr"))for(i=0;i<$scope.rewards.length;i++)$scope.rewards[i].plid==reward_id&&($scope.rewards[i].attr||($scope.rewards[i].attr=[]),$scope.rewards[i].attr.push(value))})),angular.forEach($scope.rewards,(function(value){Restangular.one("campaign",$scope.campaign_id).one("pledge-level",value.plid).get().then((function(success){var selectedReward=success;selectedReward.quantity=value.quantity,selectedReward.attr=value.attr,selectedReward.shipping&&($scope.requiresShipping=!0),$scope.totalReplacedCost+=parseFloat(selectedReward.amount)*parseInt(selectedReward.quantity),$scope.rewardsQueue.push(selectedReward)}))})))},$scope.pledgeReplacement(),$scope.tip={value:null,dollar_amount:0,type:"Dollar",name:""},$scope.tipTypeError=!1,PortalSettingsService.getSettingsObj().then((function(success){portal_settings=success.public_setting,$scope.allowDecimalNotation=portal_settings.site_campaign_decimal_option,$scope.reward_html_editor=success.public_setting.site_theme_campaign_reward_html_editor,$scope.contributionTypeRadio=portal_settings.site_theme_campaign_contribution_type_radio,$scope.enableRewardVariation=portal_settings.site_theme_campaign_show_reward_enable_variation,$scope.charity_percentage_fee=portal_settings.site_campaign_charity_helper_percentage,$scope.anonymousContributionTypeOnly=portal_settings.site_campaign_anonymous_contribution_type_only,$scope.isEnableContributionMessage=portal_settings.site_campaign_allow_contribution_message,$scope.isContributionLayout1=portal_settings.site_campaign_contribution_layout_toggle_1,$scope.site_stripe_tokenization_settings=portal_settings.site_stripe_tokenization,$scope.site_campaign_alt_city_input_toggle=portal_settings.site_campaign_alt_city_input_toggle,$scope.selectedTipCurrency=portal_settings.site_tip_currency,$scope.acceptExtraPledgeData=portal_settings.site_campaign_profile_data_on_pledge,$scope.tippingOptions=portal_settings.site_tipping,$scope.displayCampaignDisclaimer=success.public_setting.site_campaign_campaign_toggle_disclaimer_text,$scope.forceAnonymousPledge=portal_settings.site_campaign_always_anonymous_contribution,$scope.combineTip=portal_settings.site_campaign_combine_amount_tip,$scope.site_campaign_fee_direct_transaction=portal_settings.site_campaign_fee_direct_transaction,$scope.stripe_standard_mode=portal_settings.stripe_standard_mode,void 0!==$scope.tippingOptions&&null!=$scope.tippingOptions||($scope.tippingOptions={toggle:!1}),$scope.tippingOptions.hasOwnProperty("toggle")&&$scope.tippingOptions.toggle&&Restangular.one("account/stripe/charge-amount").customGET().then((function(success){if(success[0]?($scope.lowestAmount=parseFloat(success[0].minimum_charge_amount),$scope.selectedTipCurrency?$scope.tipInfo=$scope.selectedTipCurrency:$scope.tipInfo=success[0]):($scope.lowestAmount=.5,$scope.campaign&&($scope.selectedTipCurrency?$scope.tipInfo=$scope.selectedTipCurrency:$scope.tipInfo=$scope.campaign.currencies[0])),$scope.tippingOptions.selectedTipDefault||($scope.tippingOptions.selectedTipDefault="tiers"),$scope.tippingOptions.toggle_dynamic&&!$scope.tippingOptions.toggle_tiers||"dynamic"==$scope.tippingOptions.selectedTipDefault)$scope.tip={value:null,dollar_amount:0,type:"Dollar",name:""},$scope.tippingOptions.toggle_dynamic_min_max&&$scope.tippingOptions.dynamic_min&&($scope.tip.value=$scope.tippingOptions.dynamic_min,$scope.tip.dollar_amount=$scope.tippingOptions.dynamic_min),$scope.selectedTipType="dynamic",$scope.tip={value:null,dollar_amount:0,type:"Dollar"},$scope.tippingOptions.toggle_dynamic_min_max&&$scope.tippingOptions.dynamic_min&&($scope.tip.value=$scope.tippingOptions.dynamic_min,$scope.tip.dollar_amount=$scope.tippingOptions.dynamic_min);else if($scope.tippingOptions.toggle_tiers||"tiers"==$scope.tippingOptions.selectedTipDefault){if($scope.tip={value:null,dollar_amount:0,type:"Dollar",name:""},$scope.tippingOptions.tiers[0]){$scope.updateTierValues();var dollarAmount=$scope.tippingOptions.tiers[0].dollar_amount;$scope.tip={value:$scope.tippingOptions.tiers[0].value,dollar_amount:dollarAmount,type:$scope.tippingOptions.tiers[0].type,name:$scope.tippingOptions.tiers[0].name}}$scope.selectedTipType="tiers"}else $scope.tippingOptions.toggle_dynamic||$scope.tippingOptions.toggle_tiers||!$scope.tippingOptions.toggle_no_tip||($scope.selectedTipType="no_tip",$scope.tip={value:null,dollar_amount:0,type:"Dollar"});$scope.tippingOptions.toggle_no_tip&&"no_tip"==$scope.tippingOptions.selectedTipDefault&&($scope.selectedTipType="no_tip",$scope.tip={value:null,dollar_amount:0,type:"Dollar"}),$routeParams.tiptype&&($scope.selectedTipType=$routeParams.tiptype,"no_tip"==$scope.selectedTipType?$scope.tip={value:null,dollar_amount:0,type:"Dollar"}:"tiers"==$scope.selectedTipType?($scope.tiersIndex=0,$routeParams.tipindex&&($scope.tiersIndex=$routeParams.tipindex),$scope.tippingOptions.tiers[$scope.tiersIndex]&&($scope.updateTierValues(),dollarAmount=$scope.tippingOptions.tiers[$scope.tiersIndex].dollar_amount,$scope.tip={value:$scope.tippingOptions.tiers[$scope.tiersIndex].value,dollar_amount:dollarAmount,type:$scope.tippingOptions.tiers[$scope.tiersIndex].type,name:$scope.tippingOptions.tiers[$scope.tiersIndex].name})):"dynamic"==$scope.selectedTipType&&($scope.initialDynamicTip=0,$scope.tippingOptions.toggle_dynamic_min_max&&$scope.tippingOptions.dynamic_min&&($scope.initialDynamicTip=$scope.tippingOptions.dynamic_min),$scope.tip={value:$scope.initialDynamicTip,dollar_amount:$scope.initialDynamicTip,type:"Dollar",name:""},$routeParams.tipvalue&&($scope.tip={value:$routeParams.tipvalue,dollar_amount:$routeParams.tipvalue,type:"Dollar",name:""},$scope.tipValueInt=parseInt($routeParams.tipvalue),$scope.tippingOptions.toggle_dynamic_min_max&&($scope.tippingOptions.dynamic_min&&$scope.tipValueInt<$scope.tippingOptions.dynamic_min?($scope.tip.value=$scope.tippingOptions.dynamic_min,$scope.tip.dollar_amount=$scope.tippingOptions.dynamic_min):$scope.tippingOptions.dynamic_max&&$scope.tipValueInt>$scope.tippingOptions.dynamic_max&&($scope.tip.value=$scope.tippingOptions.dynamic_max,$scope.tip.dollar_amount=$scope.tippingOptions.dynamic_max))))),void 0!==$scope.tippingOptions&&$scope.tippingOptions.hasOwnProperty("tiers")&&$scope.tippingOptions.tiers.length&&($scope.tipTiersDefaultName=$scope.tippingOptions.tiers[0].name,$scope.tipTiersDefaultAmount=$scope.tippingOptions.tiers[0].dollar_amount,$routeParams.tipindex&&($scope.tipTiersDefaultName=$scope.tippingOptions.tiers[$routeParams.tipindex].name,$scope.tipTiersDefaultAmount=$scope.tippingOptions.tiers[$routeParams.tipindex].dollar_amount))})),$scope.anonymousContributionTypeOnly?$scope.selecteContribution=!1:$scope.selecteContribution="contribution_type_regular",function(){$scope.alt_shipping=portal_settings.site_theme_alt_shipping_layout,$scope.native_lookup=portal_settings.site_theme_shipping_native_lookup,$scope.native_lookup&&(portal_settings.site_theme_default_shipping_country.name=portal_settings.site_theme_default_shipping_country.native_name);$scope.default_country=portal_settings.site_theme_default_shipping_country,null!=portal_settings.site_theme_default_shipping_country&&portal_settings.site_theme_default_shipping_country.name&&($scope.selectedCountry.selected=portal_settings.site_theme_default_shipping_country);$scope.setCountry($scope.selectedCountry.selected),null!=$scope.selectedCountry.selected&&Object.getOwnPropertyNames($scope.selectedCountry.selected).length&&getSubcountries($scope.selectedCountry.selected.id);$scope.alt_shipping&&($scope.selectedReward&&$scope.selectedReward.shipping?getCountries().then((function(countries){var newCountries=[],worldShippingExist=!1,countryShippingList=[];angular.forEach($scope.selectedReward.shipping,(function(value,key){1!=value.shipping_option_type_id&&3!=value.shipping_option_type_id||(worldShippingExist=!0),2==value.shipping_option_type_id&&countryShippingList.push(value)})),worldShippingExist||(angular.forEach(countryShippingList,(function(item,key){angular.forEach(countries,(function(country,key){item.country_id==country.id&&newCountries.push(country)}))})),$scope.countries=newCountries)})):getCountries())}(),portal_settings.site_campaign_always_anonymous_contribution&&($scope.contribution=$scope.contribution.slice($scope.contribution.length-1),$scope.anonymous_contribution=1,$scope.partial_anonymous_contribution=0),void 0!==$scope.acceptExtraPledgeData&&$scope.acceptExtraPledgeData||($scope.acceptExtraPledgeData=!1),void 0!==success.public_setting.site_campaign_pledge_redirect&&success.public_setting.site_campaign_pledge_redirect?$scope.site_campaign_pledge_redirect=success.public_setting.site_campaign_pledge_redirect:$scope.site_campaign_pledge_redirect={toggle:!1,url:""}})),$scope.checkCardType=function(){var cardNumber=$scope.creditCard.number,cardType=($.payment.validateCardNumber(cardNumber),$.payment.cardType(cardNumber)),$card=$("input.creditCardNumber");switch(cardType){case"visa":$card.css("background","#fff url(images/cards/Visa.png) no-repeat right 10px center");break;case"mastercard":$card.css("background","#fff url(images/cards/MasterCard.png) no-repeat right 10px center");break;case"amex":$card.css("background","#fff url(images/cards/American%20Express.png) no-repeat right 10px center");break;case"dinersclub":$card.css("background","#fff url(images/cards/diners.png) no-repeat right 10px center");break;case"discover":$card.css("background","#fff url(images/cards/Discover.png) no-repeat right 10px center");break;case"jcb":$card.css("background","#fff url(images/cards/jcb.png) no-repeat right 10px center");break;default:$card.css("background-image","none")}},$scope.initStripePayment=function(){$("input.creditCardNumber").payment("formatCardNumber"),$("input.cardCVC").payment("formatCardCVC")};var count=0;function clearAddress(){$scope.selectedCity.selected=void 0,$scope.selectedSubcountry.selected=void 0,null!=portal_settings.site_theme_default_shipping_country&&portal_settings.site_theme_default_shipping_country.name&&($scope.selectedCountry.selected=portal_settings.site_theme_default_shipping_country),$scope.shipOptions=[],$scope.address.mail_code="",$scope.address.street1="",$scope.address.street2=""}function checkNative(addressData){return angular.forEach(addressData,(function(value,key){if($scope.native_lookup){var name="";null!=value.country_native_name?(name+=value.country_native_name,value.country=value.country_native_name):name+=value.country,null!=value.subcountry_native_name?(name+=" "+value.subcountry_native_name,value.subcountry=value.subcountry_native_name):name+=" "+value.subcountry,null!=value.city_native_name&&"Other"!=value.city?(name+=", "+value.city_native_name,value.city=value.city_native_name):"Other"!=value.city?name+=", "+value.city:value.city="",value.city_full=name}})),addressData}function attributesValidation(){var translation=$translate.instant(["pledge_campaign_attribute_required_error"]);$("#reward-variation").find('input[name="variation_value"]').each((function(){$(this).val()?($scope.valcheck=$scope.valcheck&&!0,$(this).parent().parent(".field").removeClass("error"),$(this).parent().parent(".field").find(".error-text").remove()):($scope.valcheck=$scope.valcheck&&!1,$(this).parent().parent(".field").addClass("error"),$(this).parent().parent(".field").append('<div class="error-text ui red pointing prompt label">'+translation.pledge_campaign_attribute_required_error+"</div>"))})),$("#reward-variation").find('input[name="variation_value"]').change((function(){$scope.valcheck=$scope.valcheck&&!0,$(this).parent().parent(".field").removeClass("error"),$(this).parent().parent(".field").find(".error-text").remove()}))}function phoneNumberValidation(){var translation=$translate.instant(["pledge_campaign_phone_required_error"]);$("#phone-number-form").form({phone_value:{identifier:"phone_value",rules:[{type:"empty",prompt:translation.pledge_campaign_phone_required_error}]}},{inline:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form")}function newPhoneNumberValidation(){var translation=$translate.instant(["pledge_campaign_new_phone_value_required_error","pledge_campaign_new_phone_type_required_error"]);$("#new-phone-number-form").form({new_phone_number:{identifier:"new_phone_number",rules:[{type:"empty",prompt:translation.pledge_campaign_new_phone_value_required_error}]},new_phone_type:{identifier:"new_phone_type",rules:[{type:"empty",prompt:translation.pledge_campaign_new_phone_type_required_error}]}},{inline:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form")}function errorHandling(failed){var msg={header:""};if(failed.data){if(failed.data.errors)for(var prop in failed.data.errors){msg.header=failed.data.errors[prop][0].code;break}else failed.data.type?msg.header=failed.data.message:msg.header=failed.data.code;/No such token/.test(msg.header)&&(msg.extra_message=$translate.instant("pledge_campaign_no_such_token")),"entity_not_found"==failed.data.code&&(msg.header=$translate.instant("pledge_campaign_entity_not_found_error")),"account_profile_stripe_pledge_direct_off_missing_connected"==failed.data.code&&(msg.header=$translate.instant("pledge_campaign_missing_connect")),$rootScope.floatingMessage=msg}}function generateTokenOrPledge(promises,pledgeAttributes,businessData){$scope.site_stripe_tokenization_settings.toggle&&!$scope.toggle.selectedCard?$scope.stripe.createToken($scope.cardNumberElement,$scope.stripeExtraDetails).then((function(result){result.error?($timeout((function(){$rootScope.removeFloatingMessage();angular.element(document.querySelector("#card-errors")).html(result.error.message);msg={header:"pledge_campaign_stripe_elements_error"},$rootScope.floatingMessage=msg,$("#finalpledge").removeClass("disabled")}),500),$scope.valcheck=!1):(0==$scope.pledgerAccountConnected?($scope.creditCard.card_token=result.token.id,promises.push(StripeService.newPledgerAccount($scope.creditCard))):$scope.toggle.newCard||$scope.selectedCardID||($scope.creditCard.card_token=result.token.id,promises.push(StripeService.createCard($scope.pledgerAccountID,$scope.creditCard))),$scope.resolvePromiseChain(promises,pledgeAttributes,businessData))})):(0==$scope.pledgerAccountConnected?promises.push(StripeService.newPledgerAccount($scope.creditCard)):$scope.toggle.newCard||$scope.selectedCardID||promises.push(StripeService.createCard($scope.pledgerAccountID,$scope.creditCard)),$scope.resolvePromiseChain(promises,pledgeAttributes,businessData))}function addAddressPhoneNumber(business_organization_id,businessPromises,addressInfo,phoneInfo,bypass_extra){business_organization_id&&(addressInfo.business_organization_id=business_organization_id,phoneInfo.business_organization_id=business_organization_id),!$scope.toggle.newAddress&&bypass_extra&&businessPromises.push(Restangular.one("account/address").customPOST(addressInfo)),$scope.toggle.newAddress||bypass_extra||!$scope.selectedAddress&&$scope.selectedReward&&$scope.selectedReward.shipping&&businessPromises.push(Restangular.one("account/address").customPOST(addressInfo)),$scope.newNumberCreated.number.length>0&&$scope.newNumberCreated.phonetype&&(phoneInfo.number=$scope.newNumberCreated.number,phoneInfo.phone_number_type_id=$scope.newNumberCreated.phonetype.id,phoneInfo.person_id=UserService.id,businessPromises.push(Restangular.one("account/phone-number").customPOST(phoneInfo)))}function attachBusinessToAddressPhone(business_id,businessPromises,address,phoneInfo,businessData,promises,pledgeAttributes){if(pledgeAttributes||(pledgeAttributes={}),addAddressPhoneNumber(business_id,businessPromises,address,phoneInfo,!0),businessPromises&&businessPromises.length)return $q.all(businessPromises).then((function(resolved){return angular.forEach(resolved,(function(value){value.address_id&&(businessData.address_id=value.address_id,$scope.selectedAddressID=value.address_id),value.phone_number_id&&(businessData.phone_id=value.phone_number_id,$scope.chosenPhoneNumberId=value.phone_number_id)})),generateTokenOrPledge(promises,pledgeAttributes,businessData)}));generateTokenOrPledge(promises,pledgeAttributes,businessData)}function sendGATransaction(success,gaId){var ea_id=success.id,ea_affiliation=$scope.campaign.name,ea_revenue=success.amount,script=($scope.rname,"<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','"+gaId+"', 'auto', {'name': 'ecommerceTracking'});ga('ecommerceTracking.require', 'ecommerce');ga('ecommerceTracking.ecommerce:addTransaction',{    'id': '"+ea_id+"',    'affiliation': '"+ea_affiliation+"',    'revenue': '"+ea_revenue+"',  });ga('ecommerceTracking.ecommerce:addItem',{    'id': '"+ea_id+"',    'price': '"+ea_revenue+"',    'name': '"+($scope.rname?$scope.rname:"contribution")+"',  });ga('ecommerceTracking.ecommerce:send');ga('send', 'pageview');<\/script>");$scope.gaScript=$sce.trustAsHtml(script)}function sendFBTransaction(success,fbId){success.id,$scope.campaign.name,success.amount,$scope.rname,$scope.rname&&$scope.rname;var script="<script>console.log('Facebook Pixel ready with ID"+fbId+"');!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window, document,'script','https://connect.facebook.net/en_US/fbevents.js');fbq('init', '"+fbId+"');fbq('track', 'PageView');<\/script><noscript><img height='1' width='1' style='display:none'src='https://www.facebook.com/tr?id="+fbId+"&ev=PageView&noscript=1'/></noscript>\x3c!-- End Facebook Pixel Code --\x3e";$scope.fbScript=$sce.trustAsHtml(script)}function sendRCTransaction(success,appId){var rcData={appId:appId,unixTimestamp:Math.floor(Date.now()/1e3),invoiceNumber:success.entry_backer_id,firstName:$scope.user.first_name,lastName:$scope.user.last_name,email:$scope.user.email,amount:$scope.pledgeAmount,currencyCode:$scope.campaign.currencies[0].code_iso4217_alpha};Restangular.one("portal").customGET("integration/referral-candy",{email:rcData.email,first_name:rcData.firstName,invoice_amount:rcData.amount,timestamp:rcData.unixTimestamp}).then((function(success){rcData.hash=success.signature,console.log(success),console.log(rcData);var popsicle='<div id="refcandy-popsicle" data-app-id="'+appId+'" data-fname="'+rcData.firstName+'" data-lname="'+rcData.lastName+'" data-email="'+rcData.email+'" data-amount="'+rcData.amount+'" data-currency="'+rcData.currencyCode+'" data-timestamp="'+rcData.unixTimestamp+'" data-external-reference-id="'+rcData.invoiceNumber+'" data-signature="'+rcData.hash+'"></div><script>(function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v;z="script";l="refcandy-purchase-js";c="refcandy-popsicle";p="go.referralcandy.com/purchase/";t="data-app-id";r={email:"a",fname:"b",lname:"c",amount:"d",currency:"e","accepts-marketing":"f",timestamp:"g","referral-code":"h",locale:"i","external-reference-id":"k",signature:"ab"};i=e.getElementsByTagName(z)[0];s=function(e,t){if(t){return""+e+"="+encodeURIComponent(t)}else{return""}};d=function(e){return""+p+h.getAttribute(t)+".js?lightbox=1&aa=75&"};if(!e.getElementById(l)){h=e.getElementById(c);if(h){o=e.createElement(z);o.id=l;a=function(){var e;e=[];for(n in r){u=r[n];v=h.getAttribute("data-"+n);e.push(s(u,v))}return e}();o.src="//"+d(h.getAttribute(t))+a.join("&");return i.parentNode.insertBefore(o,i)}}})(document);<\/script>',mint='<div id="refcandy-mint" data-app-id="'+appId+'" data-fname="'+rcData.firstName+'" data-lname="'+rcData.lastName+'" data-email="'+rcData.email+'" data-amount="'+rcData.amount+'" data-currency="'+rcData.currencyCode+'" data-timestamp="'+rcData.unixTimestamp+'" data-external-reference-id="'+rcData.invoiceNumber+'" data-signature="'+rcData.hash+'"></div><script>(function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v;z="script";l="refcandy-purchase-js";c="refcandy-mint";p="go.referralcandy.com/purchase/";t="data-app-id";r={email:"a",fname:"b",lname:"c",amount:"d",currency:"e","accepts-marketing":"f",timestamp:"g","referral-code":"h",locale:"i","external-reference-id":"k",signature:"ab"};i=e.getElementsByTagName(z)[0];s=function(e,t){if(t){return""+e+"="+encodeURIComponent(t)}else{return""}};d=function(e){return""+p+h.getAttribute(t)+".js?aa=75&"};if(!e.getElementById(l)){h=e.getElementById(c);if(h){o=e.createElement(z);o.id=l;a=function(){var e;e=[];for(n in r){u=r[n];v=h.getAttribute("data-"+n);e.push(s(u,v))}return e}();o.src="//"+d(h.getAttribute(t))+a.join("&");return i.parentNode.insertBefore(o,i)}}})(document);<\/script>';$scope.public_settings.site_campaign_referralcandy_analytics.enable_popup?$scope.rcScript=$sce.trustAsHtml(popsicle):$scope.rcScript=$sce.trustAsHtml(mint)}))}function setNativeName(placeValue){return placeValue.country_native_name&&(placeValue.country=placeValue.country_native_name),placeValue.subcountry_native_name&&(placeValue.subcountry=placeValue.subcountry_native_name),placeValue.city_native_name&&(placevalue.city=placeValue.city_native_name),placeValue}function chooseShipping(address){if(null!=address&&null!=address){if($scope.shipping_error=!1,$scope.shipOptions=[],$scope.selectedReward&&$scope.selectedReward.shipping&&!$scope.pledgeReplace){var len=$scope.selectedReward.shipping.length,count=0,found=!1;angular.forEach($scope.selectedReward.shipping,(function(val){if(!found&&(val.country_id==address.country_id&&val.subcountry_id==address.subcountry_id&&3==val.shipping_option_type_id?($scope.native_lookup&&(val=setNativeName(val)),$scope.shipOptions=[{shipping_option_type:val.shipping_option_type,shipping_option_type_id:val.shipping_option_type_id,country:val.country,sub_country:val.subcountry,cost:val.cost}],count-=len,found=!0):count++,count==len)){var dummy=0;angular.forEach($scope.selectedReward.shipping,(function(v){v.country_id==address.country_id&&2==v.shipping_option_type_id?($scope.native_lookup&&(v=setNativeName(v)),$scope.shipOptions=[{shipping_option_type:v.shipping_option_type,shipping_option_type_id:v.shipping_option_type_id,country:v.country,sub_country:"",cost:v.cost}],dummy-=len,found=!0):dummy++,dummy==len&&(angular.forEach($scope.selectedReward.shipping,(function(value){1==value.shipping_option_type_id&&($scope.shipOptions=[{shipping_option_type:value.shipping_option_type,shipping_option_type_id:value.shipping_option_type_id,country:"",sub_country:"",cost:value.cost}],found=!0)})),$scope.shipOptions.length<1&&($scope.shipping_error=!0))}))}}))}else $scope.rewardsQueue.length&&$scope.pledgeReplace&&($scope.totalPledgeReplacementShippingCost=0,angular.forEach($scope.rewardsQueue,(function(selectedReward){if(selectedReward.shipping){$scope.pledgeReplaceShippingFound=!0;var len=selectedReward.shipping.length,count=0,found=!1;angular.forEach(selectedReward.shipping,(function(val){if(!found&&(val.country_id==address.country_id&&val.subcountry_id==address.subcountry_id&&3==val.shipping_option_type_id?(msg={header:"pledge_campaign_replace_sub_country_message"},$rootScope.floatingMessage=msg,count-=len,found=!0):count++,count==len)){var dummy=0;angular.forEach(selectedReward.shipping,(function(v){v.country_id==address.country_id&&2==v.shipping_option_type_id?($scope.native_lookup&&(v=setNativeName(v)),selectedReward.shipOptions=[{shipping_option_type:v.shipping_option_type,shipping_option_type_id:v.shipping_option_type_id,country:v.country,sub_country:"",cost:v.cost}],dummy-=len,found=!0):dummy++,dummy==len&&(angular.forEach(selectedReward.shipping,(function(value){1==value.shipping_option_type_id&&(selectedReward.shipOptions=[{shipping_option_type:value.shipping_option_type,shipping_option_type_id:value.shipping_option_type_id,country:"",sub_country:"",cost:value.cost}],found=!0)})),selectedReward.shipOptions.length<1&&($scope.shipping_error=!0))}))}}))}selectedReward.shipOptions&&($scope.totalPledgeReplacementShippingCost+=parseFloat(selectedReward.shipOptions[0].cost))})));subcountry_id=address.subcountry_id,$scope.alt_shipping&&$scope.site_campaign_alt_city_input_toggle&&Restangular.one("locale").customGET("city",{subcountry_id:subcountry_id}).then((function(success){success&&success.length&&($scope.address.city_id=success[0].city_id)}))}var subcountry_id}function getCountries(){return Geolocator.getCountries().then((function(countries){if($scope.native_lookup)for(var i in countries)null!=countries[i].native_name&&(countries[i].name=countries[i].native_name);if($scope.countries=countries,$scope.default_country){for(var index in $scope.countries){var value=$scope.countries[index];if(value.id==$scope.default_country.id){$scope.default_country=value,$scope.countries.splice(index,1);break}}$scope.countries.splice(0,0,$scope.default_country)}return $scope.countries}))}Restangular.one("campaign").customGET($scope.campaign_id,{use_path_lookup:$routeParams.privatepath?1:0,path:$routeParams.privatepath}).then((function(success){$scope.campaign=success,$rootScope.campaign_path=$scope.campaign.uri_paths[0].path,$rootScope.page_title=$scope.campaign.name?$scope.campaign.name+" - Contribution":"Contribution",$scope.campaign_loc=$scope.campaign.uri_paths[0].path,window.b=$scope.campaign_loc,angular.forEach($scope.campaign.pledges,(function(value,key){$scope.pledgeLevel==value.pledge_level_id&&($scope.pledgeindex=count),count++})),angular.forEach($scope.campaign.settings,(function(value,index){var setting_name=value.name,setting_value=value.value;"name"!=setting_name&&($scope.campaign[setting_name]=setting_value)})),getSettings(),StripeService.clientID().then((function(success){if("publishable_key"in success){var indexOf=success.publishable_key.indexOf("test");$scope.testMode=indexOf>-1}})),$scope.$on("settings_loaded",(function(event){3==$scope.public_settings.site_payment_gateway&&$scope.public_settings.paypal_publishable_key&&PaypalService.init($scope.campaign).then((function(){paypal.Buttons({style:{layout:"vertical",color:"blue",shape:"rect",label:"paypal"},createOrder:function(data,actions){var campaign_currency="USD";$scope.campaign.currencies.length>0&&(campaign_currency=$scope.campaign.currencies[0].code_iso4217_alpha);var total=parseInt($scope.campaignFundingGoal.value),items=[{name:"Contribution",description:"Contribution towards "+$scope.campaign.name+" campaign",unit_amount:{currency_code:campaign_currency,value:$scope.campaignFundingGoal.value},quantity:"1",tax:{currency_code:campaign_currency,value:"0.00"}}];if($scope.currentCoupon){var discount_amount=0;$scope.currentCoupon.discount_amount>0&&(discount_amount=parseInt($scope.currentCoupon.discount_amount)),$scope.currentCoupon.discount_percentage&&(discount_amount=total*$scope.currentCoupon.discount_percentage/100)}$scope.tip.dollar_amount&&(total+=parseInt($scope.tip.dollar_amount),items.push({name:"Tip",description:"Platform tip via "+$scope.campaign.name+" campaign",unit_amount:{currency_code:campaign_currency,value:$scope.tip.dollar_amount},quantity:"1",tax:{currency_code:campaign_currency,value:"0.00"}}));var final_total=total;$scope.currentCoupon&&(final_total-=discount_amount);var purchase_units=[{amount:{currency_code:campaign_currency,value:final_total,breakdown:{item_total:{currency_code:campaign_currency,value:total}}},items:items}];$scope.currentCoupon&&(purchase_units[0].amount.breakdown.discount={currency_code:campaign_currency,value:discount_amount});var prefill_email="",prefill_first_name="",prefill_last_name="";return $scope.user.email&&(prefill_email=$scope.user.email),$scope.user.first_name&&(prefill_first_name=$scope.user.first_name),$scope.user.last_name&&(prefill_last_name=$scope.user.last_name),actions.order.create({purchase_units:purchase_units,payer:{email_address:prefill_email,name:{given_name:prefill_first_name,surname:prefill_last_name}},application_context:{shipping_preference:"NO_SHIPPING"}})},onCancel:function(data){},onError:function(err){},onApprove:function(data,actions){return actions.order.capture().then((function(details){!function(paypal_order_id){$scope.anonymousContributionTypeOnly&&(1==$scope.selectedContributionAnon.toggle?$scope.selecteContribution=2:$scope.selecteContribution=1);var pledgeAttributes={};if($scope.site_campaign_alt_city_input_toggle&&!$scope.alt_shipping&&($scope.address.city_id=258463),$scope.selectedReward&&$scope.selectedReward.attributes&&void 0!==$scope.selectedReward.attributes.variation){var variation_choice=angular.copy($scope.selectedReward.attributes.variation);$('input[name="variation_value"]').each((function(key){""!=$(this).val()?variation_choice[key].choice=variation_choice[key].choice[$(this).val()].value:variation_choice[key].choice=null})),pledgeAttributes.variation=variation_choice}$scope.pledgeReplace&&angular.forEach($scope.rewardsQueue,(function(selectedReward){if(selectedReward.attributes&&void 0!==selectedReward.attributes.variation){var variation_choice=angular.copy(selectedReward.attributes.variation);$('input[name="variation_value"]').each((function(key){this.id==selectedReward.pledge_level_id&&(""!=$(this).val()?variation_choice[key]&&(variation_choice[key].choice=variation_choice[key].choice[$(this).val()].value):variation_choice[key]&&(variation_choice[key].choice=null))})),selectedReward.pledgeAttributes||(selectedReward.pledgeAttributes={}),$scope.public_settings.site_campaign_charity_helper_enable&&($scope.charity.country&&($scope.charity.country_name=$scope.countries[$scope.charity.country-1].name),selectedReward.pledgeAttributes.charity=$scope.charity),selectedReward.pledgeAttributes.variation=variation_choice}})),$scope.public_settings.site_campaign_charity_helper_enable&&($scope.charity.country&&($scope.charity.country_name=$scope.countries[$scope.charity.country-1].name),pledgeAttributes.charity=$scope.charity),msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg;var promises=[];if($scope.businessSelectedAttribute={business_contribution:0,business_organization_id:null},!($scope.selectedReward&&$scope.selectedReward.shipping&&$scope.shipping_error)){if($scope.checkContribution(),$("#finalpledge").addClass("disabled"),$scope.pledgeReplace){var postShipping=!1;!$scope.toggle.newAddress&&$scope.rewardsQueue.length&&angular.forEach($scope.rewardsQueue,(function(selectedReward){selectedReward.shipping&&(postShipping=!0),postShipping&&promises.push(Restangular.one("account/address").customPOST($scope.address))}))}var businessPromises=[];if($scope.acceptExtraPledgeData)return"Organization"==$scope.selectedAccountType&&($scope.selectedCompany||Restangular.one("account/business").customPOST($scope.businessSelected).then((function(success){businessData.business_id=success.business_organization_id,attachBusinessToAddressPhone(businessData.business_id,businessPromises,$scope.address,$scope.phoneInfo,businessData)})),$scope.selectedCompany&&attachBusinessToAddressPhone($scope.selectedCompany.business_organization_id,businessPromises,$scope.address,$scope.phoneInfo,businessData,promises,pledgeAttributes)),void("Individual"==$scope.selectedAccountType&&attachBusinessToAddressPhone(null,businessPromises,$scope.address,$scope.phoneInfo,businessData,promises,pledgeAttributes));addAddressPhoneNumber(null,businessPromises,$scope.address,$scope.phoneInfo,!1),$q.all(businessPromises).then((function(resolved){angular.forEach(resolved,(function(value){value.address_id&&(businessData.address_id=value.address_id,$scope.selectedAddressID=value.address_id),value.phone_number_id&&(businessData.phone_id=value.phone_number_id,$scope.chosenPhoneNumberId=value.phone_number_id)}));var total=parseInt($scope.campaignFundingGoal.value);$scope.tip.dollar_amount&&(total+=parseInt($scope.tip.dollar_amount));var pledgeInfo={paypal_order_id:paypal_order_id,pledge_level_id:$scope.pledgeLevel,amount:total,shipping_address_id:$scope.selectedAddressID||"",phone_number_id:$scope.chosenPhoneNumberId,anonymous_contribution:$scope.anonymous_contribution,anonymous_contribution_partial:$scope.partial_anonymous_contribution,attributes:JSON.stringify(pledgeAttributes),use_sca:0};$scope.acceptExtraPledgeData&&"Organization"==$scope.selectedAccountType&&businessData&&($scope.selectedCompany&&$scope.selectedCompany.hasOwnProperty("business_organization_id")?pledgeInfo.business_organization_id=parseInt($scope.selectedCompany.business_organization_id):pledgeInfo.business_organization_id=parseInt(businessData.business_organization_id),$scope.selectedAddressID&&(pledgeInfo.shipping_address_id=parseInt($scope.selectedAddressID)),$scope.chosenPhoneNumberId&&(pledgeInfo.phone_number_id=parseInt($scope.chosenPhoneNumberId))),$scope.couponCodeValid&&$scope.currentCoupon&&(pledgeInfo.coupon_code=$scope.currentCoupon.code),$scope.tippingOptions.toggle&&$scope.tip.dollar_amount&&0!=$scope.tip.dollar_amount&&(pledgeInfo.amount_tip=parseFloat($scope.tip.dollar_amount).toFixed(2),$scope.tippingOptions.toggle_process_tips_immediately&&(pledgeInfo.force_tip_processing=!0)),pledgeAttributes.hasOwnProperty("charity")&&pledgeAttributes.charity&&pledgeAttributes.charity.charity_final_confirmation&&(pledgeInfo.charity_helper=1),$scope.contributionMessage&&(pledgeInfo.note=$scope.contributionMessage),Restangular.one("campaign",$scope.campaign_id).one("pledge").customPOST(pledgeInfo).then((function(success){UserService.updateUserData({campaign_backer:1}),success.amount_tip&&($scope.tip.dollar_amount=parseFloat(success.amount_tip).toFixed(2)),msg={header:"pledge_campaign_pledge_success"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),$(".pledge-thank-you").modal({selector:{close:".actions .button",deny:".actions .negative, .actions .deny, .actions .cancel, .close"},closable:!1}).modal("show"),void 0!==$scope.campaign.settings&&$scope.campaign.contribution_redirect?$timeout((function(){window.location.href=$scope.campaign.contribution_redirect}),5e3):void 0!==$scope.site_campaign_pledge_redirect&&$scope.site_campaign_pledge_redirect.toggle&&$timeout((function(){window.location.href=$scope.site_campaign_pledge_redirect.url}),5e3),$scope.public_settings.site_campaign_ecommerce_analytics&&$scope.public_settings.site_campaign_ecommerce_analytics.toggle&&sendGATransaction(success,$scope.public_settings.site_campaign_ecommerce_analytics.code),$scope.public_settings.site_campaign_facebook_analytics&&$scope.public_settings.site_campaign_facebook_analytics.toggle&&sendFBTransaction(success,$scope.public_settings.site_campaign_facebook_analytics.code),$scope.public_settings.site_campaign_referralcandy_analytics&&$scope.public_settings.site_campaign_referralcandy_analytics.toggle&&sendRCTransaction(success,$scope.public_settings.site_campaign_referralcandy_analytics.id)}),(function(failed){errorHandling(failed),$("#finalpledge").removeClass("disabled"),$scope.failed_code=failed.data.code,msg={loading:!0,loading_message:failed.data.message},$rootScope.floatingMessage=msg}))}))}}(details.id)}))},onInit:function(data,actions){actions.disable(),document.querySelector('.agreement input[type="checkbox"]').addEventListener("change",(function(event){event.target.checked?actions.enable():actions.disable()}))},onClick:function(){var translation=$translate.instant(["pledge_campaign_selectcity_error","pledge_campaign_selectsubcountry_error"]);if($scope.valcheck=!0,$scope.selectedSubcountry.selected||($(".select-error").remove(),$("#select-subcountry").append('<div class="select-error ui red pointing prompt label transition visible">'+translation.pledge_campaign_selectsubcountry_error+"</div>"),$("#select-subcountry").addClass("error")),$("#select-city .select2-container").hasClass("select2-container-disabled")||$scope.selectedCity.selected||$scope.site_campaign_alt_city_input_toggle||($(".select-error").remove(),$("#select-city").append('<div class="select-error ui red pointing prompt label transition visible">'+translation.pledge_campaign_selectcity_error+"</div>"),$("#select-city").addClass("error")),$scope.tippingOptions.toggle&&$scope.tipValidation(),$scope.public_settings.site_campaign_reward_attributes_required&&attributesValidation(),$scope.pledgeReplace&&$scope.requiresShipping&&$scope.public_settings.site_campaign_reward_phone_required&&($scope.toggle.newNumber?phoneNumberValidation():newPhoneNumberValidation()),"number"==typeof $scope.pledgeindex&&$scope.public_settings.site_campaign_reward_phone_required&&$scope.shippingOption&&$scope.shippingOption.length&&!$scope.pledgeReplace&&($scope.toggle.newNumber?phoneNumberValidation():newPhoneNumberValidation()),$scope.pledgeReplace?(!$scope.pledgeReplace&&$scope.pledgeAmount||$scope.pledgeReplace&&$scope.pledgeAmount)&&$scope.contributeAmountValidation():$scope.contributeAmountValidation(),$scope.toggle.newAddress?$scope.chooseAddressFormValidation():$scope.newAddressFormValidation(),$scope.acceptExtraPledgeData&&("Organization"==$scope.selectedAccountType&&($scope.toggle.newCompany?$scope.chooseBusinessFormValidation():$scope.newBusinessFormValidation()),$scope.toggle.newNumber?phoneNumberValidation():newPhoneNumberValidation()),!$scope.isContributionLayout1&&$scope.public_settings.site_tos_contribution_ui){if(!$('.agreement input[type="checkbox"]').is(":checked"))return $scope.tos_not_checked=!0,void $rootScope.scrollToError();$scope.tos_not_checked=!1}$scope.valcheck?$rootScope.scrollToError():document.querySelector("#error").classList.remove("hidden")}}).render("#paypal-button-container")}))})),portal_settings.site_campaign_enable_organization_name&&Restangular.one('portal/person/attribute?filters={"person_id":"'+$scope.campaign.managers[0].id+'"}').customGET().then((function(success){$scope.organization_name.value=success[0].attributes.organization_name,$scope.organization_name.ein=success[0].attributes.ein})),$scope.$emit("loading_finished")})),$scope.pledgeLevel&&Restangular.one("campaign",$scope.campaign_id).one("pledge-level",$scope.pledgeLevel).get().then((function(success){$scope.selectedReward=success,$scope.rname=$scope.selectedReward.name})),StripeService.getPledgerAccount().then((function(success){if(null==(success=success[0]))$scope.pledgerAccountConnected=!1,$scope.toggle.newCard=!1,$scope.oldcard=!1;else{for(var i in $scope.toggle.newCard=!0,$scope.pledgerAccountConnected=!0,$scope.pledgerAccountID=success.stripe_account_id,$scope.pledgerCards=success.cards,$scope.pledgerCards)1==$scope.pledgerCards[i].default_card&&($scope.default_card=$scope.pledgerCards[i],$scope.defaultindex=i);null!=success.cards&&success.cards.length>0?$scope.oldcard=!0:$scope.oldcard=!1}})),$scope.contributionSelectionHelp="Contribution Selection 1 is selected",$scope.contributionSelected=function(type){$scope.selecteContribution=type.type,1==$scope.selecteContribution?$scope.contributionSelectionHelp="Contribution Selection 1 is selected":2==$scope.selecteContribution?$scope.contributionSelectionHelp="Contribution Selection 2 is selected":3==$scope.selecteContribution&&($scope.contributionSelectionHelp="Contribution Selection 3 is selected"),$(".help-popup").popup({content:$scope.contributionSelectionHelp,on:"click"})},$scope.isAGift=function(){$scope.charity.is_a_gift=$("input[name='is_a_gift_aid']").is(":checked")},$(".help-popup").popup({content:$scope.contributionSelectionHelp,on:"click"}),$scope.gotoRewards=function(){$location.path($scope.currentLoc)},$scope.cardID=1,$scope.cardTypeSelected=function(type){$scope.cardselected=type.name,$scope.cardID=type.id},$scope.setFlag=function(key,value){$scope.toggle[key]=value,"newAddress"==key&&value&&clearAddress()},$scope.dropdownReset=function(selector){".address-select"==selector?$scope.selectedAddress=null:".number-select"==selector?$scope.chosenPhoneNumberId=null:$scope.selectedCardID=null,$(selector).dropdown("clear"),$(selector).dropdown("restore defaults")},Restangular.one("account/address").customGET().then((function(success){$scope.profileAddress=success.plain(),$scope.profileAddress.personal=checkNative($scope.profileAddress.personal),$scope.profileAddress.business=checkNative($scope.profileAddress.business),$scope.profileAddress.personal?($scope.hasAddress=!0,$scope.toggle.newAddress=!0):($scope.hasAddress=!1,$scope.toggle.newAddress=!1)})),$scope.pledgeLevel&&Restangular.one("campaign",$scope.campaign_id).one("pledge-level",$scope.pledgeLevel).one("shipping-option").customGET().then((function(data){$scope.shippingOption=data,setTimeout((function(){$scope.newNumberCreated.number||$scope.newNumberCreated.phonetype||$("#phone_type_Landline").click(),$scope.newNumberCreated.phonetype&&$("#phone_type_"+$scope.newNumberCreated.phonetype.name).click()}),100)})),$scope.address={city_id:"",mail_code:"",street1:"",street2:"",country_id:""},$scope.creditCard={number:"",exp_month:"",exp_year:"",cvc:"",name:"",card_token:""},$scope.person={fname:"",lname:"",address1:"",zip:"",number:"",occupation:"",employer:""},$scope.checkContribution=function(){2==$scope.selecteContribution?$scope.anonymous_contribution=1:$scope.anonymous_contribution=0,3==$scope.selecteContribution?$scope.partial_anonymous_contribution=1:$scope.partial_anonymous_contribution=0,1==$scope.selecteContribution&&($scope.anonymous_contribution=0,$scope.partial_anonymous_contribution=0),portal_settings.site_campaign_always_anonymous_contribution&&($scope.anonymous_contribution=1,$scope.partial_anonymous_contribution=0)},$scope.clickToggle=function(key){"newCard"==key?($scope.toggle.selectedCard=!1,$(".choose-card-form.ui.form").form("clear"),$(".credit-card-form").removeClass("error")):"newAddress"==key?($scope.shipOptions=[],$scope.toggle.selectedAddress=!1,$(".choose-address-form.ui.form").form("clear"),$(".select-error").remove()):"newNumber"==key?($scope.toggle.selectedNumber=!1,$("#phone-number-form").form("clear"),setTimeout((function(){$scope.newNumberCreated.number||$scope.newNumberCreated.phonetype||$("#phone_type_Landline").click(),$scope.newNumberCreated.phonetype&&$("#phone_type_"+$scope.newNumberCreated.phonetype.name).click()}),100)):"newCompany"==key&&($scope.toggle.newCompany=!1,$("#new-user-company-form").form("clear"),$scope.newNumberCreated.number||$scope.newNumberCreated.phonetype||$("#phone_type_Landline").click(),$scope.newNumberCreated.phonetype&&$("#phone_type_"+$scope.newNumberCreated.phonetype.name).click()),$scope.toggle[key]=!$scope.toggle[key],0==$scope.toggle[key]&&"newAddress"==key&&clearAddress()},$scope.initStripeElement=function(){var translation=$translate.instant(["pledge_campaign_stripe_elements_cardExpirey","pledge_campaign_stripe_elements_cardNumber","pledge_campaign_creditcard_cvc_placeholder"]);$scope.stripe=Stripe($scope.site_stripe_tokenization_settings.public_stripe_key),$scope.elements=$scope.stripe.elements();var cardBrandToPfClass={visa:"pf-visa",mastercard:"pf-mastercard",amex:"pf-american-express",discover:"pf-discover",diners:"pf-diners",jcb:"pf-jcb",unknown:"pf-credit-card"},style={base:{iconColor:"#A3A3A3",color:"#000000",lineHeight:"16px",fontWeight:400,fontFamily:'Lato,"Helvetica Neue0",Arial,Helvetica,sans-serif',fontSize:"14px","::placeholder":{color:"#A3A3A3"}},invalid:{color:"#d95c5c",":focus":{color:"#d95c5c"}}};$scope.cardNumberElement=$scope.elements.create("cardNumber",{placeholder:translation.pledge_campaign_stripe_elements_cardNumber,iconStyle:"solid",style:style}),$scope.cardNumberElement.mount("#card-number-element"),$scope.cardExpiryElement=$scope.elements.create("cardExpiry",{placeholder:translation.pledge_campaign_stripe_elements_cardExpirey,iconStyle:"solid",style:style}),$scope.cardExpiryElement.mount("#card-expiry-element"),$scope.cardCvcElement=$scope.elements.create("cardCvc",{placeholder:translation.pledge_campaign_creditcard_cvc_placeholder,iconStyle:"solid",style:style}),$scope.cardCvcElement.mount("#card-cvc-element"),$scope.cardNumberElement.addEventListener("change",(function(event){var displayError=angular.element("#card-errors");event.error?displayError.textContent=event.error.message:displayError.textContent="",event.brand&&function(brand,cardBrandToPfClass){var brandIconElement=document.getElementById("brand-icon"),pfClass="pf-credit-card";if(brand in cardBrandToPfClass)switch(pfClass=cardBrandToPfClass[brand],brand){case"visa":$("#brand-icon").css("background-image","url(images/cards/Visa.png)");break;case"mastercard":$("#brand-icon").css("background-image","url(images/cards/MasterCard.png)");break;case"amex":$("#brand-icon").css("background-image","url(images/cards/American%20Express.png)");break;case"dinersclub":$("#brand-icon").css("background-image","url(images/cards/diners.png)");break;case"discover":$("#brand-icon").css("background-image","url(images/cards/Discover.png)");break;case"jcb":$("#brand-icon").css("background-image","url(images/cards/jcb.png)");break;default:$("#brand-icon").css("background-image","url(images/cards/default-credit-card-icon.png)")}for(var i=brandIconElement.classList.length-1;i>=0;i--)brandIconElement.classList.remove(brandIconElement.classList[i]);brandIconElement.classList.add("pf"),brandIconElement.classList.add(pfClass)}(event.brand,cardBrandToPfClass)})),$("#brand-icon").css("background-image","url(images/cards/default-credit-card-icon.png)")},$scope.chooseCardFormValidation=function(){var translation=$translate.instant(["pledge_campaign_choose_card_error"]);$(".choose-card-form.ui.form").form({choose_card:{identifier:"choose_card",rules:[{type:"empty",prompt:translation.pledge_campaign_choose_card_error}]}},{inline:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form")},$scope.chooseAddressFormValidation=function(){var translation=$translate.instant(["pledge_campaign_choose_address_error"]);$(".choose-address-form.ui.form").form({choose_address:{identifier:"choose_address",rules:[{type:"empty",prompt:translation.pledge_campaign_choose_address_error}]}},{inline:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form")},$scope.chooseBusinessFormValidation=function(){var translation=$translate.instant(["pledge_campaign_choose_company_error"]);$(".user-company-form.ui.form").form({choose_address:{identifier:"company_value",rules:[{type:"empty",prompt:translation.pledge_campaign_choose_company_error}]}},{inline:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form")},$scope.newBusinessFormValidation=function(){var translation=$translate.instant(["pledge_campaign_business_company_error","pledge_campaign_business_primary_lastName_error","pledge_campaign_business_primary_firstName_error","pledge_campaign_business_primary_email_error"]),validation={company_name:{identifier:"company_name",rules:[{type:"empty",prompt:translation.pledge_campaign_business_company_error}]},primaryEmail:{identifier:"businessEmail",rules:[{type:"empty",prompt:translation.pledge_campaign_business_primary_email_error}]}};$(".user-new-company-form.ui.form").form(validation,{inline:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form")},$scope.newCardFormValidation=function(){var translation=$translate.instant(["pledge_campaign_card_number_error","pledge_campaign_card_exp_month_error","pledge_campaign_card_exp_year_error","pledge_campaign_card_cvc_error"]);$(".credit-card-form.ui.form").form({card_number:{identifier:"card_number",rules:[{type:"empty",prompt:translation.pledge_campaign_card_number_error}]},card_exp_month:{identifier:"card_exp_month",rules:[{type:"empty",prompt:translation.pledge_campaign_card_exp_month_error}]},card_exp_year:{identifier:"card_exp_year",rules:[{type:"empty",prompt:translation.pledge_campaign_card_exp_year_error}]},card_cvc:{identifier:"card_cvc",rules:[{type:"empty",prompt:translation.pledge_campaign_card_cvc_error}]}},{inline:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form")},$scope.contributeAmountValidation=function(){$.fn.form.settings.rules.under_minimum=function(value){return!($scope.pledgeAmount<$scope.public_settings.site_theme_campaign_min_contribute_amount)},$.fn.form.settings.rules.over_maximum=function(value){return!($scope.pledgeAmount>$scope.max_amoumt&&$scope.allow_max)};var translation=$translate.instant(["pledge_campaign_contribution_empty","pledge_campaign_contribution_under_minimum","pledge_campaign_contribution_over_maximum"]);2==$scope.allowDecimalNotation||3==$scope.allowDecimalNotation?$(".contribution-form.ui.form").form({contribution_amount:{identifier:"contribution_amount",rules:[{type:"empty",prompt:translation.pledge_campaign_contribution_empty},{type:"under_minimum",prompt:translation.pledge_campaign_contribution_under_minimum},{type:"over_maximum",prompt:translation.pledge_campaign_contribution_over_maximum}]}},{inline:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form"):$(".contribution-form.ui.form").form({contribution_amount:{identifier:"contribution_amount_decimal",rules:[{type:"empty",prompt:translation.pledge_campaign_contribution_empty},{type:"under_minimum",prompt:translation.pledge_campaign_contribution_under_minimum},{type:"over_maximum",prompt:translation.pledge_campaign_contribution_over_maximum}]}},{inline:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form")},$scope.tipValidation=function(){if(!$scope.selectedTipType)return $scope.tipTypeError=!0,void($scope.valcheck=$scope.valcheck&&!1);if($.fn.form.settings.rules.tip_zero=function(value){return 0!=$scope.tip.dollar_amount},$.fn.form.settings.rules.tip_number=function(value){if($scope.tip.dollar_amount)return!!$scope.tip.dollar_amount.match(/^[0-9]\d*(((,\d{3}){1})?(\.\d{0,2})?)$/)},$.fn.form.settings.rules.tip_under_minimum=function(value){return!$scope.tippingOptions.dynamic_min||!(Number($scope.tip.dollar_amount)<Number($scope.tippingOptions.dynamic_min))},$.fn.form.settings.rules.tip_over_maximum=function(value){return!$scope.tippingOptions.dynamic_max||!(Number($scope.tip.dollar_amount)>Number($scope.tippingOptions.dynamic_max))},"dynamic"==$scope.selectedTipType){var translation=$translate.instant(["pledge_campaign_tip_empty","pledge_campaign_tip_invalid","pledge_campaign_tip_under_minimum","pledge_campaign_tip_over_maximum"]);$scope.tippingOptions.toggle_dynamic_min_max||$scope.tippingOptions.dynamic_min?$(".dynamic-tipping-form.ui.form").form({dynamic_tip:{identifier:"dynamic_tip",rules:[{type:"empty",prompt:translation.pledge_campaign_tip_empty},{type:"tip_zero",prompt:translation.pledge_campaign_tip_empty},{type:"tip_number",prompt:translation.pledge_campaign_tip_invalid},{type:"tip_under_minimum",prompt:translation.pledge_campaign_tip_under_minimum},{type:"tip_over_maximum",prompt:translation.pledge_campaign_tip_over_maximum}]}},{inline:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form"):$(".dynamic-tipping-form.ui.form").form({dynamic_tip:{identifier:"dynamic_tip",rules:[{type:"empty",prompt:translation.pledge_campaign_tip_empty},{type:"tip_zero",prompt:translation.pledge_campaign_tip_empty},{type:"tip_number",prompt:translation.pledge_campaign_tip_invalid}]}},{inline:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form")}},$scope.newAddressFormValidation=function(){var translation=$translate.instant(["pledge_campaign_shipping_country_error","pledge_campaign_shipping_subcountry_error","pledge_campaign_shipping_city_error","pledge_campaign_shipping_mailcode_error","pledge_campaign_shipping_streetaddress_error"]),validation={country:{identifier:"country",rules:[{type:"empty",prompt:translation.pledge_campaign_shipping_country_error}]},mail_code:{identifier:"mail_code",rules:[{type:"empty",prompt:translation.pledge_campaign_shipping_mailcode_error}]},street_address:{identifier:"street_address",rules:[{type:"empty",prompt:translation.pledge_campaign_shipping_streetaddress_error}]}};$scope.site_campaign_alt_city_input_toggle&&(validation.city={identifier:"city",rules:[{type:"empty",prompt:translation.pledge_campaign_shipping_city_error}]}),$(".new-shipping-address-form.ui.form").form(validation,{inline:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form")},$scope.submitWidgetPledge=function(){if(($scope.loadingIcon=!0,$scope.responseMsg="pledge_campaign_loading_text",!$scope.contrib||$("#pledgecheck").checkbox("is checked"))&&!($scope.selectedReward&&$scope.selectedReward.shipping&&$scope.shipping_error||$("form, ng-form").find(".ng-invalid,.has-error").length>0))if($scope.checkContribution(),$scope.responseMsg="",$scope.totalAmount<=1)$scope.responseMsg="Donation Amount must be a number and  atleast greater than 1 dollar";else{$("div.loader").addClass("active");$("#finalpledge").addClass("disabled");var pledgeInfo={entry_id:$scope.campaign_id,number:$scope.creditCard.number,cvc:$scope.creditCard.cvc,exp_month:$scope.creditCard.exp_month,exp_year:$scope.creditCard.exp_year,amount:$scope.totalAmount,first_name:$scope.person.fname,last_name:$scope.person.lname,personal_address_line1:$scope.person.address1,personal_address_zip:$scope.person.zip,personal_city_id:$scope.city_id,personal_phone_number:$scope.person.number,occupation:$scope.person.occupation||"",employer:$scope.person.employer||""};$scope.tippingOptions.toggle&&$scope.tip.dollar_amount&&0!=$scope.tip.dollar_amount&&(pledgeInfo.amount_tip=parseFloat($scope.tip.dollar_amount).toFixed(2),$scope.tippingOptions.toggle_process_tips_immediately&&(pledgeInfo.force_tip_processing=!0)),Restangular.one("account/widgetmakr").customPOST(pledgeInfo).then((function(success){$scope.wcardID=success.cards[0].widgetmakr_account_card_id,$scope.ctype=success.cards[0].widgetmakr_account_card_type;var infoPledge={widgetmakr_account_card_id:$scope.wcardID,amount:$scope.totalAmount,anonymous_contribution:$scope.anonymous_contribution,anonymous_contribution_partial:$scope.partial_anonymous_contribution};Restangular.one("campaign",$scope.campaign_id).one("pledge").customPOST(infoPledge).then((function(success){$scope.responseMsg=!1,$scope.loadingIcon=!1,$(".pledge-thank-you").modal({selector:{close:".actions .button",deny:".actions .negative, .actions .deny, .actions .cancel, .close"},onDeny:function(){}}).modal("show");UserService.updateUserData({campaign_backer:1})}),(function(failed){$scope.responseMsg=!1,$scope.loadingIcon=!1,$("#finalpledge").removeClass("disabled")}))}),(function(failed){$scope.responseMsg=!1,$scope.loadingIcon=!1,$("#finalpledge").removeClass("disabled"),"Provided credit card number appears to be invalid."==failed.data.message&&($scope.responseMsg="Provided credit card number appears to be invalid"),"Provided credit card number is too large."==failed.data.message&&($scope.responseMsg="Provided credit card number is too large"),"Invalid Credit Card Number."==failed.data.message&&($scope.responseMsg="Invalid Credit Card Number"),"Invalid Card Expiration Date."===failed.data.message&&($scope.responseMsg="Invalid Card Expiration Date"),"Donation Amount must be a number and at least 1 dollar"===failed.data.message&&($scope.responseMsg="Donation Amount must be a number and  atleast greater than 1 dollar"),"Ccv can only contain numbers."===failed.data.message&&($scope.responseMsg="Ccv can only contain numbers"),"Validation failed for one or more entities. See 'EntityValidationErrors' property for more details."===failed.data.message&&($scope.responseMsg="Pledge failed")}))}},$scope.submit=function(){$scope.anonymousContributionTypeOnly&&(1==$scope.selectedContributionAnon.toggle?$scope.selecteContribution=2:$scope.selecteContribution=1),$scope.stripe_pledge=$scope.stripe,$scope.stripe_tip=$scope.stripe,!$scope.site_campaign_fee_direct_transaction&&$scope.stripe_standard_mode&&$scope.campaign.managers[0]&&$scope.campaign.managers[0].publishable_key&&($scope.stripe_pledge=Stripe($scope.campaign.managers[0].publishable_key));var pledgeAttributes={};if($scope.site_campaign_alt_city_input_toggle&&!$scope.alt_shipping&&($scope.address.city_id=258463),$scope.selectedReward&&$scope.selectedReward.attributes&&void 0!==$scope.selectedReward.attributes.variation){var variation_choice=angular.copy($scope.selectedReward.attributes.variation);$('input[name="variation_value"]').each((function(key){""!=$(this).val()?variation_choice[key].choice=variation_choice[key].choice[$(this).val()].value:variation_choice[key].choice=null})),pledgeAttributes.variation=variation_choice}$scope.pledgeReplace&&angular.forEach($scope.rewardsQueue,(function(selectedReward){if(selectedReward.attributes&&void 0!==selectedReward.attributes.variation){var variation_choice=angular.copy(selectedReward.attributes.variation);$('input[name="variation_value"]').each((function(key){this.id==selectedReward.pledge_level_id&&(""!=$(this).val()?variation_choice[key]&&(variation_choice[key].choice=variation_choice[key].choice[$(this).val()].value):variation_choice[key]&&(variation_choice[key].choice=null))})),selectedReward.pledgeAttributes||(selectedReward.pledgeAttributes={}),$scope.public_settings.site_campaign_charity_helper_enable&&($scope.charity.country&&($scope.charity.country_name=$scope.countries[$scope.charity.country-1].name),selectedReward.pledgeAttributes.charity=$scope.charity),selectedReward.pledgeAttributes.variation=variation_choice}})),$scope.public_settings.site_campaign_charity_helper_enable&&($scope.charity.country&&($scope.charity.country_name=$scope.countries[$scope.charity.country-1].name),pledgeAttributes.charity=$scope.charity);var translation=$translate.instant(["pledge_campaign_selectcity_error","pledge_campaign_selectsubcountry_error"]);if($scope.valcheck=!0,$scope.selectedSubcountry.selected||($(".select-error").remove(),$("#select-subcountry").append('<div class="select-error ui red pointing prompt label transition visible">'+translation.pledge_campaign_selectsubcountry_error+"</div>"),$("#select-subcountry").addClass("error")),$("#select-city .select2-container").hasClass("select2-container-disabled")||$scope.selectedCity.selected||$scope.site_campaign_alt_city_input_toggle||($(".select-error").remove(),$("#select-city").append('<div class="select-error ui red pointing prompt label transition visible">'+translation.pledge_campaign_selectcity_error+"</div>"),$("#select-city").addClass("error")),$scope.tippingOptions.toggle&&$scope.tipValidation(),$scope.public_settings.site_campaign_reward_attributes_required&&attributesValidation(),$scope.pledgeReplace&&$scope.requiresShipping&&$scope.public_settings.site_campaign_reward_phone_required&&($scope.toggle.newNumber?phoneNumberValidation():newPhoneNumberValidation()),"number"==typeof $scope.pledgeindex&&$scope.public_settings.site_campaign_reward_phone_required&&$scope.shippingOption&&$scope.shippingOption.length&&!$scope.pledgeReplace&&($scope.toggle.newNumber?phoneNumberValidation():newPhoneNumberValidation()),$scope.pledgeReplace?(!$scope.pledgeReplace&&$scope.pledgeAmount||$scope.pledgeReplace&&$scope.pledgeAmount)&&$scope.contributeAmountValidation():$scope.contributeAmountValidation(),$scope.toggle.newCard?$scope.chooseCardFormValidation():$scope.newCardFormValidation(),$scope.toggle.newAddress?$scope.chooseAddressFormValidation():$scope.newAddressFormValidation(),$scope.acceptExtraPledgeData&&("Organization"==$scope.selectedAccountType&&($scope.toggle.newCompany?$scope.chooseBusinessFormValidation():$scope.newBusinessFormValidation()),$scope.toggle.newNumber?phoneNumberValidation():newPhoneNumberValidation()),!$scope.isContributionLayout1&&$scope.public_settings.site_tos_contribution_ui){if(!$('.agreement input[type="checkbox"]').is(":checked"))return $scope.tos_not_checked=!0,void $rootScope.scrollToError();$scope.tos_not_checked=!1}if($scope.valcheck){msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg;var promises=[];if($scope.businessSelectedAttribute={business_contribution:0,business_organization_id:null},$scope.selectedReward&&$scope.selectedReward.shipping&&$scope.shipping_error)return;if($scope.checkContribution(),$("#finalpledge").addClass("disabled"),$scope.pledgeReplace){var postShipping=!1;!$scope.toggle.newAddress&&$scope.rewardsQueue.length&&angular.forEach($scope.rewardsQueue,(function(selectedReward){selectedReward.shipping&&(postShipping=!0),postShipping&&promises.push(Restangular.one("account/address").customPOST($scope.address))}))}var businessPromises=[];if($scope.acceptExtraPledgeData)return"Organization"==$scope.selectedAccountType&&($scope.selectedCompany||Restangular.one("account/business").customPOST($scope.businessSelected).then((function(success){businessData.business_id=success.business_organization_id,attachBusinessToAddressPhone(businessData.business_id,businessPromises,$scope.address,$scope.phoneInfo,businessData)})),$scope.selectedCompany&&attachBusinessToAddressPhone($scope.selectedCompany.business_organization_id,businessPromises,$scope.address,$scope.phoneInfo,businessData,promises,pledgeAttributes)),void("Individual"==$scope.selectedAccountType&&attachBusinessToAddressPhone(null,businessPromises,$scope.address,$scope.phoneInfo,businessData,promises,pledgeAttributes));addAddressPhoneNumber(null,businessPromises,$scope.address,$scope.phoneInfo,!1),$q.all(businessPromises).then((function(resolved){angular.forEach(resolved,(function(value){value.address_id&&(businessData.address_id=value.address_id,$scope.selectedAddressID=value.address_id),value.phone_number_id&&(businessData.phone_id=value.phone_number_id,$scope.chosenPhoneNumberId=value.phone_number_id)})),generateTokenOrPledge(promises,pledgeAttributes,businessData)}))}else $rootScope.scrollToError()},$scope.resolvePromiseChain=function(promises,pledgeAttributes,businessData){$q.all(promises).then((function(resolved){angular.forEach(resolved,(function(value){value.cards?($scope.selectedCardID=value.cards[0].stripe_account_card_id,$scope.pledgerAccountConnected):value.stripe_account_card_id&&($scope.selectedCardID=value.stripe_account_card_id),value.address_id&&($scope.selectedAddressID=value.address_id),value.business_organization_id&&($scope.business_organization_id=value.business_organization_id)})),$scope.forceAnonymousPledge&&($scope.anonymous_contribution=1);var pledgeInfo={stripe_account_card_id:$scope.selectedCardID,pledge_level_id:$scope.pledgeLevel,amount:$scope.totalAmount,shipping_address_id:$scope.selectedAddressID||"",phone_number_id:$scope.chosenPhoneNumberId,anonymous_contribution:$scope.anonymous_contribution,anonymous_contribution_partial:$scope.partial_anonymous_contribution,attributes:JSON.stringify(pledgeAttributes),use_sca:1};if($scope.acceptExtraPledgeData&&"Organization"==$scope.selectedAccountType&&businessData&&($scope.selectedCompany&&$scope.selectedCompany.hasOwnProperty("business_organization_id")?pledgeInfo.business_organization_id=parseInt($scope.selectedCompany.business_organization_id):pledgeInfo.business_organization_id=parseInt(businessData.business_organization_id),$scope.selectedAddressID&&(pledgeInfo.shipping_address_id=parseInt($scope.selectedAddressID)),$scope.chosenPhoneNumberId&&(pledgeInfo.phone_number_id=parseInt($scope.chosenPhoneNumberId))),$scope.couponCodeValid&&$scope.currentCoupon&&(pledgeInfo.coupon_code=$scope.currentCoupon.code),$scope.tippingOptions.toggle&&$scope.tip.dollar_amount&&0!=$scope.tip.dollar_amount&&(pledgeInfo.amount_tip=parseFloat($scope.tip.dollar_amount).toFixed(2),$scope.tippingOptions.toggle_process_tips_immediately&&(pledgeInfo.force_tip_processing=!0)),pledgeAttributes.hasOwnProperty("charity")&&pledgeAttributes.charity&&pledgeAttributes.charity.charity_final_confirmation&&(pledgeInfo.charity_helper=1),$scope.contributionMessage&&(pledgeInfo.note=$scope.contributionMessage),$scope.pledgeReplace){var country,validShipping=!1;if(angular.forEach($scope.rewardsQueue,(function(value){!country&&value.shipOptions&&(country=value.shipOptions[0].country),value.shipOptions&&(2==value.shipOptions[0].shipping_option_type_id&&value.shipOptions[0].country==country||1==value.shipOptions[0].shipping_option_type_id)&&(validShipping=!0)})),!validShipping&&$scope.requiresShipping)return msg={header:"pledge_campaign_replace_specific_country_message"},void($rootScope.floatingMessage=msg);Restangular.one("campaign",$scope.campaign_id).one("pledge",$scope.replaceId).customDELETE().then((function(success){var promises=[];if($scope.directContribution){var pledgeInfo={stripe_account_card_id:$scope.selectedCardID,amount:$scope.pledgeAmount,anonymous_contribution:$scope.anonymous_contribution,anonymous_contribution_partial:$scope.partial_anonymous_contribution,use_sca:1},pledge=PledgeService.makePledge(pledgeInfo,$scope.campaign_id,$scope.stripe_pledge,$scope.stripe_tip);promises.push(pledge)}$scope.rewardsQueue.length&&angular.forEach($scope.rewardsQueue,(function(value,key,obj){var total=value.shipOptions?$scope.total(value.shipOptions[0].cost):value.amount,pledgeInfo={stripe_account_card_id:$scope.selectedCardID,pledge_level_id:value.pledge_level_id,amount:total,shipping_address_id:$scope.selectedAddressID||"",phone_number_id:$scope.chosenPhoneNumberId,anonymous_contribution:$scope.anonymous_contribution,anonymous_contribution_partial:$scope.partial_anonymous_contribution,attributes:JSON.stringify(value.pledgeAttributes),use_sca:1},pledge=PledgeService.makePledge(pledgeInfo,$scope.campaign_id,$scope.stripe_pledge,$scope.stripe_tip);obj[key].total_cost_with_quantity=0,obj[key].total_cost_with_quantity=value.amount*value.quantity;for(var i=0;i<value.quantity;i++)promises.push(pledge)})),$scope.resolvePledgeReplaceQueue(promises)}),(function(failed){var error_msg=failed.data.errors.entry_backer_id[0].message;msg={header:error_msg},$rootScope.floatingMessage=msg}))}$scope.pledgeReplace||PledgeService.makePledge(pledgeInfo,$scope.campaign_id,$scope.stripe_pledge,$scope.stripe_tip).then((function(success){$scope.tip.dollar_amount=parseFloat(success.amount_tip).toFixed(2),msg={header:"pledge_campaign_pledge_success"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),$scope.site_stripe_tokenization_settings.toggle&&$scope.cardNumberElement,$(".pledge-thank-you").modal({selector:{close:".actions .button",deny:".actions .negative, .actions .deny, .actions .cancel, .close"},closable:!1}).modal("show"),void 0!==$scope.campaign.settings&&$scope.campaign.contribution_redirect?$timeout((function(){window.location.href=$scope.campaign.contribution_redirect}),5e3):void 0!==$scope.site_campaign_pledge_redirect&&$scope.site_campaign_pledge_redirect.toggle&&$timeout((function(){window.location.href=$scope.site_campaign_pledge_redirect.url}),5e3);UserService.updateUserData({campaign_backer:1}),$scope.public_settings.site_campaign_ecommerce_analytics&&$scope.public_settings.site_campaign_ecommerce_analytics.toggle&&sendGATransaction(success,$scope.public_settings.site_campaign_ecommerce_analytics.code),$scope.public_settings.site_campaign_facebook_analytics&&$scope.public_settings.site_campaign_facebook_analytics.toggle&&sendFBTransaction(success,$scope.public_settings.site_campaign_facebook_analytics.code),$scope.public_settings.site_campaign_referralcandy_analytics&&$scope.public_settings.site_campaign_referralcandy_analytics.toggle&&sendRCTransaction(success,$scope.public_settings.site_campaign_referralcandy_analytics.id)}),(function(failed){errorHandling(failed),$("#finalpledge").removeClass("disabled"),$scope.failed_code=failed.data.code,"account_campaign_transaction_max_allowed_funds_raised"===$scope.failed_code?$translate("account_campaign_transaction_max_allowed_funds_raised").then((function(value){$scope.responseMsg=value})):$translate("Card_is_invalid").then((function(value){$scope.responseMsg=value,StripeService.getPledgerAccount().then((function(success){null==(success=success[0])?($scope.pledgerAccountConnected=!1,$scope.toggle.newCard=!1,$scope.oldcard=!1):($scope.toggle.newCard=!0,$scope.pledgerAccountConnected=!0,$scope.pledgerAccountID=success.stripe_account_id,$scope.pledgerCards=success.cards,success.cards.length>0?$scope.oldcard=!0:$scope.oldcard=!1)}))}))}))}),(function(failed){$("#finalpledge").removeClass("disabled"),errorHandling(failed)}))},$scope.resolvePledgeReplaceQueue=function(promises){$q.all(promises).then((function(resolved){msg={header:"pledge_campaign_pledge_success"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),$scope.site_stripe_tokenization_settings.toggle&&$scope.cardNumberElement&&($scope.cardNumberElement.clear(),$scope.cardExpiryElement.clear(),$scope.cardCvcElement.clear()),$(".pledge-thank-you").modal({selector:{close:".actions .button",deny:".actions .negative, .actions .deny, .actions .cancel, .close"},closable:!1}).modal("show");UserService.updateUserData({campaign_backer:1})}),(function(failed){errorHandling(failed),$("#finalpledge").removeClass("disabled"),$scope.failed_code=failed.data.code,"account_campaign_transaction_max_allowed_funds_raised"===$scope.failed_code?$translate("account_campaign_transaction_max_allowed_funds_raised").then((function(value){$scope.responseMsg=value})):$translate("Card_is_invalid").then((function(value){$scope.responseMsg=value,StripeService.getPledgerAccount().then((function(success){null==(success=success[0])?($scope.pledgerAccountConnected=!1,$scope.toggle.newCard=!1,$scope.oldcard=!1):($scope.toggle.newCard=!0,$scope.pledgerAccountConnected=!0,$scope.pledgerAccountID=success.stripe_account_id,$scope.pledgerCards=success.cards,success.cards.length>0?$scope.oldcard=!0:$scope.oldcard=!1)}))}))}))},$scope.stateTypes=[],$scope.Cities=function(term){var count=0;term&&Geolocator.searchCities(term).then((function(cities){angular.forEach(cities,(function(value){"211"==value.country_id&&($scope.stateTypes[count]=value,count++)}))}))},$scope.cardSelected=function(card,index){$scope.selectedCardID=card.stripe_account_card_id,$scope.stripe_account_id=card.stripe_account_id,$scope.toggle.selectedCard=!0,$scope.cardindex=index,$scope.vlaueofindex=$("#cardinfo").attr("value"),$("#deletemodal").css("visibility","visible")},$scope.openModalById=function(id){$(".ui.modal#"+id).modal("show")},$scope.deleteCard=function(){StripeService.deleteCard($scope.stripe_account_id,$scope.selectedCardID).then((function(){$scope.pledgerCards.splice($scope.cardindex,1),$("#carddropdown option[value='$scope.vlaueofindex']").remove(),$(".dropdown.card-select").dropdown("restore defaults")}))},$scope.tipTypeSelection=function(type){if($scope.tipTypeError=!1,$scope.tip={value:null,dollar_amount:0,type:"Dollar"},"tiers"==type){if($scope.tippingOptions.tiers[0]){$scope.updateTierValues(),$scope.tip={value:$scope.tippingOptions.tiers[0].value,dollar_amount:$scope.tippingOptions.tiers[0].dollar_amount,type:$scope.tippingOptions.tiers[0].type,name:$scope.tippingOptions.tiers[0].name,index:0},$scope.tipTiersDefaultName=$scope.tippingOptions.toggle_tier_names?$scope.tippingOptions.tiers[0].name:"",$scope.tipTiersDefaultAmount=$scope.tippingOptions.tiers[0].dollar_amount;var percentString=$scope.tipTiersDefaultName+" - "+$filter("formatCurrency")($scope.tipTiersDefaultAmount,$scope.tipInfo.code_iso4217_alpha,$scope.public_setting.site_campaign_decimal_option);$(".tip-tiers").dropdown("set text",percentString)}}else"dynamic"==type&&$scope.tippingOptions.toggle_dynamic_min_max&&$scope.tippingOptions.dynamic_min&&($scope.tip.value=$scope.tippingOptions.dynamic_min,$scope.tip.dollar_amount=$scope.tippingOptions.dynamic_min);$scope.selectedTipType=type},$scope.tipTierSelection=function(value,type,dollarAmount,name,index){$scope.tip={value:parseFloat(value),dollar_amount:parseFloat(dollarAmount),type:type,name:name,index:index}},$scope.updateTierValues=function(){angular.forEach($scope.tippingOptions.tiers,(function(value){"Percent"==value.type?value.dollar_amount=value.value/100*$scope.pledgeAmount:value.dollar_amount=value.value,$scope.combineTip||value.dollar_amount<$scope.lowestAmount&&(value.dollar_amount+=$scope.lowestAmount)}))},$scope.shippingOptionString=function(shipOpID){1==shipOpID?$translate("Worldwide Shipping").then((function(value){$scope.shipping_option=value})):2==shipOpID?$translate("Country Specific Shipping").then((function(value){$scope.shipping_option=value})):$translate("SubCountry Specific Shipping").then((function(value){$scope.shipping_option=value}))},$scope.citySelect=function(city){chooseShipping(city)},$scope.addressSelected=function(address){chooseShipping(address),$scope.toggle.selectedAddress=!0,$scope.selectedAddress=address,$scope.address.country_id=address.country_id,$scope.selectedAddressID=address.address_id},$scope.cities=[],$scope.searchCities=function(term){var native_lookup=1==$scope.native_lookup?1:0;term&&($scope.alt_shipping?Geolocator.searchCitiesBySubcountry(term,$scope.selectedSubcountry.selected.id,native_lookup).then((function(cities){if($scope.cities=cities,!cities||cities instanceof Array&&0===cities.length)Geolocator.searchCitiesBySubcountry(term,$scope.selectedSubcountry.selected.id,0).then((function(cities){$scope.cities=cities}));else if(native_lookup){for(var i in cities)null!=cities[i].city_native_name&&(cities[i].name=cities[i].city_native_name),null!=cities[i].country_native_name&&(cities[i].country=cities[i].country_native_name),null!=cities[i].subcountry_native_name&&(cities[i].subcountry=cities[i].subcountry_native_name);$scope.cities=cities}})):Geolocator.searchCities(term,native_lookup).then((function(cities){$scope.cities=cities})))},$scope.contactPhoneSelected=function(selectedNumber){$scope.toggle.selectedNumber=!0,$scope.chosenPhoneNumberId=selectedNumber.phone_number_id},$scope.phoneTypeSelected=function(type){$scope.newNumberCreated.phonetype=type},$scope.userCompanySelected=function(selectedCompany){$scope.selectedCompany=selectedCompany};var paramID={person_id:UserService.id};function getSubcountries(countryID){Geolocator.getSubcountriesByCountry(countryID).then((function(subcountries){if($scope.native_lookup)for(var i in subcountries)null!=subcountries[i].native_name&&(subcountries[i].name=subcountries[i].native_name);$scope.subcountries=subcountries}))}$scope.setCountry=function(country){$scope.selectedCountry.selected=country},$scope.$watch("selectedCity.selected",(function(value,oldValue){value!=oldValue&&value&&(cityID=Geolocator.lookupCityID(value.name),cityID&&($scope.address.city_id=cityID),countryID=Geolocator.lookupCountryID(value.name),countryID&&($scope.address.country_id=countryID),$scope.citySelect(value),$("#select-city .select-error").remove(),$("#select-city").removeClass("error"))})),$scope.$watch("selectedCountry.selected",(function(value,oldValue){value!=oldValue&&value&&($scope.selectedReward&&chooseShipping(value),$scope.selectedCity.selected=void 0,$scope.selectedSubcountry.selected=void 0,getSubcountries(value.id))})),$scope.$watch("selectedSubcountry.selected",(function(value,oldValue){value!=oldValue&&value&&(chooseShipping(value),$("#select-subcountry .select-error").remove(),$("#select-subcountry").removeClass("error"))})),$scope.$watch("address.country_id",(function(countryID){var worldWide=null,country=null;countryID&&(angular.forEach($scope.shippingOption,(function(item,key){item.country_id==countryID&&(country=key),1==item.shipping_option_type_id&&(worldWide=key)})),null!=country?$scope.costIndex=country:null!=worldWide&&($scope.costIndex=worldWide))})),$scope.goBackToCampaign=function(){try{window.location.href=$scope.campaign.uri_paths[0].path}catch(e){console.error(e)}},$scope.total=function(shipping,tip,coupon){if($scope.totalAmount=parseFloat($scope.pledgeAmount),coupon){if(coupon.discount_percentage>0){var discount=$scope.pledgeAmount*(coupon.discount_percentage/100);$scope.amountDiscounted=discount,$scope.totalAmount=Math.max(0,$scope.pledgeAmount-discount)}coupon.discount_amount>0&&($scope.amountDiscounted=coupon.discount_amount>$scope.pledgeAmount?$scope.pledgeAmount:coupon.discount_amount,$scope.totalAmount=Math.max(0,$scope.pledgeAmount-coupon.discount_amount))}return shipping&&($scope.totalAmount+=parseFloat(shipping)),tip?($scope.totalAmountPlusTip=parseFloat($scope.totalAmount)+parseFloat(tip),$scope.totalAmountPlusTip):parseFloat($scope.totalAmount)},$scope.couponCode="",$scope.couponCodeValid=!0,$scope.applyCoupon=function(couponCode){$scope.couponAppliedMessage=$translate.instant("pledge_campaign_searching_coupon"),Restangular.one("campaign",$scope.campaign_id).one("coupon?code="+couponCode+"&pledge_level_id="+$scope.pledgeLevel).customGET().then((function(success){$scope.currentCoupon=success,$scope.couponCodeValid=!0,success.discount_percentage>0&&($scope.couponAppliedMessage=success.discount_percentage+"%"),success.discount_amount>0&&($scope.couponAppliedMessage=$filter("formatCurrency")(success.discount_amount,$scope.campaign.currencies[0].code_iso4217_alpha,$scope.public_setting.site_campaign_decimal_option)),$scope.couponAppliedMessage+=" "+$translate.instant("pledge_campaign_discount_applied")}),(function(failure){$scope.couponCodeValid=!1,$scope.currentCoupon=void 0,$scope.couponCode="",$scope.couponAppliedMessage=$translate.instant("pledge_campaign_coupon_invalid")}))},$scope.replacedTotal=function(amount,shipping,tip,coupon){if($scope.totalAmount=parseFloat($scope.pledgeAmount),coupon){if(coupon.discount_percentage>0){var discount=$scope.pledgeAmount*(coupon.discount_percentage/100);$scope.amountDiscounted=discount,$scope.totalAmount=Math.max(0,$scope.pledgeAmount-discount)}coupon.discount_amount>0&&($scope.amountDiscounted=coupon.discount_amount>$scope.pledgeAmount?$scope.pledgeAmount:coupon.discount_amount,$scope.totalAmount=Math.max(0,$scope.pledgeAmount-coupon.discount_amount))}return shipping&&($scope.totalAmount+=parseFloat(shipping)),tip?($scope.totalAmountPlusTip=parseFloat($scope.totalAmount)+parseFloat(tip),$scope.totalAmountPlusTip):parseFloat($scope.totalAmount)},$scope.accountTypeSelected=function(type){$scope.selectedAccountType=type,"Organization"==type&&function(paramID){Restangular.one("account/").customGET("business",paramID).then((function(success){$scope.userCompanies=success.plain(),$scope.userCompanies.length?$scope.toggle.newCompany=!0:$scope.toggle.newCompany=!1}))}(paramID)},$scope.current_host=$location.host();var m_names=new Array("January","February","March","April","May","June","July","August","September","October","November","December"),currdate=new Date;$scope.currdate=m_names[currdate.getMonth()]+" "+currdate.getDate()+" "+currdate.getFullYear()+" "+currdate.getHours()+":"+currdate.getMinutes(),$scope.$watch("campaignFundingGoal.value",(function(newValue,oldValue){if(newValue!=oldValue&&newValue&&$scope.campaign&&"string"==typeof newValue){if($scope.pledgeReplace){var t=0;angular.forEach($scope.rewardsQueue,(function(selectedReward){t+=parseFloat(selectedReward.amount)*parseInt(selectedReward.quantity)})),total_replaced=parseInt(t)+parseInt(newValue),$scope.totalReplacedCost=$rootScope.formatFundingGoal(""+total_replaced),$scope.pledgeAmount=$rootScope.formatFundingGoal(newValue)}else $scope.pledgeAmount=$rootScope.formatFundingGoal(newValue);if("tiers"==$scope.selectedTipType&&$scope.updateTierValues(),$scope.tip.value&&0!=$scope.tip.value&&"Percent"==$scope.tip.type){var index=$routeParams.tipindex?$routeParams.tipindex:0,tipAmount=$scope.tippingOptions.tiers[index].dollar_amount;if(angular.forEach($scope.tippingOptions.tiers,(function(value,key,obj){$scope.tip.index==key&&(tipAmount=value.dollar_amount)})),$scope.tip.dollar_amount=tipAmount,$scope.tippingOptions.toggle_tier_names)var percentString=$scope.tip.name+" - ";else percentString="";percentString+=$filter("formatCurrency")(tipAmount,$scope.tipInfo.code_iso4217_alpha,$scope.public_setting.site_campaign_decimal_option),$(".tip-tiers").dropdown("set text",percentString)}}})),$scope.scrollToRewardParam=function(){$location.search({}),$location.path($scope.campaign_loc).search("scroll_to_reward",1)}}]);