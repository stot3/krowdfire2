app.controller("ContactMessageCtrl",["$scope","$rootScope","Restangular","PortalSettingsService","$translate","UserService","RestFullResponse","$timeout",function($scope,$rootScope,Restangular,PortalSettingsService,$translate,UserService,RestFullResponse,$timeout){var msg;$scope.receiver={},$scope.message={first_name:"",last_name:"",email:""},$scope.user_list_page=1,$scope.user_list_page_entries=10,$scope.isLoggedin=UserService.isLoggedIn(),PortalSettingsService.getSettingsObj().then((function(success){$scope.isAllowAnonContactMsg=success.public_setting.site_allow_anonymous_contact_message})),$scope.showContactModal=function(user){user&&($scope.receiver=user),UserService.isLoggedIn()||$scope.isAllowAnonContactMsg?user?($(".contact-message-modal").modal("is active")&&($(".ui modal").modal("hide all"),$(".ui dimmer").dimmer("hide")),$(".contact-message-modal").modal("show"),$(".contact-message-modal").modal("setting",{onApprove:$scope.sendContactMessage})):($(".contact-user-modal").modal("is active")&&($(".ui modal").modal("hide all"),$(".ui dimmer").dimmer("hide")),$(".contact-user-modal").modal("show"),$(".contact-user-modal").modal("setting",{onApprove:$scope.sendUserMessage})):$(".log-in-required-modal").modal("show")},$scope.validateMessage=function(form_target){var translation=$translate.instant(["contact_message_missing_subject","contact_message_missing_body","contact_message_missing_recipient","contact_message_missing_first_name","contact_message_missing_last_name","contact_message_missing_email","contact_email_validate_error"]),fields={subject:{identifier:"subject",rules:[{type:"empty",prompt:translation.contact_message_missing_subject}]},body:{identifier:"body",rules:[{type:"empty",prompt:translation.contact_message_missing_body}]},recipient:{identifier:"recipient",rules:[{type:"empty",prompt:translation.contact_message_missing_recipient}]},first_name:{identifier:"first_name",rules:[{type:"empty",prompt:translation.contact_message_missing_first_name}]},last_name:{identifier:"last_name",rules:[{type:"empty",prompt:translation.contact_message_missing_last_name}]},email:{identifier:"email",rules:[{type:"empty",prompt:translation.contact_message_missing_email},{type:"email",prompt:translation.contact_email_validate_error}]}};"contact-message"==form_target&&$(".ui.form.contact-message").form(fields,{inline:!0,onSuccess:function(){$scope.validMessage=!0},onFailure:function(){$scope.validMessage=!1}}).form("validate form"),"contact-user"==form_target&&$(".ui.form.contact-user").form(fields,{inline:!0,onSuccess:function(){$scope.validMessage=!0},onFailure:function(){$scope.validMessage=!1}}).form("validate form")},$scope.sendContactMessage=function(){if($scope.validateMessage("contact-message"),!$scope.validMessage)return!1;$scope.message.body=$scope.message.body.replace(/(\r\n|\n|\r)/gm,"<br>"),$scope.message.person_id=$scope.receiver.id,msg={loading_message:"action_sending",loading:!0},$rootScope.floatingMessage=msg,Restangular.one("account/message").customPOST($scope.message).then((function(success){$translate("message_sentto").then((function(value){msg={header:value+" "+$scope.receiver.first_name+" "+$scope.receiver.last_name},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()})),$scope.cleartext(),$timeout((function(){var clickElem=document.querySelector('[data-tab="inbox"]');angular.element(clickElem).triggerHandler("click")}))}),(function(failure){msg={header:failure.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()})),$(".contact-message-modal").modal("hide")},$scope.sendUserMessage=function(){if($scope.validateMessage("contact-user"),!$scope.validMessage)return!1;var data={body:$scope.message.body.replace(/(\r\n|\n|\r)/gm,"<br>"),person_id:$scope.receiver.id,subject:$scope.message.subject};msg={loading_message:"action_sending",loading:!0},$rootScope.floatingMessage=msg,Restangular.one("account/message").customPOST(data).then((function(success){$translate("message_sentto").then((function(value){msg={header:value+" "+$scope.receiver.first_name+" "+$scope.receiver.last_name},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()})),$scope.cleartext(),$scope.$emit("composed_new_message"),$timeout((function(){var clickElem=document.querySelector('[data-tab="inbox"]');angular.element(clickElem).triggerHandler("click")}))}),(function(failure){msg={header:failure.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()})),$(".contact-user-modal").modal("hide")},$scope.setRecipient=function(event){var first_name=event.target.attributes["first-name"].value,last_name=event.target.attributes["last-name"].value,id=event.target.attributes["data-value"].value;$scope.receiver.id=id,$scope.receiver.first_name=first_name,$scope.receiver.last_name=last_name},$scope.setRecipientOnEnter=function(event){if(13==event.keyCode){var updatedRecipient=angular.element("div.to-user a.profile-link"),first_name=updatedRecipient[0].attributes["first-name"].value,last_name=updatedRecipient[0].attributes["last-name"].value,id=updatedRecipient[0].attributes["user-id"].value;$scope.receiver.id=id,$scope.receiver.first_name=first_name,$scope.receiver.last_name=last_name}},$scope.updateUserList=function(name){$scope.user_list_page=1,$scope.getPeopleNames(name)},$scope.getPeopleNames=function(name,append){$scope.append=!1,void 0!==append&&($scope.append=append);var filters={filters:{name:name},page:$scope.user_list_page,page_entries:$scope.user_list_page_entries};RestFullResponse.all("portal/person-public").getList(filters).then((function(success){for(var i in $scope.pagination_info=success.headers(),$scope.append||($scope.list_users=[]),success.data)void 0!==success.data[i]&&null!==success.data[i]&&"object"==typeof success.data[i]&&"id"in success.data[i]&&$scope.list_users.push(success.data[i]);$timeout((function(){$scope.list_users.length>0&&$(".recipient.dropdown").dropdown("show")}),0)}),(function(failed){$scope.list_users=!1}))};var pageAdjust=function(adjust){$scope.user_list_page+adjust>0&&($scope.user_list_page+=adjust)};$scope.appendNextPage=function(){$scope.user_list_page>=$scope.pagination_info["x-pager-last-page"]||(pageAdjust(1),$scope.getPeopleNames($scope.message.receiver,!0))},$scope.nextPage=function(){pageAdjust(1),$scope.getPeopleNames($scope.message.receiver)},$scope.previousPage=function(){pageAdjust(-1),$scope.getPeopleNames($scope.message.receiver)},$scope.cleartext=function(){$("#subject").val(""),$("#message").val(""),$("#subject-user").val(""),$("#message-user").val(""),void 0!==$scope.message&&("subject"in $scope.message&&($scope.message.subject=""),"body"in $scope.message&&($scope.message.body=""),"first_name"in $scope.message&&($scope.message.first_name=""),"last_name"in $scope.message&&($scope.message.last_name=""),"email"in $scope.message&&($scope.message.email=""))},$scope.getPeopleNames("")}]);