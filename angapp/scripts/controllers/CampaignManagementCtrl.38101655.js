app.controller("CampaignManagementCtrl",["$location","$scope","$rootScope","RESOURCE_REGIONS","CampaignSettingsService","$translatePartialLoader","$translate","Restangular","$timeout","RestFullResponse","CreateCampaignService","$routeParams","UserService","RequestCacheService","ngQuickDateDefaults",function($location,$scope,$rootScope,RESOURCE_REGIONS,CampaignSettingsService,$translatePartialLoader,$translate,Restangular,$timeout,RestFullResponse,CreateCampaignService,$routeParams,UserService,RequestCacheService,ngQuickDateDefaults){function getCampaignStatus(){Restangular.one("campaign").all("status").getList().then((function(success){$scope.campaignStatus=success}))}function isValidDate(d){return"[object Date]"===Object.prototype.toString.call(d)&&!isNaN(d.getTime())}function convertDate(d){var value=d;if(!isValidDate(new Date(value))){var year=value.substring(0,4),month=value.substring(5,7),day=value.substring(8,10);return new Date(year,month-1,day)}return d}function fix_date(s){return"string"==typeof s?Date.parse(s):s?s.getTime():void 0}function filterCampaign(filter){return filter.campaign_id?RestFullResponse.one("campaign",filter.campaign_id).customGET().then((function(success){updateURL(),$scope.campaigns=[success.data.plain()];success.headers();$scope.sortOrFiltersCampaign.pagination.entriesperpage=1,angular.forEach($scope.campaigns,(function(campaign){void 0!==$scope.public_settings.site_campaign_exclude_shipping_cost&&$scope.public_settings.site_campaign_exclude_shipping_cost&&(campaign.funded_amount=campaign.funded_amount-campaign.total_shipping_cost),$scope.tooLateForCapture(campaign)}))})):RestFullResponse.all("campaign").getList(filter).then((function(success){updateURL(),$scope.campaigns=success.data,$rootScope.checkstart=!0;var headers=success.headers();$scope.sortOrFiltersCampaign.pagination.currentpage=headers["x-pager-current-page"],$scope.sortOrFiltersCampaign.pagination.numpages=headers["x-pager-last-page"],$scope.sortOrFiltersCampaign.pagination.nextpage=headers["x-pager-next-page"],$scope.sortOrFiltersCampaign.pagination.pagesinset=headers["x-pager-pages-in-set"],$scope.sortOrFiltersCampaign.pagination.totalentries=headers["x-pager-total-entries"],$scope.sortOrFiltersCampaign.pagination.entriesperpage=headers["x-pager-entries-per-page"],angular.forEach($scope.campaigns,(function(campaign){CampaignSettingsService.processSettings(campaign.settings),campaign.settings=CampaignSettingsService.getSettings(),$scope.tooLateForCapture(campaign),void 0!==$scope.public_settings.site_campaign_exclude_shipping_cost&&$scope.public_settings.site_campaign_exclude_shipping_cost&&(campaign.funded_amount=campaign.funded_amount-campaign.total_shipping_cost),$scope.progressHide=$scope.public_settings.site_campaign_progress_bar_hide,campaign.settings.master_progress_bar_hide=!1,$scope.progressHide?campaign.settings.master_progress_bar_hide=!0:campaign.settings.master_progress_bar_hide=!1,void 0!==campaign.settings.progress_bar_hide&&(campaign.settings.master_progress_bar_hide=campaign.settings.progress_bar_hide)})),$(".campaign-table thead tr .check-all input").prop("checked",!1)}))}function updateURL(){var pageparam=1==$routeParams.page||1==$scope.sortOrFiltersCampaign.page?null:$scope.sortOrFiltersCampaign.page;"object"==typeof $scope.sortOrFiltersCampaign.filters.category?$location.search("category",null):$location.search("category",$scope.sortOrFiltersCampaign.filters.category),$location.search("name",$scope.sortOrFiltersCampaign.filters.name||null),$location.search("page",pageparam),$location.search("order",$scope.sortOrFiltersCampaign.sort||null),$location.search("status",$scope.sortOrFiltersCampaign.filters.entry_status_id||null)}$scope.RESOURCE_REGIONS=RESOURCE_REGIONS,$scope.user=UserService,window.a=$scope,$scope.campaign={},$scope.campaignStatus={},$scope.categories={},$scope.toggle={},$scope.sortOrFiltersCampaign={sort:"",filters:{category:{},location:"",entry_status_id:"",manager:UserService.person_id},page_entries:10,page_limit:100,pagination:{},page:null},$scope.sortOrFiltersCampaign.filters.category=$routeParams.category||$scope.sortOrFiltersCampaign.filters.category,$scope.sortOrFiltersCampaign.filters.entry_status_id=$routeParams.status||$scope.sortOrFiltersCampaign.filters.entry_status_id,$scope.sortOrFiltersCampaign.filters.name=$routeParams.name||$scope.sortOrFiltersCampaign.filters.name,$timeout((function(){$scope.sortOrFiltersCampaign.page=$routeParams.page||1})),$scope.sortOrFiltersCampaign.campaign_id=$routeParams.campaign_id||null,$scope.sortOrFiltersCampaign.sort=$routeParams.order||null,$scope.days_text="days ago",$scope.day_text="day ago",$scope.rdays_text="days to go",$scope.rday_text="day to go",$scope.hours_text="hours ago",$scope.hour_text="hour ago",$scope.rhours_text="hours to go",$scope.rhour_text="hour to go",$scope.minutes_text="minutes ago",$scope.minute_text="minute ago",$scope.rminutes_text="minutes to go",$scope.rminute_text="minute to go",$scope.dateInPast=function(value,sec){return 0==sec||"00"==sec||sec<0},Restangular.one("portal/setting/").customGET().then((function(success){$scope.$emit("loading_finished"),$scope.public_settings={},angular.forEach(success,(function(value){"site_campaign_state_hide"==value.name&&($scope.public_settings[value.name]=value.value),"site_campaign_progress_bar_hide"==value.name&&($scope.public_settings[value.name]=value.value),"site_campaign_exclude_shipping_cost"!=value.name?"site_campaign_management"==value.name&&($scope.public_settings[value.name]=value.value):$scope.public_settings[value.name]=value.value})),void 0!==$scope.public_settings.site_campaign_management&&null!=$scope.public_settings.site_campaign_management||($scope.public_settings.site_campaign_management={transaction_hide:!1,pause_hide:!1}),filterCampaign($scope.sortOrFiltersCampaign)})),$scope.filterCampaign=function(){filterCampaign($scope.sortOrFiltersCampaign)},$scope.successMessage=[],$scope.errorMessage=[],$scope.totalentry=[10,25,40,55,70],RequestCacheService.getCategory().then((function(success){$scope.categories=success})),getCampaignStatus(),$scope.check=function(){$scope.checkstatus=!0},$scope.campaignManagerHasEndDate=function(campaign){return null!=campaign.ends_date_time},$scope.duration_type=[{id:"1",type:"duration_type_day"},{id:"2",type:"duration_type_week"},{id:"3",type:"duration_type_month"},{id:"4",type:"duration_type_year"}],$scope.durationTypeSelected=function(typeID){$scope.extendingCampaign.duration_type_id=typeID},$scope.openExtendCampaignModal=function(campaign){campaign&&($scope.extendingCampaign=campaign,$(".extend-campaign-modal").modal("show"))},$scope.extendCampaignEndDate=function(){$scope.extendingCampaign.ends_date_time=new Date($scope.extendingCampaign.ends_date_time),$scope.extendingCampaign.ends_date_time.setTime($scope.extendingCampaign.ends_date_time.getTime()+864e5*$scope.extendEndDays);var month=$scope.extendingCampaign.ends_date_time.getMonth();month=month>=9?$scope.extendingCampaign.ends_date_time.getMonth()+1:"0"+(month=$scope.extendingCampaign.ends_date_time.getMonth()+1);var day=$scope.extendingCampaign.ends_date_time.getDate();day>9||(day="0"+day);var hours=$scope.extendingCampaign.ends_date_time.getHours();hours>9||(hours="0"+hours);var mins=$scope.extendingCampaign.ends_date_time.getMinutes();mins>9||(mins="0"+mins);var datestring=$scope.extendingCampaign.ends_date_time.getFullYear()+"-"+month+"-"+day+" "+hours+":"+mins+":00";$scope.extendingCampaign.ends=datestring,$scope.extendingCampaign.ends=$scope.extendingCampaign.ends.replace(/\//g,"-"),1==$scope.user.portal_admin&&($scope.extendingCampaign.entry_status_id=2),1==$scope.user.campaign_manager&&($scope.extendingCampaign.entry_status_id=10),Restangular.one("campaign",$scope.extendingCampaign.id).customPUT($scope.extendingCampaign).then((function(success){angular.forEach($scope.campaigns,(function(campaign,key){campaign.id==$scope.extendingCampaign.id&&($scope.campaigns[key]=success)})),msg={header:"campaign_management_extend_campaign_date_success"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),$(".extend-campaign-modal").modal("hide")}))},$scope.setCampaignEndDate=function(){if("string"==typeof $scope.extendingCampaign.starts_date_time&&($scope.extendingCampaign.starts_date_time=new Date($scope.extendingCampaign.starts_date_time)),$scope.extendingCampaign.starts_date_time&&"object"==typeof $scope.extendingCampaign.starts_date_time)if($scope.extendingCampaign.starts_date_time.toString().length>19){month=(month=$scope.extendingCampaign.starts_date_time.getMonth())>=9?$scope.extendingCampaign.starts_date_time.getMonth()+1:"0"+(month=$scope.extendingCampaign.starts_date_time.getMonth()+1),(day=$scope.extendingCampaign.starts_date_time.getDate())>9||(day="0"+day),(hours=$scope.extendingCampaign.starts_date_time.getHours())>9||(hours="0"+hours),(mins=$scope.extendingCampaign.starts_date_time.getMinutes())>9||(mins="0"+mins);var datestring=$scope.extendingCampaign.starts_date_time.getFullYear()+"-"+month+"-"+day+" "+hours+":"+mins+":00";$scope.extendingCampaign.starts=datestring}else $scope.extendingCampaign.starts=$scope.extendingCampaign.starts_date_time.substring(0,16)+":00";var month,day,hours,mins;"string"==typeof $scope.extendingCampaign.ends_date_time&&($scope.extendingCampaign.ends_date_time=new Date($scope.extendingCampaign.ends_date_time)),month=(month=$scope.extendingCampaign.ends_date_time.getMonth())>=9?$scope.extendingCampaign.ends_date_time.getMonth()+1:"0"+(month=$scope.extendingCampaign.ends_date_time.getMonth()+1),(day=$scope.extendingCampaign.ends_date_time.getDate())>9||(day="0"+day),(hours=$scope.extendingCampaign.ends_date_time.getHours())>9||(hours="0"+hours),(mins=$scope.extendingCampaign.ends_date_time.getMinutes())>9||(mins="0"+mins);datestring=$scope.extendingCampaign.ends_date_time.getFullYear()+"-"+month+"-"+day+" "+hours+":"+mins+":00";$scope.extendingCampaign.ends=datestring,$scope.extendingCampaign.ends=$scope.extendingCampaign.ends.replace(/\//g,"-"),1==$scope.user.portal_admin&&($scope.extendingCampaign.entry_status_id=2),1==$scope.user.campaign_manager&&($scope.extendingCampaign.entry_status_id=10),Restangular.one("campaign",$scope.extendingCampaign.id).customPUT($scope.extendingCampaign).then((function(success){angular.forEach($scope.campaigns,(function(campaign,key){campaign.id==$scope.extendingCampaign.id&&($scope.campaigns[key]=success)})),msg={header:"campaign_management_extend_campaign_date_success"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),$(".extend-campaign-modal").modal("hide")}))},$scope.$watchGroup(["extendingCampaign.duration_type_id","extendingCampaign.runtime_days","extendingCampaign.starts_date_time"],(function(values,oldValues){if(void 0!==oldValues[1]&&($scope.oldtype_id=angular.copy($scope.extendingCampaign.duration_type_id),(!values[0]||values[1]<0||!values[2])&&($scope.extendingCampaign.ends_date_time=""),values[2]&&values[1]&&values[0])){var days;switch(parseInt(values[0])){case 1:days=values[1];break;case 2:days=7*values[1];break;case 3:days=30*values[1];break;case 4:days=365*values[1];break;default:days=0}isValidDate(new Date(864e5*days))&&("string"==typeof $scope.extendingCampaign.starts_date_time?$scope.extendingCampaign.ends_date_time=new Date(fix_date($scope.extendingCampaign.starts_date_time)+864e5*days):$scope.extendingCampaign.ends_date_time=new Date($scope.extendingCampaign.starts_date_time.getTime()+864e5*days))}})),$scope.$watch("extendingCampaign.ends_date_time",(function(values){if(values&&($("#end-date-field .select-error").remove(),$("#end-date-field").removeClass("error")),$scope.checkstatus&&($scope.checkstatus=!1,$scope.extendingCampaign.starts=convertDate($scope.extendingCampaign.starts_date_time),$scope.extendingCampaign.starts_date_time)){$scope.extendingCampaign.ends=convertDate(values),$scope.extendingCampaign.runtime_days=Math.round((fix_date($scope.extendingCampaign.ends_date_time)-fix_date($scope.extendingCampaign.starts_date_time))/864e5),$scope.extendingCampaign.duration_type_id=1;var day_option=$translate.instant("Day");$("#duration_dtext").text(day_option)}})),$scope.campaignManagerTransactionHide=function(campaign){return $scope.public_settings.site_campaign_management.transaction_hide?!(1!=$scope.user.person_type_id||!campaign.funded_amount):!!campaign.funded_amount},$scope.campaignManagerPauseHide=function(campaign){return $scope.public_settings.site_campaign_management.pause_hide?1==$scope.user.person_type_id&&2==campaign.entry_status_id:2==campaign.entry_status_id},$scope.getTransecStats=function(campaignID){$location.path("campaign-manager/transactions/"+campaignID),Restangular.one("campaign/"+campaignID+"/stats").customGET(null,{summary:1}).then((function(success){})),Restangular.one("campaign/"+campaignID+"/stats").customGET(null,{summary:0}).then((function(success){}))},$scope.changeCampaignStatus=function(campaign,statusID){msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg;var changes={entry_status_id:statusID};Restangular.one("campaign",campaign.id).customPUT(changes).then((function(success){$scope.delayUpdate()}),(function(failed){}))},$scope.delayUpdate=function(){$timeout((function(){filterCampaign($scope.sortOrFiltersCampaign),getCampaignStatus(),msg={header:"action_success"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}),800)},$scope.updateSortCampaign=function(sort){$scope.sortOrFiltersCampaign.sort=sort||"",filterCampaign($scope.sortOrFiltersCampaign)},$scope.updateFiltersCampaignCategory=function(category){$scope.sortOrFiltersCampaign.filters.category=category,filterCampaign($scope.sortOrFiltersCampaign)},$scope.updateFiltersCampaignStatus=function(statusID){$scope.sortOrFiltersCampaign.filters.entry_status_id=statusID,filterCampaign($scope.sortOrFiltersCampaign)},$scope.updateFiltersCampaignOrder=function(order){$scope.sortOrFiltersCampaign.sort=order,filterCampaign($scope.sortOrFiltersCampaign)},$scope.checkentry=function(){$scope.entries=$("#searchbtn").dropdown("get value"),$scope.sortOrFiltersCampaign.page_entries=$scope.entries,filterCampaign($scope.sortOrFiltersCampaign)},$scope.tooLateForCapture=function(campaign){var today_date=new Date,offset=today_date.getTimezoneOffset();today_date.setMinutes(today_date.getMinutes()-offset),today_date=today_date.toISOString().substring(0,19).replace("T"," ");var end_date=new Date(campaign.ends_date_time);return end_date.setDate(end_date.getDate()+5),end_date=end_date.toISOString().substring(0,19).replace("T"," "),campaign.too_late_capture=today_date>end_date,campaign.too_late_capture},$scope.editCampaign=function(campaign){$location.path("getstarted/"+campaign.entry_id)},$scope.searchCampaign=function(word){$scope.sortOrFiltersCampaign.filters.name=word,filterCampaign($scope.sortOrFiltersCampaign)},$scope.cancelCampaign=function(campaign){campaign?($scope.cancellingCampaign=campaign,$(".cancel-multi-campaign-modal").modal("show")):$(".not-select-modal").modal("show")},$scope.confirmCancelCampaign=function(campaign){$scope.changeCampaignStatus(campaign,11)},$scope.sortByDate=function(){$scope.toggle.created=!$scope.toggle.created,$scope.toggle.created?$scope.sortOrFiltersCampaign.sort="created":$scope.sortOrFiltersCampaign.sort="-created",filterCampaign($scope.sortOrFiltersCampaign)},$scope.manageStream=function(campaign){$location.path("campaign-manager/stream-management/"+campaign.id)}}]);