app.controller("LoginCtrl",["$rootScope","$location","$scope","PortalSettingsService","UserService","Restangular","redirectService","$translate","$translatePartialLoader","AUTH_SCHEME","$timeout",function($rootScope,$location,$scope,PortalSettingsService,UserService,Restangular,redirectService,$translate,$translatePartialLoader,AUTH_SCHEME,$timeout){$scope.submit_once=!1,$scope.formData={},$scope.account={},$scope.translateText=function(text){return $translate.instant(text)};var auth_scheme=AUTH_SCHEME[0],tmp_lst=redirectService.getUrl().split("/");"authenticate"==tmp_lst[1]&&"forgot"==tmp_lst[2]&&($rootScope.login_successful={message:"login_new_password"}),$scope.$watch("userEmail",(function(v){$scope.formData.email||($scope.formData.email=v)})),$(".modal").modal({allowMultiple:!0}),$scope.tos_login=!0,PortalSettingsService.getSettings(!0).then((function(success){$rootScope.loginRedirect=null,$scope.val=success,angular.forEach($scope.val,(function(value){value&&("site_tos_login_ui"===value.name?$scope.tos_login=value.value:"site_auth_scheme"===value.name?auth_scheme=value.value:"site_disable_account_setting"===value.name?$scope.isAccSetEnabled=!value.value:"site_login_redirect"!==value.name||$rootScope.loginRedirect?"social_login"===value.name&&($scope.socialLogin=value.value.toggle):($rootScope.loginRedirect=value.value,void 0!==$scope.loginRedirect.text&&""!==$scope.loginRedirect.text&&void 0!==$scope.loginRedirect.link&&""!==$scope.loginRedirect.link?$scope.loginRedirectShow=!0:$scope.loginRedirectShow=!1)),"site_payment_gateway"===value.name&&($scope.site_payment_gateway=value.value)})),null!==$scope.socialLogin&&void 0!==$scope.socialLogin||($scope.socialLogin=!1),$scope.isAccSetEnabled=null==$scope.isAccSetEnabled||$scope.isAccSetEnabled,$scope.$emit("loading_finished")})),$scope.cancelSubmit=function(){$rootScope.loading=!1,$rootScope.login_successful=null,$scope.closeModal()},$scope.socialLogin=null,$rootScope.checklogin=!0,$scope.formData={},$scope.submitWithTFA=function(){var translation=$translate.instant(["tab_security_error_empty_code","tab_security_error_invalid_code"]);!0!==$scope.socialLogin?($scope.formData.email||($scope.formData.email=$('#login input[name="email"]').val()),$scope.formData.password||($scope.formData.password=$('#login input[name="password"]').val())):($scope.formData.email||($scope.formData.email=$("#okta-signin-username").val()),$scope.formData.password||($scope.formData.password=$("#okta-signin-password").val())),Restangular.one("authenticate").customPOST($scope.formData).then((function(success){console.log(success);var rules=[{type:"empty",prompt:translation.tab_security_error_empty_code}];success.valid_tfa_code_required&&rules.push({type:"contains[null]",prompt:translation.tab_security_error_invalid_code}),$scope.form_validation={code:{identifier:"code",rules:rules}},$("#code-form").form($scope.form_validation,{inline:!0,keyboardShortcuts:!0,onSuccess:function(){$scope.onSubmitSuccess(success)},onFailure:function(){rules.pop()}}).form("validate form")}))},$scope.onSubmitSuccess=function(success){success.valid_tfa_code_required?($scope.openModal("enter-2fa"),$scope.formData.email=$('#login input[name="email"]').val(),$scope.formData.password=$('#login input[name="password"]').val()):($scope.formData.errors=null,$rootScope.login_successful={message:"login_login_successful"},$translate(["login_page_login_success"]).then((function(value){$scope.login_message=value.login_page_login_success})),UserService.setLoggedIn(success),1==success.person_type_id&&Restangular.one("account/stripe/application").customGET("",{},{"X-Auth-Token":success.auth_token}).then((function(success){var stripe_setting=success.plain(),show_modal=!1;stripe_setting.publishable_key&&"public_id_dummy"!=stripe_setting.publishable_key||(show_modal=!0),stripe_setting.secret_key&&"secret_key_dummy"!=stripe_setting.secret_key||(show_modal=!0),$scope.site_payment_gateway&&1!=$scope.site_payment_gateway&&(show_modal=!1),$rootScope.loading=!1,$rootScope.login_successful=null,show_modal&&($location.path("/admin/dashboard"),$location.hash("portal-settings"),$rootScope.showNewPlatformModal=!0)})),$(".ui.modal").modal("hide"))},$scope.submit=async function(){if(!0!==$scope.socialLogin){if($scope.tos_login){if($scope.submit_once=!0,!$('#login input[type="checkbox"]').is(":checked"))return void($scope.login_tos_not_checked=!0);$scope.login_tos_not_checked=!1}if(!$(".ui.login.form").form("validate form"))return}$scope.formData.errors=null,$rootScope.login_successful=null,$rootScope.loading=!0,$rootScope.login_successful={message:"login_logging_in"},$translate(["login_page_login_message"]).then((function(value){$scope.login_message=value.login_page_login_message})),!0!==$scope.socialLogin?($scope.formData.email||($scope.formData.email=$('#login input[name="email"]').val()),$scope.formData.password||($scope.formData.password=$('#login input[name="password"]').val())):($scope.formData.email=$("#okta-signin-username").val(),$scope.formData.password=$("#okta-signin-password").val()),2==auth_scheme.id&&($scope.formData.password_scheme="sha1");const result=Restangular.all("authenticate").post($scope.formData).then((function(success){$scope.onSubmitSuccess(success)}),(function(failure){return $scope.formData.errors=null,$rootScope.login_successful=null,$scope.formData.errors=failure.data.errors,$scope.formData.error_message=failure.data.message,$scope.str=$scope.formData.errors.credential_verification[0].code,"authenticate_invalid_authenticate_credentials"===$scope.str&&$translate("login_page_invalid_credentials").then((function(value){$scope.invalid_cred=value})),$rootScope.loading=!1,{success:0,errors:$scope.formData.errors,message:$scope.formData.error_message}}));return await result},$scope.serrormessgae="",$timeout((function(){$translate(["login_page_invalid_email","login_page_empty_email","login_page_password_empty","login_page_password_length"]).then((function(value){$scope.email_empty_invalid=value.login_page_invalid_email,$scope.email_empty=value.login_page_empty_email,$scope.password_empty=value.login_page_password_empty,$scope.password_length=value.login_page_password_length,$(".ui.login.form").form({email:{identifier:"email",rules:[{type:"empty",prompt:$scope.email_empty},{type:"email",prompt:$scope.email_empty_invalid}]},password:{identifier:"password",rules:[{type:"empty",prompt:$scope.password_empty},{type:"length[6]",prompt:$scope.password_length}]}},{inline:!0})}))}),1e3),$scope.forgotPassword=function(){$(".forgot-password-modal").modal({onApprove:function(){if(!$(".ui.email.form").form("validate form"))return!1}}).modal("show")},$scope.resetPassword=function(){if($scope.isAccSetEnabled){if(!$(".ui.email.form").form("validate form"))return;var data={email:$scope.account.email};Restangular.one("authenticate").one("forgot").customPOST(data).then((function(success){success.success?$rootScope.emailconfirmed=!0:$rootScope.wrongemail=!0}))}},$scope.reconfirm=function(){if($(".ui.email.form").form("validate form")){var data={email:$scope.account.email};Restangular.one("register").one("reconfirm").customPOST(data).then((function(success){success.success?$rootScope.emailconfirmed=!0:$rootScope.wrongemail=!0}))}};var translationLogin=$translate.instant(["login_emailempty_prompt","login_emailinvalid_prompt"]);$(".ui.email.form").form({email:{identifier:"email",rules:[{type:"empty",prompt:translationLogin.login_emailempty_prompt},{type:"email",prompt:translationLogin.login_emailinvalid_prompt}]}},{inline:!0,on:"blur",onInvalid:function(){this.hasClass("ng-pristine")&&(this.parent().removeClass("error"),this.next().remove())}}),$scope.openModal=function(modalId,callback){$(".modal#"+modalId).modal({closable:!1,onApprove:function(){return"function"==typeof callback&&callback(),!1}}).modal("show")}}]);