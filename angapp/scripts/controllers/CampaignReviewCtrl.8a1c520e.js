app.controller("campaignReviewCtrl",["$timeout","$interval","$location","$scope","$filter","$browser","$translatePartialLoader","$translate","$routeParams","Restangular","RESOURCE_REGIONS","API_URL","PortalSettingsService","$rootScope","CampaignSettingsService","UserService","RestFullResponse","DisqusShortnameService","VideoLinkService","SOCIAL_SHARING_OPTIONS","$anchorScroll",function($timeout,$interval,$location,$scope,$filter,$browser,$translatePartialLoader,$translate,$routeParams,Restangular,RESOURCE_REGIONS,API_URL,PortalSettingsService,$rootScope,CampaignSettingsService,UserService,RestFullResponse,DisqusShortnameService,VideoLinkService,SOCIAL_SHARING_OPTIONS,$anchorScroll){var msg,native_lookup;$scope.RESOURCE_REGIONS=RESOURCE_REGIONS,$scope.duration="",$scope.campaign={},$scope.featuredMedia=!0,$scope.campaignTab=!0,$scope.campaign_id=$routeParams.campaign_id,$scope.user=UserService,$scope.$location=$location,$rootScope.currentLoc=$location.path(),window.b=$location.path(),$rootScope.campaign_path=$location.path(),$scope.currentAbsUrl=$location.absUrl(),$scope.stream_pagination={},$scope.stream_filter={page_entries:10,page_limit:100,pagination:{},page:1},$scope.organization_name={},$scope.hashcheck=$location.hash(),$scope.show_section={},$scope.show_section.streamDetail=!1,$scope.stream={},$scope.duration="",$scope.dtype="",$timeout((function(){$("#campaign-tabs .menu-tabs .item").tab({context:$("#campaign-tabs")}),$(".tabular.menu .item").tab()})),$(document).ready((function(){window.scrollTo(0,0)})),$scope.showCampaign=0,$scope.showFaq=0,$scope.showBacker=0,$scope.showComment=0,$scope.showStream=0,$scope.isPrivateCampaign=/campaign\/private/.test($rootScope.currentLoc);var params;$scope.note={},PortalSettingsService.getSettingsObj().then((function(success){$scope.public_settings=success.public_setting,$scope.reward_html_editor=success.public_setting.site_theme_campaign_reward_html_editor,native_lookup=success.public_setting.site_theme_shipping_native_lookup,$scope.enabledContribution=success.public_setting.site_campaign_contributions,$scope.enabledContrubitionRewardsPopup=success.public_setting.site_theme_campaign_reward_modal,$scope.contributionInstruction=success.public_setting.site_campaign_contributions_instruction,$scope.removeContactUser=success.public_setting.site_campaign_contact_user,$scope.enableRewardVariation=success.public_setting.site_theme_campaign_show_reward_enable_variation,$scope.isRemoveCampaignFaq=success.public_setting.site_campaign_remove_campaign_faq,$scope.isCreatorNameOnly=success.public_setting.site_campaign_display_creator_info_name_only,$scope.isCreatorInfoOnMainBlock=success.public_setting.site_campaign_creator_info_display,$scope.isBackersOnSidebar=success.public_setting.site_campaign_backers_list_display,$scope.isCommentsOnMainBlock=success.public_setting.site_campaign_comments_display,$scope.isUpdatesOnMainBlock=success.public_setting.site_campaign_updates_display,$scope.isHideBackerProfileLink=success.public_setting.site_campaign_backer_hide_profile_link,$scope.isHideBackedCampaignsAmount=success.public_setting.site_campaign_backer_hide_backed_campaigns,$scope.isBlurbInSidebar=success.public_setting.site_campaign_move_blurb_sidebar,$scope.minContributionAmount=success.public_setting.site_theme_campaign_min_contribute_amount,$scope.isCreatorInfoTopBottomOfCampaign=success.public_setting.site_campaign_creator_info_display_top_bottom,$scope.isExplainerTextEnabled=success.public_setting.site_campaign_enable_explainer_text,$scope.isAllowAnonContactMsg=success.public_setting.site_allow_anonymous_contact_message,$scope.moveEmbedBelowCommentsAccordionMobile=success.public_setting.site_campaign_move_embed_below_comments_accordion,$scope.moveBackersBelowCreatorAccordionMobile=success.public_setting.site_campaign_move_backers_accordion_below_creator_accordion,$scope.moveCreatorInfoToSidebar=success.public_setting.site_campaign_creator_info_display_sidebar,$scope.moveSharingButtonsToSidebar=success.public_setting.site_campaign_share_campaign_actions_display_sidebar,$scope.site_campaign_enable_organization_name=success.public_setting.site_campaign_enable_organization_name,$scope.displayOnlyFbTwitterEmailShare=success.public_setting.site_campaign_share_display_only_fb_email_twitter,$scope.displayRewardsMobileTab=success.public_setting.site_campaign_display_reward_on_mobile_tabs,$scope.showShareHeaderAfterCampaignCreation=success.public_setting.site_campaign_page_show_share_header,$scope.isRemoveCampaignLinks=$scope.public_settings.site_campaign_remove_campaign_links,$scope.hideRaiseMode=$scope.public_settings.site_campaign_remove_raise_mode,$scope.pledge_amount=1,$scope.minContributionAmount&&($scope.pledge_amount=$scope.minContributionAmount),void 0!==$scope.public_settings.site_campaign_custom_button&&null!=$scope.public_settings.site_campaign_custom_button||($scope.public_settings.site_campaign_custom_button={toggle:!1,reward:"Choose Reward",contribution:"Contribution"}),$scope.customText=$scope.public_settings.site_campaign_custom_button,4==success.public_setting.site_contribute_behaviour.default?!0:($scope.cursetting=success,$scope.cursetting.public_setting.site_contribute_behaviour.default||($scope.cursetting.public_setting.site_contribute_behaviour.default=1),2==$scope.cursetting.public_setting.site_contribute_behaviour.default&&(UserService.isLoggedIn()?$scope.user_check=!1:$scope.user_check=!0)),success.public_setting.site_campaign_hide_creator_info&&($scope.site_campaign_hide_creator_info=success.public_setting.site_campaign_hide_creator_info),$scope.comment_form={},$scope.comment_form.message="",null!=success.public_setting.comment_system?$scope.comment_system=success.public_setting.comment_system:$scope.comment_system="disqus","disqus"==$scope.comment_system?($scope.hasDisqusShortname,DisqusShortnameService.getDisqusShortname().then((function(shortname){$scope.disqus_shortname,angular.forEach(shortname,(function(value){3==value.setting_type_id&&($scope.disqus_shortname=value.value)}));var disqus_identifier=$scope.campaign_id;$scope.identifier=$scope.campaign_id;var disqus_url=$location.absUrl();if(window.DISQUS)$('<div id="disqus_thread"></div>').insertAfter("#insert_disqus"),DISQUS.reset({reload:!0,config:function(){this.page.identifier=disqus_identifier,this.page.url=disqus_url}});else if($scope.disqus_shortname){$('<div id="disqus_thread"></div>').insertAfter("#insert_disqus"),window.disqus_identifier=disqus_identifier,window.disqus_url=disqus_url;var dsq=document.createElement("script");dsq.type="text/javascript",dsq.async=!0,dsq.src="//"+$scope.disqus_shortname+".disqus.com/embed.js",$("head").append(dsq)}}))):"custom"==$scope.comment_system&&($scope.comments_show_comment_picture=success.public_setting.custom_comment_show_comment_picture,$scope.getComments(),$scope.comments_background_style={"background-color":"#"+success.public_setting.custom_comment_comment_background_color,"font-family":success.public_setting.custom_comment_font_family},$scope.comments_font_color={color:"#"+success.public_setting.custom_comment_font_color},success.public_setting.custom_comment_auto_refresh&&setInterval((function(){$scope.getComments()}),6e4)),Restangular.one("campaign").customGET($scope.campaign_id,{use_path_lookup:/campaign\/private/.test($rootScope.currentLoc)?1:0,path:$rootScope.currentLoc.substring(1)}).then((function(success){$location.hash()&&$timeout((function(){$anchorScroll()})),$scope.profileTypes=[{name:"Campaign",profile_type_id:1},{name:"FAQ",profile_type_id:2},{name:"Backers",profile_type_id:3},{name:"Streams",profile_type_id:4},{name:"Comments",profile_type_id:5}],$scope.campaign=success,$scope.embed_path=$location.absUrl(),$scope.embed_path=$scope.embed_path.replace(window.b,"/embed/card-view/"+$scope.campaign.entry_id),CampaignSettingsService.processSettings($scope.campaign.settings);var campaignSettings=CampaignSettingsService.getSettings();if(null==campaignSettings||!campaignSettings.enable_rewards_pagination&&campaignSettings.hasOwnProperty("enable_rewards_pagination")?$scope.rewardPagination={page:1,page_entries:9999,pagination:{numpages:1}}:($scope.progressHide=!1,$scope.public_settings.site_campaign_progress_bar_hide,$scope.progressHide=$scope.public_settings.site_campaign_progress_bar_hide,void 0!==campaignSettings.progress_bar_hide&&($scope.progressHide=campaignSettings.progress_bar_hide),$scope.rewardPagination={page:1,page_entries:5,pagination:{numpages:1}}),Restangular.one("account/person",$scope.campaign.managers[0].id).customGET().then((function(success){$scope.managerInfo=success})),$scope.public_settings.site_campaign_enable_organization_name&&Restangular.one('portal/person/attribute?filters={"person_id":"'+$scope.campaign.managers[0].id+'"}').customGET().then((function(success){$scope.organization_name.value=success[0].attributes.organization_name,$scope.organization_name.ein=success[0].attributes.ein})),$scope.campaign.pledges){var requiredNumCalls=parseInt($scope.campaign.pledges.length/$scope.rewardPagination.page_entries);$scope.campaign.pledges.length%$scope.rewardPagination.page_entries!=0&&(requiredNumCalls+=1),$scope.rewardPagination.pagination.numpages=requiredNumCalls,$scope.filterRewards()}switch($scope.public_settings.site_campaign_sharing_options){case SOCIAL_SHARING_OPTIONS.sharing_users:$scope.is_sharing_available=!0;break;case SOCIAL_SHARING_OPTIONS.sharing_backers:$scope.is_sharing_available=!1,$scope.campaign.managers[0].id!=$scope.user.id&&1!=$scope.user.person_type_id||($scope.is_sharing_available=!0);break;case SOCIAL_SHARING_OPTIONS.sharing_disabled:$scope.is_sharing_available=!1;break;default:$scope.is_sharing_available=!0}void 0!==$scope.public_settings.site_campaign_exclude_shipping_cost&&$scope.public_settings.site_campaign_exclude_shipping_cost&&($scope.campaign.funded_amount=$scope.campaign.funded_amount-$scope.campaign.total_shipping_cost),angular.forEach($scope.campaign.settings,(function(value,index){var setting_name=value.name,setting_value=value.value;"name"!=setting_name&&($scope.campaign[setting_name]=setting_value,$scope.campaign.profile_type_view_id||($scope.campaign.profile_type_view_id=0),$scope.campaign.hide_contribute_button_per_campaign&&($scope.hideThisContribButton=$scope.campaign.hide_contribute_button_per_campaign))})),native_lookup&&$scope.campaign.cities&&$scope.campaign.cities.forEach((function(value){getNativeName(value)})),CampaignSettingsService.setCampaignId($scope.campaign_id),CampaignSettingsService.processSettings(success.settings),$scope.campaign.settings=CampaignSettingsService.getSettings(),$scope.campaign.settings.top_header_link&&$scope.campaign.settings.top_header_link.length<=0&&($scope.campaign.settings.top_header_link="#"),"#"==$scope.campaign.settings.top_header_link&&delete $scope.campaign.settings.top_header_link,$scope.campaign.settings.google_analytics_id&&setGACode($scope.campaign.settings.google_analytics_id),$scope.remaining_time=$scope.campaign.time_remaining,$scope.days_rem=$scope.campaign.days_remaining_inclusive,$scope.campaign.timezoneText=moment().tz($scope.campaign.timezone).zoneAbbr(),$translate(["seconds_to_go","second_to_go","seconds_ago","second_ago","minutes_to_go","minute_to_go","minutes_ago","minute_ago","hours_to_go","hour_to_go","hours_ago","hour_ago"]).then((function(values){0==$scope.days_rem?($scope.days_rem=$scope.campaign.hours_remaining_inclusive,0==$scope.days_rem?($scope.days_rem=$scope.campaign.minutes_remaining_inclusive,0==$scope.days_rem?($scope.days_rem=$scope.campaign.seconds_remaining_inclusive,$scope.days_rem>=1?$scope.days_rem>1?$scope.day_text=values.seconds_to_go:$scope.day_text=values.second_to_go:($scope.days_rem=-1*$scope.days_rem,$scope.days_rem>1?$scope.day_text=values.seconds_ago:$scope.day_text=values.second_ago)):$scope.days_rem>=1?$scope.days_rem>1?$scope.day_text=values.minutes_to_go:$scope.day_text=values.minute_to_go:($scope.days_rem=-1*$scope.days_rem,$scope.days_rem>1?$scope.day_text=values.minutes_ago:$scope.day_text=values.minute_ago)):$scope.days_rem>=1?$scope.days_rem>1?$scope.day_text=values.hours_to_go:$scope.day_text=values.hour_to_go:($scope.days_rem=-1*$scope.days_rem,$scope.days_rem>1?$scope.day_text=values.hours_ago:$scope.day_text=values.hour_ago)):$scope.days_rem>=1?$scope.days_rem>1?$scope.day_text=" days to go":$scope.day_text=" day to go":($scope.days_rem=-1*$scope.days_rem,$scope.days_rem>1?$scope.day_text="days ago":$scope.day_text="day ago")}));var elapsedSecond=$scope.campaign.seconds_elapsed,elapsedMinute=elapsedSecond/60,elapsedHour=elapsedMinute/60,elapsedDay=elapsedHour/24,elapsedMonth=elapsedDay/30,elapsedYear=elapsedMonth/12;if(elapsedYear>=1?($scope.duration=Math.floor(elapsedYear),$scope.duration>1?$scope.dtype="years":$scope.dtype="year"):elapsedMonth>=1?($scope.duration=Math.floor(elapsedMonth),$scope.duration>1?$scope.dtype="months":$scope.dtype="month"):elapsedDay>=1?($scope.duration=Math.floor(elapsedDay),$scope.duration>1?$scope.dtype="days":$scope.dtype="day"):elapsedHour>=1?($scope.duration=Math.floor(elapsedHour),$scope.duration>1?$scope.dtype="hours":$scope.dtype="hour"):elapsedMinute>=1?($scope.duration=Math.floor(elapsedMinute),$scope.duration>1?$scope.dtype="minutes":$scope.dtype="minute"):elapsedSecond>=1&&($scope.duration=Math.floor(elapsedSecond),$scope.duration>1?$scope.dtype="seconds":$scope.dtype="second"),msg={header:"Maximum funding goal has been reached for this campaign"},$scope.campaign.maximum_allowed_funds_raised?$scope.campaign.funded_amount>=$scope.campaign.maximum_allowed_funds_raised?($scope.thresholdallowed=!0,$scope.thresholdallowedbtn=!0,$scope.successMessage.push(msg)):($scope.thresholdallowedbtn=!1,$scope.thresholdallowed=!0):($scope.thresholdallowed=!1,$scope.thresholdallowedbtn=!1),$scope.FAQ=success.faqs,success.faqs&&($scope.faqs=success.faqs.length),$scope.campaign.campaign_links=[],success.links&&angular.forEach(success.links,(function(value){1==value.region_id&&1==value.resource_content_type_id&&"link"==value.resource_type&&($scope.campaign.video=value.uri.replace(/https?:\/\//gi,$location.protocol()+"://"),VideoLinkService.processVideoLink($scope.campaign.video,""),$scope.campaign.video_type=VideoLinkService.get_video_type(),"custom"==$scope.campaign.video_type&&($scope.campaign.video=VideoLinkService.get_video_link())),2==value.region_id&&$scope.campaign.campaign_links.push(value)})),success.ends&&$scope.dateInPast(success.ends,success.seconds_remaining)&&($scope.disabled=!0),success.description||($scope.noDescription=!0),success.files){var hasMainImage=!1;angular.forEach(success.files,(function(value){3!=value.region_id||(hasMainImage=!0)})),hasMainImage||($scope.noMainImage=!0)}else $scope.noMainImage=!0;if($scope.backers_pagination={sort:"-created",page_entries:10,page_limit:100,page:1,pagination:{}},$scope.campaign.backers=[],$scope.getBackers=function(){RestFullResponse.all("campaign/"+success.entry_id+"/backer").getList($scope.backers_pagination).then((function(success){$scope.campaign.backers=success.data;var headers=success.headers();headers["x-pager-total-entries"]?$scope.campaign.backer_offset?$scope.backer_length=parseInt(headers["x-pager-total-entries"])+parseInt($scope.campaign.backer_offset):$scope.backer_length=parseInt(headers["x-pager-total-entries"]):$scope.backer_length="0",$scope.backers_pagination.currentpage=headers["x-pager-current-page"],$scope.backers_pagination.numpages=headers["x-pager-last-page"],$scope.backers_pagination.nextpage=headers["x-pager-next-page"],$scope.backers_pagination.pagesinset=headers["x-pager-pages-in-set"],$scope.backers_pagination.totalentries=headers["x-pager-total-entries"],$scope.backers_pagination.entriesperpage=headers["x-pager-entries-per-page"]})).then((function(){null!=$scope.public_settings.site_theme_campaign_backer_option?("2"==$scope.public_settings.site_theme_campaign_backer_option&&($scope.hideb=!0,$scope.showBacker=0),"1"==$scope.public_settings.site_theme_campaign_backer_option&&($scope.showBacker=1,$scope.validUser=1),"0"==$scope.public_settings.site_theme_campaign_backer_option&&($scope.showBacker=0,$scope.validUser=1),"3"==$scope.public_settings.site_theme_campaign_backer_option&&($scope.user.auth_token?($scope.showBacker=1,$scope.validUser=1):($scope.showBacker=0,$scope.validUser=0))):($scope.showBacker=1,$scope.validUser=1),$scope.backer_show=($scope.showBacker||($scope.showBacker||$scope.campaign.backers.length)&&"2"!=$scope.public_settings.site_theme_campaign_backer_option)&&$scope.validUser}))},$scope.getBackers(),$scope.campaign.streams=[],RestFullResponse.all("campaign/"+success.entry_id+"/stream").getList($scope.stream_filter).then((function(success){$scope.campaign.streams=success.data;var headers=success.headers();if($scope.stream_pagination.currentpage=headers["x-pager-current-page"],$scope.stream_pagination.numpages=headers["x-pager-last-page"],$scope.stream_pagination.nextpage=headers["x-pager-next-page"],$scope.stream_pagination.pagesinset=headers["x-pager-pages-in-set"],$scope.stream_pagination.totalentries=headers["x-pager-total-entries"],$scope.stream_pagination.entriesperpage=headers["x-pager-entries-per-page"],$scope.public_settings.site_campaign_updates_display&&$location.search().stream){var stream_id=$location.search().stream;setTimeout((function(){angular.element("#campaign").click(),angular.element("#streams").click(),$element.find("#stream-"+stream_id)[0].scrollIntoView()}),0)}})),$scope.checklink=function(){var translate=$translate.instant(["campaign_page_campaigntitle","campaign_page_faq","campaign_page_rewardstitle","campaign_page_backers","campaign_page_streams","campaign_page_comments","campaign_page_files"]);if($location.hash())switch($("#campaign").removeClass("active"),$("#campaign-seg").removeClass("active"),$location.hash()){case translate.campaign_page_faq:$scope.campaign.faqs&&void 0!==$scope.campaign.faqs[0]&&$scope.campaign.faqs[0].faq_pairs.length,$(".menu-tabs .item").removeClass("active"),$("#faq").addClass("active"),$("#mobile-faq").addClass("active"),$("#faq-seg").addClass("active");break;case translate.campaign_page_backers:$(".menu-tabs .item").removeClass("active"),$("#backer").addClass("active"),$("#mobile-backer").addClass("active"),$("#backer-seg").addClass("active");break;case translate.campaign_page_streams:$(".menu-tabs .item").removeClass("active"),$("#stream").addClass("active"),$("#mobile-stream").addClass("active"),$("#stream-seg").addClass("active");break;case translate.campaign_page_comments:$(".menu-tabs .item").removeClass("active"),$("#comment").addClass("active"),$("#mobile-comment").addClass("active"),$("#comment-seg").addClass("active");break;case translate.campaign_page_campaigntitle:$(".menu-tabs .item").removeClass("active"),$("#campaign").addClass("active"),$("#mobile-campaign").addClass("active"),$("#campaign-seg").addClass("active");break;case translate.campaign_page_rewardstitle:$(".menu-tabs .item").removeClass("active"),$("#rewards").addClass("active"),$("#mobile-rewards").addClass("active"),$("#rewards-seg").addClass("active");break;case translate.campaign_page_files:$(".menu-tabs .item").removeClass("active"),$("#file").addClass("active"),$("#mobile-file").addClass("active"),$("#file-seg").addClass("active")}},setTimeout((function(){$scope.checklink()}),500),$scope.makeLink=function(id){var linkpath=$location.path();$location.path(linkpath).hash(id).replace(),$scope.hashcheck=$location.hash()},$scope.toggleHash=function(selectedItemKey){var translatedKey=$translate.instant(selectedItemKey);$location.search("").replace(),$scope.makeLink(translatedKey),$scope.checklink()},$rootScope.page_title=$scope.campaign.name?$scope.campaign.name+" - "+$rootScope.site_company:$rootScope.site_company,$rootScope.ogMeta.title=$rootScope.page_title,$scope.campaign.files){for(var max_id=-1,image_index=-1,i=0;i<$scope.campaign.files.length;i++)3===$scope.campaign.files[i].region_id&&$scope.campaign.files[i].id>max_id&&(max_id=$scope.campaign.files[i].id,image_index=i);$rootScope.ogMeta.image=$scope.server+"/image/campaign_detail_large/"+$scope.campaign.files[image_index].path_external}Restangular.one("portal/setting").getList().then((function(success){$scope.public_settings={},$scope.public_settings.site_theme_campaign_display_iso_date=success.site_theme_campaign_display_iso_date,angular.forEach(success,(function(value){3==value.setting_type_id&&($scope.public_settings[value.name]=value.value)})),void 0!==$scope.public_settings.site_campaign_custom_button&&null!=$scope.public_settings.site_campaign_custom_button||($scope.public_settings.site_campaign_custom_button={toggle:!1,reward:"Choose Reward",contribution:"Contribution"}),$scope.customText=$scope.public_settings.site_campaign_custom_button,$scope.contribution=$scope.customText.contribution;var currency=$filter("formatCurrency")($scope.public_settings.site_theme_campaign_min_contribute_amount,$scope.campaign.currencies[0].code_iso4217_alpha,$scope.public_setting.site_campaign_decimal_option);1==$scope.customText.toggle&&$scope.contribution.indexOf("[min]")>-1&&($scope.contribution=$scope.contribution.replace("[min]",currency)),$scope.public_settings.site_theme_campaign_min_button_show?$scope.minamount=$scope.public_settings.site_theme_campaign_min_contribute_amount:$scope.minamount=1,void 0!==$scope.public_settings.site_theme_campaign_per_min&&$scope.public_settings.site_theme_campaign_per_min&&void 0!==$scope.campaign.min_contribution&&($scope.minamount=$scope.campaign.min_contribution),void 0!==$scope.public_settings.site_theme_campaign_faq_option?("2"==$scope.public_settings.site_theme_campaign_faq_option&&($scope.hidef=!0,$scope.showFaq=0),"1"==$scope.public_settings.site_theme_campaign_faq_option&&($scope.showFaq=1),"0"==$scope.public_settings.site_theme_campaign_faq_option&&($scope.showFaq=0)):$scope.showFaq=1,null!=$scope.public_settings.site_theme_campaign_comment_option?("2"==$scope.public_settings.site_theme_campaign_comment_option&&($scope.hidec=!0,$scope.showComment=0),"1"==$scope.public_settings.site_theme_campaign_comment_option&&($scope.showComment=1)):$scope.showComment=1,null!=$scope.public_settings.site_theme_campaign_stream_option?("2"==$scope.public_settings.site_theme_campaign_stream_option&&($scope.hides=!0,$scope.showStream=0),"1"==$scope.public_settings.site_theme_campaign_stream_option&&($scope.showStream=1),"0"==$scope.public_settings.site_theme_campaign_stream_option&&($scope.showStream=0)):$scope.showStream=1,$scope.comment_form.anonymous=$scope.public_settings.custom_comment_anonymous_force,void 0===$scope.public_settings.site_theme_campaign_hide_min_contribute_message&&($scope.public_settings.site_theme_campaign_hide_min_contribute_message=!1),1==$scope.user.person_id||$scope.user.person_id==$scope.campaign.managers[0].person_id?$scope.validUser=1:$scope.validUser=0}),(function(failure){$msg={header:failure.data.message},$scope.errorMessage.push($msg)})),$scope.$emit("loading_finished"),1==$location.search().scroll_to_reward&&($scope.displayRewardsMobileTab&&$(window).width()<767?$scope.scrollToMobileRewardsTab():$scope.scrollToRewards())}),(function(failure){$location.path("404")}))})),$scope.sortOrFiltersComments={sort:"-created",page_entries:5,page_limit:100,page:1,pagination:{}},$scope.getComments=function(comment_id,sort_order){if(sort_order&&($scope.sortOrFiltersComments.sort=sort_order),comment_id)return Restangular.one("campaign/"+$scope.campaign_id+"/comment/"+comment_id).customGET();RestFullResponse.one("campaign/"+$scope.campaign_id).customGET("comment",$scope.sortOrFiltersComments).then((function(success){$scope.comments=success.data,$scope.comments.forEach((function(comment,index){var secondsElapsed=(Date.now()-Date.parse(comment.created))/1e3,timePeriod="",timeNumber=0;secondsElapsed<60?(timeNumber="",timePeriod="custom_comment_time_less_minute"):secondsElapsed<3600?(timePeriod=1==(timeNumber=parseInt(secondsElapsed/60))?"custom_comment_time_a_minute":"custom_comment_time_minute",$scope.comments[index].timeAgo=timePeriod):secondsElapsed<86400?(timePeriod=1==(timeNumber=parseInt(secondsElapsed/3600))?"custom_comment_time_a_hour":"custom_comment_time_hour",$scope.comments[index].timeAgo=timePeriod):secondsElapsed<604800?(timePeriod=1==(timeNumber=parseInt(secondsElapsed/86400))?"custom_comment_time_a_day":"custom_comment_time_day",$scope.comments[index].timeAgo=timePeriod):secondsElapsed<2592e3?(timePeriod=1==(timeNumber=parseInt(secondsElapsed/604800))?"custom_comment_time_a_week":"custom_comment_time_week",$scope.comments[index].timeAgo=timePeriod):secondsElapsed<31557600?(timePeriod=1==(timeNumber=parseInt(secondsElapsed/2592e3))?"custom_comment_time_a_month":"custom_comment_time_month",$scope.comments[index].timeAgo=timePeriod):(timePeriod=1==(timeNumber=parseInt(secondsElapsed/31557600))?"custom_comment_time_a_year":"custom_comment_time_year",$scope.comments[index].timeAgo=timePeriod),$scope.comments[index].timeNumber=1==timeNumber?"":timeNumber,$scope.comments[index].timePeriod=timePeriod}));var headers=success.headers();$scope.sortOrFiltersComments.pagination.currentpage=headers["x-pager-current-page"],$scope.sortOrFiltersComments.pagination.numpages=headers["x-pager-last-page"],$scope.sortOrFiltersComments.pagination.nextpage=headers["x-pager-next-page"],$scope.sortOrFiltersComments.pagination.pagesinset=headers["x-pager-pages-in-set"],headers["x-pager-total-entries"]?$scope.sortOrFiltersComments.pagination.totalentries=headers["x-pager-total-entries"]:$scope.sortOrFiltersComments.pagination.totalentries=0,$scope.sortOrFiltersComments.pagination.entriesperpage=headers["x-pager-entries-per-page"]}))},$scope.moment=function(value,suffix){return moment(value).fromNow(suffix)},$scope.daysEndDateInPast=function(daysEnd,ends,seconds_remaining){return 1!=daysEnd&&(!(!seconds_remaining||!ends)&&!$scope.dateInPast(ends,seconds_remaining))},$scope.dateInPast=function(value,sec){return 0==sec||"00"==sec||sec<0},$scope.rewardExpired=function(value){if(value){var temp=value.split(" "),rewardDateVal=temp[0].replace(/-/g,"/")+" "+temp[1],today_date=(new Date).toDateString();return new Date(rewardDateVal).toDateString()==today_date}return!1},$scope.filterRewards=function(){var startindex=($scope.rewardPagination.page-1)*$scope.rewardPagination.page_entries,endindex=startindex+$scope.rewardPagination.page_entries;$scope.campaign.pledges_to_show=angular.copy($scope.campaign.pledges),$scope.campaign.pledges_to_show=$scope.campaign.pledges_to_show.slice(startindex,endindex),$scope.customText.toggle&&angular.forEach($scope.campaign.pledges_to_show,(function(value,key,obj){obj[key].rewardCustom=$scope.customText.reward;var currency=$filter("formatCurrency")(obj[key].amount,$scope.campaign.currencies[0].code_iso4217_alpha,$scope.public_setting.site_campaign_decimal_option);1==$scope.customText.toggle&&(obj[key].rewardCustom.indexOf("[reward]")>-1&&(obj[key].rewardCustom=obj[key].rewardCustom.replace("[reward]",currency)))}))},Restangular.one("campaign",$scope.campaign_id).one("note").customGET().then((function(success){success&&success.length&&($scope.note=success[0].value,$scope.note.id=success[0].id)})),$scope.$emit("loading_finished"),$scope.addNotes=function(fieldName,key){$translate(fieldName).then((function(value){$scope.noteFieldName=value})),$scope.noteFieldKey=key,$(".ui.modal.admin-notes").modal("show")},$scope.saveNote=function(){var data={value:$scope.note};$scope.note.id?Restangular.one("campaign",$scope.campaign_id).one("note",$scope.note.id).customPUT(data):Restangular.one("campaign",$scope.campaign_id).one("note",$scope.note.id).customPOST(data)},$scope.action=function(actionName){var data={entry_status_id:""};msg={loading:!0,loading_message:"updating_campaign_status"},$rootScope.floatingMessage=msg,"approve"==actionName?(data.entry_status_id=2,Restangular.one("campaign",$scope.campaign_id).customPUT(data).then((function(success){msg={header:"approve_campaign"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}),(function(failure){msg={header:failure.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}))):"disapprove"==actionName&&(data.entry_status_id=3,Restangular.one("campaign",$scope.campaign_id).customPUT(data).then((function(success){msg={header:"disapprove_campaign"},$rootScope.floatingMessage=msg}),(function(failure){msg={header:failure.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()})))},$scope.removeNote=function(fieldName){$scope.note[fieldName]="",$scope.saveNote()},$scope.dateInPast=function(value,sec){return 0==sec||"00"==sec||sec<0},$scope.toggleFeaturedMedia=function(media){"image"==media&&($scope.featuredMedia=!0),"video"==media&&($scope.featuredMedia=!1)},$scope.toggleCampaignTab=function(tab){"campaign"==tab&&($scope.campaignTab=!0),"faq"==tab&&($scope.campaignTab=!1)},$scope.makeLink=function(id){var linkpath=$location.path();$location.path(linkpath).hash(id).replace(),$scope.hashcheck=$location.hash()},$scope.showManager=function(){$window.open("profile/"+$scope.campaign.managers[0].person_id)},$scope.getTotalStream=function(){var tmp=parseInt($scope.stream_pagination.entriesperpage)*parseInt($scope.stream_filter.page_limit);return tmp>$scope.stream_pagination.totalentries?$scope.stream_pagination.totalentries:tmp},$scope.toDate=function(str){if(str&&str.length){var d=str.substring(0,10),lst=str.substring(0,10).split("-"),time=str.substring(11,16);new Date(lst[0],lst[1]-1,lst[2]);return d+"  "+time}},$scope.showStreamDeail=function(stream,index){$scope.stream=stream,$scope.stream.sindex=index,$location.search("stream",stream.id).replace()},(params=$location.search()).stream&&($("#campaign-tabs .ui.menu .item").tab("change tab","streams"),$scope.show_section.streamDetail=!0,Restangular.one("campaign",$scope.campaign_id).one("stream",params.stream).customGET().then((function(success){$scope.stream=success}))),$scope.scrollToRewards=function(){$timeout((function(){$("html, body").animate({scrollTop:$("#campaign-seg #rewards-list").offset().top-15},500)}),800)},$scope.scrollToMobileRewardsTab=function(){var rewardsString=$translate.instant("campaign_page_rewardstitle");$timeout((function(){$location.hash()!==rewardsString&&($location.search("").replace(),$scope.makeLink(rewardsString),$scope.checklink()),$("html, body").animate({scrollTop:$("#rewards-seg #rewards-list").offset().top-15},500)}),800)}}]);