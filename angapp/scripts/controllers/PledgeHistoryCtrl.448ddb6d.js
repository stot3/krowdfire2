app.controller("PledgeHistoryCtrl",["$routeParams","$location","$timeout","$translatePartialLoader","$translate","$scope","$rootScope","RestFullResponse","UserService","Restangular","RESOURCE_REGIONS","RequestCacheService","PortalSettingsService","CampaignSettingsService",function($routeParams,$location,$timeout,$translatePartialLoader,$translate,$scope,$rootScope,RestFullResponse,UserService,Restangular,RESOURCE_REGIONS,RequestCacheService,PortalSettingsService,CampaignSettingsService){$scope.RESOURCE_REGIONS=RESOURCE_REGIONS;var user=UserService;$scope.rewardAttr=[],$scope.replaceValidated=!1,$scope.toggle={},$scope.selectedRewards=[],$scope.rewardQueue=[],$scope.sortOrFiltersCampaign={sort:"",filters:{category:{},entry_status_id:[],backer:user.person_id},page_entries:10,page_limit:100,pagination:{},page:1},$scope.totalentry=[10,25,40,55,70];var msg,today_date=new Date,offset=today_date.getTimezoneOffset();function filterCampaign(filter){RestFullResponse.all("campaign").getList(filter).then((function(success){!function(){var pageparam=1==$routeParams.page||1==$scope.sortOrFiltersCampaign.page?null:$scope.sortOrFiltersCampaign.page;"object"==typeof $scope.sortOrFiltersCampaign.filters.category?$location.search("category",null):$location.search("category",$scope.sortOrFiltersCampaign.filters.category);$location.search("name",$scope.sortOrFiltersCampaign.filters.name||null),$location.search("page",pageparam)}(),$scope.campaigns=success.data.plain(),angular.forEach($scope.campaigns,(function(campaignValue){Restangular.one("campaign",campaignValue.id).one("pledge").customGET().then((function(pledge){campaignValue.pledge_details=pledge.plain()})),angular.forEach(campaignValue.files,(function(fileValue,index){"Campaign Thumbnail"==fileValue.region_name&&fileValue.path_external&&(campaignValue.campaign_thumb_url=fileValue.path_external)}))}));var headers=success.headers();$scope.sortOrFiltersCampaign.pagination.currentpage=headers["x-pager-current-page"],$scope.sortOrFiltersCampaign.pagination.numpages=headers["x-pager-last-page"],$scope.sortOrFiltersCampaign.pagination.nextpage=headers["x-pager-next-page"],$scope.sortOrFiltersCampaign.pagination.pagesinset=headers["x-pager-pages-in-set"],$scope.sortOrFiltersCampaign.pagination.totalentries=headers["x-pager-total-entries"],$scope.sortOrFiltersCampaign.pagination.entriesperpage=headers["x-pager-entries-per-page"]}))}today_date.setMinutes(today_date.getMinutes()-offset),$scope.today=today_date.toISOString().substring(0,19).replace("T"," "),$scope.campaign_status=["tab_pledge_filter_all","tab_pledge_filter_campaign_running","tab_pledge_filter_campaign_ended"],$scope.sortOrFiltersCampaign.filters.category=$routeParams.category||$scope.sortOrFiltersCampaign.filters.category,$scope.sortOrFiltersCampaign.filters.entry_status_id=$routeParams.status||$scope.sortOrFiltersCampaign.filters.entry_status_id,$scope.sortOrFiltersCampaign.filters.name=$routeParams.name||$scope.sortOrFiltersCampaign.filters.name,$scope.sortOrFiltersCampaign.page=$routeParams.page||1,filterCampaign($scope.sortOrFiltersCampaign),PortalSettingsService.getSettingsObj().then((function(success){$scope.portalsetting=success,$scope.isISODate=success.public_setting.site_theme_campaign_display_iso_date,void 0===success.public_setting.site_campaign_pledge_update&&(success.public_setting.site_campaign_pledge_update=!1),void 0===success.public_setting.site_campaign_withdraw_hide&&(success.public_setting.site_campaign_withdraw_hide=!1),$scope.campaignWithdrawContribution=success.public_setting.site_campaign_withdraw_hide,$scope.campaignPledgeReplace=success.public_setting.site_campaign_pledge_update})),RequestCacheService.getCategory().then((function(success){$scope.categories=success,$rootScope.checkpledgehistory=$scope.categories})),Restangular.one("campaign").all("status").getList().then((function(success){$scope.campaignStatus=success})),$scope.searchCampaign=function(word){$scope.sortOrFiltersCampaign.filters.name=word,filterCampaign($scope.sortOrFiltersCampaign)},$scope.updateFiltersCampaignCategory=function(category){$scope.sortOrFiltersCampaign.filters.category=category,filterCampaign($scope.sortOrFiltersCampaign)},$scope.updateFiltersCampaignStatus=function(status){$scope.sortOrFiltersCampaign.filters.entry_status_id=status.id,filterCampaign($scope.sortOrFiltersCampaign)},$scope.checkentry=function(){$scope.entries=$("#searchbtn").dropdown("get value"),$scope.sortOrFiltersCampaign.page_entries=$scope.entries,filterCampaign($scope.sortOrFiltersCampaign)},$scope.updateFiltersCampaignOrder=function(order){$scope.sortOrFiltersCampaign.sort=order,filterCampaign($scope.sortOrFiltersCampaign)},$scope.selectStatus=function(index){0==index?$scope.sortOrFiltersCampaign.filters.entry_status_id="":1==index?$scope.sortOrFiltersCampaign.filters.entry_status_id=[1,2,4]:2==index&&($scope.sortOrFiltersCampaign.filters.entry_status_id=[5,6,7,8,9]),filterCampaign($scope.sortOrFiltersCampaign)},$scope.openPledgeDetail=function(parent,index,campaignIndex){[2,5,6,7,8,9,13].indexOf(parent.campaign.entry_status_id)>-1?$scope.hideWithdraw=!0:$scope.hideWithdraw=!1,$scope.parentIndex=parent.$index,$scope.pledgeDetails=parent.$parent.campaign,CampaignSettingsService.setCampaignId($scope.pledgeDetails.entry_id),CampaignSettingsService.processSettings($scope.pledgeDetails.settings),$scope.pledgeDetails.settings=CampaignSettingsService.getSettings(),$scope.detailIndex=index,$timeout((function(){$("#pledge-details").modal("show")}),100),$scope.currentCampaign={currency:$scope.campaigns[campaignIndex].currencies[0],id:$scope.campaigns[campaignIndex].id,pledge:$scope.campaigns[campaignIndex].pledges,pledgeDetailId:$scope.campaigns[campaignIndex].pledge_details[index].id,amount:$scope.campaigns[campaignIndex].pledge_details[index].amount},Restangular.one("campaign",$scope.currentCampaign.id).customGET().then((function(success){$scope.currentCampaign.pledge=success.pledges})),null!==$scope.currentCampaign.pledge?$scope.isThereRewards=!0:$scope.isThereRewards=!1},$scope.openModalById=function(id){$(".ui.modal#"+id).modal("show")},$scope.deletePledge=function(){msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg,Restangular.one("campaign",$scope.pledgeDetails.id).one("pledge",$scope.pledgeDetails.pledge_details[$scope.detailIndex].id).customDELETE().then((function(success){msg={header:"action_success"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}))},$scope.sortByDate=function(){$scope.toggle.created=!$scope.toggle.created,$scope.toggle.created?$scope.sortOrFiltersCampaign.sort="created":$scope.sortOrFiltersCampaign.sort="-created",filterCampaign($scope.sortOrFiltersCampaign)},$scope.filterCampaign=function(){filterCampaign($scope.sortOrFiltersCampaign)},$scope.$emit("loading_finished"),$scope.getPledges=function(campaignID){Restangular.one("campaign",campaignID).one("pledge").customGET().then((function(pledges){$scope.pledge_histories=pledges}))},$scope.rewardSelected=function(data){$scope.currentReward=$scope.currentCampaign.pledge[data],$scope.rewardAttr="";var exists=!1;angular.forEach($scope.selectedRewards,(function(value){value.pledge_level_id==$scope.currentReward.pledge_level_id&&(exists=!0)})),exists||$scope.selectedRewards.push($scope.currentReward)},$scope.chooseReward=function(reward){reward.quantity?(reward.quantity++,angular.forEach($scope.rewardQueue,(function(value,key,obj){value.name==reward.name&&(obj[key].quantity=reward.quantity)}))):reward.quantity=1,1==reward.quantity&&$scope.rewardQueue.push(reward)},$scope.removeReward=function(reward){angular.forEach($scope.rewardQueue,(function(value,key,obj){if(reward.pledge_level_id==value.pledge_level_id&&1==reward.quantity)return $scope.rewardQueue.splice(key,1),void(reward.quantity=0);reward.pledge_level_id==value.pledge_level_id&&obj[key].quantity--}))},$scope.replaceContribution=function(){$("#replace-contribution-modal").modal({closable:!1}).modal("show"),$scope.hideInitialModal=!0},$scope.amountModalView=function(){$scope.isAmountContribution=!0,$scope.isRewardsContribution=!1,$scope.hideInitialModal=!1},$scope.rewardsModalView=function(){$scope.currentCampaign.pledge.length&&$scope.rewardSelected(0),$scope.isRewardsContribution=!0,$scope.isAmountContribution=!1,$scope.hideInitialModal=!1},$scope.replacementClose=function(){$scope.isRewardsContribution=!1,$scope.isAmountContribution=!1,$scope.currentReward=null,$scope.contributionValue=null,$scope.rewardQueue=[],$scope.totalReplaced=0,$scope.replaceValidated=!1,$("#replace-contribution-modal").modal("hide")},$scope.submitReplacement=function(){$scope.replacedRewards=[],$scope.totalAmount=0,$scope.submitReplacement.amount&&($scope.totalAmount+=parseInt($scope.submitReplacement.amount)),angular.forEach($scope.selectedRewards,(function(value){value.quantity>0&&($scope.replacedRewards.push({plid:value.pledge_level_id,pledge_name:value.name,pledge_amount:value.amount,quantity:value.quantity,selected_attr:value.selectedAttr}),$scope.totalAmount+=value.amount*value.quantity)}));var redirect={},count=0;redirect.eid=$scope.currentCampaign.id,redirect.m=$scope.submitReplacement.amount?$scope.submitReplacement.amount:0,redirect.r=$scope.currentCampaign.pledgeDetailId,angular.forEach($scope.replacedRewards,(function(value){redirect["plid_"+count++]=value.plid,redirect[value.plid+"_quantity"]=value.quantity,redirect[value.plid+"_amount"]=value.pledge_amount})),$location.path("/pledge-campaign").search(redirect),$scope.replaceCheckout=!0,$scope.isRewardsContribution=!1,$scope.isAmountContribution=!1,$scope.rewardQueue=[],$scope.totalReplaced=0,$scope.replaceValidated=!1,$scope.replacementClose()},$scope.$watch("[submitReplacement.amount, currentReward.quantity]",(function(newValue){var sumitReplaceAmount=parseInt(newValue[0]),total=0;0!=sumitReplaceAmount&&(total+=sumitReplaceAmount),$scope.rewardQueue&&(total||(total=0),angular.forEach($scope.rewardQueue,(function(value){total+=parseInt(value.amount)*value.quantity}))),$scope.totalReplaced=total,$scope.replaceValidated=!!($scope.currentCampaign&&$scope.totalReplaced>=$scope.currentCampaign.amount)}))}]);