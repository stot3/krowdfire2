app.controller("CreateCampaignCtrl",["$q","$location","$routeParams","$rootScope","$scope","$interval","$timeout","$translatePartialLoader","$translate","$http","APICampaign","APIPortal","APILocale","API_URL","RESOURCE_REGIONS","UserService","CreateCampaignService","Restangular","Geolocator","$upload","CurrencyService","FileUploadService","ngQuickDateDefaults","PortalSettingsService","CampaignSettingsService","RestFullResponse",function($q,$location,$routeParams,$rootScope,$scope,$interval,$timeout,$translatePartialLoader,$translate,$http,APICampaign,APIPortal,APILocale,API_URL,RESOURCE_REGIONS,UserService,CreateCampaignService,Restangular,Geolocator,$upload,CurrencyService,FileUploadService,ngQuickDateDefaults,PortalSettingsService,CampaignSettingsService,RestFullResponse){var msg;$scope.urlHost=$location.protocol()+"://"+$location.host()+"/",$scope.clearMessage=function(){$rootScope.floatingMessage=[]},$scope.urlHost=$location.protocol()+"://"+$location.host()+"/",$scope.clearMessage=function(){$rootScope.floatingMessage=[]};var reward_priority=-1,countriesWithShippingStatus=[];$scope.froalaOptionsCampaigns={},$scope.organization_name={},$scope.thresholdvalue={value:0};var reqDeleteFileArr=[];$scope.currentUploadFile={title:"",description:"",fileName:"",icon:"file",path:"",resourceId:-1},$scope.user=UserService,Restangular.one('portal/person/attribute?filters={"person_id":"'+$scope.user.id+'"}').customGET().then((function(success){success[0].attributes&&1==success[0].attributes.trulioo_verified&&($rootScope.verified=!0)}));$location.absUrl().replace($location.path(),"");$scope.top_header_protocals=[{value:"http://"},{value:"https://"},{value:"Relative Path"}],$scope.top_header_link_default_protocal=$scope.top_header_protocals[0],$scope.remove_link_protocals=function($event){$event.target.value=$event.target.value.replace("https://","").replace("http://","")},$scope.showt={value:!1},function(foption){for(var prop in $rootScope.froalaOptions)$rootScope.froalaOptions.hasOwnProperty(prop)&&(foption[prop]=$rootScope.froalaOptions[prop])}($scope.froalaOptionsCampaigns),$scope.invalidThumbnailVideo=!1,$scope.campaign=CreateCampaignService,$scope.RESOURCE_REGIONS=RESOURCE_REGIONS,$scope.currentPath=$location.path().split("/")[1],$scope.countries=$scope.$parent.countries,$scope.allCategories=[],$scope.categories=$scope.$parent.categories,$scope.subcategories=[],$scope.campaign_image="",$scope.category_ids=[],$scope.sub_category_ids={ids:[]},$scope.city={},$scope.user=UserService,$scope.cities=[],$scope.multipleCity={},$scope.campaign.rewards=[],$scope.run_mode=!0,$scope.sub_country_ids=[],$scope.runMode=[{name:"Time_Based_Campaign",id:1},{name:"Continuous_Campaign",id:2}],$scope.links=[];var initialLinks=[];function loadRunMode(){$scope.public_settings.site_campaign_defaults.toggle&&2==$scope.public_settings.site_campaign_defaults_runMode&&($scope.runModeSelected=$scope.public_settings.site_campaign_defaults_runMode,$scope.run_mode=!1),$scope.public_settings.site_campaign_defaults.toggle&&1==$scope.public_settings.site_campaign_defaults_runMode&&($scope.runModeSelected=$scope.public_settings.site_campaign_defaults_runMode,$scope.campaign.runtime_days=1,$scope.run_mode=!0)}if($scope.campaignFundingGoal={value:0},$scope.isCampaignRevised=!1,$scope.in_revision=!1,Restangular.one("campaign",$routeParams.campaign_id).customGET().then((function(success){$scope.owner=success.managers[0]})),PortalSettingsService.getSettingsObj().then((function(success){$scope.public_settings=success.public_setting,$scope.native_lookup=$scope.public_settings.site_theme_shipping_native_lookup,$scope.reward_html_editor=success.public_setting.site_theme_campaign_reward_html_editor,$scope.default_country=$scope.public_settings.site_theme_default_shipping_country,$scope.isCampaignPercetangeEnabled=$scope.public_settings.site_theme_campaign_percentage_enabled,$scope.enableRewardVariation=$scope.public_settings.site_theme_campaign_show_reward_enable_variation,$scope.enableRewardTimeLimit=success.public_setting.site_campaign_show_reward_enable_time_limit,$scope.isRemoveTopHeaderImg=$scope.public_settings.site_campaign_remove_top_header_image,$scope.isRemoveRaiseMode=$scope.public_settings.site_campaign_remove_raise_mode,$scope.isRemoveTimePeriod=$scope.public_settings.site_campaign_remove_time_period,$scope.isRemoveCampaignLinks=$scope.public_settings.site_campaign_remove_campaign_links,$scope.isRemoveCampaignFaq=$scope.public_settings.site_campaign_remove_campaign_faq,$scope.isRemoveCampaignBio=$scope.public_settings.site_campaign_enable_campaign_bio,$scope.isRemoveCampaignGA=$scope.public_settings.site_campaign_remove_campaign_google_analytics,$scope.isStepFundingDelayed=success.public_setting.site_theme_campaign_delayed_funding_setup,$scope.direct_transaction=success.public_setting.site_campaign_fee_direct_transaction,$scope.contributionEnabled=success.public_setting.site_campaign_contributions,$scope.enableCampaignRevisions=success.public_setting.site_campaign_enable_campaign_revisions,$scope.isStepRewardDelayed=success.public_setting.site_theme_campaign_delayed_reward_setup,$scope.isExplainerTextEnabled=success.public_setting.site_campaign_enable_explainer_text,$scope.isHideDaysToGoChecked=success.public_setting.site_campaign_toggle_hide_days_to_go_by_default,$scope.showRewardsTab=success.public_setting.site_theme_campaign_show_reward_section,$scope.isFieldDisplayStacked=success.public_setting.site_campaign_creation_field_display_stacked,$scope.hideCampaignImageField=success.public_setting.site_campaign_creation_hide_campaign_image_field,$scope.hideCampaignBlurbField=success.public_setting.site_campaign_creation_hide_campaign_blurb_field,$scope.hideCampaignCategoryField=success.public_setting.site_campaign_creation_hide_campaign_category_field,$scope.hideCampaignManagerField=success.public_setting.site_campaign_creation_hide_campaign_manager_field,$scope.hideCampaignDescriptionField=success.public_setting.site_campaign_creation_hide_campaign_description_field,$scope.showCampaignImageField=success.public_setting.site_campaign_creation_show_campaign_image_field,$scope.hideStartCampaignPage=success.public_setting.site_campaign_creation_hide_start_page,$scope.hideAllCampaignRewardsFields=success.public_setting.site_campaign_creation_hide_campaign_rewards_fields,$scope.showCampaignDescription=success.public_setting.site_campaign_creation_show_campaign_description_field,$scope.displayPrevButtonHeader=success.public_setting.site_campaign_creation_display_previous_button_on_header,$scope.hideStartCampaignPage=success.public_setting.site_campaign_creation_hide_start_page,$scope.startCampaignOnCurrentDate=success.public_setting.site_campaign_creation_start_campaign_on_current_date,$scope.enableContribButtonPerCampaign=success.public_setting.site_campaign_enable_contribute_button_per_campaign,$scope.hideWithdrawButton=success.public_setting.site_campaign_withdraw_hide,getCampaignImages(),getCampaignHeaderImages(),void 0!==$scope.enableCampaignRevisions&&null!=$scope.enableCampaignRevisions||($scope.enableCampaignRevisions=!1),void 0!==$scope.public_settings.site_campaign_hide_profile&&null!=$scope.public_settings.site_campaign_hide_profile||($scope.public_settings.site_campaign_hide_profile=!1),$scope.showProfile=!$scope.public_settings.site_campaign_hide_profile,void 0===$scope.public_settings.site_campaign_defaults&&($scope.public_settings.site_campaign_defaults={hide_fundraise:!1,fundingGoal:1e8,toggle:!1,percentage_fee:10}),void 0!==$scope.public_settings.site_campaign_faq&&null!=$scope.public_settings.site_campaign_faq||($scope.public_settings.site_campaign_faq={toggle:!1}),$scope.isDisableFaq=$scope.public_settings.site_campaign_faq.toggle,$scope.isRemoveFundraise=!$scope.public_settings.site_campaign_defaults.hide_fundraise||1==$scope.user.person_type_id,$scope.public_settings.site_campaign_defaults_runMode?loadRunMode():$scope.runModeSelected=1,loadCampaignData(!1),void 0===$scope.public_settings.site_campaign_allow_thumbnail_video&&($scope.public_settings.site_campaign_allow_thumbnail_video=!0)})),$(document).ready((function(){})),$routeParams.campaign_id)var campaign_id=$routeParams.campaign_id;function reformatReward(rewards){if($scope.rewards_data=[],rewards.length>0){var count=0;angular.forEach(rewards,(function(val){var tempAttributes={};val.attributes&&(tempAttributes=val.attributes);var addressData,newAddress,rewardsModel={amount:val.amount,name:val.name,description:val.description,item_limit:val.item_limit,estimated_delivery_time:val.estimated_delivery_time,estimated_delivery_time_convert:convertDate(val.estimated_delivery_time),shipping_option_id:"",shipping:[],pledge_level_id:val.pledge_level_id,attributes:tempAttributes,expires:val.expires,priority:val.priority,coupon_id:val.coupon_id},cID=[];$scope.rewards_data.push(rewardsModel),Restangular.one("campaign",campaign_id).one("pledge-level").customGET().then((function(success){angular.forEach(success,(function(value){value.estimated_delivery_time&&(value.estimated_delivery_time_convert=convertDate(value.estimated_delivery_time)),null===value.shipping&&(value.shipping=[]);var index=$scope.rewards_data.findIndex((function(r){return r.pledge_level_id==value.pledge_level_id}));$scope.rewards_data[index].selectedCoupons=value.coupon}))})),val.shipping&&val.shipping.length>0&&(val.shipping=(addressData=val.shipping,newAddress=[],angular.forEach(addressData,(function(address){$scope.native_lookup&&(address.country_native_name&&(address.country=address.country_native_name),address.subcountry_native_name&&(address.subcountry=address.subcountry_native_name,address.name=address.subcountry)),newAddress.push(address)})),newAddress),angular.forEach(val.shipping,(function(value){if(3==value.shipping_option_type_id){var data={id:value.country_id,sub_cont:[]};if(cID.length>0){var insert=!0;angular.forEach(cID,(function(v){v.id==data.id&&(insert=!1)})),insert&&cID.push(data)}else cID.push(data)}})),angular.forEach(val.shipping,(function(value){var shippingOption={cost:"",name:"",description:"",shipping_option_type_id:"",country_id:"",subcountry_id:"",sub_countries:[],worldwideOption:"",shipping_option_id:value.shipping_option_id,id:value.id};if(3==value.shipping_option_type_id){$scope.show_sub=!0;var index=0,shipOption={cost:"",name:"",description:"",shipping_option_type_id:3,country_id:"",subcountry_id:"",shipping_option_id:value.shipping_option_id,id:value.id};angular.forEach(cID,(function(subVal){value.country_id==subVal.id?(shipOption={cost:value.cost,name:value.name,description:"",shipping_option_type_id:value.shipping_option_type_id,country_id:value.country_id,subcountry_id:value.subcountry_id,shipping_option_id:value.shipping_option_id,id:value.id},cID[index].sub_cont.push(shipOption)):index++}))}else shippingOption={cost:value.cost,name:"",description:"",shipping_option_type_id:value.shipping_option_type_id,country_id:value.country_id,subcountry_id:"",sub_countries:[],shipping_option_id:value.shipping_option_id,id:value.id},$scope.rewards_data[count].shipping.push(shippingOption)})),angular.forEach(cID,(function(Val){shippingOption={cost:"",name:"",description:"",shipping_option_type_id:3,country_id:Val.id,subcountry_id:"",sub_countries:Val.sub_cont,shipping_option_id:Val.shipping_option_id,id:Val.id},$scope.rewards_data[count].shipping.push(shippingOption)}))),count++}))}$scope.getCountries(),reward_priority=$scope.rewards_data.length}function getFAQ(){Restangular.one("campaign",campaign_id).one("faq").getList().then((function(success){success.length?$scope.campaign.faq=success:($scope.campaign.faq=[],$scope.addFAQ($scope.campaign.faq)),angular.forEach($scope.campaign.faq,(function(value,key,obj){value.faq_pairs||(value.faq_pairs=[],$scope.addFAQPair(value.faq_pairs))}))}))}function getRevisionFAQ(){Restangular.one("campaign",campaign_id).one("faq-revision").getList().then((function(success){success.length?($scope.campaign.faq=success,angular.forEach($scope.campaign.faq,(function(value,key,obj){value.faq_pairs||(value.faq_pairs=[],$scope.addFAQPair(value.faq_pairs))}))):($scope.no_faq_revisions=!0,getFAQ())}))}function loadCampaignData(inSaveData){CreateCampaignService.load($routeParams.campaign_id).then((function(success){if($scope.$emit("loading_finished"),$scope.campaign=success.plain(),loadRunMode(),!$scope.campaignFundingGoal.value&&$scope.campaign.hasOwnProperty("funding_goal")&&($scope.public_settings.site_campaign_defaults.toggle&&0==$scope.campaign.funding_goal?($scope.campaign.funding_goal=$scope.public_settings.site_campaign_defaults.fundingGoal,$scope.campaignFundingGoal.value=$scope.campaign.funding_goal):$scope.campaignFundingGoal.value=$scope.campaign.funding_goal),setCampaignThumbnailVideo(),$translate("get_started_fundingdetails1",{campaign_fee:$scope.percentage+"%"}).then((function(value){$scope.get_started_fundingdetails1=value})),$scope.campaign.blurb&&($scope.campaign.blurb=$scope.campaign.blurb.replace(/&#39;/g,"'")),$scope.campaign.timezoneText=moment().tz($scope.campaign.timezone).zoneAbbr(),CampaignSettingsService.setCampaignId($routeParams.campaign_id),CampaignSettingsService.processSettings(success.settings),$scope.campaign.settings=CampaignSettingsService.getSettings(),$scope.enableCampaignRevisions&&2==$scope.campaign.entry_status_id&&Restangular.one("campaign",campaign_id).customGET("setting-revision/bio_enable").then((function(success){success.value&&($scope.settingRevisions=!0,$scope.campaign.settings.bio_enable=success.value)})),$scope.campaign.settings.campaign_fee_percentage||$scope.public_settings.site_theme_campaign_percentage_enabled&&$scope.public_settings.site_campaign_defaults.toggle&&($scope.campaign.settings.campaign_fee_percentage=$scope.public_settings.site_campaign_defaults.percentage_fee),$scope.progressHide=!1,$scope.public_settings.site_campaign_progress_bar_hide?$scope.progressHide=!0:$scope.progressHide=!1,void 0!==$scope.campaign.settings.progress_bar_hide?$scope.progressHide=$scope.campaign.settings.progress_bar_hide:$scope.campaign.settings.progress_bar_hide=$scope.public_settings.site_campaign_progress_bar_hide,$scope.public_settings.site_campaign_enable_organization_name&&Restangular.one('portal/person/attribute?filters={"person_id":"'+$scope.campaign.managers[0].id+'"}').customGET().then((function(success){$scope.organization_name.value=success[0].attributes.organization_name,$scope.organization_name.ein=success[0].attributes.ein})),$scope.hideCampaignManagerField&&"undefined"===$scope.hideCampaignManagerField||($scope.campaign.settings.campaign_manager_name=$scope.campaign.managers[0].first_name+" "+$scope.campaign.managers[0].last_name),void 0!==$scope.campaign.settings&&"top_header_link"in $scope.campaign.settings)for(var i in $scope.top_header_protocals){if($scope.campaign.settings.top_header_link.indexOf($scope.top_header_protocals[i].value)>-1){$scope.top_header_link=$scope.campaign.settings.top_header_link.replace($scope.top_header_protocals[i].value,""),$scope.top_header_link_default_protocal=$scope.top_header_protocals[i],$scope.top_header_protocals[i].default=!0;break}"undefined"!=$scope.campaign.settings.top_header_link&&($scope.top_header_link=$scope.campaign.settings.top_header_link,$scope.top_header_link_default_protocal=$scope.top_header_protocals[2])}if($scope.campaign.settings.hasOwnProperty("enable_rewards_pagination")||($scope.campaign.settings.enable_rewards_pagination=!0),$scope.campaign.settings.hasOwnProperty("min_contribution")||($scope.campaign.settings.min_contribution=null),$scope.campaign.settings.hasOwnProperty("max_contribution")||($scope.campaign.settings.max_contribution=null),$scope.startCampaignOnCurrentDate){var currentDate=new Date;$scope.campaign.starts_date_time=currentDate}else $scope.campaign.starts_date_time=reformatDate($scope.campaign.starts_date_time);if($scope.campaign.ends_date_time=reformatDate($scope.campaign.ends_date_time),$scope.rewards_data=[],$scope.getCountries(),$scope.campaign.pledges&&reformatReward($scope.campaign.pledges),$translate(["Time_Based_Campaign","Continuous_Campaign"]).then((function(value){if($scope.campaign.starts&&null==$scope.campaign.ends&&($("#default-run-mode").text(value.Continuous_Campaign),$scope.run_mode=!1,$scope.runModeSelected=2),$scope.public_settings.site_campaign_continuous_run_mode&&($scope.campaign.ever_published||10==$scope.campaign.entry_status_id)&&(2==$scope.public_settings.site_campaign_defaults_runMode&&($("#default-run-mode").text(value.Continuous_Campaign),$scope.run_mode=!1),null==$scope.campaign.ends_date_time?($("#default-run-mode").text(value.Continuous_Campaign),$scope.run_mode=!1):($("#default-run-mode").text(value.Time_Based_Campaign),$scope.run_mode=!0,$scope.runModeSelected=1)),($scope.public_settings.site_campaign_fixed_campaign_duration_enable||1==$scope.public_settings.site_campaign_defaults_runMode&&$scope.public_settings.site_campaign_defaults.toggle)&&(!$scope.public_settings.site_campaign_defaults.toggle||$scope.campaign.starts_date_time||$scope.campaign.ends_date_time||($scope.campaign.starts_date_time=$scope.public_settings.site_campaign_fixed_campaign_duration_start,$scope.campaign.ends_date_time=$scope.public_settings.site_campaign_fixed_campaign_duration_end),$scope.campaign.starts_date_time||($scope.campaign.starts_date_time=$scope.public_settings.site_campaign_fixed_campaign_duration_start),!$scope.campaign.ends_date_time&&$scope.run_mode&&($scope.campaign.ends_date_time=$scope.public_settings.site_campaign_fixed_campaign_duration_end),$scope.campaign.runtime_days=Math.round((fix_date($scope.campaign.ends_date_time)-fix_date($scope.campaign.starts_date_time))/864e5)),2==$scope.public_settings.site_campaign_defaults_runMode&&$scope.public_settings.site_campaign_defaults.toggle)if(!$scope.campaign.starts_date_time&&$scope.public_settings.site_campaign_fixed_campaign_duration_enable)$scope.campaign.starts_date_time=$scope.public_settings.site_campaign_fixed_campaign_duration_start;else if(!$scope.campaign.starts_date_time){var date=new Date,newDate=date.getFullYear()+"/"+(date.getMonth()+1)+"/"+date.getDate()+" "+date.getHours()+":"+date.getMinutes()+":00";$scope.campaign.starts_date_time=newDate}})),$scope.campaign.maximum_allowed_funds_raised&&($scope.thresholdvalue.value=$scope.campaign.maximum_allowed_funds_raised,$("#maxthreshold").checkbox("check")),$scope.public_settings.hasOwnProperty("site_campaign_max_threshold_hide")&&$scope.public_settings.site_campaign_max_threshold_hide&&($scope.campaign.maximum_allowed_funds_raised=0,$scope.thresholdvalue.value=0,$("#maxthreshold").checkbox("uncheck")),success.uri_paths.length&&($scope.campaign.uri_path=success.uri_paths[0].path),$scope.old_path=success.uri_paths[0].path,0==$scope.campaign.funding_goal&&($scope.campaign.funding_goal=""),Restangular.one("campaign",campaign_id).one("stripe-account").customGET().then((function(stripe){stripe.length&&($scope.campaign.stripe_account_id=stripe[0].id),$scope.public_settings.hasOwnProperty("site_campaign_fee_direct_transaction")&&$scope.public_settings.site_campaign_fee_direct_transaction&&($scope.campaign.stripe_account_id=null)})),$scope.campaign.links?($scope.links=[],angular.forEach($scope.campaign.links,(function(value){1==value.region_id&&1==value.resource_content_type_id&&"link"==value.resource_type&&($scope.campaign.video=value),value.region_id==$scope.RESOURCE_REGIONS.campaign.thumbnail_video&&"link"==value.resource_type&&($scope.campaignThumbnailVideo=value),"generic"==value.resource_content_type&&("http://"==value.uri.substring(0,7)?(value.uri=value.uri.replace("http://",""),value.default_protocol="http://"):"https://"==value.uri.substring(0,8)?(value.uri=value.uri.replace("https://",""),value.default_protocol="https://"):value.default_protocol="Relative Path",$scope.links.push(value))}))):($scope.campaign.links=[],$scope.addLink($scope.campaign.links)),$scope.category_ids=[],$scope.campaign.categories?Restangular.one("portal/category").customGET().then((function(success){if(success&&success.length){var categoryTemp=[];success.forEach((function(value,index){null==value.parent_category_id&&categoryTemp.push(value)})),$scope.categories=angular.copy(categoryTemp)}!function(campaignCategories){if(campaignCategories){$scope.category_ids=[],$scope.sub_category_ids={ids:[]};var categoryIdsArray=[],subCategoryIdsArray=[],campaignCategoriesCopy=angular.copy(campaignCategories);angular.forEach(campaignCategoriesCopy,(function(value){null!=value.parent_category_id?subCategoryIdsArray.push(value.category_id):categoryIdsArray.push(value.category_id)})),$scope.category_ids=angular.copy(categoryIdsArray),$scope.sub_category_ids.ids=angular.copy(subCategoryIdsArray),$timeout((function(){$("#category-field select").val($scope.category_ids).trigger("change")}),0)}}($scope.campaign.categories)})):$scope.campaign.categories=[],$scope.campaign.cities&&(angular.forEach($scope.campaign.cities,(function(value,index){checkCitiesNative(value)})),$scope.cities=$scope.campaign.cities,$scope.multipleCity.selected=$scope.campaign.cities),$scope.enableCampaignRevisions&&2==$scope.campaign.entry_status_id?getRevisionFAQ():getFAQ(),$timeout((function(){$translate(["get_started_funding_startdate_placeholder","get_started_funding_enddate_note"]).then((function(value){$scope.get_started_funding_startdate_placeholder=value.get_started_funding_startdate_placeholder,$scope.get_started_funding_enddate_note=value.get_started_funding_enddate_note}))}),100),Restangular.one("campaign",campaign_id).one("pledge-level").customGET().then((function(success){$scope.campaign.rewards=[],angular.forEach(success,(function(value){value.estimated_delivery_time&&(value.estimated_delivery_time_convert=convertDate(value.estimated_delivery_time)),null===value.shipping&&(value.shipping=[]),$scope.campaign.rewards.push(value)}))})),Restangular.one("campaign",$scope.campaign.entry_id).one("note").customGET().then((function(success){success&&($scope.notes=success[0].value)})),CurrencyService.getCurrency((function(success){success&&($scope.native_lookup&&success.forEach((function(value){value.name=value.native_name?value.native_name:value.name})),$scope.currency_options=success,angular.forEach($scope.currency_options,(function(value){$scope.public_settings.site_campaign_defaults.toggle&&($scope.campaign.currency_id=$scope.public_settings.site_campaign_currency_id),value.currency_id==$scope.campaign.currency_id&&($scope.ccode=value.code_iso4217_alpha)})),$scope.campaign.currency_id||($scope.campaign.currency_id=success[0].currency_id))})),$scope.public_settings.campaign_content_suggestion_enabled&&$scope.public_settings.campaign_content_suggestion){var suggestionEndpointUrl=$scope.public_settings.campaign_content_suggestion;suggestionEndpointUrl.indexOf("{email}")>-1&&(suggestionEndpointUrl=suggestionEndpointUrl.replace("{email}",$scope.user.email)),$http({method:"GET",url:suggestionEndpointUrl}).then((function(success){var resData=success.data;resData.hasOwnProperty("suggestions")?($scope.blurbSuggestions=resData.suggestions.blurb,$scope.descriptionSuggestions=resData.suggestions.description,$scope.faqSuggestions=resData.suggestions.faq):console.error("Content suggestion not available")}),(function(error){console.error(error)}))}if(!inSaveData&&$scope.enableCampaignRevisions&&2==$scope.campaign.entry_status_id&&2==$scope.user.person_type_id&&$scope.enableCampaignRevisions&&2==$scope.campaign.entry_status_id&&Restangular.one("campaign",$scope.campaign.entry_id).one("revision").customGET().then((function(success){try{$scope.revision=success[0],$location.search("revision_id",success[0].entry_revision_id)}catch(error){Restangular.one("campaign/"+$scope.campaign.entry_id+"/revision").customPOST($scope.campaign).then((function(new_success){$scope.revision=new_success[0],$scope.revision.blurb=$scope.campaign.blurb,$scope.revision.name=$scope.campaign.name,$scope.revision.description=$scope.campaign.description,$location.search("revision_id",new_success[0].entry_revision_id)}))}})),!inSaveData&&$scope.enableCampaignRevisions&&2==$scope.campaign.entry_status_id&&1==$scope.user.person_type_id&&$routeParams.revision_id&&($scope.isCampaignRevised=!0,Restangular.one("campaign",$scope.campaign.entry_id).one("revision",$routeParams.revision_id).customGET().then((function(success){$scope.revision=success[0]}))),$routeParams.revision_id&&($scope.in_revision=!0),$scope.isExplainerTextEnabled&&1==$scope.user.person_type_id){var adminOnlyTranslation=$translate.instant(["admin_only_explainer_text_title_default","admin_only_explainer_text_msg_default"]);void 0!==$scope.campaign.settings.explainer_text&&null!=$scope.campaign.settings.explainer_text||($scope.campaign.settings.explainer_text={title:adminOnlyTranslation.admin_only_explainer_text_title_default,message:adminOnlyTranslation.admin_only_explainer_text_msg_default,close:!1})}$scope.isHideDaysToGoChecked&&($scope.campaign.settings.days_to_go_hide=!0),$scope.hideStartCampaignPage&&void 0!==$scope.hideStartCampaignPage&&"unnamed_campaign"===$scope.campaign.name&&($scope.campaign.name=""),("undefined"!==$scope.enableContribButtonPerCampaign||$scope.enableContribButtonPerCampaign)&&$scope.campaign.settings.hide_contribute_button_per_campaign}))}function checkCitiesNative(cityObj){var cityFull="";$scope.native_lookup&&(cityObj.country=null!=cityObj.country_native_name?cityObj.country_native_name:cityObj.country,cityObj.subcountry=null!=cityObj.subcountry_native_name?cityObj.subcountry_native_name:cityObj.subcountry,cityObj.city=null!=cityObj.city_native_name?cityObj.city_native_name:cityObj.city,cityFull=cityObj.country+", "+cityObj.subcountry+", "+cityObj.city,cityObj.city_full=cityFull,cityObj.name=cityFull)}function getCampaignImages(){$scope.enableCampaignRevisions&&$routeParams.revision_id?Restangular.one("campaign",campaign_id).one("resource-revision/file/").customGET().then((function(success){if(hasImage=!1,success.length){$scope.campaignImages=[];for(var i=0;i<success.length;i++)success[i].region_id==$scope.RESOURCE_REGIONS.campaign.thumbnail&&($scope.campaignImages.push(success[i]),hasImage=!0)}hasImage||Restangular.one("campaign",campaign_id).one("resource/file/").customGET().then((function(success){if($scope.campaignImages=[],success.length){$scope.nonRevisionCampaignImage=!0;for(var i=0;i<success.length;i++)success[i].region_id==$scope.RESOURCE_REGIONS.campaign.thumbnail&&$scope.campaignImages.push(success[i])}}),(function(fail){$scope.campaignImages=[]}))}),(function(fail){$scope.campaignImages=[]})):Restangular.one("campaign",campaign_id).one("resource/file/").customGET().then((function(success){if($scope.campaignImages=[],success.length)for(var i=0;i<success.length;i++)success[i].region_id==$scope.RESOURCE_REGIONS.campaign.thumbnail&&$scope.campaignImages.push(success[i])}),(function(fail){$scope.campaignImages=[]}))}Restangular.one("portal/setting").customGET().then((function(success){angular.forEach(success,(function(value){"site_campaign_raise_modes"==value.name&&3==value.setting_type_id&&($scope.mode_allowed=value.value,Restangular.one("campaign/raise-mode").customGET().then((function(modes){$scope.fundingMode=modes,angular.forEach($scope.fundingMode,(function(mode){$translate(mode.description).then((function(value){mode.description=value})),$scope.mode_allowed.allowed.indexOf(mode.id)>-1&&(mode.allowed=!0)})),$timeout((function(){$(".ui.dropdown").dropdown()}),200)}))),"site_campaign_fee_percentage"==value.name&&3==value.setting_type_id&&($scope.percentage=value.value),"site_theme_campaign_show_reward_section"==value.name&&($scope.show_reward=value.value),null==value.setting&&($scope.setting={top_header_link:""}),"site_payment_gateway"==value.name&&($scope.payment_gateway=value.value,2==$scope.payment_gateway&&Restangular.one("account/widgetmakr/widget").customGET().then((function(success){success.length>0&&($scope.widget_accountID=success[0].widgetmakr_account_id)}))),"site_default_widget_makr_id"==value.name&&value.value&&($scope.widget_default_accountID=value.value)})),Restangular.one("campaign",campaign_id).one("ever_published").customGET().then((function(success){$scope.fundingExist=$scope.direct_transaction||!$scope.contributionEnabled||$scope.isStepFundingDelayed&&!success.ever_published,$scope.master_show_reward=!1,$scope.showRewardsTab&&($scope.master_show_reward=!0),$scope.isStepRewardDelayed&&2!=$scope.campaign.entry_status_id&&($scope.master_show_reward=!1),"getstarted"==$scope.currentPath?($scope.nextStepUrl="campaign-setup/"+$routeParams.campaign_id,$scope.firstPage=!0):"campaign-setup"==$scope.currentPath?($scope.backUrl="getstarted/"+$routeParams.campaign_id,$scope.master_show_reward?(!$scope.hideAllCampaignRewardsFields&&void 0===$scope.hideAllCampaignRewardsFields||!$scope.showCampaignDescription&&void 0===$scope.showCampaignDescription?$scope.thirdStepPath="rewards":$scope.thirdStepPath="story",$scope.nextStepUrl=$scope.thirdStepPath+"/"+$routeParams.campaign_id):$scope.showProfile?$scope.nextStepUrl="profile-setup/"+$routeParams.campaign_id:$scope.fundingExist?$scope.public_settings.site_enable_advanced_widget?$scope.nextStepUrl="campaign-widget/"+$routeParams.campaign_id:$scope.nextStepUrl="campaign-preview/"+$routeParams.campaign_id:$scope.nextStepUrl="complete-funding/"+$routeParams.campaign_id):"rewards"!=$scope.currentPath&&"story"!=$scope.currentPath||($scope.showProfile?$scope.nextStepUrl="profile-setup/"+$routeParams.campaign_id:$scope.fundingExist?$scope.public_settings.site_enable_advanced_widget?$scope.nextStepUrl="campaign-widget/"+$routeParams.campaign_id:($scope.nextStepUrl="campaign-preview/"+$routeParams.campaign_id,$scope.backUrl="campaign-setup/"+$routeParams.campaign_id):$scope.nextStepUrl="complete-funding/"+$routeParams.campaign_id),$routeParams.revision_id&&($scope.nextStepUrl+="?revision_id="+$routeParams.revision_id,$scope.backUrl+="?revision_id="+$routeParams.revision_id,"campaign-setup"==$scope.currentPath&&($scope.nextStepUrl="campaign-preview/"+$routeParams.campaign_id+"?revision_id="+$routeParams.revision_id,$scope.backUrl="getstarted/"+$routeParams.campaign_id+"?revision_id="+$routeParams.revision_id)),$scope.$emit("loading_finished")}))})),$scope.setBlurbFromSuggestion=function(blurbSuggestion){$timeout((function(){$("textarea[name='blurb']").val(blurbSuggestion.content)}))},$scope.setDescriptionFromSuggestion=function(descriptionSuggestion){$scope.froalaOptionsCampaigns.froalaEditor("html.set",descriptionSuggestion.content)},$scope.setFAQFromSuggestion=function(faqSuggestion){for(var faqIndex in $scope.campaign.faq&&$scope.campaign.faq.length?($scope.campaign.faq[0].name=faqSuggestion.name,$scope.campaign.faq[0].description=faqSuggestion.title,$scope.campaign.faq[0].faq_pairs||($scope.campaign.faq[0].faq_pairs=[])):($scope.campaign.faq=[],$scope.campaign.faq.push({name:faqSuggestion.name,description:faqSuggestion.title,faq_pairs:[]})),faqSuggestion.content)faqIndex<$scope.campaign.faq[0].faq_pairs.length?($scope.campaign.faq[0].faq_pairs[faqIndex].question=faqSuggestion.content[faqIndex].question,$scope.campaign.faq[0].faq_pairs[faqIndex].answer=faqSuggestion.content[faqIndex].answer):$scope.campaign.faq[0].faq_pairs.push({question:faqSuggestion.content[faqIndex].question,answer:faqSuggestion.content[faqIndex].answer,display_priority:faqSuggestion.content.length+1})},$scope.dropdown={}||$scope.dropdown,$scope.duration_type=[{id:"1",type:"duration_type_day"},{id:"2",type:"duration_type_week"},{id:"3",type:"duration_type_month"},{id:"4",type:"duration_type_year"}],$scope.dropdown.shipping=[{id:"1",value:"campaign_reward_worldwide_shipping"},{id:"2",value:"campaign_reward_countryspecific_shipping"},{id:"3",value:"campaign_reward_subcountryspecific_shipping"}],$scope.setRunMode=function(mode){$scope.runModeSelected=mode.id,2==mode.id?$scope.run_mode=!1:($scope.campaign.runtime_days=1,$scope.run_mode=!0)},$scope.uploadCampaignThumnail=function(files){if(files.length)if($scope.allowedImage(files[0].type)){var endpoint="campaign/"+campaign_id+"/resource/file/";($scope.enableCampaignRevisions&&2==$scope.campaign.entry_status_id&&2==$scope.user.person_type_id||$scope.enableCampaignRevisions&&$routeParams.revision_id&&2==$scope.campaign.entry_status_id&&$scope.campaignImages[0].entry_file_revision_id&&1==$scope.user.person_type_id)&&(endpoint="campaign/"+campaign_id+"/resource-revision/file/");var params={resource_content_type:"image",region_id:$scope.RESOURCE_REGIONS.campaign.thumbnail},$picNode=$(".campaignBasics");null!=$scope.campaignImages&&0==$scope.campaignImages.length||$scope.nonRevisionCampaignImage?($scope.nonRevisionCampaignImage=!1,FileUploadService.upload(endpoint,files,params,$picNode).then((function(success){0!=success.length&&getCampaignImages()}))):null!=$scope.campaignImages&&$scope.campaignImages.length>0&&FileUploadService.modify(endpoint,files,params,$scope.campaignImages[0].id,$picNode).then((function(success){0!=success.length&&getCampaignImages()}))}else $(".wrong-filetype").modal("show")},$scope.allowedImage=function(file_type){return["image/vnd.microsoft.icon","image/x-icon","image/png","image/pjpeg","image/jpeg","image/gif"].indexOf(file_type)>-1},$scope.deleteCampaignThumnail=function(files){if(files&&files.length){var file=files.pop(),endpoint="resource/file";$scope.enableCampaignRevisions&&2==$scope.campaign.entry_status_id&&(endpoint="resource-revision/file"),Restangular.one("campaign",campaign_id).one(endpoint).customDELETE(file.id).then((function(success){getCampaignImages()})),$(".imagePlace .dimmer").dimmer("hide"),$(".ui.progress.upload-bar").show(),$(".ui.loader.download-loader").hide()}};var getCampaignHeaderImages=function(){$scope.enableCampaignRevisions&&$routeParams.revision_id?Restangular.one("campaign",campaign_id).one("resource-revision/file/").customGET().then((function(success){var hasHeader=!1;if(success.length){$scope.campaignHeaderImages=[];for(var i=0;i<success.length;i++)success[i].region_id==$scope.RESOURCE_REGIONS.campaign.top_header&&($scope.campaignHeaderImages.push(success[i]),hasHeader=!0)}hasHeader||Restangular.one("campaign",campaign_id).one("resource/file/").customGET().then((function(success){if($scope.campaignHeaderImages=[],success.length){$scope.nonRevisionCampaignHeaderImage=!0;for(var i=0;i<success.length;i++)success[i].region_id==$scope.RESOURCE_REGIONS.campaign.top_header&&$scope.campaignHeaderImages.push(success[i])}}))})):Restangular.one("campaign",campaign_id).one("resource/file/").customGET().then((function(success){if($scope.campaignHeaderImages=[],success.length)for(var i=0;i<success.length;i++)success[i].region_id==$scope.RESOURCE_REGIONS.campaign.top_header&&$scope.campaignHeaderImages.push(success[i])}))};function setCampaignThumbnailVideo(){var existing_id=!1;if(null==$scope.campaignThumbnailVideo?$scope.campaignThumbnailVideo={}:void 0!==$scope.campaignThumbnailVideo.id&&(existing_id=$scope.campaignThumbnailVideo.id),void 0!==$scope.campaignThumbnailVideo.uri&&""!=$scope.campaignThumbnailVideo.uri&&existing_id){var data={entry_id:campaign_id,resource_type:"link",resource_content_type:"video",resource:$scope.campaignThumbnailVideo.uri,region_id:$scope.RESOURCE_REGIONS.campaign.thumbnail_video};Restangular.one("campaign",campaign_id).one("resource/link",existing_id).customPUT(data).then((function(success){$scope.campaignThumbnailVideo=success}))}else if(void 0!==$scope.campaignThumbnailVideo.uri&&""!=$scope.campaignThumbnailVideo.uri){data={entry_id:campaign_id,resource_type:"link",resource_content_type:"video",resource:$scope.campaignThumbnailVideo.uri,region_id:$scope.RESOURCE_REGIONS.campaign.thumbnail_video};Restangular.one("campaign",campaign_id).one("resource/link/").customPOST(data).then((function(success){$scope.campaignThumbnailVideo=success}))}else""==$scope.campaignThumbnailVideo.uri&&Restangular.one("campaign",campaign_id).one("resource/link/").customDELETE(existing_id).then((function(success){$scope.campaignThumbnailVideo={}}))}function refreshLinks(){Restangular.one("campaign",campaign_id).customGET().then((function(success){var newIndex=0;angular.forEach(success.links,(function(value,index){"generic"==value.resource_content_type&&("http://"==value.uri.substring(0,7)?(value.uri=value.uri.replace("http://",""),value.default_protocol="http://"):"https://"==value.uri.substring(0,8)?(value.uri=value.uri.replace("https://",""),value.default_protocol="https://"):value.default_protocol="Relative Path",$scope.links[newIndex]=value,newIndex+=1)}))}))}function saveFAQs(){$scope.campaign.faq.forEach((function(faq){faq.faq_id?(Restangular.one("campaign",campaign_id).one("faq",faq.faq_id).customPUT(faq),updateFAQPairs(faq)):faq.name&&faq.description&&Restangular.one("campaign",campaign_id).one("faq").customPOST(faq).then((function(success){var faqID=success[0].id;faq.faq_id=faqID,faq.faq_pairs.length&&updateFAQPairs(faq)}))})),$scope.enableCampaignRevisions&&2==$scope.campaign.entry_status_id&&$scope.user.person_type_id,getFAQ()}function updateFAQPairs(faq){var rep=[];angular.forEach(faq.faq_pairs,(function(value,key){if(value.question&&value.answer)if(value.id){var req=Restangular.one("campaign",campaign_id).one("faq",faq.faq_id).one("faq-pair",value.id).customPUT(value);rep.push(req)}else{req=Restangular.one("campaign",campaign_id).one("faq",faq.faq_id).one("faq-pair").customPOST({pairs:[value]});rep.push(req)}})),$q.all(rep).then((function(success){}))}function updateRevisionFAQPairs(faq){var rep=[];angular.forEach(faq.faq_pairs,(function(value,key){if(value.question&&value.answer)if(value.id&&!$scope.no_faq_revisions){$scope.no_faq_revisions=!1;var req=Restangular.one("campaign",campaign_id).one("faq-revision",faq.faq_revision_id).one("faq-pair-revision",value.id).customPUT(value);rep.push(req)}else{req=Restangular.one("campaign",campaign_id).one("faq-revision",faq.faq_revision_id).one("faq-pair-revision").customPOST({pairs:[value]});rep.push(req)}})),$q.all(rep).then((function(success){}))}function resetFileUpload(){$scope.currentUploadFile={title:"",description:"",fileName:"",icon:"file",path:"",resourceId:-1}}function isValidDate(d){return"[object Date]"===Object.prototype.toString.call(d)&&!isNaN(d.getTime())}function convertDate(d){var value=d;if(!isValidDate(new Date(value))){var year=value.substring(0,4),month=value.substring(5,7),day=value.substring(8,10);return new Date(year,month-1,day)}return d}function ISOtoPostgres(data){return data?("string"!=typeof data&&(data=data.toISOString()),data.slice(0,10).replace("T"," ")):"__NULL__"}function reformatDate(dateString){if(null!=dateString)return dateString=dateString.replace(/\-/g,"/")}function fix_date(s){return"string"==typeof s?Date.parse(s):s?s.getTime():void 0}$scope.uploadCampaignHeaderImage=function(files){if(files.length)if($scope.allowedImage(files[0].type)){var endpoint="campaign/"+campaign_id+"/resource/file/";($scope.enableCampaignRevisions&&2==$scope.campaign.entry_status_id&&2==$scope.user.person_type_id||$scope.enableCampaignRevisions&&$routeParams.revision_id&&2==$scope.campaign.entry_status_id&&$scope.campaignHeaderImages[0].entry_file_revision_id&&1==$scope.user.person_type_id)&&(endpoint="campaign/"+campaign_id+"/resource-revision/file/");var params={resource_content_type:"image",region_id:$scope.RESOURCE_REGIONS.campaign.top_header},$picNode=$(".campaignHeaderImage");0==$scope.campaignHeaderImages.length||$scope.nonRevisionCampaignHeaderImage?($scope.nonRevisionCampaignHeaderImage=!1,FileUploadService.upload(endpoint,files,params,$picNode).then((function(success){0!=success.length&&getCampaignHeaderImages()}))):$scope.campaignHeaderImages.length>0&&FileUploadService.modify(endpoint,files,params,$scope.campaignHeaderImages[0].id,$picNode).then((function(success){0!=success.length&&getCampaignHeaderImages()}))}else $(".wrong-filetype").modal("show")},$scope.deleteCampaignHeaderImage=function(files){if(files&&files.length){var file=files.pop();Restangular.one("campaign",campaign_id).one("resource/file").customDELETE(file.id).then((function(success){getCampaignHeaderImages()})),$(".imagePlace .dimmer").dimmer("hide"),$(".ui.progress.upload-bar").show(),$(".ui.loader.download-loader").hide()}},$scope.setRaiseMode=function(data){$scope.campaign.raise_mode_id=data.raise_mode_id},$scope.stateSelected=function(data){$scope.campaign.settings.state_current=$scope.public_settings.site_campaign_state_settings[data]},$scope.durationTypeSelected=function(typeID){$scope.campaign.duration_type_id=typeID},$scope.delayGetImage=function(campaignID){$timeout((function(){Restangular.one("campaign",campaignID).one("resource/file").customGET().then((function(images){$scope.campaign.files=images}))}),800)},angular.isUndefined($scope.categories)&&APIPortal.categories({},(function(success){$scope.categories=$scope.$parent.categories=success})),$scope.getCountries=function(){Geolocator.getCountries().then((function(countries){if($scope.native_lookup)for(var i in countries)null!=countries[i].native_name&&(countries[i].name=countries[i].native_name);if($scope.countries=countries,$scope.default_country){for(var index in $scope.countries){var value=$scope.countries[index];if(value.id==$scope.default_country.id){$scope.default_country=value,$scope.countries.splice(index,1);break}}$scope.countries.splice(0,0,$scope.default_country)}$scope.updateDuplicatedCountryList($scope.countries)}))},$scope.updateDuplicatedCountryList=function(countries){for(var index in countriesWithShippingStatus=[],!countries&&$scope.countries&&(countries=$scope.countries),countries)countries[index].hasOwnProperty("shipping_status")&&delete countries[index].shipping_status;for(var rewardIndex in $scope.rewards_data){var reward=$scope.rewards_data[rewardIndex];if(reward.hasOwnProperty("shipping")&&null!=reward.shipping)for(var shipIndex in reward.shipping){var shipping=reward.shipping[shipIndex];if(shipping.hasOwnProperty("country_id")&&shipping.hasOwnProperty("shipping_option_type_id")){for(var countryIndex in countries){var country=countries[countryIndex],theCountry=null;if(country.id==shipping.country_id){theCountry=country;break}}var shippingStatus={reward_index:rewardIndex,shipping_option_type_id:parseInt(shipping.shipping_option_type_id)};null!=theCountry&&(theCountry.hasOwnProperty("shipping_status")||(theCountry.shipping_status=[]),theCountry.shipping_status.push(shippingStatus),countriesWithShippingStatus.push(theCountry))}}}},$scope.$watch("campaign.currency_id",(function(value,oldValue){value&&($("#campaign-currency-field .select-error").remove(),$("#campaign-currency-field").removeClass("error")),angular.forEach($scope.currency_options,(function(value){value.currency_id!=$scope.campaign.currency_id||($scope.ccode=value.code_iso4217_alpha)}))})),$scope.removeLink=function(link,index){$scope.links.splice(index,1),link.id&&Restangular.one("campaign",campaign_id).one("resource/link",link.id).customDELETE().then((function(success){refreshLinks()}))},$scope.removeFaqPair=function(faq,pair){faq.faq_pairs.splice(faq.faq_pairs.indexOf(pair),1),pair.faq_pair_id&&Restangular.one("campaign",campaign_id).one("faq",faq.id).one("faq-pair",pair.faq_pair_id).customDELETE().then((function(success){getFAQ()})),pair.faq_pair_revision_id&&$scope.enableCampaignRevisions&&2==$scope.campaign.entry_status_id&&Restangular.one("campaign",campaign_id).one("faq-revision",faq.id).one("faq-pair-revision",pair.faq_pair_revision_id).customDELETE().then((function(success){getRevisionFAQ()}))},$("#pathID").blur((function(){Restangular.one("portal/uri-path",$scope.campaign.uri_path).customGET().then((function(success){1==success.result?($translate(["duplicate_path_error"]).then((function(value){$scope.duplicatePath_message=value.duplicate_path_error})),$("#pathID").addClass("has-error"),$scope.duplicatePath=!0):($("#pathID").removeClass("has-error"),$scope.duplicatePath=!1)}))})),$timeout((function(){$.fn.form.settings.rules.lessThanInteger=function(integer){return integer>0}})),$scope.basicsValidation=function(){var translation=$translate.instant(["get_started_titlemessage","get_started_blurbnote","get_started_fundingmoney_input","get_started_funding_numberdays_note","get_started_funding_mode_note"]),basicsFormObj={title:{identifier:"title",rules:[{type:"empty",prompt:translation.get_started_titlemessage}]},goal:{identifier:"goal",rules:[{type:"empty",prompt:translation.get_started_fundingmoney_input},{type:"lessThanInteger[goal]",prompt:translation.get_started_fundingmoney_input}]},runtime_days:{identifier:"runtime_days",rules:[{type:"empty",prompt:translation.get_started_funding_numberdays_note}]}};$scope.hideCampaignBlurbField&&void 0!==$scope.hideCampaignBlurbField||(basicsFormObj.blurb={identifier:"blurb",rules:[{type:"empty",prompt:translation.get_started_blurbnote}]}),$scope.hideCampaignBlurbField&&void 0!==$scope.isRemoveRaiseMode||(basicsFormObj.funding_mode={identifier:"funding_mode",rules:[{type:"empty",prompt:translation.get_started_funding_mode_note}]}),$(".campaign-basics-form.ui.form").form(basicsFormObj,{inline:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form")},$scope.campaignFeeValidation=function(){var translation=$translate.instant(["get_started_campaign_percentage_empty"]);$(".campaign-basics-form.ui.form").form({percentage_fee:{identifier:"percentage_fee",rules:[{type:"empty",prompt:translation.get_started_campaign_percentage_empty}]}},{inline:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form")},$scope.campaignMinContributionValidation=function(){$.fn.form.settings.rules.min_number=function(value){return!isNaN($scope.campaign.settings.min_contribution)};var translation=$translate.instant(["get_started_campaign_min_nan"]);$(".campaign-basics-form.ui.form").form({campaign_min:{identifier:"campaign_min",rules:[{type:"min_number",prompt:translation.get_started_campaign_min_nan}]}},{inline:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form")},$scope.campaignMaxContributionValidation=function(){var translation=$translate.instant(["get_started_campaign_max_nan"]);$(".campaign-basics-form.ui.form").form({campaign_max:{identifier:"campaign_max",rules:[{type:"integer",prompt:translation.get_started_campaign_max_nan}]}},{inline:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form")},$scope.campaignVideoValidation=function(){var translation=$translate.instant(["get_started_campaign_video_empty"]);$(".campaign-basics-form.ui.form").form({campaign_video:{identifier:"campaign_video",rules:[{type:"empty",prompt:translation.get_started_campaign_video_empty}]}},{inline:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form")},$scope.campaignContractNumberValidation=function(){var translation=$translate.instant(["get_started_campaign_contract_number_empty"]);$(".campaign-basics-form.ui.form").form({contract_number:{identifier:"contract_number",rules:[{type:"empty",prompt:translation.get_started_campaign_contract_number_empty}]}},{inline:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form")},$scope.campaignManagerValidation=function(){var translation=$translate.instant(["get_started_campaign_manager_error"]);$(".campaign-details-form.ui.form").form({recipient:{identifier:"recipient",rules:[{type:"empty",prompt:translation.get_started_campaign_manager_error}]}},{inline:!0,onSuccess:function(){$scope.passCampaignManagerCheck=!0,$scope.valcheck=!0},onFailure:function(){$scope.passCampaignManagerCheck=!1,$scope.valcheck=!1}}).form("validate form")},$.fn.form.settings.rules.regexFroalaValidation=function(value,validate){return!(validate<=0)},$scope.rewardsValidation=function(){var translation=$translate.instant(["campaign_reward_reward_contribution_description_error","campaign_reward_reward_contribution_name_error","campaign_reward_reward_contribution_message_error","campaign_reward_reward_contribution_message_error2"]);$scope.rewards_validation={reward_amount:{identifier:"reward_amount",rules:[{type:"not[0]",prompt:translation.campaign_reward_reward_contribution_message_error},{type:"empty",prompt:translation.campaign_reward_reward_contribution_message_error2}]},reward_title:{identifier:"reward_title",rules:[{type:"empty",prompt:translation.campaign_reward_reward_contribution_name_error}]}},angular.forEach($scope.rewards_data,(function(value,key){void 0===value.description||null==value.description||value.description.length;var validation={identifier:"description"+(key+1),rules:[{type:"regexFroalaValidation["+value.description.length+"]",prompt:translation.campaign_reward_reward_contribution_description_error}]};$scope.rewards_validation["description"+(key+1)]=validation})),$(".campaign-rewards-form.ui.form").form($scope.rewards_validation,{inline:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form")},$scope.saveData=function($event){if($scope.valcheck=!0,"getstarted"==$scope.currentPath)$scope.campaign.blurb&&($scope.campaign.blurb=$scope.campaign.blurb.replace(/'/g,"&#39;")),$scope.basicsValidation(),function(){var translation=$translate.instant(["campaign_basics_currency_prompt","campaign_basics_uploadimage_prompt","campaign_basics_selectcategory_prompt","campaign_basics_description_prompt","campaign_basics_selectstartdate_prompt","campaign_basics_select_end_date_prompt"]);$scope.campaign.currency_id||($(".select-error").remove(),$("#campaign-currency-field").append('<div class="select-error ui red pointing prompt label transition visible">'+translation.campaign_basics_currency_prompt+"</div>"),$("#campaign-currency-field").addClass("error"),$scope.valcheck=$scope.valcheck&&!1),$scope.currency_options||($(".select-error").remove(),$("#campaign-currency-field").addClass("error"),$scope.valcheck=$scope.valcheck&&!1),$("#featured-img-field .ui.image").hasClass("image-uploaded")||void 0!==$scope.hideCampaignImageField&&$scope.hideCampaignImageField||($("#featured-img-field .select-error").remove(),$("#featured-img-field").append('<div class="select-error ui red pointing prompt label transition visible">'+translation.campaign_basics_uploadimage_prompt+"</div>"),$("#featured-img-field").addClass("error"),$scope.valcheck=$scope.valcheck&&!1),$("#category-field .select2-choices li").hasClass("select2-search-choice")||void 0!==$scope.hideCampaignCategoryField&&$scope.hideCampaignCategoryField||($("#category-field .select-error").remove(),$("#category-field").append('<div class="select-error ui red pointing prompt label transition visible">'+translation.campaign_basics_selectcategory_prompt+"</div>"),$("#category-field").addClass("error"),$scope.valcheck=$scope.valcheck&&!1),$("#start-date-field .quickdate").hasClass("startdate-selected")||($("#start-date-field .select-error").remove(),$("#start-date-field").append('<div class="select-error ui red pointing prompt label transition visible">'+translation.campaign_basics_selectstartdate_prompt+"</div>"),$("#start-date-field").addClass("error"),$scope.valcheck=$scope.valcheck&&!1),!$("#end-date-field .quickdate").hasClass("enddate-selected")&&$scope.run_mode&&($("#end-date-field .select-error").remove(),$("#end-date-field").append('<div class="select-error ui red pointing prompt label transition visible">'+translation.campaign_basics_select_end_date_prompt+"</div>"),$("#end-date-field").addClass("error"),$scope.valcheck=$scope.valcheck&&!1),$scope.invalidVideo&&($("#campaign-video .select-error").remove(),$("#campaign-video").addClass("error"),$scope.valcheck=$scope.valcheck&&!1),$scope.invalidThumbnailVideo&&($("#campaign-thumbnail-video .select-error").remove(),$("#campaign-thumbnail-video").addClass("error"),$scope.valcheck=$scope.valcheck&&!1)}(),$scope.public_settings.site_campaign_percentage_required&&$scope.campaignFeeValidation(),$scope.public_settings.site_theme_campaign_per_min&&$scope.campaignMinContributionValidation(),$scope.public_settings.site_theme_campaign_per_max&&$scope.campaignMaxContributionValidation(),$scope.public_settings.site_campaign_video_required&&$scope.campaignVideoValidation(),$scope.public_settings.site_theme_campaign_contract_number_enable&&$scope.campaignContractNumberValidation();else if("campaign-setup"==$scope.currentPath){if($scope.campaign.settings&&$scope.campaign.settings.campaign_manager_name&&(!$scope.hideCampaignManagerField||"undefined"==$scope.hideCampaignManagerField))$scope.campaignManagerValidation();$scope.hideCampaignDescriptionField||$scope.froalaOptionsCampaigns.froalaEditor("events.trigger","form.submit",[],!0),function(){var translation=$translate.instant(["campaign_setup_links_label_error","campaign_setup_links_url_error"]);window.formObj={};for(var i=0;i<8;i++)if(i<4)formObj["link_label"+i]={},formObj["link_label"+i].identifier="link_label"+i,formObj["link_label"+i].rules=[],formObj["link_label"+i].rules.push({type:"empty",prompt:translation.campaign_setup_links_label_error});else{var j=i-4;formObj["link_url"+j]={},formObj["link_url"+j].identifier="link_url"+j,formObj["link_url"+j].rules=[],formObj["link_url"+j].rules.push({type:"empty",prompt:translation.campaign_setup_links_url_error})}$(".ui.form.campaign-links").form(formObj,{inline:!0,on:"blur",onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form")}(),function(){var translation=$translate.instant(["campaign_basics_currency_prompt","campaign_basics_uploadimage_prompt","campaign_basics_selectcategory_prompt","campaign_basics_description_prompt"]);$scope.campaign.description||$scope.hideCampaignDescriptionField||($("#campaign-details-field .select-error").remove(),$("#campaign-details-field").append('<div class="select-error ui red pointing prompt label transition visible">'+translation.campaign_basics_description_prompt+"</div>"),$("#campaign-details-field").addClass("error"),$scope.valcheck=$scope.valcheck&&!1),!$("#featured-img-field .ui.image").hasClass("image-uploaded")&&$scope.showCampaignImageField&&($("#featured-img-field .select-error").remove(),$("#featured-img-field").append('<div class="select-error ui red pointing prompt label transition visible">'+translation.campaign_basics_uploadimage_prompt+"</div>"),$("#featured-img-field").addClass("error"),$scope.valcheck=$scope.valcheck&&!1),$(".faq-description").hasClass("has-error")?($("#faq-description").addClass("error"),$scope.valcheck=$scope.valcheck&&!1):$("#faq-description").removeClass("error")}()}else if(("rewards"==$scope.currentPath||"story"==$scope.currentPath)&&(void 0!==$scope.showCampaignDescription&&$scope.showCampaignDescription||$scope.rewardsValidation(),!$scope.campaign.description&&$scope.showCampaignDescription)){var translation=$translate.instant(["campaign_basics_description_prompt"]);$("#campaign-details-field .select-error").remove(),$("#campaign-details-field").append('<div class="select-error ui red pointing prompt label transition visible">'+translation.campaign_basics_description_prompt+"</div>"),$("#campaign-details-field").addClass("error"),$scope.valcheck=$scope.valcheck&&!1}$rootScope.scrollToError();var currentEle=$event.currentTarget,navigating=!$(currentEle).hasClass("save-campaign-button");if(!$scope.valcheck)return $event.preventDefault(),msg={header:"fail_message_save_changes_button"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),!1;$scope.enableCampaignRevisions&&2==$scope.campaign.entry_status_id&&$scope.revision&&Restangular.one("campaign",$scope.campaign.entry_id).one("revision",$scope.revision.entry_revision_id).customPUT($scope.revision).then((function(success){})),$scope.enableCampaignRevisions&&2==$scope.campaign.entry_status_id&&1==$scope.user.person_type_id&&$scope.revision&&$routeParams.revision_id&&($scope.campaign.blurb=$scope.revision.blurb,$scope.campaign.description=$scope.revision.description,$scope.campaign.name=$scope.revision.name),$scope.campaign.rewards=[];var count=0;if(angular.forEach($scope.rewards_data,(function(val){var rewardsModel={amount:val.amount,name:val.name,description:val.description,shipping_option_id:"",shipping:[],item_limit:val.item_limit,estimated_delivery_time:ISOtoPostgres(val.estimated_delivery_time_convert),pledge_level_id:val.pledge_level_id,id:val.pledge_level_id,attributes:val.attributes,expires:val.expires,priority:val.priority,coupon_id:val.selectedCoupons&&val.selectedCoupons.length>0?val.selectedCoupons[0].coupon_id:"__NULL__",selectedCoupons:val.selectedCoupons};$scope.campaign.rewards.push(rewardsModel),val.shipping.length>0&&angular.forEach(val.shipping,(function(value){var shippingOption={cost:"",name:"",description:"",shipping_option_type_id:"",country_id:"",subcountry_id:"",shipping_option_id:"",worldwideOption:""};value.sub_countries.length>0?angular.forEach(value.sub_countries,(function(sub){shippingOption={cost:sub.cost,name:sub.name,description:"",shipping_option_type_id:sub.shipping_option_type_id,country_id:sub.country_id,shipping_option_id:sub.shipping_option_id,subcountry_id:sub.subcountry_id,worldwideOption:!1},$scope.campaign.rewards[count].shipping.push(shippingOption)})):(shippingOption={cost:value.cost,name:"",description:"",shipping_option_type_id:value.shipping_option_type_id,country_id:value.country_id,shipping_option_id:value.shipping_option_id,subcountry_id:"",worldwideOption:""},1==value.shipping_option_type_id?shippingOption.worldwideOption=!0:shippingOption.worldwideOption=!1,$scope.campaign.rewards[count].shipping.push(shippingOption))})),count++})),$scope.campaign.skip_path_update=1,$scope.hideStartCampaignPage&&void 0!==$scope.hideStartCampaignPage&&($scope.campaign.uri_path="campaign/"+$scope.campaign.entry_id+"/"+$scope.campaign.name.toLowerCase().replace(/\s+/g,"-")),$scope.campaign.uri_paths[0].path=$scope.campaign.uri_path,2==$scope.runModeSelected&&($scope.campaign.ends="__NULL__",$scope.campaign.runtime_days=1,$scope.campaign.raise_mode_id=2),2==$scope.payment_gateway&&($scope.campaign.currency_id=162,$scope.widget_default_accountID?$scope.campaign.widgetmakr_account_id=$scope.widget_default_accountID:$scope.campaign.widgetmakr_account_id=$scope.widget_accountID),2!==$scope.campaign.entry_status_id&&delete $scope.campaign.entry_status_id,"getstarted"==$scope.currentPath){if(void 0!==$scope.campaign.settings&&null!=$scope.campaign.settings)if($scope.top_header_link){var selectedProtocal=$(".dropdown.top-header-link-protocol").dropdown("get value");selectedProtocal!==$scope.top_header_protocals[2].value.toLowerCase()?$scope.campaign.settings.top_header_link=selectedProtocal+$scope.top_header_link:$scope.campaign.settings.top_header_link=$scope.top_header_link}else CampaignSettingsService.deleteSettings({top_header_link:"__NULL__"}),delete $scope.campaign.settings.top_header_link;if($("#maxthreshold").checkbox("is checked")&&!$scope.public_settings.site_campaign_max_threshold_hide?$scope.thresholdvalue.value>$scope.campaign.funding_goal?$scope.campaign.maximum_allowed_funds_raised=$scope.thresholdvalue.value:($scope.campaign.maximum_allowed_funds_raised=$scope.campaign.funding_goal,$scope.thresholdvalue.value=$scope.campaign.funding_goal):($scope.thresholdvalue.value=0,$scope.campaign.maximum_allowed_funds_raised=0),1==$scope.runModeSelected&&!($scope.campaign.starts_date_time&&$scope.campaign.ends_date_time&&$scope.campaign.runtime_days>0)&&($scope.campaign.starts_date_time||$scope.campaign.runtime_days||$scope.campaign.ends_date_time))return $scope.saveError=!0,void $timeout((function(){$scope.saveError=!1}),1500);$("#location").text()||($scope.campaign.city_id="__NULL__")}else $scope.campaign.maximum_allowed_funds_raised&&($scope.thresholdvalue.value=$scope.campaign.maximum_allowed_funds_raised,$("#maxthreshold").checkbox("check"),$scope.showt.value=!0);if("rewards"==$scope.currentPath||"story"==$scope.currentPath)!function(){$scope.rlength=0,$scope.rewards_save_error=!1,countriesWithShippingStatus&&angular.forEach(countriesWithShippingStatus,(function(value,index){value.hasOwnProperty("shipping_status")&&delete value.shipping_status}));$scope.campaign.rewards.forEach((function(reward){if($("#description"+($scope.campaign.rewards.indexOf(reward)+1)).froalaEditor("codeView.isActive")&&""!=$("#description"+($scope.campaign.rewards.indexOf(reward)+1)).froalaEditor("codeView.get")&&(reward.description=$("#description"+($scope.campaign.rewards.indexOf(reward)+1)).froalaEditor("codeView.get")),reward.name&&reward.description&&reward.amount>0){var request1;if(reward.item_limit&&0!=reward.item_limit||(reward.item_limit="__NULL__"),reward.expires&&(reward.expires=convertDate(reward.expires),"string"!=typeof reward.expires&&(reward.expires=reward.expires.toISOString()),reward.expires=reward.expires.substring(0,10)),reward.id){var id=reward.id;request1=Restangular.one("campaign",campaign_id).one("pledge-level",id).customPUT(reward)}else reward.entry_id=campaign_id,request1=Restangular.one("campaign",campaign_id).one("pledge-level").customPOST(reward);request1.then((function(success){reward.id=success.id,function(reward,rewardID){var shipping=$scope.campaign.rewards[$scope.campaign.rewards.indexOf(reward)].shipping;angular.forEach(shipping,(function(obj){1==obj.shipping_option_type_id&&delete obj.country_id,!parseInt(obj.shipping_option_id)&&parseInt(obj.shipping_option_type_id)?Restangular.one("campaign",campaign_id).one("pledge-level",rewardID).one("shipping-option").customPOST(obj).then((function(success){obj.shipping_option_id=success.id})):obj.shipping_option_id&&!obj.shipping_option_type_id?Restangular.one("campaign",campaign_id).one("pledge-level",rewardID).one("shipping-option",obj.shipping_option_id).customDELETE():Restangular.one("campaign",campaign_id).one("pledge-level",rewardID).one("shipping-option",obj.shipping_option_id).customPUT(obj)})),$scope.rlength++}(reward,success.id),$scope.saveSuccessful=!0,$scope.rlength==$scope.campaign.rewards.length&&$timeout((function(){loadCampaignData(!0)}),500),$scope.updateDuplicatedCountryList(),$timeout((function(){$scope.saveSuccessful=!1}),1500)}),(function(fail){$scope.rewards_save_error=fail.data.message,reward.errorMessage=fail.data.message,$scope.updateDuplicatedCountryList()}))}}))}(),$scope.backUrl="campaign-setup/"+$routeParams.campaign_id;else{if($scope.campaign.category_id=$scope.category_ids.concat($scope.sub_category_ids.ids),2!=$scope.runModeSelected&&("string"==typeof $scope.campaign.ends_date_time&&($scope.campaign.ends_date_time=new Date($scope.campaign.ends_date_time)),$scope.campaign.ends_date_time&&"object"==typeof $scope.campaign.ends_date_time))if($scope.campaign.ends_date_time.toString().length>19){month=(month=$scope.campaign.ends_date_time.getMonth())>=9?$scope.campaign.ends_date_time.getMonth()+1:"0"+(month=$scope.campaign.ends_date_time.getMonth()+1),(day=$scope.campaign.ends_date_time.getDate())>9||(day="0"+day),(hours=$scope.campaign.ends_date_time.getHours())>9||(hours="0"+hours),(mins=$scope.campaign.ends_date_time.getMinutes())>9||(mins="0"+mins);var datestring=$scope.campaign.ends_date_time.getFullYear()+"-"+month+"-"+day+" "+hours+":"+mins+":00";$scope.campaign.ends=datestring}else $scope.campaign.ends_date_time.getTime()&&($scope.campaign.ends=$scope.campaign.ends_date_time.toString().substring(0,16)+":00");if("string"==typeof $scope.campaign.starts_date_time&&($scope.campaign.starts_date_time=new Date($scope.campaign.starts_date_time)),$scope.campaign.starts_date_time&&"object"==typeof $scope.campaign.starts_date_time)if($scope.campaign.starts_date_time.toString().length>19){var month,day,hours,mins;month=(month=$scope.campaign.starts_date_time.getMonth())>=9?$scope.campaign.starts_date_time.getMonth()+1:"0"+(month=$scope.campaign.starts_date_time.getMonth()+1),(day=$scope.campaign.starts_date_time.getDate())>9||(day="0"+day),(hours=$scope.campaign.starts_date_time.getHours())>9||(hours="0"+hours),(mins=$scope.campaign.starts_date_time.getMinutes())>9||(mins="0"+mins);datestring=$scope.campaign.starts_date_time.getFullYear()+"-"+month+"-"+day+" "+hours+":"+mins+":00";$scope.campaign.starts=datestring}else $scope.campaign.starts=$scope.campaign.starts_date_time.substring(0,16)+":00";if($scope.campaign.starts&&null!=$scope.campaign.starts&&($scope.campaign.starts_date_time=new Date($scope.campaign.starts_date_time.toString()),$scope.campaign.starts_date_time=$scope.campaign.starts_date_time.toString().replace(/\//g,"-"),$scope.campaign.starts=$scope.campaign.starts.replace(/\//g,"-")),"__NULL__"!=$scope.campaign.ends&&null!=$scope.campaign.ends&&($scope.campaign.ends_date_time=new Date($scope.campaign.ends_date_time.toString()),$scope.campaign.ends_date_time=$scope.campaign.ends_date_time.toString().replace(/\//g,"-"),$scope.campaign.ends=$scope.campaign.ends.replace(/\//g,"-")),"campaign-setup"==$scope.currentPath&&(selectedProtocols=$(".dropdown.top-header-link-protocol").dropdown("get text"),Restangular.one("campaign",campaign_id).customGET().then((function(success){initialLinks=[],angular.forEach(success.links,(function(value){"generic"==value.resource_content_type&&initialLinks.push(value)})),angular.forEach($scope.links,(function(link,index){Array.isArray(selectedProtocols)?"Relative Path"!=selectedProtocols[index]?(link.uri=link.uri.replace(/^https?\:\/\//i,""),link.resource=selectedProtocols[index]+link.uri):link.resource=link.uri:"Relative Path"!=selectedProtocols?(link.uri=link.uri.replace(/^https?\:\/\//i,""),link.resource=selectedProtocols+link.uri):link.resource=link.uri;var data_link=angular.copy(link);data_link.uri=link.resource,data_link.label=link.uri_text,data_link.uri&&(data_link.id?data_link.uri_text==initialLinks[index].uri_text&&data_link.uri==initialLinks[index].uri||(data_link.resource_type="link",Restangular.one("campaign",campaign_id).one("resource/link",data_link.id).customPUT(data_link).then((function(success){refreshLinks()}))):(data_link.resource_type="link",Restangular.one("campaign",campaign_id).one("resource/link").customPOST(data_link).then((function(success){$scope.links[index]=success.plain(),refreshLinks()}))))}))})),$scope.enableCampaignRevisions&&2==$scope.campaign.entry_status_id&&2==$scope.user.person_type_id?$scope.campaign.faq.forEach((function(faq){var faqObj;$scope.no_faq_revisions?faq.name&&faq.description&&((faqObj={}).description=faq.description,faqObj.name=faq.name,Restangular.one("campaign",campaign_id).one("faq-revision").customPOST(faqObj).then((function(success){var faqID=success[0].id;faq.faq_revision_id=faqID,faq.faq_pairs.length&&updateRevisionFAQPairs(faq)}))):((faqObj={}).description=faq.description,faqObj.name=faq.name,Restangular.one("campaign",campaign_id).one("faq-revision",faq.faq_revision_id).customPUT(faqObj),updateRevisionFAQPairs(faq))})):$scope.enableCampaignRevisions&&2==$scope.campaign.entry_status_id&&1==$scope.user.person_type_id&&$scope.campaign.faq[0].faq_revision_id?Restangular.one("campaign",campaign_id).one("faq").getList().then((function(success){success.length&&success.forEach((function(faq){faq.faq_id&&Restangular.one("campaign",$scope.campaign.entry_id).one("faq").customDELETE(faq.faq_id),faq.faq_revision_id&&Restangular.one("campaign",$scope.campaign.entry_id).one("faq-revision").customDELETE(faq.faq_revision_id)})),$scope.campaign.faq.forEach((function(faq){faq.faq_id&&(Restangular.one("campaign",$scope.campaign.entry_id).one("faq").customDELETE(faq.faq_id),faq.faq_id=null),faq.faq_revision_id&&(Restangular.one("campaign",$scope.campaign.entry_id).one("faq-revision").customDELETE(faq.faq_revision_id),faq.faq_revision_id=null),angular.forEach(faq.faq_pairs,(function(value,key){value.id&&(value.id=null)})),Restangular.one("campaign",campaign_id).one("faq").customPOST(faq).then((function(success){var faqID=success[0].id;faq.faq_id=faqID,faq.faq_pairs.length&&updateFAQPairs(faq)}))}))})):saveFAQs(),reqDeleteFileArr.length&&(reqDeleteFileArr.forEach((function(value){Restangular.one("campaign",$scope.campaign.id).one("resource/file",value).customDELETE()})),reqDeleteFileArr=[])),"getstarted"==$scope.currentPath)if(setCampaignThumbnailVideo(),$scope.enableCampaignRevisions&&2==$scope.campaign.entry_status_id&&1==$scope.user.person_type_id&&function(){$scope.campaignImages[0]&&$scope.campaignImages[0].entry_file_revision_id&&Restangular.one("campaign",campaign_id).one("resource/file/").customGET().then((function(success){var tempCampaignImages=[];if(success.length){for(var i=0;i<success.length;i++)success[i].region_id==$scope.RESOURCE_REGIONS.campaign.thumbnail&&tempCampaignImages.push(success[i]);var imageObj={file_sync_resource_id:tempCampaignImages[0].id,file_sync:!0};Restangular.one("campaign",campaign_id).one("resource-revision/file",$scope.campaignImages[0].id).customPUT(imageObj).then((function(success){Restangular.one("campaign",campaign_id).one("resource-revision/file").customDELETE($scope.campaignImages[0].id).then((function(success){getCampaignImages()}))}))}}));$scope.campaignHeaderImages[0]&&$scope.campaignHeaderImages[0].entry_file_revision_id&&Restangular.one("campaign",campaign_id).one("resource/file/").customGET().then((function(success){var tempCampaignHeaderImages=[];if(success.length){for(var i=0;i<success.length;i++)success[i].region_id==$scope.RESOURCE_REGIONS.campaign.top_header&&tempCampaignHeaderImages.push(success[i]);var imageObj={file_sync_resource_id:tempCampaignHeaderImages[0].id,file_sync:!0};Restangular.one("campaign",campaign_id).one("resource-revision/file",$scope.campaignHeaderImages[0].id).customPUT(imageObj).then((function(success){Restangular.one("campaign",campaign_id).one("resource-revision/file").customDELETE($scope.campaignHeaderImages[0].id).then((function(success){getCampaignHeaderImages()}))}))}}))}(),null==$scope.campaign.video&&($scope.campaign.video={}),void 0!==$scope.campaign.video.id&&""!=$scope.campaign.video.uri)$scope.campaign.video.entry_id=campaign_id,$scope.campaign.video.resource_id=$scope.campaign.video.id,$scope.campaign.video.resource=$scope.campaign.video.uri,$scope.campaign.video.resource_content_type="video",Restangular.one("campaign",campaign_id).one("resource/link",$scope.campaign.video.id).customPUT($scope.campaign.video).then((function(success){$scope.campaign.video=success}));else if(""!=$scope.campaign.video.uri&&void 0!==$scope.campaign.video.uri){var data={entry_id:campaign_id,resource_type:"link",resource_content_type:"video",resource:$scope.campaign.video.uri,region_id:1};Restangular.one("campaign",campaign_id).one("resource/link/").customPOST(data).then((function(success){$scope.campaign.video=success}))}else""==$scope.campaign.video.uri&&Restangular.one("campaign",campaign_id).one("resource/link/").customDELETE($scope.campaign.video.id).then((function(success){$scope.campaign.video={}}))}var delObj={};for(var property in $scope.campaign.settings)$scope.campaign.settings.hasOwnProperty(property)&&""==$scope.campaign.settings[property]&&"boolean"!=typeof $scope.campaign.settings[property]&&(delObj[property]=1);var reqArr=[];null!=$scope.campaign.settings&&null!=$scope.campaign.settings&&Object.getOwnPropertyNames($scope.campaign.settings).length&&($scope.enableCampaignRevisions&&2==$scope.campaign.entry_status_id&&2==$scope.user.person_type_id?reqArr.push(Restangular.one("campaign",campaign_id).one("setting-revision").customPUT({bio_enable:$scope.campaign.settings.bio_enable})):$scope.enableCampaignRevisions&&2==$scope.campaign.entry_status_id&&1==$scope.user.person_type_id?($scope.settingRevisions&&reqArr.push(Restangular.one("campaign",campaign_id).one("setting-revision").customPUT({bio_enable:$scope.campaign.settings.bio_enable})),reqArr.push(CampaignSettingsService.saveSettings($scope.campaign.settings))):reqArr.push(CampaignSettingsService.saveSettings($scope.campaign.settings))),msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg;var selectedProtocols,campaignSaveReq=Restangular.one("campaign",campaign_id).customPUT($scope.campaign).then((function(success){if(CreateCampaignService.cacheIn(success),loadCampaignData(!0),$scope.rewards_save_error)msg={header:"success_message_save_changes_reward_save_error"};else{if(1!=$scope.user.person_type_id&&success.total_backers>0&&"getstarted"==$scope.currentPath)var translation_value=$rootScope.checkTranslation("success_message_save_changes_button","success_message_save_changes_not_admin_button");else translation_value="success_message_save_changes_button";if($scope.enableCampaignRevisions&&2==$scope.user.person_type_id&&2==$scope.campaign.entry_status_id)translation_value="success_message_save_changes_button_revision";else if($scope.enableCampaignRevisions&&1==$scope.user.person_type_id&&2==$scope.campaign.entry_status_id)translation_value="success_message_save_changes_button_admin_revision";msg={header:translation_value}}($rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),navigating)||window.navigator.userAgent.indexOf("Trident")>-1&&window.location.reload()}),(function(failure){msg={header:failure.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}));reqArr.push(campaignSaveReq),Object.getOwnPropertyNames(delObj).length&&reqArr.push(CampaignSettingsService.deleteSettings(delObj)),$q.all(reqArr)},$scope.uploadCampaignFile=function(files){if(files.length){$scope.isUploading=!0;var url="campaign/"+$scope.campaign.id+"/resource/file";FileUploadService.uploadFile(url,files).then((function(success){var mimeType;$scope.currentUploadFile.resourceId=success.data.id,$scope.currentUploadFile.title=$scope.currentUploadFile.title?$scope.currentUploadFile.title:success.data.name,$scope.currentUploadFile.fileName=success.data.name,$scope.currentUploadFile.path=success.data.path_external,mimeType=success.data.mime_type,/image/.test(mimeType)?$scope.currentUploadFile.icon="file image":/pdf/.test(mimeType)?$scope.currentUploadFile.icon="file pdf":/text/.test(mimeType)?$scope.currentUploadFile.icon="file text":/excel/.test(mimeType)?$scope.currentUploadFile.icon="file excel":/powerpoint/.test(mimeType)?$scope.currentUploadFile.icon="file powerpoint":/msword/.test(mimeType)?$scope.currentUploadFile.icon="file word":/video/.test(mimeType)?$scope.currentUploadFile.icon="file video":/audio/.test(mimeType)?$scope.currentUploadFile.icon="file audio":$scope.currentUploadFile.icon="file",$scope.isUploading=!1}),(function(error){$scope.isUploading=!1}))}},$scope.addCampaignFile=function(){$scope.currentUploadFile.fileName&&($scope.campaign.settings.hasOwnProperty("campaign_files")||($scope.campaign.settings.campaign_files=[]),$scope.campaign.settings.campaign_files.push($scope.currentUploadFile),resetFileUpload())},$scope.cancelCampaignFile=function(){Restangular.one("campaign",$scope.campaign.id).one("resource/file",$scope.currentUploadFile.resourceId).customDELETE(),resetFileUpload()},$scope.removeFileFromSetting=function(fileObjIndex){if($scope.enableCampaignRevisions&&2==$scope.campaign.entry_status_id)return!1;var resourceId;resourceId=$scope.campaign.settings.campaign_files[fileObjIndex].resourceId,reqDeleteFileArr.push(resourceId),$scope.campaign.settings.campaign_files.splice(fileObjIndex,1)},$scope.saveVideoLink=function(){var link=window.prompt("Please enter a URL to insert","https://");Restangular.one("campaign",campaign_id).one("resource/link").customPOST({resource:link,resource_content_type:"video",region_id:$scope.RESOURCE_REGIONS.campaign.campaign.header})},$scope.searchCities=function(term){var native_lookup=1==$scope.native_lookup?1:0;term&&Geolocator.searchCities(term,native_lookup).then((function(cities){angular.forEach(cities,(function(value){checkCitiesNative(value)})),$scope.cities=cities}))},$scope.coupons=[],$scope.selectedCoupons={selected:[]},$scope.searchCoupons=function(term,reward){if(reward.selectedCoupons||(reward.selectedCoupons=[]),reward.selectedCoupons.length>=1)$scope.coupons=[];else{var filters={sort:"-created",filters:{code:term}};term&&RestFullResponse.one("portal").all("coupon").getList(filters).then((function(success){$scope.coupons=success.data}))}},$scope.$watch("multipleCity.selected",(function(value){value&&($scope.campaign.city_id=[],angular.forEach(value,(function(city){var cityID=Geolocator.lookupCityID(city.name);cityID?$scope.campaign.city_id.push(cityID):city.id&&$scope.campaign.city_id.push(city.id)})))})),$scope.$watch("campaign.starts_date_time",(function(newValue,oldValue){null!=oldValue&&null!=oldValue||null==newValue||null==newValue||null!=$scope.campaign.runtime_days&&null!=$scope.campaign.runtime_days||($scope.campaign.runtime_days=1)})),$scope.noPastDates=function(d){if(!d)return!0;d.getDay();var now=new Date;return now.setHours(0),now.setMinutes(0),now.setSeconds(0),now.setMilliseconds(0),d>=now},$scope.categorypicker={placeholder:"Please select one or more categories",width:"100%"},$scope.subcategorypicker={placeholder:"You can select sub-categories",width:"100%"},$scope.currencypicker={width:"100%"},$scope.addReward=function(arr){if($scope.reward_html_editor)rewardsModel={amount:0,name:"",pledge_level_id:"",description:"<p><br></p>",shipping_option_id:"",shipping:[],attributes:{}};else var rewardsModel={amount:0,name:"",pledge_level_id:"",description:" ",shipping_option_id:"",shipping:[],attributes:{}};arr&&(-1==reward_priority&&(reward_priority=0),rewardsModel.priority=reward_priority++,arr.push(angular.copy(rewardsModel)))},$scope.addShippingOption=function(arr){var worldwideInList=!1;angular.forEach(arr,(function(value,key){1==value.shipping_option_type_id&&(worldwideInList=!0)}));var shippingOption={cost:"",name:"",description:"",shipping_option_type_id:"",country_id:"",subcountry_id:"",sub_countries:[],worldwideOption:worldwideInList};arr&&arr.push(angular.copy(shippingOption))},$scope.addVariationOption=function(reward){reward.attributes?reward.attributes.variation||(reward.attributes.variation=[]):reward.attributes={};var variationOption={name:"",choice:[]};reward.attributes.variation||(reward.attributes.variation=[]),reward.attributes.variation.push(angular.copy(variationOption))},$scope.removeVariationOption=function(reward,index){reward.attributes.variation.splice(index,1)},$scope.addChoice=function(variation){variation&&variation.choice.push(angular.copy({value:""}))},$scope.removeChoice=function(choice,index){choice.splice(index,1)},$scope.addsubCountry=function(arr,index){angular.forEach($scope.subCountries,(function(val){val.cost&&$scope.campaign.rewards[index].shipping.push(val)}))},$scope.addLink=function(arr){arr&&arr.push(angular.copy({uri:"",resource:"",label:"",resource_content_type:"generic",region_id:2}))},$scope.addFAQ=function(arr){if($scope.public_settings.site_campaign_faq.toggle)var FAQ={name:$scope.public_settings.site_campaign_faq.name,description:$scope.public_settings.site_campaign_faq.description,faq_pairs:[]};else FAQ={name:"",description:"",faq_pairs:[]};arr&&arr.push(angular.copy(FAQ))},$scope.addFAQPair=function(FAQ){var pair={question:"",answer:"",display_priority:FAQ.length+1};if(FAQ)return FAQ.push(angular.copy(pair))},$scope.faqSortOptions={stop:function(e,ui){for(var pairs=ui.item.scope().faq.faq_pairs,i=0;i<pairs.length;i++)pairs[i].display_priority=i+1,$scope.campaign.faq[0].faq_pairs[i]=pairs[i]}},$scope.rewardVariationSortOptions={stop:function(e,ui){for(var pairs=ui.item.scope().faq.faq_pairs,i=0;i<pairs.length;i++)pairs[i].display_priority=i+1,$scope.campaign.faq[0].faq_pairs[i]=pairs[i]}},$scope.selectShippingOption=function(rewardIndex,sIndex,optionID){var default_country_id="";$scope.public_settings.hasOwnProperty("site_theme_default_shipping_country")&&(default_country_id=$scope.public_settings.site_theme_default_shipping_country.country_id),$scope.rewards_data[rewardIndex].shipping[sIndex].cost="",$scope.rewards_data[rewardIndex].shipping[sIndex].shipping_option_type_id=optionID,$scope.rewards_data[rewardIndex].shipping[sIndex].country_id=default_country_id},$scope.selectedCountry=function(reward,sIndex,countryID){var shipping=$scope.campaign.rewards[$scope.campaign.rewards.indexOf(reward)].shipping;angular.forEach(shipping,(function(value,key){key!=sIndex&&countryID==value.country_id&&(countryID=null,country_exist=!0)})),$scope.campaign.rewards[$scope.campaign.rewards.indexOf(reward)].shipping[sIndex].country_id=countryID},$scope.deleteFaq=function(faq){$scope.faq=faq,$(".delete-faq-modal").modal("show")},$scope.confirmDeleteFaq=function($event){$scope.faq.entry_id=$scope.campaign.entry_id,$scope.faq.faq_id&&Restangular.one("campaign",$scope.campaign.entry_id).one("faq",$scope.faq.faq_id).customDELETE($scope.faq),$scope.faq.faq_revision_id&&Restangular.one("campaign",$scope.campaign.entry_id).one("faq-revision").customDELETE($scope.faq.faq_revision_id);angular.copy({name:"",description:"",faq_pairs:[]},$scope.campaign.faq[0])},$scope.deleteReward=function(reward,index){$scope.reward=reward,$scope.reward.$index=index,$(".delete-reward-modal").modal("show")},$scope.removeShippingOption=function(item,array){angular.forEach(array.shipping,(function(value,key){item.$$hashKey==value.$$hashKey&&array.shipping.splice(key,1)})),item.sub_countries.length>0?angular.forEach(item.sub_countries,(function(value){value.shipping_option_id&&Restangular.one("campaign",campaign_id).one("pledge-level",array.pledge_level_id).one("shipping-option",value.shipping_option_id).customDELETE()})):item.shipping_option_id&&Restangular.one("campaign",campaign_id).one("pledge-level",array.pledge_level_id).one("shipping-option",item.shipping_option_id).customDELETE()},$scope.confirmDeleteReward=function(){$scope.reward.pledge_level_id&&Restangular.one("campaign",$scope.campaign.entry_id).one("pledge-level",$scope.reward.pledge_level_id).customDELETE(),1===$scope.rewards_data.length?$scope.rewards_data=[]:$scope.rewards_data.splice($scope.reward.$index,1)},$scope.checkShippingOption=function(data){var index=-1;angular.forEach(data,(function(value,key){if(1==value.shipping_option_type_id)return index=key,!1})),-1==index?angular.forEach(data,(function(value,key){value.worldwideOption=!1})):angular.forEach(data,(function(value,key){value.worldwideOption=!0}))},$scope.showSubCountry=function(id,rindex,shipId,shipIndex){3==shipId&&Geolocator.getSubcountriesByCountry(id).then((function(subcountries){if($scope.native_lookup)for(var i in subcountries)null!=subcountries[i].native_name&&(subcountries[i].name=subcountries[i].native_name);subcountries&&($scope.subCountries=[],angular.forEach(subcountries,(function(val){var sub={cost:0,name:"",description:"",shipping_option_type_id:3,country_id:id,subcountry_id:"",worldwideOption:!1};sub.name=val.name,sub.subcountry_id=val.subcountry_id,$scope.subCountries.push(sub)})),$scope.rewards_data[rindex].shipping[shipIndex].sub_countries=$scope.subCountries,$scope.show_sub=!0)}))},$scope.validLink=function(link){if($scope.invalidThumbnailVideo=!1,$("#campaign-thumbnail-video .select-error").remove(),$("#campaign-thumbnail-video").removeClass("error"),link){link=link.replace(/https?:\/\//gi,$location.protocol()+"://");var encoded_link=btoa(link);Restangular.one("campaign/video-check").customGET(encoded_link).then((function(success){0==success.result&&($scope.invalidThumbnailVideo=!0)}))}else $scope.invalidThumbnailVideo=!1},$scope.videoCheck=function(link){if($scope.invalidVideo=!1,$("#campaign-video .select-error").remove(),$("#campaign-video").removeClass("error"),link){$scope.campaign.video.uri=link.replace(/https?:\/\//gi,$location.protocol()+"://");var encoded_link=btoa(link);Restangular.one("campaign/video-check").customGET(encoded_link).then((function(success){0==success.result&&($scope.invalidVideo=!0)}))}else $scope.invalidVideo=!1},$scope.check=function(){$scope.checkstatus=!0},$translate(["get_started_funding_startdate_placeholder","get_started_funding_enddate_placeholder"]).then((function(value){$scope.get_started_funding_startdate_placeholder=value.get_started_funding_startdate_placeholder,$scope.get_started_funding_enddate_placeholder=value.get_started_funding_enddate_placeholder})),$scope.$watchGroup(["campaign.duration_type_id","campaign.runtime_days","campaign.starts_date_time"],(function(values,oldValues){if(void 0!==oldValues[1]&&($scope.oldtype_id=angular.copy($scope.campaign.duration_type_id),(!values[0]||values[1]<0||!values[2])&&($scope.campaign.ends_date_time=""),values[2]&&values[1]&&values[0])){var days;switch(parseInt(values[0])){case 1:days=values[1];break;case 2:days=7*values[1];break;case 3:days=30*values[1];break;case 4:days=365*values[1];break;default:days=0}isValidDate(new Date(864e5*days))&&("string"==typeof $scope.campaign.starts_date_time?$scope.campaign.ends_date_time=new Date(fix_date($scope.campaign.starts_date_time)+864e5*days):$scope.campaign.ends_date_time=new Date($scope.campaign.starts_date_time.getTime()+864e5*days))}})),$scope.$watch("campaign.starts_date_time",(function(newValue,oldValue){newValue&&($("#start-date-field .select-error").remove(),$("#start-date-field").removeClass("error"))})),$scope.$watch("campaign.ends_date_time",(function(values){if(values&&($("#end-date-field .select-error").remove(),$("#end-date-field").removeClass("error")),$scope.checkstatus&&($scope.checkstatus=!1,$scope.campaign.starts=convertDate($scope.campaign.starts_date_time),$scope.campaign.starts_date_time)){$scope.campaign.ends=convertDate(values),$scope.campaign.runtime_days=Math.round((fix_date($scope.campaign.ends_date_time)-fix_date($scope.campaign.starts_date_time))/864e5),$scope.campaign.duration_type_id=1;var day_option=$translate.instant("Day");$("#duration_dtext").text(day_option)}})),$scope.$watch("category_ids",(function(newValue,oldValue){if($scope.allCategories.length||Restangular.one("portal/category").customGET().then((function(success){$scope.allCategories=angular.copy(success)}),(function(error){console.error("Category Retrieve Error",error)})),!function(arr1,arr2){if(arr1.length!=arr2.length)return!1;for(var i=0;i<arr1.length;i++)for(var j=0;j<arr2.length;j++){if(j==arr2.length-1&&arr1[i]!=arr2)return!1;arr1[i],arr2[j]}return!0}(newValue,oldValue)&&($("#category-field .select2-choices li").hasClass("select2-search-choice")&&($("#category-field .select-error").remove(),$("#category-field").removeClass("error")),newValue&&newValue.length)){for(var subcategory_temp=[],i=0;i<newValue.length;i++)for(var j=0;j<$scope.allCategories.length;j++)$scope.allCategories[j].parent_category_id==newValue[i]&&subcategory_temp.push($scope.allCategories[j]);$scope.subcategories=angular.copy(subcategory_temp),$timeout((function(){$("#sub-category-field select").val($scope.sub_category_ids.ids).trigger("change")}),0)}})),$scope.$watch("sub_category_ids.ids",(function(newValue,oldValue){newValue!=oldValue&&$("#sub-category-field .select2-choices li").hasClass("select2-search-choice")&&($("#sub-category-field .select-error").remove(),$("#sub-category-field").removeClass("error"))})),$scope.$watch("campaignImages",(function(newValue,oldValue){newValue&&($("#featured-img-field .select-error").remove(),$("#featured-img-field").removeClass("error"))})),$scope.$watch("campaign.description",(function(newValue,oldValue){newValue&&($("#campaign-details-field .select-error").remove(),$("#campaign-details-field").removeClass("error"))})),$scope.$watch("campaign.faq[0].description",(function(newValue,oldValue){newValue&&$("#faq-description").removeClass("error")})),$scope.updateUserList=function(name){$("input[name='recipient']").removeAttr("value"),$scope.user_list_page=1,$scope.getPeopleNames(name)},$scope.getPeopleNames=function(name,append){$scope.append=!1,void 0!==append&&($scope.append=append);var filters={filters:{name:name},page:$scope.user_list_page,page_entries:$scope.user_list_page_entries};RestFullResponse.all("portal/person-public").getList(filters).then((function(success){for(var i in $scope.pagination_info=success.headers(),$scope.append||($scope.list_users=[]),success.data)void 0!==success.data[i]&&null!==success.data[i]&&"object"==typeof success.data[i]&&"id"in success.data[i]&&$scope.list_users.push(success.data[i]);$timeout((function(){$scope.list_users.length>0&&$(".recipient.dropdown").dropdown("show")}),0)}),(function(failed){$scope.list_users=!1}))},$scope.setRecipient=function(event){var first_name=event.target.attributes["first-name"].value,last_name=event.target.attributes["last-name"].value,id=event.target.attributes["data-value"].value;$scope.campaign.manager_id=id,$scope.campaign.settings.campaign_manager_name=first_name+" "+last_name},$scope.$watch((function(){return $scope.campaign.private}),(function(newValue,oldValue){newValue!=oldValue&&(newValue?($scope.campaign.settings&&!$scope.campaign.settings.original_uri_path&&($scope.campaign.settings.original_uri_path=$scope.campaign.uri_path),/campaign\/private/.test($scope.campaign.uri_path)||Restangular.one("portal/token").customGET().then((function(success){$scope.campaign.uri_path="campaign/private/"+success.token}))):$scope.campaign.settings&&$scope.campaign.settings.original_uri_path&&($scope.campaign.uri_path=$scope.campaign.settings.original_uri_path))})),$scope.$watch("campaignFundingGoal.value",(function(newValue,oldValue){newValue!=oldValue&&newValue&&$scope.campaign&&"string"==typeof newValue&&($scope.campaign.funding_goal=$rootScope.formatFundingGoal(newValue))})),$scope.$watch("thresholdvalue.value",(function(newValue,oldValue){newValue!=oldValue&&newValue&&$scope.campaign&&"string"==typeof newValue&&($scope.campaign.threshold=$rootScope.formatFundingGoal(newValue))}))}]);