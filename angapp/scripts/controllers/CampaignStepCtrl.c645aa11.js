app.controller("CampaignStepCtrl",["$location","CampaignSettingsService","Restangular","$routeParams","$scope","CreateCampaignService","PortalSettingsService","UserService","$rootScope",function($location,CampaignSettingsService,Restangular,$routeParams,$scope,CreateCampaignService,PortalSettingsService,UserService,$rootScope){$scope.verified=!1;var paras=$location.$$path.split("/");function getSiteSettings(){PortalSettingsService.getSettingsObj().then((function(success){$scope.public_settings=success.public_setting,$scope.direct_transaction=success.public_setting.site_campaign_fee_direct_transaction,$scope.contributionEnabled=success.public_setting.site_campaign_contributions,$scope.reward_show=success.public_setting.site_theme_campaign_show_reward_section,$scope.payment_gateway=success.public_setting.site_payment_gateway,$scope.isStepFundingDelayed=success.public_setting.site_theme_campaign_delayed_funding_setup,$scope.enableCampaignRevisions=success.public_setting.site_campaign_enable_campaign_revisions,$scope.isStepRewardDelayed=success.public_setting.site_theme_campaign_delayed_reward_setup,$scope.hideAllCampaignRewardsFields=success.public_setting.site_campaign_creation_hide_campaign_rewards_fields,$scope.showCampaignDescription=success.public_setting.site_campaign_creation_show_campaign_description_field,$scope.hideCampaignImageField=success.public_setting.site_campaign_creation_hide_campaign_image_field,$scope.hideCampaignBlurbField=success.public_setting.site_campaign_creation_hide_campaign_blurb_field,$scope.hideCampaignCategoryField=success.public_setting.site_campaign_creation_hide_campaign_category_field,$scope.showCampaignImageField=success.public_setting.site_campaign_creation_show_campaign_image_field,$scope.moveLaunchButtonStep5=success.public_setting.site_campaign_creation_launch_campaign_on_step5,$scope.bankFormEnabled=$scope.public_settings.site_campaign_country_funding_step,void 0!==$scope.public_settings.site_campaign_hide_profile&&null!=$scope.public_settings.site_campaign_hide_profile||($scope.public_settings.site_campaign_hide_profile=!1),CreateCampaignService.load($scope.campaign_entry_id).then((function(success){$rootScope.campaignInEditing=success,$scope.campaign=success,CampaignSettingsService.setCampaignId($scope.campaign_entry_id),CampaignSettingsService.processSettings(success.settings),$scope.campaign.settings=CampaignSettingsService.getSettings(),Restangular.one("campaign",$scope.campaign.id).one("stripe-account").customGET().then((function(stripe){stripe.length&&($scope.stripe_account_id=stripe[0].id)})),hasImage()&&$scope.campaign.name&&$scope.campaign.raise_mode_id&&$scope.campaign.profile_type_id&&$scope.campaign.blurb&&$scope.campaign.categories&&$scope.campaign.funding_goal&&$scope.campaign.currency_id&&$scope.campaign.description?$scope.isPreviewDone=!0:$scope.isPreviewDone=!1,$scope.decideStepsNeeded()})),$scope.hideAllCampaignRewardsFields&&$scope.showCampaignDescription?$scope.thirdStepPath="story":$scope.thirdStepPath="rewards"}))}function hasImage(){var bool=!1;return $scope.campaign.files&&angular.forEach($scope.campaign.files,(function(file){3!=file.region_id||(bool=!0)})),bool}$scope.path=paras[1],$scope.campaign_entry_id=$routeParams.campaign_id,$scope.thirdStepPath="",$routeParams.revision_id&&($scope.revisionIdParam="/?revision_id="+$routeParams.revision_id),$scope.uid=UserService.person_type_id,$rootScope.campaignInEditing&&$rootScope.campaignInEditing.id==parseInt($scope.campaign_entry_id)?($scope.campaign=$rootScope.campaignInEditing,getSiteSettings()):getSiteSettings(),$scope.decideStepsNeeded=function(){$scope.profile_show=!$scope.public_settings.site_campaign_hide_profile||1==$scope.uid,$scope.master_reward_show=!1,$scope.reward_show&&($scope.master_reward_show=!0),$scope.isStepRewardDelayed&&2!=$scope.campaign.entry_status_id&&($scope.master_reward_show=!1),$scope.public_settings.site_enable_advanced_widget?2==$scope.payment_gateway||$scope.direct_transaction&&!$scope.bankFormEnabled||!$scope.contributionEnabled||$scope.isStepFundingDelayed&&!$scope.campaign.ever_published?$scope.master_reward_show?($scope.step_class="six column",$scope.profile_show||($scope.step_class="five column")):($scope.step_class="five column",$scope.profile_show||($scope.step_class="four column")):$scope.master_reward_show?($scope.step_class="seven column",$scope.profile_show||($scope.step_class="six column")):($scope.step_class="six column",$scope.profile_show||($scope.step_class="five column")):2==$scope.payment_gateway||$scope.direct_transaction&&!$scope.bankFormEnabled||!$scope.contributionEnabled||$scope.isStepFundingDelayed&&!$scope.campaign.ever_published?$scope.master_reward_show?($scope.step_class="five column",$scope.profile_show||($scope.step_class="four column")):($scope.step_class="four column",$scope.profile_show||($scope.step_class="three column")):$scope.master_reward_show?($scope.step_class="six column",$scope.profile_show||($scope.step_class="five column")):($scope.step_class="five column",$scope.profile_show||($scope.step_class="four column"))},$scope.validateBasicStep=function(){return $scope.hideCampaignBlurbField&&$scope.hideCampaignCategoryField&&$scope.hideCampaignImageField?$scope.campaign.name&&$scope.campaign.funding_goal&&$scope.campaign.starts&&$scope.campaign.ends:$scope.hideCampaignBlurbField?$scope.campaign.name&&$scope.campaign.funding_goal&&hasImage()&&$scope.campaign.starts&&$scope.campaign.ends:$scope.hideCampaignImageField?$scope.campaign.name&&$scope.campaign.blurb&&$scope.campaign.funding_goal&&$scope.campaign.starts&&$scope.campaign.ends&&$scope.campaign.categories:$scope.hideCampaignCategoryField?$scope.campaign.name&&$scope.campaign.blurb&&$scope.campaign.funding_goal&&$scope.campaign.starts&&$scope.campaign.ends&&hasImage():$scope.campaign.ends?$scope.campaign.name&&$scope.campaign.blurb&&$scope.campaign.funding_goal&&$scope.campaign.starts&&$scope.campaign.ends&&hasImage()&&$scope.campaign.categories:$scope.campaign.name&&$scope.campaign.blurb&&$scope.campaign.funding_goal&&$scope.campaign.starts&&hasImage()&&$scope.campaign.categories},$scope.validateDetailStep=function(){return $scope.showCampaignImageField?hasImage():$scope.public_settings.site_campaign_enable_campaign_bio?$scope.campaign&&$scope.campaign.settings?$scope.campaign.settings.bio_enable:void 0:$scope.campaign.description},$scope.validateRewardStep=function(){return $scope.hideAllCampaignRewardsFields&&$scope.showCampaignDescription?$scope.campaign.description:!$scope.public_settings.site_theme_campaign_show_reward_required||!!$scope.campaign.pledges},$scope.validateProfileStep=function(){return void 0===$scope.public_settings.site_verification&&($scope.public_settings.site_verification={toggle:!1}),1===$scope.campaign.profile_type_id||$scope.campaign.business_organizations&&$scope.campaign.business_organizations.length?!$scope.public_settings.site_verification.toggle||$rootScope.verified:void 0},$scope.validateFundingStep=function(){if($scope.campaign.settings)return $scope.campaign.settings.country_bank_form?!!$scope.campaign.settings.bank:!!$scope.direct_transaction||(!!$scope.stripe_account_id||$scope.campaign.stripe_account_id)}}]);