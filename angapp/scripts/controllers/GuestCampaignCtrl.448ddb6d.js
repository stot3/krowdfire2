app.controller("GuestCampaignCtrl",["$q","$location","$scope","UserService","StripeService","$routeParams","$translatePartialLoader","$translate","Restangular","Geolocator","RESOURCE_REGIONS",function($q,$location,$scope,UserService,StripeService,$routeParams,$translatePartialLoader,$translate,Restangular,Geolocator,RESOURCE_REGIONS){$scope.RESOURCE_REGIONS=RESOURCE_REGIONS,window.a=$scope,$scope.pledgeLevel=$routeParams.plid,$scope.pledgeAmount=parseInt($routeParams.m),$scope.campaign_id=$routeParams.eid,$scope.selectedCity={},$scope.toggle={newCard:!1,newAddress:!1,selectedCard:!1,selectedAddress:!1},$("i").popup(),Restangular.one("campaign",$scope.campaign_id).get().then((function(success){$scope.campaign=success;var count=0;angular.forEach($scope.campaign.pledges,(function(value,key){$scope.pledgeLevel==value.pledge_level_id&&($scope.pledgeindex=count),count++}))})),$scope.dropdownReset=function(selector){".address-select"==selector?$scope.selectedAddress=null:$scope.selectedCardID=null,$(selector).dropdown("restore defaults")},$scope.address={city_id:"",mail_code:"",street1:"",street2:"",country_id:""},$scope.creditCard={email:"",number:"",exp_month:"",exp_year:"",cvc:"",first_name:"",last_name:""},$scope.guestinfo={},$scope.company={name:""},$scope.submit=function(){if(!($("form, ng-form").find(".ng-invalid,.has-error").length>0)){$("div.loader").addClass("active");var promises=[];$scope.pledgeLevel||($scope.company.name&&promises.push(Restangular.one("account/business/guest").customPOST($scope.company)),promises.push(StripeService.newGuestPledgerAccount($scope.creditCard))),$scope.pledgeLevel&&(promises.push(StripeService.newGuestPledgerAccount($scope.creditCard)),$scope.company.name&&promises.push(Restangular.one("account/business/guest").customPOST($scope.company)),$scope.campaign.pledges[$scope.pledgeindex].shipping&&promises.push(Restangular.one("account/address/guest").customPOST($scope.address))),$q.all(promises).then((function(resolved){angular.forEach(resolved,(function(value){value.card_id&&($scope.guest_card_id=value.card_id,$scope.guest_fingerprint=value.fingerprint),value.address_id&&($scope.selectedAddressID=value.address_id)}));var pledgeInfo={pledge_level_id:$scope.pledgeLevel,amount:$scope.totalAmount,shipping_address_id:$scope.selectedAddressID||"",card_id:$scope.guest_card_id,fingerprint:$scope.guest_fingerprint,email:$scope.creditCard.email,last_name:$scope.creditCard.last_name,first_name:$scope.creditCard.first_name};Restangular.one("campaign",$scope.campaign_id).one("pledge/guest").customPOST(pledgeInfo).then((function(success){$scope.responseMsg="Thank you for your contribution",$(".thank-you").dimmer({closable:!1}).dimmer("show")}),(function(failed){$("div.loader").removeClass("active"),$scope.responseMsg="Invalid Card"}))}),(function(failed){$("div.loader").removeClass("active"),$scope.responseMsg=failed.data.message}))}},$scope.openModalById=function(id){$(".ui.modal#"+id).modal("show")},$scope.cities=[],$scope.searchCities=function(term){term&&Geolocator.searchCities(term).then((function(cities){$scope.cities=cities}))},$scope.$watch("selectedCity.selected",(function(value){value&&(cityID=Geolocator.lookupCityID(value.name),cityID&&($scope.address.city_id=cityID),countryID=Geolocator.lookupCountryID(value.name),countryID&&($scope.address.country_id=countryID))})),$scope.$watch("address.country_id",(function(countryID){var worldWide=null,country=null;countryID&&(angular.forEach($scope.shippingOption,(function(item,key){item.country_id==countryID&&(country=key),1==item.shipping_option_type_id&&(worldWide=key)})),null!=country?$scope.costIndex=country:null!=worldWide&&($scope.costIndex=worldWide))})),$scope.goBackToCampaign=function(){$location.path("/campaign/"+$scope.campaign.entry_id+"/"+$scope.campaign.name)},$scope.total=function(shipping){return $scope.totalAmount=shipping?parseInt($scope.pledgeAmount)+parseInt(shipping):$scope.pledgeAmount,$scope.totalAmount}}]);