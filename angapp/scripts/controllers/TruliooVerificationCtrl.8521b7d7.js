app.controller("TruliooVerificationCtrl",["$translate","$scope","UserService","$rootScope","Restangular","$q","Geolocator","API_URL",function($translate,$scope,UserService,$rootScope,Restangular,$q,Geolocator,API_URL){function getCustomFieldsAndVerify(person_id){getCustomFields(person_id).then((function(success){success.length>0&&(!(!success[0].attributes||!success[0].attributes.hasOwnProperty("trulioo_verified"))&&success[0].attributes.trulioo_verified)?($scope.truliooVerified=!0,$scope.verifyTruliooLoading.confirm_loading=!1):($scope.truliooVerified=!1,$scope.verifyTruliooLoading.confirm_loading=!1)}))}function getAddress(paramID){return Restangular.one("account/").customGET("address",{person_id:paramID}).then((function(success){if(success)return{paddress:success.personal,baddress:success.business}}))}function getPhoneNumber(paramID){return Restangular.one("account/").customGET("phone-number",{person_id:paramID}).then((function(success){return{pphonenumber:success.personal,bphonenumber:success.business}}))}function checkNative(addressData){return angular.forEach(addressData,(function(value,key){if($scope.native_lookup){var name="";null!=value.country_native_name?name+=value.country_native_name:name+=value.country,null!=value.subcountry_native_name?name+=" "+value.subcountry_native_name:name+=" "+value.subcountry,null!=value.city_native_name&&"Other"!=value.city?name+=", "+value.city_native_name:"Other"!=value.city?name+=", "+value.city:value.city="",value.city_full=name}})),addressData}$scope.truliooNeededFields={},$scope.truliooVerified=!1,$scope.verifyTruliooLoading={loading:!1,confirm_loading:!0},$scope.user=UserService,$scope.valCheck=!0,confirmTruliooTransaction=function(transId){var xhr=new XMLHttpRequest;return xhr.open("GET",API_URL.identity_proxy_url+"/confirm/"+transId,!0),xhr.setRequestHeader("Content-Type","application/json"),xhr.send(),new Promise((function(resolve,reject){xhr.onload=function(){if(200===xhr.status){var response=JSON.parse(xhr.response);resolve(response)}else reject({error:"Unable to communicate with server."})}}))},verifyTrulioo=function(){$scope.verifyTruliooLoading.loading=!0;var payload=$scope.truliooNeededFields;if(payload){payload={AcceptTruliooTermsAndConditions:!0,CleansedAddress:!1,FirstGivenName:payload.FirstGivenName.value,FirstSurName:payload.FirstSurName.value,BuildingNumber:payload.BuildingNumber.value,StreetName:payload.StreetName.value,City:payload.City.value,StreetName:payload.StreetName.value,PostalCode:payload.PostalCode.value};var xhr=new XMLHttpRequest;return xhr.open("POST",API_URL.identity_proxy_url+"/verifyuser/"+$scope.user.id,!0),xhr.setRequestHeader("Content-Type","application/json"),xhr.send(JSON.stringify(payload)),$(".ui.modal.addresses-modal").modal("hide"),new Promise((function(resolve,reject){xhr.onload=function(){var trulioo_verified={country:"",product_name:"",verified:!1,response:!1};if(200===xhr.status){var response=JSON.parse(xhr.response);Array.isArray(response)?response[0].attributes&&response[0].attributes.hasOwnProperty("trulioo_verified")?$scope.$apply((function(){trulioo_verified.verified.verified=!0,$scope.truliooVerified=!0,$rootScope.verified=!0,$scope.verifyTruliooLoading.loading=!1})):$scope.$apply((function(){$scope.verifyTruliooLoading.loading=!1,reject(response)})):response.hasOwnProperty("Record")&&"match"===response.Record.RecordStatus?$scope.$apply((function(){trulioo_verified.verified.verified=!0,$scope.truliooVerified=!0,$rootScope.verified=!0,$scope.verifyTruliooLoading.loading=!1,resolve(trulioo_verified)})):$scope.$apply((function(){$scope.verifyTruliooLoading.loading=!1,reject(response)}))}else reject(!1)}}))}},$scope.savePersonAttributes=function(person_id,$data){console.log($data),Restangular.one("portal/person/attribute",person_id).customPUT($data)},$scope.generateTruliooNeededFields=function(promises){return $q.all(promises).then((function(result){var phoneNumber,country_code,xhr;$scope.useAddress;for(var i=0;i<result.length;i++){if(result[i]&&result[i].hasOwnProperty("paddress")&&result[i].paddress&&result[i].paddress[0].hasOwnProperty("address_type"))for(var j=0;j<result[i].paddress.length;j++)if(result[i].paddress[j].primary_address){$scope.useAddress=result[i].paddress[j];break}result[i]&&result[i].hasOwnProperty("pphonenumber")&&result[i].pphonenumber&&result[i].pphonenumber[0].hasOwnProperty("phone_number_type")&&(phoneNumber=result[i].pphonenumber[0])}return $scope.useAddress?(country_code=$scope.useAddress.code_iso3166_1,xhr=new XMLHttpRequest,xhr.open("GET",API_URL.identity_proxy_url+"/fields/"+country_code,!0),xhr.setRequestHeader("Content-Type","application/json"),xhr.send(),new Promise((function(resolve,reject){xhr.onload=function(){if(200===xhr.status){var response=JSON.parse(xhr.response);resolve(response)}else reject({error:"Unable to communicate with server."})}}))).then((function(success){if("object"==typeof success){var personInfoReq=success.properties.PersonInfo.properties,locationReq=success.properties.Location.properties,communicationReq=success.properties.Communication.properties;return $scope.$apply((function(){if(personInfoReq)for(var property in personInfoReq)"FirstGivenName"===property&&($scope.truliooNeededFields[property]={value:$scope.user.first_name,required:-1!=success.properties.PersonInfo.required.indexOf(property)}),"FirstSurName"===property&&($scope.truliooNeededFields[property]={value:$scope.user.last_name,required:-1!=success.properties.PersonInfo.required.indexOf(property)});if(locationReq)for(var property in locationReq)"City"===property&&($scope.truliooNeededFields[property]={value:$scope.useAddress.city,required:-1!=success.properties.Location.required.indexOf(property)}),"PostalCode"===property&&($scope.truliooNeededFields[property]={value:$scope.useAddress.mail_code,required:-1!=success.properties.Location.required.indexOf(property)}),"StreetName"===property&&($scope.truliooNeededFields[property]={value:$scope.useAddress.street2,required:-1!=success.properties.Location.required.indexOf(property)}),"BuildingNumber"===property&&($scope.truliooNeededFields[property]={value:$scope.useAddress.street1,required:-1!=success.properties.Location.required.indexOf(property)}),"StateProvinceCode"===property&&($scope.truliooNeededFields[property]={value:$scope.useAddress.subcountry,required:-1!=success.properties.Location.required.indexOf(property)});if(communicationReq)for(var property in communicationReq)"EmailAddress"===property&&($scope.truliooNeededFields[property]={value:$scope.user.email,required:-1!=success.properties.Communication.required.indexOf(property)}),phoneNumber&&phoneNumber.hasOwnProperty("phone_number_type")&&"Mobile Phone Number"===phoneNumber.phone_number_type&&"MobileNumber"===property&&($scope.truliooNeededFields[property]={value:phoneNumber.number,required:-1!=success.properties.Communication.required.indexOf(property)}),phoneNumber&&phoneNumber.hasOwnProperty("phone_number_type")&&"Landline Phone Number"===phoneNumber.phone_number_type&&"Telephone"===property&&($scope.truliooNeededFields[property]={value:phoneNumber.number,required:-1!=success.properties.Communication.required.indexOf(property)}),!$scope.truliooNeededFields.TelephoneType&&phoneNumber&&($scope.truliooNeededFields.TelephoneType={value:phoneNumber.phone_number_type,required:-1!=success.properties.Communication.required.indexOf(property)})})),$scope.truliooNeededFields}})):{error:"No primary address set"}}))},$scope.onPageLoad=function(person_id){Restangular.one("account/address").customGET().then((function(success){$scope.personal_addresses=checkNative(success.personal),$scope.business_addresses=checkNative(success.business)})),$scope.generateTruliooNeededFields([getAddress(person_id),getPhoneNumber(person_id)])},getCustomFields=function(person_id){return $scope.custom_field=[],Restangular.one('portal/person/attribute?filters={"person_id":"'+person_id+'"}').customGET().then((function(success){return $scope.$emit("loading_finished"),success&&($scope.custom_field=success),$scope.public_settings.site_campaign_enable_organization_name&&$scope.custom_field[0].attributes&&($scope.organization_name.value=$scope.custom_field[0].attributes.organization_name,$scope.organization_name.ein=$scope.custom_field[0].attributes.ein),$scope.public_settings.site_campaign_business_section_custom&&$scope.public_settings.site_campaign_business_section_custom.length>0&&($scope.bcustom=[],angular.forEach($scope.public_settings.site_campaign_business_section_custom,(function(value){var fieldRequire=!1,fieldPlaceholder="";value.placeholder&&(fieldPlaceholder=value.placeholder),value.profile_setting_required&&(fieldRequire=value.profile_setting_required);var field={name:value.name,identifier:"customFieldBusiness"+key,value:"",placeholder:fieldPlaceholder,required:fieldRequire};angular.forEach($scope.custom_field[0].attributes,(function(val,key,obj){key&&key==value.name&&(field.value=val)})),$scope.bcustom.push(field)})),$scope.bcustom_copy=angular.copy($scope.bcustom)),$scope.public_settings.site_campaign_personal_section_custom&&$scope.public_settings.site_campaign_personal_section_custom.length>0&&($scope.pcustom=[],angular.forEach($scope.public_settings.site_campaign_personal_section_custom,(function(value,key){var fieldRequire=!1,fieldPlaceholder="";if(value.placeholder&&(fieldPlaceholder=value.placeholder),value.profile_setting_required&&(fieldRequire=value.profile_setting_required),$scope.public_settings.site_campaign_personal_section_enhanced)var field={name:value.name,identifier:"customField"+key,value:"",option:value.option,dropdown_array:value.dropdown_array,profile_step_show:value.profile_step_show,profile_setting_register_show:value.profile_setting_register_show,profile_setting_show:value.profile_setting_show,register_show:value.register_show,validate:value.validate,placeholder:fieldPlaceholder,required:fieldRequire};else field={name:value.name,identifier:"customField"+key,value:"",option:"Text",dropdown_array:null,profile_step_show:!0,placeholder:fieldPlaceholder,required:fieldRequire};angular.forEach($scope.custom_field[0].attributes,(function(val,key,obj){key&&key==value.name&&(field.value=val)})),$scope.pcustom.push(field)})),$scope.pcustom_copy=angular.copy($scope.pcustom)),$scope.custom_field}),(function(error){return $scope.custom_field=[],$scope.pcustom=[],$scope.pcustom_copy=angular.copy($scope.pcustom),$scope.custom_field}))},$rootScope.$on("TruliooPageLoad",(function(evt,data){var person_id=data&&data.hasOwnProperty("person")?data.person.person_id:void 0;void 0!==person_id&&($scope.user=data.person),$scope.generateTruliooNeededFields([getAddress(person_id),getPhoneNumber(person_id)]),getCustomFieldsAndVerify(person_id)})),$scope.onPageLoad(),getCustomFieldsAndVerify($scope.user.id),$scope.showAddresses=function(){$(".addresses-modal").modal("setting",{closable:!1}).modal("show")},$scope.searchCities=function(term){var native_lookup=1==$scope.public_setting.site_theme_shipping_native_lookup?1:0;term&&Geolocator.searchCities(term,native_lookup).then((function(cities){$scope.cities=cities}))},addressValidation=function(){var translation=$translate.instant(["tab_address_select_company_error","tab_address_address1_error","tab_address_mailcode_error"]);$(".address-form").form({company_select:{identifier:"company_select",rules:[{type:"empty",prompt:translation.tab_address_select_company_error}]},address1:{identifier:"address1",rules:[{type:"empty",prompt:"Please specify building number"}]},address1:{identifier:"address2",rules:[{type:"empty",prompt:"Please specify street name"}]},mail_code:{identifier:"mail_code",rules:[{type:"empty",prompt:translation.tab_address_mailcode_error}]}},{inline:!0,onSuccess:function(){$scope.valCheck=$scope.valCheck&&!0},onFailure:function(){$scope.valCheck=$scope.valCheck&&!1}}).form("validate form")},setTruliooNeededFields=function(address){$scope.truliooNeededFields={AcceptTruliooTermsAndConditions:!0,CleansedAddress:!1,FirstGivenName:{value:$scope.user.first_name,required:!0},FirstSurName:{value:$scope.user.last_name,required:!0},BuildingNumber:{value:address.street1,required:!0},StreetName:{value:address.street2,required:!0},City:{value:address.city?address.city:address.selected.city,required:!0},PostalCode:{value:address.mail_code,required:!0}}},$scope.setAddress=function(){var selectedOption=function(){var selected=null;return $("table.address-table-personal").find("tbody td.t-check-box input").each((function(){$(this).prop("checked")&&(selected=$(this).scope())})),selected}();if($(".ui.modal.addresses-modal").modal("setting",{onApprove:function(){return!1}}),null!==selectedOption)if(selectedOption.hasOwnProperty("address"))setTruliooNeededFields(selectedOption.address),verifyTrulioo();else if(selectedOption.hasOwnProperty("newAddress")&&(addressValidation(),$scope.valCheck)){var payload={street1:selectedOption.newAddress.street1,street2:selectedOption.newAddress.street2,city_id:selectedOption.newAddress.selected.city_id,mail_code:selectedOption.newAddress.mail_code,primary_address:1};angular.forEach($scope.personal_addresses,(function(value){if(1==value.primary_address){unsetPrimary=Restangular.one("account/address",value.address_id).customPUT({primary_address:0})}})),Restangular.one("account/address").customPOST(payload).then((function(success){msg={header:"tab_address_save_success"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),setTruliooNeededFields(selectedOption.newAddress),verifyTrulioo()}),(function(failed){msg={header:failed.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}))}}}]);