app.controller("AdminUsersCtrl",["$scope","PortalSettingsService","$rootScope","$timeout","$q","$translatePartialLoader","Restangular","RestFullResponse","FileUploadService","$translate","UserService",function($scope,PortalSettingsService,$rootScope,$timeout,$q,$translatePartialLoader,Restangular,RestFullResponse,FileUploadService,$translate,UserService){$scope.clearMessage=function(){$rootScope.floatingMessage=[]};var msg={};function updateUserListing(sortOrFilters){RestFullResponse.one("portal").all("person").getList(sortOrFilters).then((function(success){$("#myloader").hide("fast",(function(){$("body").removeClass("loading")})),$scope.persons=success.data,$scope.data=[];var headers=success.headers();$scope.sortOrFiltersPerson.pagination.currentpage=headers["x-pager-current-page"],$scope.sortOrFiltersPerson.pagination.numpages=headers["x-pager-last-page"],$scope.sortOrFiltersPerson.pagination.nextpage=headers["x-pager-next-page"],$scope.sortOrFiltersPerson.pagination.pagesinset=headers["x-pager-pages-in-set"],$scope.sortOrFiltersPerson.pagination.totalentries=headers["x-pager-total-entries"],$scope.sortOrFiltersPerson.pagination.entriesperpage=headers["x-pager-entries-per-page"],createUserCSV($scope.persons,$scope.data)}))}function createUserCSV(userData,userDataCSV){var value=$translate.instant(["tab_user_admin","tab_user_registered","tab_user_pending","tab_user_approved","tab_user_disabled","tab_user_name","tab_user_email","tab_user_usertype","tab_user_created","tab_user_status","tab_user_iD"]);$scope.regis=value.tab_user_registered,$scope.admin=value.tab_user_admin,$scope.userpend=value.tab_user_pending,$scope.userapprv=value.tab_user_approved,$scope.userdis=value.tab_user_disabled,$scope.uid=value.tab_user_iD,$scope.uname=value.tab_user_name,$scope.uemail=value.tab_user_email,$scope.utype=value.tab_user_usertype,$scope.ucreated=value.tab_user_created,$scope.ustatus=value.tab_user_status,$scope.csvheader={id:$scope.uid,name:$scope.uname,email:$scope.uemail,type:$scope.utype,created:$scope.ucreated,Status:$scope.ustatus},userDataCSV.push($scope.csvheader),angular.forEach(userData,(function(value){var data1;switch(1==value.person_type_id?$scope.usertype=$scope.admin:$scope.usertype=$scope.regis,value.person_status_id){case 1:$scope.userstatus=$scope.userpend;break;case 2:$scope.userstatus=$scope.userapprv;break;case 3:$scope.userstatus=$scope.userdis}$scope.fullname=value.first_name+" "+value.last_name,data1={id:value.person_id,name:$scope.fullname,email:value.email,type:$scope.usertype,created:value.created.slice(0,10),Status:$scope.userstatus},userDataCSV.push(data1)}))}function confirmMultiUserDelete(){msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg;var requestQueue=[];angular.forEach($scope.peopleToDelete,(function(value){var id;requestQueue.push((id=value.id,Restangular.one("portal/person",id).customDELETE()))})),$q.all(requestQueue).then((function(success){angular.forEach(success,(function(value){var deleted_person_id=value.id;angular.forEach($scope.persons,(function(value,key){value.id==deleted_person_id&&$scope.persons.splice(key,1)}))})),msg={header:"users_deleted_successfully"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),$scope.testval=msg.header,$translate($scope.testval).then((function(value){value&&($scope.Message1=value)}))}),(function(failed){msg={header:failed.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}))}function checkNative(addressData){return angular.forEach(addressData,(function(value,key){if($scope.native_lookup){var name="";null!=value.country_native_name?name+=value.country_native_name:name+=value.country,null!=value.subcountry_native_name?name+=" "+value.subcountry_native_name:name+=" "+value.subcountry,null!=value.city_native_name&&"Other"!=value.city?name+=", "+value.city_native_name:"Other"!=value.city?name+=", "+value.city:value.city="",value.city_full=name}})),addressData}$scope.organization_name={},$scope.sortOrFiltersPerson={sort:"-created",filters:{person_status:{},person_type:{}},page_entries:25,page_limit:100,pagination:{},page:1},$scope.createdtype="-created",$scope.createdbtn=!0,$scope.showcreated=!0,$scope.nametype="-first_name",$scope.namebtn=!0,$scope.showname=!1,$scope.persontype="-person_id",$scope.personbtn=!0,$scope.showperson=!1,Restangular.one("portal/setting").customGET().then((function(success){angular.forEach(success,(function(value){"site_payment_gateway"==value.name?$scope.payment_gateway=value.value:"site_theme_campaign_display_iso_date"==value.name&&($scope.isISODate=value.value)}))})),PortalSettingsService.getSettingsObj().then((function(success){$scope.public_settings=success.public_setting,$scope.isRemoveUserProfileBio=success.public_setting.site_remove_user_profile_bio})),$scope.getCustomFields=function(person_id){$scope.custom_field=[],Restangular.one('portal/person/attribute?filters={"person_id":"'+person_id+'"}').customGET().then((function(success){$scope.$emit("loading_finished"),success&&($scope.custom_field=success),$scope.public_settings.site_campaign_enable_organization_name&&$scope.custom_field[0].attributes&&($scope.organization_name.value=$scope.custom_field[0].attributes.organization_name,$scope.organization_name.ein=$scope.custom_field[0].attributes.ein),$scope.public_settings.site_campaign_business_section_custom&&$scope.public_settings.site_campaign_business_section_custom.length>0&&($scope.bcustom=[],angular.forEach($scope.public_settings.site_campaign_business_section_custom,(function(value){var fieldRequire=!1,fieldPlaceholder="";value.placeholder&&(fieldPlaceholder=value.placeholder),value.profile_setting_required&&(fieldRequire=value.profile_setting_required);var field={name:value.name,identifier:"customFieldBusiness"+key,value:"",placeholder:fieldPlaceholder,required:fieldRequire};angular.forEach($scope.custom_field[0].attributes,(function(val,key,obj){key&&key==value.name&&(field.value=val)})),$scope.bcustom.push(field)})),$scope.bcustom_copy=angular.copy($scope.bcustom)),$scope.public_settings.site_campaign_personal_section_custom&&$scope.public_settings.site_campaign_personal_section_custom.length>0&&($scope.pcustom=[],angular.forEach($scope.public_settings.site_campaign_personal_section_custom,(function(value,key){var fieldRequire=!1,fieldPlaceholder="";if(value.placeholder&&(fieldPlaceholder=value.placeholder),value.profile_setting_required&&(fieldRequire=value.profile_setting_required),$scope.public_settings.site_campaign_personal_section_enhanced)var field={name:value.name,identifier:"customField"+key,value:"",option:value.option,dropdown_array:value.dropdown_array,profile_step_show:value.profile_step_show,profile_setting_register_show:value.profile_setting_register_show,profile_setting_show:value.profile_setting_show,register_show:value.register_show,validate:value.validate,placeholder:fieldPlaceholder,required:fieldRequire};else field={name:value.name,identifier:"customField"+key,value:"",option:"Text",dropdown_array:null,profile_step_show:!0,placeholder:fieldPlaceholder,required:fieldRequire};angular.forEach($scope.custom_field[0].attributes,(function(val,key,obj){key&&key==value.name&&(field.value=val)})),$scope.pcustom.push(field)})),$scope.pcustom_copy=angular.copy($scope.pcustom))}),(function(error){$scope.custom_field=[],$scope.pcustom=[],$scope.pcustom_copy=angular.copy($scope.pcustom),$scope.$emit("loading_finished")}))},$scope.customFieldDropdown=function(option,field){field.value=option},$scope.savePersonAttributes=function(person_id,$data){Restangular.one("portal/person/attribute",person_id).customPUT($data)},$scope.checkentry=function(){$scope.entries=$("#searchbtn").dropdown("get value"),$scope.sortOrFiltersPerson.page_entries=$scope.entries,updateUserListing($scope.sortOrFiltersPerson)},$scope.sortUserCreated=function(){$scope.showcreated=!0,$scope.showname=!1,$scope.showperson=!1,"-created"==$scope.createdtype?($scope.createdtype="created",$scope.createdbtn=!1,$scope.sortOrFiltersPerson.sort="created"):($scope.createdbtn=!0,$scope.createdtype="-created",$scope.sortOrFiltersPerson.sort="-created"),$scope.sortOrFiltersPerson.page_entries=$("#resultValue").text(),updateUserListing($scope.sortOrFiltersPerson)},$scope.sortUserName=function(){$scope.showcreated=!1,$scope.showname=!0,$scope.showperson=!1,"-first_name"==$scope.persontype?($scope.persontype="first_name",$scope.namebtn=!1,$scope.sortOrFiltersPerson.sort="first_name"):($scope.namebtn=!0,$scope.persontype="-first_name",$scope.sortOrFiltersPerson.sort="-first_name"),$scope.sortOrFiltersPerson.page_entries=$("#resultValue").text(),updateUserListing($scope.sortOrFiltersPerson)},$scope.sortUserPerson=function(){$scope.showcreated=!1,$scope.showname=!1,$scope.showperson=!0,"-person_id"==$scope.nametype?($scope.nametype="person_id",$scope.personbtn=!1,$scope.sortOrFiltersPerson.sort="person_id"):($scope.personbtn=!0,$scope.nametype="-person_id",$scope.sortOrFiltersPerson.sort="-person_id"),$scope.sortOrFiltersPerson.page_entries=$("#resultValue").text(),updateUserListing($scope.sortOrFiltersPerson)},$scope.totalentry=[25,50,100],$scope.userShown=!1,$scope.person={},$scope.userSearch={},$scope.goBackUser=function(){$scope.userShown=!1},$scope.updateUserListing=function(){updateUserListing($scope.sortOrFiltersPerson)},$scope.getAllUserCSV=function(){var userRequestArray=[],totalNumUsers=$scope.sortOrFiltersPerson.pagination.totalentries,requiredNumCalls=0;$scope.allUsersArray=[];var reqArg={page:1};requiredNumCalls=parseInt(parseInt(totalNumUsers)/100),totalNumUsers%100!=0&&(requiredNumCalls+=1);for(var curNumCall=0;curNumCall<requiredNumCalls;curNumCall++){var request=RestFullResponse.one("portal").all("person").getList(reqArg);userRequestArray.push(request),reqArg.page+=1}return $q.all(userRequestArray).then((function(success){return $scope.allUsersCSV=[],success.forEach((function(resArr){$scope.allUsersArray=$scope.allUsersArray.concat(resArr.data)})),createUserCSV($scope.allUsersArray,$scope.allUsersCSV),$scope.allUsersCSV}))},updateUserListing($scope.sortOrFiltersPerson),$scope.getTotalItemsPerson=function(){var desiredtotal=$scope.sortOrFiltersPerson.pagination.entriesperpage*$scope.sortOrFiltersPerson.page_limit;return desiredtotal>$scope.sortOrFiltersPerson.pagination.totalentries?$scope.sortOrFiltersPerson.pagination.totalentries:desiredtotal},$scope.updatePagingPerson=function(){updateUserListing($scope.sortOrFiltersPerson)},$scope.deleteOneUser=function($event,user){$scope.user=user,$(".delete-one-user-modal").modal("show")},$scope.addProfileLink=function(){$scope.profile_links.push({})},$scope.removeProfileLink=function(e,link){link.uri_id&&($rootScope.floatingMessage=[],Restangular.one("account/website",link.uri_id).customDELETE().then((function(success){}),(function(failure){msg={header:failure.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}))),$scope.profile_links.splice($scope.profile_links.indexOf(link),1)},$scope.updatePhoto=function(data){$scope.person.photo=data,$scope.formData.photo=data,$scope.formData.files||($scope.formData.files=[]),$scope.formData.files.unshift(data)},$scope.addUserValidation=function(){var translation=$translate.instant(["tab_user_fname_message","tab_user_lname_message","tab_user_enter_email","tab_user_enter_validemail","tab_user_password_message","tab_user_password_error_message","tab_user_confirm_password_message","tab_user_password_nomatch","tab_user_password_nomatch","tab_user_custom_field_empty","tab_user_custom_field_validate"]);$scope.form_validation={first_name:{identifier:"first_name",rules:[{type:"empty",prompt:translation.tab_user_fname_message}]},last_name:{identifier:"last_name",rules:[{type:"empty",prompt:translation.tab_user_lname_message}]},email:{identifier:"email",rules:[{type:"empty",prompt:translation.tab_user_enter_email},{type:"email",prompt:translation.tab_user_enter_validemail}]},password:{identifier:"password",rules:[{type:"empty",prompt:translation.tab_user_password_message},{type:"length[6]",prompt:translation.tab_user_password_error_message}]},password_confirm:{identifier:"password_confirm",rules:[{type:"empty",prompt:translation.tab_user_confirm_password_message},{type:"match[password]",prompt:translation.tab_user_password_nomatch}]}},$scope.pcustom&&angular.forEach($scope.pcustom,(function(value,key){if(value.required&&!value.validate){var customValidate={identifier:value.identifier,rules:[{type:"empty",prompt:translation.tab_user_custom_field_empty}]};$scope.form_validation["customField"+key]=customValidate}else if(!value.required&&value.validate){customValidate={identifier:value.identifier,rules:[{type:"regexCustomValidation["+value.validate+"]",prompt:translation.tab_user_custom_field_validate}]};$scope.form_validation["customField"+key]=customValidate}else if(value.required&&value.validate){customValidate={identifier:value.identifier,rules:[{type:"empty",prompt:translation.tab_user_custom_field_empty},{type:"regexCustomValidation["+value.validate+"]",prompt:translation.tab_user_custom_field_validate}]};$scope.form_validation["customField"+key]=customValidate}})),$("#add-user-form.ui.form").form($scope.form_validation,{inline:!0,keyboardShortcuts:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1,$("html, body").animate({scrollTop:$(".field.error").offset().top},1e3)}}).form("validate form")},$scope.editUserValidation=function(){var translation=$translate.instant(["tab_user_fname_message","tab_user_lname_message","tab_user_enter_email","tab_user_enter_validemail","tab_user_password_nomatch","tab_user_custom_field_empty","tab_user_custom_field_validate"]);$scope.form_validation={first_name:{identifier:"first_name",rules:[{type:"empty",prompt:translation.tab_user_fname_message}]},last_name:{identifier:"last_name",rules:[{type:"empty",prompt:translation.tab_user_lname_message}]},email:{identifier:"email",rules:[{type:"empty",prompt:translation.tab_user_enter_email},{type:"email",prompt:translation.tab_user_enter_validemail}]},password_confirm:{identifier:"password_confirm",rules:[{type:"match[password]",prompt:translation.tab_user_password_nomatch}]}},$scope.pcustom&&angular.forEach($scope.pcustom,(function(value,key){if(value.required&&!value.validate){var customValidate={identifier:value.identifier,rules:[{type:"empty",prompt:translation.tab_user_custom_field_empty}]};$scope.form_validation["customField"+key]=customValidate}else if(!value.required&&value.validate){customValidate={identifier:value.identifier,rules:[{type:"regexCustomValidation["+value.validate+"]",prompt:translation.tab_user_custom_field_validate}]};$scope.form_validation["customField"+key]=customValidate}else if(value.required&&value.validate){customValidate={identifier:value.identifier,rules:[{type:"empty",prompt:translation.tab_user_custom_field_empty},{type:"regexCustomValidation["+value.validate+"]",prompt:translation.tab_user_custom_field_validate}]};$scope.form_validation["customField"+key]=customValidate}})),$("#edit-user-form.ui.form").form($scope.form_validation,{inline:!0,keyboardShortcuts:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1,$("html, body").animate({scrollTop:$(".field.error").offset().top},1e3)}}).form("validate form")},$scope.openModal=function(modalId,callback){$(".modal#"+modalId).modal({closable:!1,onApprove:function(){return"function"==typeof callback&&callback(),!1}}).modal("show")},$scope.closeModal=function(){$(".ui.modal").modal("hide")},$scope.getCompany=function(){var data={person_id:$scope.formData.person_id};$scope.formData.person_id&&Restangular.one("account").customGET("business",data).then((function(success){$scope.businesses=success,$scope.companies=success}))},$scope.editUser=function(person){$scope.selectedPersonId=person.person_id,$scope.formData=person,$scope.person_email=person.email;var data={person_id:$scope.selectedPersonId};Restangular.one("account/website").get(data).then((function(success){$scope.profile_links=success.personal})),$(".person-status-dropdown").dropdown("set selected",person.person_status_id),$(".person-type-id-dropdown").dropdown("set selected",person.person_type_id),$scope.userSectionTitle="Edit User",$scope.userShown=!0,1==$scope.formData.person_type_id&&$("#admin-box").checkbox("check"),$(".user-edit").find("[data-tab]").removeClass("active"),$(".user-edit").find("[data-tab='profile-details']").addClass("active"),$scope.clickHash=function(tabName){$(".user-edit").find("[data-tab]").removeClass("active"),$(".user-edit").find("[data-tab="+tabName+"]").addClass("active")},$scope.getCompany(),$scope.getCustomFields(person.person_id)},$scope.confirmUserEdit=function(){if($scope.valcheck=!0,$scope.editUserValidation(),$scope.valcheck){msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg;var id=$scope.formData.id;if(1==$scope.payment_gateway||3==$scope.payment_gateway)var data={person_id:id,person_type_id:$scope.formData.person_type_id,first_name:$scope.formData.first_name,last_name:$scope.formData.last_name,person_status_id:$(".user-edit form").find('input[name="person_status"]').val(),bio:$scope.formData.bio,password:$scope.formData.password,password_confirm:$scope.formData.password};if(2==$scope.payment_gateway)data={person_id:id,person_type_id:$scope.formData.person_type_id,first_name:$scope.formData.first_name,last_name:$scope.formData.last_name,person_status_id:$(".user-edit form").find('input[name="person_status"]').val(),bio:$scope.formData.bio,pid:$scope.formData.pid,tracking_number:$scope.formData.tracking_number,use_widgetmakr:1,password:$scope.formData.password,password_confirm:$scope.formData.password};var custom_fields={};angular.forEach($scope.pcustom,(function(v){custom_fields[v.name]=v.value})),$scope.public_settings.site_campaign_enable_organization_name&&(custom_fields.organization_name=$scope.organization_name.value,custom_fields.ein=$scope.organization_name.ein),custom_fields&&(custom_fields=JSON.stringify(custom_fields));var customFieldData={attributes:custom_fields};$scope.savePersonAttributes($scope.selectedPersonId,customFieldData),$scope.formData.email!==$scope.person_email&&(data.email=$scope.formData.email),Restangular.one("portal/person").all(id.toString()).customPUT(data).then((function(success){$.each($scope.persons,(function(key,value){if(value.person_id==success.person_id){var person=$scope.persons[key];$.each(success,(function(key1,value1){person[key1]=success[key1]}))}})),$translate(["tab_user_user_message_text","tab_user_modified_text"]).then((function(value){msg={header:value.tab_user_user_message_text+" "+data.first_name+" "+data.last_name+" "+value.tab_user_modified_text},$rootScope.floatingMessage=msg,$scope.userShown=!1,$scope.hideFloatingMessage()}))}),(function(failure){msg={header:failure.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}));for(var i=0;i<$scope.profile_links.length;i++){var value=$scope.profile_links[i];value.uri_id?Restangular.one("account").one("website",value.uri_id).customPUT(value).then((function(success){}),(function(failure){failure.data.errors?(msg={header:"Error"},$lst=[],$.each(failure.data.errors,(function(index,value){$lst.push(value[0].message)})),msg.item=$lst,$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()):(msg={header:failure.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage())})):(value.person_id=id,Restangular.one("account").all("website").customPOST(value).then((function(success){}),(function(failure){failure.data.errors?(msg={header:"Error"},$lst=[],$.each(failure.data.errors,(function(index,value){$lst.push(value[0].message)})),msg.item=$lst,$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()):(msg={header:failure.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage())})))}}},$scope.setPersonTypeId=function(id){$scope.formData.person_type_id=id},$scope.addUser=function($event){$(".add-user-modal").modal({closable:!1,onApprove:function(){return!1}}).modal("show"),$scope.person={},$scope.userSectionTitle="Add User",$scope.profile_links=[],$scope.formData={},$scope.organization_name={},$scope.public_settings.site_campaign_personal_section_custom&&$scope.public_settings.site_campaign_personal_section_custom.length>0&&($scope.pcustom=[],angular.forEach($scope.public_settings.site_campaign_personal_section_custom,(function(value,key){var fieldRequire=!1,fieldPlaceholder="";if(value.placeholder&&(fieldPlaceholder=value.placeholder),value.profile_setting_required&&(fieldRequire=value.profile_setting_required),$scope.public_settings.site_campaign_personal_section_enhanced)var field={name:value.name,identifier:"customField"+key,value:"",option:value.option,dropdown_array:value.dropdown_array,profile_step_show:value.profile_step_show,profile_setting_register_show:value.profile_setting_register_show,profile_setting_show:value.profile_setting_show,register_show:value.register_show,validate:value.validate,placeholder:fieldPlaceholder,required:fieldRequire};else field={name:value.name,identifier:"customField"+key,value:"",option:"Text",dropdown_array:null,profile_step_show:!0,placeholder:fieldPlaceholder,required:fieldRequire};$scope.pcustom.push(field)})),$scope.pcustom_copy=angular.copy($scope.pcustom))},$scope.confirmUserAdd=function(){if($scope.valcheck=!0,$scope.addUserValidation(),$scope.valcheck){if(msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg,1==$scope.payment_gateway)var data={first_name:$scope.formData.first_name,last_name:$scope.formData.last_name,email:$scope.formData.email,person_status_id:$(".add-user-modal form").find('input[name="person_status"]').val()||1,password:$scope.formData.password,password_confirm:$scope.formData.password_confirm,bio:$scope.formData.bio,person_type_id:$(".add-user-modal form").find('input[name="person_role"]').val()};if(2==$scope.payment_gateway)data={first_name:$scope.formData.first_name,last_name:$scope.formData.last_name,email:$scope.formData.email,person_status_id:$(".add-user-modal form").find('input[name="person_status"]').val()||1,password:$scope.formData.password,password_confirm:$scope.formData.password_confirm,bio:$scope.formData.bio,pid:$scope.formData.pid,tracking_number:$scope.formData.tracking_number,use_widgetmakr:1,person_type_id:$(".add-user-modal form").find('input[name="person_role"]').val()};var custom_fields={};$scope.pcustom&&angular.forEach($scope.pcustom,(function(v){custom_fields[v.name]=v.value})),$scope.public_settings.site_campaign_enable_organization_name&&(custom_fields.organization_name=$scope.organization_name.value,custom_fields.ein=$scope.organization_name.ein),custom_fields&&(data.attributes=JSON.stringify(custom_fields)),Restangular.one("portal/person").customPOST(data).then((function(success){$(".add-user-modal").modal("hide"),$translate(["tab_user_user_message_text","tab_user_added_text"]).then((function(value){msg={header:value.tab_user_user_message_text+" "+data.first_name+" "+data.last_name+" "+value.tab_user_added_text},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}))}),(function(failure){if(console.log(failure),msg={header:failure.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),"register_invalid_email_exists"==failure.data.errors.email[0].code){var email_error=failure.data.errors.email[0].message;$(".email-error").html(email_error)}else""!=$(".email-error").html()&&$(".email-error").html("")}))}},$scope.deleteMultiUser=function($event){$(".user-table");$scope.peopleToDelete=[],$(".person-row").each((function(){$(this).find(".t-check-box input").prop("checked")&&$scope.peopleToDelete.push($(this).scope().person)})),$scope.peopleToDelete.length?$(".delete-multi-user-modal").modal({onApprove:confirmMultiUserDelete}).modal("show"):(msg={header:"tab_users_select_error"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage())},$scope.approveMultiUser=function(){msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg;var selectError=!1;$(".person-row").each((function(){if($(this).find(".t-check-box input").prop("checked")){var ps=$(this).scope().person,form={person_id:ps.id,person_status_id:2};selectError=!0,Restangular.one("portal/person",form.person_id).customPUT(form).then((function(success){ps.person_status_id=2,msg={header:"users_approved_successfully"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}),(function(failure){0==$rootScope.floatingMessage.length&&(msg={header:failure.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage())}))}})),selectError||(msg={header:"tab_users_select_error"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage())},$scope.disableMultiUser=function(){msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg;var selectError=!1;$(".person-row").each((function(){if($(this).find(".t-check-box input").prop("checked")){var ps=$(this).scope().person,form={person_id:ps.id,person_status_id:3};selectError=!0,Restangular.one("portal/person",form.person_id).customPUT(form).then((function(success){ps.person_status_id=3,msg={header:"users_disabled_successfully"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}),(function(failure){0==$rootScope.floatingMessage.length&&(msg={header:failure.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage())}))}})),selectError||(msg={header:"tab_users_select_error"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage())},$scope.searchUserBy=function(word){1!=$scope.searchMode&&$scope.searchMode?2==$scope.searchMode&&($scope.sortOrFiltersPerson.filters.name="",$scope.sortOrFiltersPerson.filters.email=word):($scope.sortOrFiltersPerson.filters.name=word,$scope.sortOrFiltersPerson.filters.email=""),updateUserListing($scope.sortOrFiltersPerson)},$scope.searchType=function(type){$scope.searchMode=type,$scope.searchUserBy($scope.userSearch.searchInput)},$scope.userStatusFilter=function(status){$scope.sortOrFiltersPerson.filters.person_status=status,updateUserListing($scope.sortOrFiltersPerson)},$scope.userTypeFilter=function(type){$scope.sortOrFiltersPerson.filters.person_type=type,updateUserListing($scope.sortOrFiltersPerson)},$scope.uploadUserImage=function(files){if(files&&files.length){var $picNode=$(".userProfileImage"),params={person_id:$scope.formData.id,resource_content_type:"image"};$scope.formData.files=[],FileUploadService.upload("account/resource/file",files,params,$picNode).then((function(success){$scope.formData.files[0]=success[0].data}))}},$scope.deleteUserImage=function(files){if(files&&files.length){var file=files.shift(),param={person_id:$scope.formData.id};Restangular.one("account/resource/file").customDELETE(file.id,param),$(".imagePlace .dimmer").dimmer("hide"),$(".ui.progress.upload-bar").show(),$(".ui.loader.download-loader").hide()}},$scope.showPersonal=function(id){"p"==id&&(setTimeout((function(){$("#personalbtn").addClass("positive"),$("#Npersonalbtn").addClass("positive"),$("#Nbusinessbtn").removeClass("positive"),$("#businessbtn").removeClass("positive")}),50),$scope.showpersonal=!0,$scope.showbusiness=!1),"b"==id&&(setTimeout((function(){$("#Nbusinessbtn").addClass("positive"),$("#businessbtn").addClass("positive"),$("#personalbtn").removeClass("positive"),$("#Npersonalbtn").removeClass("positive")}),50),$scope.showpersonal=!1,$scope.showbusiness=!0)},$scope.getAddressInfo=function(){var data={person_id:$scope.formData.person_id};$scope.formData.person_id&&Restangular.one("account").customGET("address",data).then((function(success){$scope.personal_addresses=checkNative(success.personal),$scope.business_addresses=checkNative(success.business),success.personal?($scope.showadd=!0,$scope.showbadd=!0,$scope.showPersonal("p")):success.business&&($scope.showadd=!1,$scope.showbadd=!0,$scope.showPersonal("b"))}))},$scope.getPhoneInfo=function(){var data={person_id:$scope.formData.person_id};$scope.formData.person_id&&Restangular.one("account").customGET("phone-number",data).then((function(success){$scope.personal_number=success.personal,$scope.business_number=success.business,success.personal?($scope.showadd=!0,$scope.showPersonal("p")):success.business&&($scope.showadd=!0,$scope.showPersonal("b"))}))},$scope.multiDelete=function(tableClass,modalID,callback){$scope.deleteQueue=function(tableClass){var queue=[];return $("table."+tableClass).find("tbody td.t-check-box input").each((function(){if($(this).prop("checked")){var item=$(this).scope();queue.push(item)}})),queue}(tableClass),$scope.itemDeleteCount=$scope.deleteQueue.length,$scope.deleteQueue.length?$scope.openModal(modalID,callback):(msg={header:"profile_setting_select_error"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage())}}]),app.controller("TabUserCompanyCtrl",["$translate","$scope","$timeout","$q","Restangular","UserService","FileUploadService","$rootScope",function($translate,$scope,$timeout,$q,Restangular,UserService,FileUploadService,$rootScope){function saveBusinessLinks(){var selectedProtocols=$(".dropdown.business-link-setup").dropdown("get text");angular.forEach($scope.businessLinks,(function(link,key){var new_link={};for(var prop in link)new_link[prop]=link[prop];Array.isArray(selectedProtocols)?"Relative Path"==selectedProtocols[key]?new_link.uri=link.uri:(link.uri=link.uri.replace(/^https?\:\/\//i,""),new_link.uri=selectedProtocols[key]+link.uri):"Relative Path"==selectedProtocols?new_link.uri=link.uri:(link.uri=link.uri.replace(/^https?\:\/\//i,""),new_link.uri=selectedProtocols+link.uri),new_link.person_id=$scope.formData.person_id,new_link.uri_text&&new_link.uri&&(new_link.uri_id?Restangular.one("account/website",new_link.uri_id).customPUT(new_link):(new_link.business_organization_id=$scope.businessSelected.business_organization_id,Restangular.one("account/website").customPOST(new_link)))}))}function getBusinessInfo(){var data={person_id:$scope.formData.person_id};Restangular.one("account").customGET("business",data).then((function(success){$scope.businesses=success,$scope.businesses[0]?$scope.showcompany=!0:$scope.showcompany=!1}))}$scope.deleteProfileImage=function(files){Restangular.one("account/resource/file").customDELETE(files[0].id).then((function(){files.splice(0,1)})),$(".imagePlace .dimmer").dimmer("hide"),$(".ui.loader.download-loader").fadeOut(),$(".ui.progress.upload-bar").fadeOut()},$scope.profile_protocols=[{value:"http://"},{value:"https://"},{value:"Relative Path"}],$scope.profile_link_default_protocol=$scope.profile_protocols[0],getBusinessInfo(),$scope.getBusinessImage=function(businessID){Restangular.one("account/resource/file?person_id="+$scope.formData.person_id+"&business_organization_id="+businessID).customGET().then((function(success){$scope.businessImage=success}))},$scope.uploadBusinessImage=function(files){if(files.length){var $picNode=$(".profileCompany"),params={resource_content_type:"image",business_organization_id:$scope.businessSelected.id};params.person_id=$scope.formData.person_id,$scope.businessSelected.id?FileUploadService.upload("account/resource/file/",files,params,$picNode).then((function(success){$scope.businessImage=[],$scope.businessImage.push(success[0].data)})):($scope.businessSelected.name="Placeholder",$scope.businessSelected.person_id=$scope.formData.person_id,Restangular.one("account/business").customPOST($scope.businessSelected).then((function(success){$scope.businessSelected=success,getBusinessInfo(),$scope.getCompany(),params.business_organization_id=$scope.businessSelected.id,FileUploadService.upload("account/resource/file/",files,params,$picNode).then((function(success){$scope.businessImage=[],$scope.businessImage.push(success[0].data)}))})))}},$scope.deleteBusinessImage=function(files){if(files&&files.length){var file=files.pop(),param={business_organization_id:$scope.businessSelected.id};params.person_id=$scope.formData.person_id,Restangular.one("account/resource/file").customDELETE(file.id,param),$(".imagePlace .dimmer").dimmer("hide"),$(".ui.loader.download-loader").fadeOut(),$(".ui.progress.upload-bar").fadeOut()}},$scope.selectBusiness=function(business){var businessId;$scope.openModal("setting-add-company"),$scope.businessLinks=[],$scope.businessImage=null,$scope.getBusinessImage(business.business_organization_id),$scope.businessSelected=business,businessId=business.business_organization_id,Restangular.all("account/website?person_id="+$scope.formData.person_id+"&business_organization_id="+businessId).customGET().then((function(success){for(var n in $scope.businessLinks=success.business,$scope.businessLinks){var current_business_link=$scope.businessLinks[n].uri;for(var i in $scope.profile_protocols){if(current_business_link.indexOf($scope.profile_protocols[i].value)>-1){$scope.businessLinks[n].uri=current_business_link.replace($scope.profile_protocols[i].value,""),$scope.businessLinks[n].profile_link_default_protocol=$scope.profile_protocols[i].value;break}$scope.businessLinks[n].profile_link_default_protocol=$scope.profile_protocols[2].value}}}))},$scope.newBusiness=function(){$(".ui.form.company-form").form("clear"),$scope.businessSelected={business_organization_id:"",description:"",name:""},$scope.businessLinks=[],$scope.businessImage=[]},$scope.addBusinessLink=function(arr){var link={uri:"",uri_text:"",business_organization_id:$scope.businessSelected.business_organization_id};angular.isUndefined(arr)?angular.copy(link):arr.push(angular.copy(link))},$scope.removeBusinessLink=function(link){link.uri_id?Restangular.one("account/website").customDELETE(link.uri_id,{business_organization_id:link.business_organization_id}).then((function(success){$scope.businessLinks.splice($scope.businessLinks.indexOf(link),1)})):$scope.businessLinks.splice($scope.businessLinks.indexOf(link),1)},$scope.companyValidation=function(){var translation=$translate.instant(["tab_company_setting_company_name_error"]);$(".company-form.ui.form").form({company_name:{identifier:"company_name",rules:[{type:"empty",prompt:translation.tab_company_setting_company_name_error}]}},{inline:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form")},$scope.saveBusinessInfoEnter=function(event){13==event.keyCode&&(event.target.blur(),$scope.saveBusinessInfo(event))},$scope.saveBusinessInfo=function(){if($scope.valcheck=!0,$scope.companyValidation(),$scope.businessSelected.person_id=$scope.formData.person_id,$scope.valcheck){var request;msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg;var custom_fields={};angular.forEach($scope.bcustom,(function(v){custom_fields[v.name]=v.value})),custom_fields&&(custom_fields=JSON.stringify(custom_fields));var customFieldData={attributes:custom_fields};$scope.businessSelected.business_organization_id?($scope.savePersonAttributes($scope.selectedPersonId,customFieldData),request=Restangular.one("account/business",$scope.businessSelected.business_organization_id).customPUT($scope.businessSelected).then((function(success){saveBusinessLinks(),msg={header:"success_message_save_changes_button"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),$scope.getCompany()}))):(Restangular.one("portal/person").customPOST(customFieldData).then((function(success){})),request=Restangular.one("account/business").customPOST($scope.businessSelected).then((function(success){$scope.businessSelected=success,saveBusinessLinks(),msg={header:"success_message_save_changes_button"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),$scope.getCompany()}))),request?request.then((function(){$("#setting-add-company").modal("hide"),msg={header:"tab_company_setting_company_info_save_success"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),getBusinessInfo(),$scope.getCompany()})):(msg={header:"tab_company_setting_company_info_save_error"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage())}},$scope.removeBusiness=function(business){return data={},data.person_id=$scope.formData.person_id,Restangular.one("account/business",business.business_organization_id).customDELETE(data)},$scope.confirmDeleteBusiness=function(){var requestQueue=[];angular.forEach($scope.deleteQueue,(function(value){requestQueue.push($scope.removeBusiness(value.business))})),msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg,$q.all(requestQueue).then((function(success){angular.forEach(success,(function(value){angular.forEach($scope.businesses,(function(business,index){value.id==business.id&&$scope.businesses.splice(index,1)}))})),msg={header:"tab_company_setting_company_info_delete_success"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),$scope.getCompany()}),(function(failed){msg={header:failed.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}))},$scope.checkAll=function(tableClass){0==$("."+tableClass+" thead tr .check-all input").prop("checked")?$("."+tableClass+" tbody tr .t-check-box input").prop("checked",!0):$("."+tableClass+" tbody tr .t-check-box input").prop("checked",!1)}}]),app.controller("TabUserAddressCtrl",["$translate","$scope","$timeout","$q","Restangular","UserService","Geolocator","PortalSettingsService","$rootScope",function($translate,$scope,$timeout,$q,Restangular,UserService,Geolocator,PortalSettingsService,$rootScope){$scope.addressSubcountrySelected={},$scope.addressCountrySelected={},$scope.addressSelected={},PortalSettingsService.getSettingsObj().then((function(success){$scope.alt_shipping=success.public_setting.site_theme_alt_shipping_layout,$scope.native_lookup=success.public_setting.site_theme_shipping_native_lookup,$scope.native_lookup&&(success.public_setting.site_theme_default_shipping_country.name=success.public_setting.site_theme_default_shipping_country.native_name),$scope.alt_shipping&&Geolocator.getCountries().then((function(countries){if($scope.native_lookup)for(var i in countries)null!=countries[i].native_name&&(countries[i].name=countries[i].native_name);if($scope.countries=countries,$scope.default_country){for(var index in $scope.countries){var value=$scope.countries[index];if(value.id==$scope.default_country.id){$scope.default_country=value,$scope.countries.splice(index,1);break}}$scope.countries.splice(0,0,$scope.default_country)}})),$scope.default_country=success.public_setting.site_theme_default_shipping_country,$scope.addressCountrySelected.selected=$scope.default_country,$scope.setCountry($scope.addressCountrySelected.selected),null!=$scope.addressCountrySelected.selected&&Object.getOwnPropertyNames($scope.addressCountrySelected.selected).length&&$scope.addressCountrySelected.selected.name&&getSubcountries($scope.addressCountrySelected.selected.id)}));var address_table="";function getSubcountries(countryID){Geolocator.getSubcountriesByCountry(countryID).then((function(subcountries){if($scope.native_lookup)for(var i in subcountries)null!=subcountries[i].native_name&&(subcountries[i].name=subcountries[i].native_name);$scope.subcountries=subcountries}))}$scope.getCompany(),$scope.selectAddress=function(address){$scope.addressSelected=address,$scope.alt_shipping?($scope.addressCountrySelected.selected={name:"",id:0},$scope.addressSubcountrySelected.selected={name:"",id:0},$scope.addressSelected.selected={name:"",id:0},$scope.addressCountrySelected.selected.name=$scope.native_lookup&&address.country_native_name?address.country_native_name:address.country,$scope.addressCountrySelected.selected.id=address.country_id,$scope.addressSubcountrySelected.selected.name=$scope.native_lookup&&address.subcountry_native_name?address.subcountry_native_name:address.subcountry,$scope.addressSubcountrySelected.selected.id=address.subcountry_id,$scope.addressSelected.selected.name=$scope.native_lookup&&address.city_native_name?address.city_native_name:address.city):$scope.addressSelected.selected={name:address.city_full},address.business_organization?$scope.showBusName=!0:$scope.showbusName=!1,angular.forEach($scope.companies,(function(value){value.business_organization_id==$scope.addressSelected.business_organization_id&&($scope.companyName=value.name,$("#defaulttext").text($scope.companyName),$("#defaulttext").removeClass("default"))}))},$scope.showpersonal=!0,$scope.showbusiness=!1,$scope.newAddress=function(){$(".ui.form").form("clear"),$scope.showBusName=!1,addressCountrySelected="",$scope.addressSelected={business_organization_id:"",city_id:"",mail_code:"",street1:"",street2:"",description:""}},$scope.removeAddress=function(address){if($scope.showbusiness){var par={business_organization_id:address.business_organization_id};return Restangular.one("account/address",address.address_id).remove(par)}if($scope.showpersonal)return Restangular.one("account/address",address.address_id).customDELETE()},$scope.confirmDeleteAddress=function(){$scope.deleteQueue.length;var requestQueue=[];angular.forEach($scope.deleteQueue,(function(value,key){requestQueue.push($scope.removeAddress(value.address))})),msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg,$q.all(requestQueue).then((function(success){angular.forEach(success,(function(value){angular.forEach($scope.addresses,(function(address,index){address.id==value.id&&$scope.addresses.splice(index,1)}))})),msg={header:"tab_address_delete_success"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),$scope.getAddressInfo()}),(function(failed){msg={header:failed.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}))},$scope.searchCities=function(term){var native_lookup=1==$scope.native_lookup?1:0;term&&($scope.alt_shipping?Geolocator.searchCitiesBySubcountry(term,$scope.addressSubcountrySelected.selected.id,native_lookup).then((function(cities){if(native_lookup)for(var i in cities)null!=cities[i].city_native_name&&(cities[i].name=cities[i].city_native_name),null!=cities[i].country_native_name&&(cities[i].country=cities[i].country_native_name),null!=cities[i].subcountry_native_name&&(cities[i].subcountry=cities[i].subcountry_native_name);$scope.cities=cities})):Geolocator.searchCities(term,native_lookup).then((function(cities){$scope.cities=cities})))},$scope.$watch("addressCountrySelected.selected",(function(value,oldValue){value!=oldValue&&value&&getSubcountries(value.id)})),$scope.$watch("addressSelected.selected",(function(value){if(value){var cityID=Geolocator.lookupCityID(value.name);cityID&&($scope.addressSelected.city_id=cityID),$("#select-city .select-error").remove(),$("#select-city").removeClass("error")}})),$scope.setCountry=function(country){$scope.addressCountrySelected.selected=country},$scope.addressValidation=function(){var translation=$translate.instant(["tab_address_select_company_error","tab_address_address1_error","tab_address_mailcode_error"]);$(".address-form.ui.form").form({company_select:{identifier:"company_select",rules:[{type:"empty",prompt:translation.tab_address_select_company_error}]},address1:{identifier:"address1",rules:[{type:"empty",prompt:translation.tab_address_address1_error}]},mail_code:{identifier:"mail_code",rules:[{type:"empty",prompt:translation.tab_address_mailcode_error}]}},{inline:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form")},$scope.saveAddressInfoEnter=function(event){13==event.keyCode&&(event.target.blur(),$scope.saveAddressInfo(event))},$scope.saveAddressInfo=function(event){var translation=$translate.instant(["tab_address_select_city_error"]);($scope.valcheck=!0,$("#select-city .select2-container").hasClass("select2-container-disabled")||$scope.addressSelected.selected||($(".select-error").remove(),$("#select-city").append('<div class="select-error ui red pointing prompt label transition visible">'+translation.tab_address_select_city_error+"</div>"),$("#select-city").addClass("error")),$scope.addressValidation(),$scope.valcheck)&&(angular.element(event.target).addClass("disabled"),msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg,$scope.addressSelected.person_id=$scope.formData.person_id,($scope.addressSelected.address_id?Restangular.one("account/address",$scope.addressSelected.address_id).customPUT($scope.addressSelected):Restangular.one("account/address").customPOST($scope.addressSelected)).then((function(success){$("#setting-add-address").modal("hide"),msg={header:"tab_address_save_success"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),angular.element(event.target).removeClass("disabled"),$scope.getAddressInfo()}),(function(failed){msg={header:failed.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),angular.element(event.target).removeClass("disabled")})))},$scope.setPrimary=function(){msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg;var queue=function(tableClass){var queue=[];return $("table."+tableClass).find("tbody td.t-check-box input").each((function(){if($(this).prop("checked")){var item=$(this).scope();queue.push(item)}})),queue}(address_table);if(1!=queue.length)msg={header:"tab_address_set_primary"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage();else{var unsetPrimary;angular.forEach($scope.addresses,(function(value){if(1==value.primary_address){var update={primary_address:0};update.person_id=$scope.formData.person_id,unsetPrimary=Restangular.one("account/address",value.address_id).customPUT(update)}}));var update={primary_address:1};update.person_id=$scope.formData.person_id,unsetPrimary?unsetPrimary.then((function(success){Restangular.one("account/address",queue[0].address.address_id).customPUT(update)})).then((function(){msg={header:"tab_address_reset_primary"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),$scope.getAddressInfo()}),(function(failed){msg={header:failed.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()})):Restangular.one("account/address",queue[0].address.address_id).customPUT(update).then((function(){msg={header:"tab_address_set_primary_success"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),$scope.getAddressInfo()}),(function(failed){msg={header:failed.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}))}},$scope.selectCompany=function(id){$scope.addressSelected.business_organization_id=id},$scope.showPersonal=function(id){"p"==id&&(setTimeout((function(){$("#personalbtn").addClass("positive"),$("#businessbtn").removeClass("positive")}),50),$scope.showpersonal=!0,$scope.showbusiness=!1,address_table="address-table-personal"),"b"==id&&(setTimeout((function(){$("#businessbtn").addClass("positive"),$("#personalbtn").removeClass("positive")}),50),$scope.showpersonal=!1,$scope.showbusiness=!0,address_table="address-table-business")}}]),app.controller("TabUserPhoneCtrl",["$translate","$scope","$timeout","$q","Restangular","UserService","PHONE_TYPE","$rootScope",function($translate,$scope,$timeout,$q,Restangular,UserService,PHONE_TYPE,$rootScope){$scope.getCompany(),$scope.formPreventDefault=function(event){if(13==event.keyCode)return event.preventDefault(),!1},$scope.savePhoneInfoEnter=function(event){13==event.keyCode&&(event.target.blur(),$scope.savePhoneInfo(event))},$scope.selectPhone=function(phone){$scope.phoneSelected=phone,phone.business_organization?$scope.showBusName=!0:$scope.showBusName=!1,angular.forEach($scope.phonetype,(function(value){value.id==$scope.phoneSelected.phone_number_type_id&&($scope.phoneName=value.name)}))},$scope.showpersonal=!0,$scope.showbusiness=!1,$scope.phonetype=PHONE_TYPE,$scope.newPhone=function(){$(".ui.form").form("clear"),$scope.showBusName=!1,$scope.phoneSelected={business_organization_id:"",number:"",phone_number_type_id:"",id:""}},$scope.removePhone=function(phone){if((par={}).person_id=$scope.formData.person_id,$scope.showbusiness){var par={business_organization_id:phone.business_organization_id};return Restangular.one("account/phone-number",phone.id).remove(par)}if($scope.showpersonal)return Restangular.one("account/phone-number",phone.id).customDELETE(par)},$scope.confirmDeletePhone=function(){$scope.deleteQueue.length;var requestQueue=[];angular.forEach($scope.deleteQueue,(function(value,key){requestQueue.push($scope.removePhone(value.phone))})),$q.all(requestQueue).then((function(success){msg={header:"tab_phone_deleted_success"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),$scope.getPhoneInfo()}),(function(failed){msg={header:failed.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}))},$scope.phoneValidation=function(){var translation=$translate.instant(["tab_phone_setting_company_error","tab_phone_setting_number_error","tab_phone_setting_notvalidnumber_error"]);$(".phone-number-form.ui.form").form({company_select:{identifier:"company_select",rules:[{type:"empty",prompt:translation.tab_phone_setting_company_error}]},number:{identifier:"number",rules:[{type:"empty",prompt:translation.tab_phone_setting_number_error},{type:"integer",prompt:translation.tab_phone_setting_notvalidnumber_error}]}},{inline:!0,keyboardShortcuts:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form")},$scope.savePhoneInfo=function(event){($scope.valcheck=!0,$scope.phoneValidation(),$scope.valcheck)&&(angular.element(event.target).addClass("disabled"),msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg,$scope.phoneSelected.person_id=$scope.formData.person_id,($scope.phoneSelected.id?Restangular.one("account/phone-number",$scope.phoneSelected.id).customPUT($scope.phoneSelected):Restangular.one("account/phone-number").customPOST($scope.phoneSelected)).then((function(success){$("#setting-add-phone").modal("hide"),msg={header:"tab_phone_saved_success"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),angular.element(event.target).removeClass("disabled"),$scope.getPhoneInfo()}),(function(failed){$("#setting-add-phone").modal("hide"),msg={header:failed.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),angular.element(event.target).removeClass("disabled")})))},$scope.phoneTypeSelected=function(id){$scope.phoneSelected.phone_number_type_id=id},$scope.selectCompany=function(id){$scope.phoneSelected.business_organization_id=id},$scope.showPersonal=function(id){"p"==id&&(setTimeout((function(){$("#Npersonalbtn").addClass("positive"),$("#Nbusinessbtn").removeClass("positive")}),50),$scope.showpersonal=!0,$scope.showbusiness=!1),"b"==id&&(setTimeout((function(){$("#Nbusinessbtn").addClass("positive"),$("#Npersonalbtn").removeClass("positive")}),50),$scope.showpersonal=!1,$scope.showbusiness=!0)}}]),app.controller("UserAccountCtrl",["$translate","$scope","UserService","Restangular","$location","$timeout","$rootScope",function($translate,$scope,UserService,Restangular,$location,$timeout,$rootScope){UserService.isLoggedIn()||$location.path("/"),$scope.formData={},$scope.formData.email=UserService.email,window.a=$scope,$scope.showPassword=!1,$scope.toggleContent=function(){$scope.showPassword^=!0},$scope.accountValidation=function(){var translation=$translate.instant(["tab_account_setting_old_pw_error","tab_account_setting_pw_error","tab_account_setting_pw_length_error","tab_account_setting_pw_error","tab_account_setting_pw_match_error"]);$(".account-form.ui.form").form({current_password:{identifier:"current_password",rules:[{type:"empty",prompt:translation.tab_account_setting_old_pw_error}]},new_password:{identifier:"new_password",rules:[{type:"empty",prompt:translation.tab_account_setting_pw_error},{type:"length[6]",prompt:translation.tab_account_setting_pw_length_error}]},confirm_password:{identifier:"confirm_password",rules:[{type:"empty",prompt:translation.tab_account_setting_pw_error},{type:"match[new_password]",prompt:translation.tab_account_setting_pw_match_error}]}},{inline:!0,keyboardShortcuts:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form")},$scope.changePassword=function(){if($scope.valcheck=!0,$scope.accountValidation(),$rootScope.scrollToError(),$scope.valcheck){var data={password_old:$scope.formData.old_password,password:$scope.formData.new_password,password_confirm:$scope.formData.confirm_password};Restangular.one("account").customPUT(data).then((function(success){$rootScope.floatingMessage={header:"tab_account_setting_pw_reset_success"},$scope.hideFloatingMessage()}),(function(failed){!function(failed){var msg={header:""};if(failed.data){if(failed.data.errors)for(var prop in failed.data.errors){msg.header=failed.data.errors[prop][0].code;break}else failed.data.type?msg.header="invalid_request_error":msg.header=failed.data.code;$rootScope.floatingMessage=msg}}(failed)}))}},$scope.sentChangeEmail=function(){msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg,Restangular.one("account").one("email").customPOST().then((function(success){msg={header:"tab_profile_setting_email_change_instructions"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}))}}]);