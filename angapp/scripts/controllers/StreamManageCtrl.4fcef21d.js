app.controller("StreamManageCtrl",["$scope","$location","$routeParams","$timeout","Restangular","RESOURCE_REGIONS","$translatePartialLoader","$translate","$rootScope",function($scope,$location,$routeParams,$timeout,Restangular,RESOURCE_REGIONS,$translatePartialLoader,$translate,$rootScope){var msg;$scope.clearMessage=function(){$rootScope.floatingMessage=[]},$scope.RESOURCE_REGIONS=RESOURCE_REGIONS;var currentEditedStream,campaign_id=$routeParams.campaign_id||null;function getCampaignData(){Restangular.one("campaign").customGET(campaign_id).then((function(success){$scope.campaign=success,$scope.editCampaignStream($scope.campaign),$scope.$emit("loading_finished")}))}$scope.campaign={},$scope.campaign.backers=[],$scope.multiBacker={},$scope.stream={},$scope.stream.stream_type_id=1,$scope.stream.html="",$scope.showSection={streamForm:!1},campaign_id?getCampaignData():$scope.$emit("loading_finished"),$scope.editCampaignStream=function(campaign){$scope.campaign=campaign,$scope.add_stream_preview=!1,$scope.stream.entry_id=$scope.campaign.entry_id,$scope.backers=[],Restangular.one("campaign/"+campaign.id.toString()+"/stream").getList(null,{sort:"-modified"}).then((function(success){$scope.streams=success||{}}),(function(failure){})),Restangular.one("campaign/"+campaign.id.toString()+"/backer").getList().then((function(success){$scope.campaign.backers=success}))},$scope.pageInsertImage=function(file,e){var target=$(e.target).closest(".stream-message");$scope.textAngularFile(file[0],target)},$scope.saveStream=function(){$scope.stream.id?(currentEditedStream.message=$scope.stream.message,$scope.updateStream()):$scope.createStream()},$scope.createStream=function(){if(null==$scope.stream.title)return msg={header:"Stream title is required."},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),void($scope.stream.has_error=!0);var lst=[];if(3==$scope.stream.stream_type_id&&(angular.forEach($scope.multiBacker.selected,(function(value){lst.push(value.person_id)})),$scope.stream.person_id=lst,0==lst.length))return msg={header:"Please select backers"},$rootScope.floatingMessage=msg,void $scope.hideFloatingMessage();msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg,Restangular.one("campaign/"+$scope.campaign.entry_id.toString()+"/stream").customPOST($scope.stream).then((function(success){$scope.showSection.streamForm=!1,$scope.streams.unshift(success),$translate(["stream_create_prefix","stream_create_suffix"]).then((function(translation){msg={header:translation.stream_create_prefix+" "+success.title+" "+translation.stream_create_suffix},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}))}),(function(failure){msg={header:failure.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}))},$scope.clearStream=function(){$scope.stream={stream_type_id:1}},$scope.editStream=function(stream){for(var p in currentEditedStream=stream,$scope.stream={},stream)stream.hasOwnProperty(p)&&($scope.stream[p]=stream[p]);$timeout((function(){$(".ui.dropdown").dropdown("set selected",$scope.stream.stream_type_id)}))},$scope.$watch("stream.stream_backers",(function(value){value&&($scope.campaign.backers=value,$scope.multiBacker.selected=value)})),$scope.publishStream=function(stream,bool){$scope.publishBool=bool,bool=!1===bool?"f":"t",$("#publish-stream").modal({onApprove:function(){var data={published:bool};msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg,Restangular.one("campaign/"+$scope.campaign.id+"/stream/"+stream.id).customPUT(data).then((function(success){$translate(["stream_update_prefix","stream_update_suffix"]).then((function(translation){msg={header:translation.stream_update_prefix+" "+success.title+" "+translation.stream_update_suffix},!1===$scope.publishBool?stream.published=!1:stream.published=!0,$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}))}),(function(failure){msg={header:failure.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}))}}).modal("show")},$scope.updateStream=function(){if($scope.showSection.streamForm=!1,3==$scope.stream.stream_type_id&&(angular.forEach($scope.multiBacker.selected,(function(value){lst.push(value.person_id)})),$scope.stream.person_id=lst,0==lst.length))return msg={header:"Please select backers"},$rootScope.floatingMessage=msg,void $scope.hideFloatingMessage();msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg,Restangular.one("campaign/"+$scope.campaign.entry_id.toString()+"/stream/"+$scope.stream.stream_id.toString()).customPUT($scope.stream).then((function(success){getCampaignData(),$translate(["stream_update_prefix","stream_update_suffix"]).then((function(translation){msg={header:translation.stream_update_prefix+" "+success.title+" "+translation.stream_update_suffix},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}))}),(function(failure){msg={header:failure.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}))},$scope.deleteStream=function(streamID){$("#delete-stream").modal({onApprove:function(){msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg,Restangular.one("campaign/"+$scope.campaign.entry_id+"/stream/"+streamID).customDELETE().then((function(success){$translate("stream_delete").then((function(translation){msg={header:translation},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}));for(var j=0;j<$scope.streams.length;j++)success.id==$scope.streams[j].id&&$scope.streams.splice(j,1)}),(function(failure){msg={header:failure.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}))}}).modal("show")},$scope.notifyBacker=function(stream){$("#notify-backers").modal({onApprove:function(){var stream_id=stream.id;msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg,Restangular.one("campaign/"+$scope.campaign.id+"/stream-notify/"+stream_id).customPOST().then((function(success){msg={header:"Notify backers successfully"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}),(function(failure){msg={header:failure.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}))}}).modal("show")},$scope.updateBackerList=function(term){$form={filters:{person_name:term}},$scope.campaign.entry_id&&Restangular.one("campaign/"+$scope.campaign.entry_id.toString()).getList("backer",$form).then((function(success){$scope.campaign.backers=success}))}}]);