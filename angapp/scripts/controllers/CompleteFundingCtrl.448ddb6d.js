app.controller("CompleteFundingCtrl",["$translate","CampaignSettingsService","$routeParams","$scope","$rootScope","$timeout","Restangular","CreateCampaignService","$location","StripeService","UserService","PortalSettingsService",function($translate,CampaignSettingsService,$routeParams,$scope,$rootScope,$timeout,Restangular,CreateCampaignService,$location,StripeService,UserService,PortalSettingsService){$scope.clearMessage=function(){$rootScope.floatingMessage=[]};var msg=[],paras=$location.$$path.split("/");function checkFunding(){if($scope.public_settings=$scope.portalsetting,$scope.contributionEnabled=$scope.portalsetting.site_campaign_contributions,isStepFundingDelayed=$scope.portalsetting.site_theme_campaign_delayed_funding_setup,$scope.public_settings.site_campaign_country_funding_step&&$scope.campaign.settings.country_bank_form)return!!$scope.campaign.settings.bank&&"StripePlaceHolder";if($scope.contributionEnabled){if(!isStepFundingDelayed)return $scope.campaign.stripe_account_id;if($scope.campaign.ever_published)return $scope.campaign.stripe_account_id}return"StripePlaceHolder"}function hasImage(){var bool=!1;return $scope.campaign.files&&angular.forEach($scope.campaign.files,(function(file){3!=file.region_id||(bool=!0)})),bool}$scope.path=paras[1],$scope.isLastStep=!1,"complete-funding"==$scope.path&&($scope.isLastStep=!0),$scope.campaign={},$scope.campaignID=$routeParams.campaign_id,$scope.nextStepUrl="campaign-preview/"+$routeParams.campaign_id,$scope.backUrl="profile-setup/"+$routeParams.campaign_id,$scope.saddress={street:"",mail:"",city:"",country:""},$scope.clientID=null,StripeService.clientID().then((function(success){success&&($scope.clientID=success)})),$scope.user=UserService,$scope.useremail=$scope.user.email,$scope.showCampaignbankForm=!1,PortalSettingsService.getSettingsObj().then((function(success){$scope.$emit("loading_finished"),$scope.portalsetting=success.public_setting,$scope.direct_transaction=success.public_setting.site_campaign_fee_direct_transaction,$scope.reward_show=success.public_setting.site_theme_campaign_show_reward_section,$scope.displayPrevButtonHeader=success.public_setting.site_campaign_creation_display_previous_button_on_header,$scope.moveLaunchButtonStep5=success.public_setting.site_campaign_creation_launch_campaign_on_step5,void 0!==$scope.portalsetting.site_campaign_hide_profile&&null!==$scope.portalsetting.site_campaign_hide_profile||($scope.portalsetting.site_campaign_hide_profile=!1),void 0!==success.public_setting.site_campaign_creation_field_display_stacked||success.public_setting.site_campaign_creation_field_display_stacked?$scope.isFieldDisplayStacked=success.public_setting.site_campaign_creation_field_display_stacked:$scope.isFieldDisplayStacked=!1,$scope.showProfile=!$scope.portalsetting.site_campaign_hide_profile,$scope.showProfile?!$scope.showProfile&&$scope.reward_show?$scope.backUrl="campaign-setup/"+$routeParams.campaign_id:$scope.backUrl="profile-setup/"+$routeParams.campaign_id:$scope.backUrl="rewards/"+$routeParams.campaign_id,$scope.showProfile||$scope.reward_show||($scope.backUrl="campaign-setup/"+$routeParams.campaign_id),$scope.portalsetting.site_enable_advanced_widget&&($scope.nextStepUrl="campaign-widget/"+$routeParams.campaign_id),$scope.portalsetting.site_campaign_country_funding_step&&($scope.bank={}),(void 0!==$scope.portalsetting.site_campaign_country_funding_step||$scope.portalsetting.site_campaign_country_funding_step)&&($scope.showCampaignbankForm=$scope.portalsetting.site_campaign_country_funding_step),$scope.direct_transaction&&1!==UserService.person_type_id&&!$scope.showCampaignbankForm&&$location.path("/404")})),$scope.disallowStripeChanges=function(){$scope.enableStripeConnect=!1,$("#stripeDropdownSelector").addClass("disabled")},$scope.allowStripeChanges=function(){$scope.enableStripeConnect=!0,$("#stripeDropdownSelector").removeClass("disabled")},$scope.enableStripeConfirmation=function(){$(".enable-stripe-modal").modal({onApprove:$scope.allowStripeChanges()}).modal("show")},CreateCampaignService.load($routeParams.campaign_id).then((function(success){$scope.campaign=success,$scope.isPostProcessing=1==$scope.portalsetting.site_campaign_raise_modes.pledge_processing.default[$scope.campaign.raise_mode_id],CampaignSettingsService.setCampaignId($routeParams.campaign_id),CampaignSettingsService.processSettings(success.settings),$scope.campaign.settings=CampaignSettingsService.getSettings(),$scope.campaign.settings.bank&&($scope.bank=$scope.campaign.settings.bank),$scope.campaign.settings.country_bank_form&&($scope.showCampaignbankForm=$scope.showCampaignbankForm&&$scope.campaign.settings.country_bank_form),$scope.campaigndesc=$scope.name+" -"+$scope.campaign.blurb,$scope.campaign.funded_amount>0&&$scope.isPostProcessing?($scope.portalsetting.site_campaign_restrict_stripe_change?$scope.allowStripeReenable=!1:$scope.allowStripeReenable=!0,$scope.disallowStripeChanges()):$scope.allowStripeChanges(),Restangular.one("account/business").customGET().then((function(success){$scope.companies=success,void 0===$scope.portalsetting.site_theme_portal_company_name||void 0===$scope.portalsetting.site_theme_portal_company_number?$scope.companies.length>0?$scope.campaignName=$scope.companies[0].name:($scope.campaignName=$scope.campaign.name,$scope.number="xxxxxxxxxx"):($scope.campaignName=$scope.portalsetting.site_theme_portal_company_name,$scope.number=$scope.portalsetting.site_theme_portal_company_number)}))})),$scope.website=$location.protocol()+"://"+$location.host()+"/campaign/"+$scope.campaignID,Restangular.one("account/address").customGET().then((function(success){$scope.address=success,$scope.address.business&&$scope.address.business.length>0?$scope.paddress=$scope.address.business:$scope.paddress=$scope.address.personal,$scope.paddress&&($scope.saddress={street:$scope.paddress[0].street1,mail:$scope.paddress[0].mail_code,city:$scope.paddress[0].city,country:$scope.paddress[0].code_iso3166_1})})),$scope.bankValidation=function(){var translation=$translate.instant(["complete_funding_bank_errormessage","complete_funding_bank_account_confirm_errormessage"]);$(".startfunding-form.ui.form").form({bank_beneficiary:{identifier:"bank_beneficiary",rules:[{type:"empty",prompt:translation.complete_funding_bank_errormessage}]},bank_code:{identifier:"bank_code",rules:[{type:"empty",prompt:translation.complete_funding_bank_errormessage}]},bank_name:{identifier:"bank_name",rules:[{type:"empty",prompt:translation.complete_funding_bank_errormessage}]},bank_branch:{identifier:"bank_branch",rules:[{type:"empty",prompt:translation.complete_funding_bank_errormessage}]},bank_account:{identifier:"bank_account",rules:[{type:"empty",prompt:translation.complete_funding_bank_errormessage}]},bank_account_confirm:{identifier:"bank_account_confirm",rules:[{type:"match[bank_account]",prompt:translation.complete_funding_bank_account_confirm_errormessage}]}},{inline:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form")},$scope.completionCheck=function(){$scope.cpath=$scope.campaign.uri_paths[0].path,$scope.direct_transaction=$scope.portalsetting.site_campaign_fee_direct_transaction,$scope.payment_gateway=$scope.portalsetting.site_payment_gateway,$scope.public_settings=$scope.portalsetting;var campaign=$scope.campaign;if(($scope.direct_transaction||2==$scope.payment_gateway||$scope.public_settings.site_campaign_country_funding_step&&$scope.campaign.settings.country_bank_form)&&(campaign.stripe_account_id=-1),$scope.public_settings.site_theme_campaign_show_reward_required?campaign.pledges?$scope.rewardsCheck=!0:$scope.rewardsCheck=!1:$scope.rewardsCheck=!0,$scope.in_revision)return $scope.confirmNotice=!0,$scope.loadingText=!1,void($scope.isLastStep&&(window.location.href="/"+$scope.cpath));if($scope.hideCampaignBlurbField=$scope.portalsetting.site_campaign_creation_hide_campaign_blurb_field,$scope.hideCampaignCategoryField=$scope.portalsetting.site_campaign_creation_hide_campaign_category_field,$scope.hideCampaignImageField=$scope.portalsetting.site_campaign_creation_hide_campaign_image_field,$scope.hideCampaignBlurbField&&$scope.hideCampaignCategoryField&&$scope.hideCampaignImageField?!!(campaign.name&&campaign.raise_mode_id&&campaign.profile_type_id&&campaign.funding_goal&&campaign.currency_id&&$scope.rewardsCheck&&checkFunding()):$scope.hideCampaignImageField?!!(campaign.name&&campaign.raise_mode_id&&campaign.profile_type_id&&campaign.blurb&&campaign.categories&&campaign.funding_goal&&campaign.currency_id&&campaign.description&&$scope.rewardsCheck&&checkFunding()):$scope.hideCampaignBlurbField?!!(hasImage()&&campaign.name&&campaign.raise_mode_id&&campaign.profile_type_id&&campaign.categories&&campaign.funding_goal&&campaign.currency_id&&campaign.description&&$scope.rewardsCheck&&checkFunding()):$scope.hideCampaignCategoryField?!!(hasImage()&&campaign.name&&campaign.raise_mode_id&&campaign.profile_type_id&&campaign.blurb&&campaign.funding_goal&&campaign.currency_id&&campaign.description&&$scope.rewardsCheck&&checkFunding()):!!(hasImage()&&campaign.name&&campaign.raise_mode_id&&campaign.profile_type_id&&campaign.blurb&&campaign.categories&&campaign.funding_goal&&campaign.currency_id&&campaign.description&&$scope.rewardsCheck&&checkFunding()))$scope.loadingText=!0,CreateCampaignService.sendForReview().then((function(success){$scope.confirmNotice=!0,$scope.loadingText=!1,$scope.isLastStep&&(window.location.href="/"+$scope.cpath)}),(function(failed){$scope.errorNotice=failed.data.message,msg={header:failed.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),$scope.loadingText=!1}));else{var steps=[];$timeout((function(){$translate(["basics","details","rewards","funding","uprofile"]).then((function(value){var array;($scope.hideCampaignBlurbField&&$scope.hideCampaignCategoryField&&$scope.hideCampaignImageField?!!(campaign.name&&campaign.raise_mode_id&&campaign.profile_type_id&&campaign.funding_goal&&campaign.currency_id):$scope.hideCampaignImageField?!!(campaign.name&&campaign.raise_mode_id&&campaign.profile_type_id&&campaign.blurb&&campaign.categories&&campaign.funding_goal&&campaign.currency_id):$scope.hideCampaignBlurbField?!!(hasImage()&&campaign.name&&campaign.raise_mode_id&&campaign.profile_type_id&&campaign.categories&&campaign.funding_goal&&campaign.currency_id):$scope.hideCampaignCategoryField?!!(hasImage()&&campaign.name&&campaign.raise_mode_id&&campaign.profile_type_id&&campaign.blurb&&campaign.funding_goal&&campaign.currency_id):!!(hasImage()&&campaign.name&&campaign.raise_mode_id&&campaign.profile_type_id&&campaign.blurb&&campaign.categories&&campaign.funding_goal&&campaign.currency_id))||steps.push(value.basics),$scope.showCampaignImageField=$scope.portalsetting.site_campaign_creation_show_campaign_image_field,($scope.showCampaignImageField?!!hasImage():!!campaign.description)||steps.push(value.details),$scope.hideAllCampaignRewardsFields=$scope.portalsetting.site_campaign_creation_hide_campaign_rewards_fields,($scope.hideAllCampaignRewardsFields?!!campaign.description:campaign.pledges&&$scope.public_settings.site_theme_campaign_show_reward_required)&&steps.push(value.rewards),campaign.stripe_account_id||steps.push(value.funding),steps.length>0&&(array=steps,$translate(["steps","stepsmessage","step","stepmessage"]).then((function(value){array.length>1?($scope.steps=value.steps,$scope.stepsmessage=value.stepsmessage,$scope.missingFieldsText=$scope.steps+'"'+array.toString()+'"'+$scope.stepsmessage):($scope.step=value.step,$scope.stepmessage=value.stepmessage,$scope.missingFieldsText=$scope.step+'"'+array.toString()+'"'+$scope.stepmessage),msg={header:$scope.missingFieldsText},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()})))}))}))}},$scope.saveData=function($event){var translation;$scope.loadingText=!0,$scope.backBtnEvent="campaign-create-prev-button"==$event.currentTarget.id,$scope.valcheck=!0,$scope.portalsetting.site_campaign_country_funding_step?$scope.bankValidation():(translation=$translate.instant(["complete_funding_bank_errormessage"]),$(".startfunding-form.ui.form").form({stripe_account:{identifier:"stripe_account",rules:[{type:"empty",prompt:translation.complete_funding_bank_errormessage}]}},{inline:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form")),$(".field").hasClass("error")&&$("html, body").animate({scrollTop:$(".field.error").offset().top+15},"fast");var currentEle=$event.currentTarget;$(currentEle).hasClass("save-campaign-button");if(!$scope.valcheck)return $event.preventDefault(),msg={header:"fail_message_save_changes_button"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),$scope.loadingText=!1,!1;if(msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg,$scope.portalsetting.site_campaign_country_funding_step&&$scope.campaign.settings.country_bank_form){$scope.campaign.settings.bank=$scope.bank;var data={force_direct_transaction:1};Restangular.one("campaign",$scope.campaignID).customPUT(data).then((function(success){CampaignSettingsService.saveSettings($scope.campaign.settings),msg={header:"success_message_save_changes_button"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),$scope.backBtnEvent||$scope.launchCheck()}))}else{data={stripe_account_id:$scope.campaign.stripe_account_id};Restangular.one("campaign",$scope.campaignID).customPUT(data).then((function(success){CampaignSettingsService.saveSettings($scope.campaign.settings),CreateCampaignService.cacheIn(success.plain()),msg={header:"success_message_save_changes_button"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),$scope.backBtnEvent||$scope.launchCheck()}))}},$scope.launchCheck=function(){$scope.portalsetting.site_campaign_creation_launch_campaign_on_step5&&$scope.completionCheck()},$scope.selectStripeId=function(id){$scope.campaign.stripe_account_id=id},CreateCampaignService.load($routeParams.campaign_id).then((function(success){$scope.campaign=success,$scope.campaign.settings=CampaignSettingsService.getSettings(),Restangular.one("campaign",$routeParams.campaign_id).one("stripe-account").customGET().then((function(success){var stripe_accounts=success.plain();UserService.id==$scope.campaign.managers[0].id||1==UserService.person_type_id?StripeService.getAccount().then((function(success){success.length?($scope.stripeAccounts=success.plain(),$scope.stripeConnected=!0,!stripe_accounts.length&&$scope.stripeAccounts.length?$scope.campaign.stripe_account_id=$scope.stripeAccounts[0].id:stripe_accounts.length&&($scope.campaign.stripe_account_id=stripe_accounts[0].id,$scope.stripeAccounts.unshift(stripe_accounts[0])),$rootScope.isConnectWithStripe&&$timeout((function(){$("button.save-campaign-button").click()}),100)):stripe_accounts.length&&($scope.stripeAccounts=stripe_accounts,stripe_accounts.length&&($scope.stripeConnected=!0,$scope.campaign.stripe_account_id=stripe_accounts[0].id,$rootScope.isConnectWithStripe&&$timeout((function(){$("button.save-campaign-button").click()}),100)))})):($scope.stripeAccounts=stripe_accounts,stripe_accounts.length&&($scope.stripeConnected=!0,$scope.campaign.stripe_account_id=stripe_accounts[0].id,$rootScope.isConnectWithStripe&&$timeout((function(){$("button.save-campaign-button").click()}),100)))}))})),Restangular.one("account/phone-number").customGET().then((function(success){success.business?$scope.number=success.business[0].number:success.personal&&($scope.number=success.personal[0].number)})),$scope.stateParam=StripeService.generateStateParam("/complete-funding/"+$scope.campaignID),$scope.stripeRedirect=StripeService.redirectURL(),$scope.setRedirectUrl=function(){var baseUrl="https://connect.stripe.com/oauth/authorize?",params={response_type:"code",client_id:$scope.clientID.client_id,account:$scope.clientID.client_id,stripe_user:{product_description:$scope.campaigndesc,business_name:$scope.campaignName,first_name:$scope.user.first_name,last_name:$scope.user.last_name,country:$scope.saddress.country,phone_number:$scope.number,url:$scope.website,email:$scope.useremail,street_address:$scope.saddress.street,city:$scope.saddress.city,zip:$scope.saddress.mail},scope:"read_write",redirect_uri:$scope.stripeRedirect,state:$scope.stateParam};$scope.portalsetting.stripe_express_mode&&(baseUrl="https://connect.stripe.com/express/oauth/authorize?",params={response_type:"code",client_id:$scope.clientID.client_id,account:$scope.clientID.client_id,stripe_user:{product_description:$scope.campaigndesc,business_name:$scope.campaignName,first_name:$scope.user.first_name,last_name:$scope.user.last_name,url:$scope.website,email:$scope.useremail},scope:"read_write",redirect_uri:$scope.stripeRedirect,state:$scope.stateParam});var finalUrl=baseUrl+$.param(params);window.location.href=finalUrl}}]);