!function(factory){"function"==typeof define&&define.amd?define(["jquery"],factory):"object"==typeof module&&module.exports?module.exports=function(root,jQuery){return void 0===jQuery&&(jQuery="undefined"!=typeof window?require("jquery"):require("jquery")(root)),factory(jQuery)}:factory(window.jQuery)}(function($){var server,server_loc,currentPath,parsedPath;$.extend($.FE.POPUP_TEMPLATES,{"file.insert":"[_BUTTONS_][_UPLOAD_LAYER_][_PROGRESS_BAR_]"}),$.extend($.FE.DEFAULTS,{fileUploadURL:"https://i.froala.com/upload",fileUploadParam:"file",fileUploadParams:{},fileUploadToS3:!1,fileUploadMethod:"POST",fileMaxSize:10485760,fileAllowedTypes:["*"],fileInsertButtons:["fileBack","|"],fileUseSelectedText:!1}),$.FE.PLUGINS.file=function(editor){function showProgressBar(){var $popup=editor.popups.get("file.insert");$popup||($popup=_initInsertPopup()),$popup.find(".fr-layer.fr-active").removeClass("fr-active").addClass("fr-pactive"),$popup.find(".fr-file-progress-bar-layer").addClass("fr-active"),$popup.find(".fr-buttons").hide(),_setProgressMessage(editor.language.translate("Uploading"),0)}function hideProgressBar(dismiss){var $popup=editor.popups.get("file.insert");$popup&&($popup.find(".fr-layer.fr-pactive").addClass("fr-active").removeClass("fr-pactive"),$popup.find(".fr-file-progress-bar-layer").removeClass("fr-active"),$popup.find(".fr-buttons").show(),dismiss&&(editor.events.focus(),editor.popups.hide("file.insert")))}function _setProgressMessage(message,progress){var $popup=editor.popups.get("file.insert");if($popup){var $layer=$popup.find(".fr-file-progress-bar-layer");$layer.find("h3").text(message+(progress?" "+progress+"%":"")),$layer.removeClass("fr-error"),progress?($layer.find("div").removeClass("fr-indeterminate"),$layer.find("div > span").css("width",progress+"%")):$layer.find("div").addClass("fr-indeterminate")}}function _showErrorMessage(message){showProgressBar();var $layer=editor.popups.get("file.insert").find(".fr-file-progress-bar-layer");$layer.addClass("fr-error");var $message_header=$layer.find("h3");$message_header.text(message),editor.events.disableBlur(),$message_header.focus()}function insert(link,text,response){editor.edit.on(),editor.events.focus(!0),editor.selection.restore(),editor.opts.fileUseSelectedText&&editor.selection.text().length&&(text=editor.selection.text()),editor.html.insert('<a href="'+link+'" id="fr-inserted-file" class="fr-file" target="_blank">'+(text||editor.selection.text())+"</a>");var $file=editor.$el.find("#fr-inserted-file");$file.removeAttr("id"),editor.popups.hide("file.insert"),editor.undo.saveStep(),_syncFiles(),editor.events.trigger("file.inserted",[$file,response])}function _parseResponse(response){try{if(!1===editor.events.trigger("file.uploaded",[response],!0))return editor.edit.on(),!1;var resp=$.parseJSON(response);return resp.path_external||resp.data.path_external?resp:(_throwError(MISSING_LINK,response),!1)}catch(ex){return _throwError(BAD_RESPONSE,response),!1}}function _parseXMLResponse(response){try{var link=$(response).find("Location").text(),key=$(response).find("Key").text();return!1===editor.events.trigger("file.uploadedToS3",[link,key,response],!0)?(editor.edit.on(),!1):link}catch(ex){return _throwError(BAD_RESPONSE,response),!1}}function _fileUploaded(text){var status=this.status,response=this.response,responseXML=this.responseXML,responseText=this.responseText;try{if(editor.opts.fileUploadToS3)if(201==status){var link=_parseXMLResponse(responseXML);link&&insert(link,text,response||responseXML)}else _throwError(BAD_RESPONSE,response||responseXML);else if(status>=200&&status<300){var resp=_parseResponse(responseText);if(resp){var fileURL;"admin"==parsedPath||"campaign-setup"==parsedPath||"campaign-manager"==parsedPath?resp.path_external?fileURL=server+"/static/images/"+resp.path_external:resp.data.path_external&&(fileURL=server+"/static/images/"+resp.data.path_external):"rewards"==parsedPath&&(fileURL=server+"/image/campaign_reward_image/"+resp.path_external),insert(fileURL,text,response||responseText)}}else _throwError(ERROR_DURING_UPLOAD,response||responseText)}catch(ex){_throwError(BAD_RESPONSE,response||responseText)}}function _fileUploadError(){_throwError(BAD_RESPONSE,this.response||this.responseText||this.responseXML)}function _fileUploadProgress(e){if(e.lengthComputable){var complete=e.loaded/e.total*100|0;_setProgressMessage(editor.language.translate("Uploading"),complete)}}function _throwError(code,response){editor.edit.on(),_showErrorMessage(editor.language.translate("Something went wrong. Please try again.")),editor.events.trigger("file.error",[{code:code,message:error_messages[code]},response])}function _fileUploadAborted(){editor.edit.on(),hideProgressBar(!0)}function upload(files){if(void 0!==files&&files.length>0){if(!1===editor.events.trigger("file.beforeUpload",[files]))return!1;var file=files[0];if(file.size>editor.opts.fileMaxSize)return _throwError(MAX_SIZE_EXCEEDED),!1;if(editor.opts.fileAllowedTypes.indexOf("*")<0&&editor.opts.fileAllowedTypes.indexOf(file.type.replace(/file\//g,""))<0)return _throwError(BAD_FILE_TYPE),!1;var form_data;if(editor.drag_support.formdata&&(form_data=editor.drag_support.formdata?new FormData:null),form_data){var key;if(!1!==editor.opts.fileUploadToS3){form_data.append("key",editor.opts.fileUploadToS3.keyStart+(new Date).getTime()+"-"+(file.name||"untitled")),form_data.append("success_action_status","201"),form_data.append("X-Requested-With","xhr"),form_data.append("Content-Type",file.type);for(key in editor.opts.fileUploadToS3.params)editor.opts.fileUploadToS3.params.hasOwnProperty(key)&&form_data.append(key,editor.opts.fileUploadToS3.params[key])}for(key in editor.opts.fileUploadParams)editor.opts.fileUploadParams.hasOwnProperty(key)&&form_data.append(key,editor.opts.fileUploadParams[key]);form_data.append(editor.opts.fileUploadParam,file);editor.opts.fileUploadURL;editor.opts.fileUploadToS3&&(editor.opts.fileUploadToS3.uploadURL?editor.opts.fileUploadToS3.uploadURL:"https://"+editor.opts.fileUploadToS3.region+".amazonaws.com/"+editor.opts.fileUploadToS3.bucket),server=$("textarea[data-server]").attr("data-server"),server_loc=$("textarea[data-server]").attr("data-loc"),currentPath=window.location.pathname,parsedPath=currentPath.split("/")[1];var xhr=new XMLHttpRequest,data=new FormData;if(data.append("success_action_status","200"),data.append("X-Requested-With","xhr"),data.append("Content-Type",file.type),"admin"==parsedPath){endpoint=server+server_loc+"portal/resource/file";xhr.open("POST",endpoint,!0),data.append("resource_type","file"),data.append("resource_content_type","generic"),data.append("resource",file),data.append("region_id","1")}else if("campaign-setup"==parsedPath||"rewards"==parsedPath||"campaign-manager"==parsedPath){var campaignID;campaignID="campaign-manager"==parsedPath?currentPath.split("/")[3]:currentPath.split("/")[2],server=$(".page-content").attr("data-server"),server_loc=$(".page-content").attr("data-loc");var endpoint=server+server_loc+"campaign/"+campaignID+"/resource/file";xhr.open("POST",endpoint,!0),data.append("entry_id",campaignID),data.append("resource_type","file"),data.append("resource_content_type","generic"),data.append("resource",file),data.append("region_id","2")}xhr.withCredentials=!0,xhr.onload=function(){_fileUploaded.call(xhr,[editor.opts.fileUseSelectedText?null:file.name])},xhr.onerror=_fileUploadError,xhr.upload.onprogress=_fileUploadProgress,xhr.onabort=_fileUploadAborted,showProgressBar(),editor.edit.off();var $popup=editor.popups.get("file.insert");$popup&&$popup.off("abortUpload").on("abortUpload",function(){4!=xhr.readyState&&xhr.abort()}),xhr.send(data)}}}function _bindInsertEvents($popup){editor.events.$on($popup,"dragover dragenter",".fr-file-upload-layer",function(){return $(this).addClass("fr-drop"),!1},!0),editor.events.$on($popup,"dragleave dragend",".fr-file-upload-layer",function(){return $(this).removeClass("fr-drop"),!1},!0),editor.events.$on($popup,"drop",".fr-file-upload-layer",function(e){e.preventDefault(),e.stopPropagation(),$(this).removeClass("fr-drop");var dt=e.originalEvent.dataTransfer;dt&&dt.files&&($popup.data("instance")||editor).file.upload(dt.files)},!0),editor.events.$on($popup,"change",'.fr-file-upload-layer input[type="file"]',function(){this.files&&($popup.data("instance")||editor).file.upload(this.files),$(this).val("")},!0)}function _hideInsertPopup(){hideProgressBar()}function _initInsertPopup(delayed){if(delayed)return editor.popups.onHide("file.insert",_hideInsertPopup),!0;var file_buttons="",upload_layer="",template={buttons:file_buttons='<div class="fr-buttons">'+editor.button.buildList(editor.opts.fileInsertButtons)+"</div>",upload_layer:upload_layer='<div class="fr-file-upload-layer fr-layer fr-active" id="fr-file-upload-layer-'+editor.id+'"><strong>'+editor.language.translate("Drop file")+"</strong><br>("+editor.language.translate("or click")+')<div class="fr-form"><input type="file" name="'+editor.opts.fileUploadParam+'" accept="/*" tabIndex="-1" aria-labelledby="fr-file-upload-layer-'+editor.id+'" role="button"></div></div>',progress_bar:'<div class="fr-file-progress-bar-layer fr-layer"><h3 tabIndex="-1" class="fr-message">Uploading</h3><div class="fr-loader"><span class="fr-progress"></span></div><div class="fr-action-buttons"><button type="button" class="fr-command fr-dismiss" data-cmd="fileDismissError" tabIndex="2" role="button">OK</button></div></div>'},$popup=editor.popups.create("file.insert",template);return _bindInsertEvents($popup),$popup}function _onRemove(link){editor.node.hasClass(link,"fr-file")}function _drop(e){var dt=e.originalEvent.dataTransfer;if(dt&&dt.files&&dt.files.length){var file=dt.files[0];if(file&&void 0!==file.type&&file.type.indexOf("image")<0&&(editor.opts.fileAllowedTypes.indexOf(file.type)>=0||editor.opts.fileAllowedTypes.indexOf("*")>=0)){editor.markers.remove(),editor.markers.insertAtPoint(e.originalEvent),editor.$el.find(".fr-marker").replaceWith($.FE.MARKERS),editor.popups.hideAll();var $popup=editor.popups.get("file.insert");return $popup||($popup=_initInsertPopup()),editor.popups.setContainer("file.insert",editor.$sc),editor.popups.show("file.insert",e.originalEvent.pageX,e.originalEvent.pageY),showProgressBar(),upload(dt.files),e.preventDefault(),e.stopPropagation(),!1}}}function _initEvents(){editor.events.on("drop",_drop),editor.events.$on(editor.$win,"keydown",function(e){var key_code=e.which,$popup=editor.popups.get("file.insert");$popup&&key_code==$.FE.KEYCODE.ESC&&$popup.trigger("abortUpload")}),editor.events.on("destroy",function(){var $popup=editor.popups.get("file.insert");$popup&&$popup.trigger("abortUpload")})}function _syncFiles(){var i,c_files=Array.prototype.slice.call(editor.el.querySelectorAll("a.fr-file")),file_srcs=[];for(i=0;i<c_files.length;i++)file_srcs.push(c_files[i].getAttribute("href"));if(files)for(i=0;i<files.length;i++)file_srcs.indexOf(files[i].getAttribute("href"))<0&&editor.events.trigger("file.unlink",[files[i]]);files=c_files}var MISSING_LINK=2,ERROR_DURING_UPLOAD=3,BAD_RESPONSE=4,MAX_SIZE_EXCEEDED=5,BAD_FILE_TYPE=6,error_messages={};error_messages[1]="File cannot be loaded from the passed link.",error_messages[MISSING_LINK]="No link in upload response.",error_messages[ERROR_DURING_UPLOAD]="Error during file upload.",error_messages[BAD_RESPONSE]="Parsing response failed.",error_messages[MAX_SIZE_EXCEEDED]="File is too large.",error_messages[BAD_FILE_TYPE]="File file type is invalid.",error_messages[7]="Files can be uploaded only to same domain in IE 8 and IE 9.";var files;return{_init:function(){_initEvents(),editor.events.on("link.beforeRemove",_onRemove),editor.$wp&&(_syncFiles(),editor.events.on("contentChanged",_syncFiles)),_initInsertPopup(!0)},showInsertPopup:function(){var $btn=editor.$tb.find('.fr-command[data-cmd="insertFile"]'),$popup=editor.popups.get("file.insert");if($popup||($popup=_initInsertPopup()),hideProgressBar(),!$popup.hasClass("fr-active")){editor.popups.refresh("file.insert"),editor.popups.setContainer("file.insert",editor.$tb);var left=$btn.offset().left+$btn.outerWidth()/2,top=$btn.offset().top+(editor.opts.toolbarBottom?0:$btn.outerHeight());editor.popups.show("file.insert",left,top,$btn.outerHeight())}},upload:upload,insert:insert,back:function(){editor.events.disableBlur(),editor.selection.restore(),editor.events.enableBlur(),editor.popups.hide("file.insert"),editor.toolbar.showInline()},hideProgressBar:hideProgressBar}},$.FE.DefineIcon("insertFile",{NAME:"file-o"}),$.FE.RegisterCommand("insertFile",{title:"Upload File",undo:!1,focus:!0,refreshAfterCallback:!1,popup:!0,callback:function(){this.popups.isVisible("file.insert")?(this.$el.find(".fr-marker").length&&(this.events.disableBlur(),this.selection.restore()),this.popups.hide("file.insert")):this.file.showInsertPopup()},plugin:"file"}),$.FE.DefineIcon("fileBack",{NAME:"arrow-left"}),$.FE.RegisterCommand("fileBack",{title:"Back",undo:!1,focus:!1,back:!0,refreshAfterCallback:!1,callback:function(){this.file.back()},refresh:function($btn){this.opts.toolbarInline?($btn.removeClass("fr-hidden"),$btn.next(".fr-separator").removeClass("fr-hidden")):($btn.addClass("fr-hidden"),$btn.next(".fr-separator").addClass("fr-hidden"))}}),$.FE.RegisterCommand("fileDismissError",{title:"OK",callback:function(){this.file.hideProgressBar(!0)}})});